<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Grisbi:  Fichier source de gsb_debug.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Généré par Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Page&nbsp;principale</span></a></li>
      <li><a href="pages.html"><span>Pages&nbsp;associées</span></a></li>
      <li><a href="annotated.html"><span>Structures&nbsp;de&nbsp;données</span></a></li>
      <li class="current"><a href="files.html"><span>Fichiers</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>Liste&nbsp;des&nbsp;fichiers</span></a></li>
      <li><a href="globals.html"><span>Portée&nbsp;globale</span></a></li>
    </ul>
  </div>
<h1>gsb_debug.c</h1><a href="gsb__debug_8c.html">Aller à la documentation de ce fichier.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ************************************************************************** */</span>
<a name="l00002"></a>00002 <span class="comment">/*     Copyright (C)    2004-2005 Alain Portal (aportal@univ-montp2.fr)       */</span>
<a name="l00003"></a>00003 <span class="comment">/*                      2006-2006 Benjamin Drieu (bdrieu@april.org)               */</span>
<a name="l00004"></a>00004 <span class="comment">/*                      http://www.grisbi.org                                                         */</span>
<a name="l00005"></a>00005 <span class="comment">/*                                                                            */</span>
<a name="l00006"></a>00006 <span class="comment">/*  This program is free software; you can redistribute it and/or modify      */</span>
<a name="l00007"></a>00007 <span class="comment">/*  it under the terms of the GNU General Public License as published by      */</span>
<a name="l00008"></a>00008 <span class="comment">/*  the Free Software Foundation; either version 2 of the License, or         */</span>
<a name="l00009"></a>00009 <span class="comment">/*  (at your option) any later version.                                       */</span>
<a name="l00010"></a>00010 <span class="comment">/*                                                                            */</span>
<a name="l00011"></a>00011 <span class="comment">/*  This program is distributed in the hope that it will be useful,           */</span>
<a name="l00012"></a>00012 <span class="comment">/*  but WITHOUT ANY WARRANTY; without even the implied warranty of            */</span>
<a name="l00013"></a>00013 <span class="comment">/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             */</span>
<a name="l00014"></a>00014 <span class="comment">/*  GNU General Public License for more details.                              */</span>
<a name="l00015"></a>00015 <span class="comment">/*                                                                            */</span>
<a name="l00016"></a>00016 <span class="comment">/*  You should have received a copy of the GNU General Public License         */</span>
<a name="l00017"></a>00017 <span class="comment">/*  along with this program; if not, write to the Free Software               */</span>
<a name="l00018"></a>00018 <span class="comment">/*  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA */</span>
<a name="l00019"></a>00019 <span class="comment">/*                                                                            */</span>
<a name="l00020"></a>00020 <span class="comment">/* ************************************************************************** */</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="include_8h.html">include.h</a>&quot;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="comment">/*START_INCLUDE*/</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="gsb__debug_8h.html">gsb_debug.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="dialog_8h.html">dialog.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="gsb__assistant_8h.html">gsb_assistant.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__account_8h.html">gsb_data_account.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__budget_8h.html">gsb_data_budget.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__category_8h.html">gsb_data_category.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__fyear_8h.html">gsb_data_fyear.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__payee_8h.html">gsb_data_payee.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__reconcile_8h.html">gsb_data_reconcile.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__transaction_8h.html">gsb_data_transaction.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="gsb__real_8h.html">gsb_real.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="gsb__status_8h.html">gsb_status.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="traitement__variables_8h.html">traitement_variables.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="utils__str_8h.html">utils_str.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="include_8h.html">include.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__transaction_8h.html">gsb_data_transaction.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="structures_8h.html">structures.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="gsb__real_8h.html">gsb_real.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="comment">/*END_INCLUDE*/</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">/*START_STATIC*/</span>
<a name="l00046"></a>00046 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_debug_add_report_page ( GtkWidget * assistant, gint page, 
<a name="l00047"></a>00047                                  <span class="keyword">struct</span> <a class="code" href="structgsb__debug__test.html">gsb_debug_test</a> * test, gchar * summary );
<a name="l00048"></a>00048 <span class="keyword">static</span> gchar *gsb_debug_budget_test  ( <span class="keywordtype">void</span> );
<a name="l00049"></a>00049 <span class="keyword">static</span> gboolean gsb_debug_budget_test_fix ();
<a name="l00050"></a>00050 <span class="keyword">static</span> gchar *gsb_debug_category_test  ( <span class="keywordtype">void</span> );
<a name="l00051"></a>00051 <span class="keyword">static</span> gboolean gsb_debug_category_test_fix ();
<a name="l00052"></a>00052 <span class="keyword">static</span> gboolean gsb_debug_enter_test_page ( GtkWidget * assistant );
<a name="l00053"></a>00053 <span class="keyword">static</span> gchar *gsb_debug_payee_test  ( <span class="keywordtype">void</span> );
<a name="l00054"></a>00054 <span class="keyword">static</span> gboolean gsb_debug_payee_test_fix ();
<a name="l00055"></a>00055 <span class="keyword">static</span> gchar * gsb_debug_reconcile_test ( <span class="keywordtype">void</span> );
<a name="l00056"></a>00056 <span class="keyword">static</span> gchar * gsb_debug_transfer_test ( <span class="keywordtype">void</span> );
<a name="l00057"></a>00057 <span class="keyword">static</span> gboolean gsb_debug_try_fix ( gboolean (* fix) () );
<a name="l00058"></a>00058 <span class="comment">/*END_STATIC*/</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">/*START_EXTERN*/</span>
<a name="l00061"></a>00061 <span class="keyword">extern</span> <a class="code" href="structgsb__real.html">gsb_real</a> <a class="code" href="accueil_8c.html#a26f304bec3fdc0651b9aa8765d4de3c6">null_real</a>;
<a name="l00062"></a>00062 <span class="comment">/*END_EXTERN*/</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 
<a name="l00067"></a><a class="code" href="gsb__debug_8c.html#a524492a56807104a76c1aa5a8a076d1b">00067</a> <span class="keyword">struct </span><a class="code" href="structgsb__debug__test.html">gsb_debug_test</a> <a class="code" href="gsb__debug_8c.html#a524492a56807104a76c1aa5a8a076d1b">debug_tests</a> [8] = {
<a name="l00068"></a>00068     <span class="comment">/* Check for reconciliation inconcistency.  */</span>
<a name="l00069"></a>00069     { N_(<span class="stringliteral">&quot;Incorrect reconcile totals&quot;</span>),
<a name="l00070"></a>00070       N_(<span class="stringliteral">&quot;This test will look for accounts where reconcile totals do not match reconciled transactions.&quot;</span>),
<a name="l00071"></a>00071       N_(<span class="stringliteral">&quot;Grisbi found accounts where reconciliation totals are inconsistent &quot;</span>
<a name="l00072"></a>00072          <span class="stringliteral">&quot;with the sum of reconcilied transactions.  Generally, the cause is &quot;</span>
<a name="l00073"></a>00073          <span class="stringliteral">&quot;too many transfers to other accounts are reconciled.  You have to &quot;</span>
<a name="l00074"></a>00074          <span class="stringliteral">&quot;manually unreconcile some transferts in inconsistent accounts.&quot;</span>
<a name="l00075"></a>00075          <span class="stringliteral">&quot;It happens sometimes too for old accounts wich pass to Euro&quot;</span>
<a name="l00076"></a>00076          <span class="stringliteral">&quot;In that case the inconsistent is only some cents and it&#39;s normal.&quot;</span>), 
<a name="l00077"></a>00077       gsb_debug_reconcile_test, NULL },
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     { N_(<span class="stringliteral">&quot;Duplicate sub-categories check&quot;</span>),
<a name="l00080"></a>00080       N_(<span class="stringliteral">&quot;free&quot;</span>),
<a name="l00081"></a>00081       N_(<span class="stringliteral">&quot;Due to a bug in previous versions of Grisbi, &quot;</span>
<a name="l00082"></a>00082          <span class="stringliteral">&quot;sub-categories may share the same numeric identifier in some &quot;</span>
<a name="l00083"></a>00083          <span class="stringliteral">&quot;cases, resulting in transactions having two sub-categories.  &quot;</span>
<a name="l00084"></a>00084          <span class="stringliteral">&quot;If you choose to continue, Grisbi will &quot;</span>
<a name="l00085"></a>00085          <span class="stringliteral">&quot;remove one of each duplicates and &quot;</span>
<a name="l00086"></a>00086          <span class="stringliteral">&quot;recreate it with a new identifier.\n\n&quot;</span>
<a name="l00087"></a>00087          <span class="stringliteral">&quot;No transaction will be lost, but in some cases, you &quot;</span>
<a name="l00088"></a>00088          <span class="stringliteral">&quot;will have to manually move transactions to this new &quot;</span>
<a name="l00089"></a>00089          <span class="stringliteral">&quot;sub-category.&quot;</span>),
<a name="l00090"></a>00090       <a class="code" href="gsb__data__category_8c.html#a77a566f97efc985ed31a709e0f999884" title="Debug check to verify if some sub categories are doubled.">gsb_debug_duplicate_categ_check</a>, <a class="code" href="gsb__data__category_8c.html#adc32170e6ce2e5c802d70dc7e0e43085">gsb_debug_duplicate_categ_fix</a> },
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     { N_(<span class="stringliteral">&quot;Duplicate sub-budgetary lines check&quot;</span>),
<a name="l00093"></a>00093       N_(<span class="stringliteral">&quot;free&quot;</span>),
<a name="l00094"></a>00094       N_(<span class="stringliteral">&quot;Due to a bug in previous versions of Grisbi, &quot;</span>
<a name="l00095"></a>00095          <span class="stringliteral">&quot;sub-budgetary lines may share the same numeric id in some &quot;</span>
<a name="l00096"></a>00096          <span class="stringliteral">&quot;cases, resulting in transactions having two sub-budgetary lines.  &quot;</span>
<a name="l00097"></a>00097          <span class="stringliteral">&quot;If you choose to continue, Grisbi will &quot;</span>
<a name="l00098"></a>00098          <span class="stringliteral">&quot;remove one of each duplicates and &quot;</span>
<a name="l00099"></a>00099          <span class="stringliteral">&quot;recreate it with a new id.entifier\n\n&quot;</span>
<a name="l00100"></a>00100          <span class="stringliteral">&quot;No transactions will be lost, but in some cases, you &quot;</span>
<a name="l00101"></a>00101          <span class="stringliteral">&quot;will have to manually move transactions to this new &quot;</span>
<a name="l00102"></a>00102          <span class="stringliteral">&quot;sub-budgetary line.&quot;</span>),
<a name="l00103"></a>00103       <a class="code" href="gsb__data__budget_8c.html#acba891a0cbb4c3504b649cdbfe682816" title="Debug check to verify if some sub budgets are doubled.">gsb_debug_duplicate_budget_check</a>, <a class="code" href="gsb__data__budget_8c.html#a2ed32cf7e76ee11f9524934bd1550f5d">gsb_debug_duplicate_budget_fix</a> },
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     { N_(<span class="stringliteral">&quot;Orphan countra-transactions check&quot;</span>),
<a name="l00106"></a>00106       N_(<span class="stringliteral">&quot;free&quot;</span>),
<a name="l00107"></a>00107       N_(<span class="stringliteral">&quot;In some rare cases, transfers are incorrectly linked to contra-transactions.  &quot;</span>
<a name="l00108"></a>00108          <span class="stringliteral">&quot;This might be because of bugs or because of imports that failed.\n&quot;</span>
<a name="l00109"></a>00109          <span class="stringliteral">&quot;To fix this, you will have to manually edit your .gsb file &quot;</span>
<a name="l00110"></a>00110          <span class="stringliteral">&quot;(with a text editor) and fix transactions using their numeric ID.&quot;</span>),
<a name="l00111"></a>00111       gsb_debug_transfer_test, NULL },
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     { N_(<span class="stringliteral">&quot;Incorrect category/sub-category number&quot;</span>),
<a name="l00114"></a>00114       N_(<span class="stringliteral">&quot;This test will look for transactions wich have non existant categories/sub-categories.&quot;</span>),
<a name="l00115"></a>00115       N_(<span class="stringliteral">&quot;Grisbi found some transactions with non existants categories/sub-categories &quot;</span>
<a name="l00116"></a>00116          <span class="stringliteral">&quot;If you choose to continue, Grisbi will remove that category error &quot;</span>
<a name="l00117"></a>00117          <span class="stringliteral">&quot;and that transactions will have no categories.&quot;</span> ),
<a name="l00118"></a>00118       gsb_debug_category_test, gsb_debug_category_test_fix },
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     { N_(<span class="stringliteral">&quot;Incorrect budget/sub-budget number&quot;</span>),
<a name="l00121"></a>00121       N_(<span class="stringliteral">&quot;This test will look for transactions wich have non existant budgets/sub-budgets.&quot;</span>),
<a name="l00122"></a>00122       N_(<span class="stringliteral">&quot;Grisbi found some transactions with non existants budgets/sub-budgets &quot;</span>
<a name="l00123"></a>00123          <span class="stringliteral">&quot;If you choose to continue, Grisbi will remove that budget error &quot;</span>
<a name="l00124"></a>00124          <span class="stringliteral">&quot;and that transactions will have no budgets.&quot;</span> ),
<a name="l00125"></a>00125       gsb_debug_budget_test, gsb_debug_budget_test_fix },
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     { N_(<span class="stringliteral">&quot;Incorrect payee number&quot;</span>),
<a name="l00128"></a>00128       N_(<span class="stringliteral">&quot;This test will look for transactions wich have non existant payees.&quot;</span>),
<a name="l00129"></a>00129       N_(<span class="stringliteral">&quot;Grisbi found some transactions with non existants payees &quot;</span>
<a name="l00130"></a>00130          <span class="stringliteral">&quot;If you choose to continue, Grisbi will &quot;</span>
<a name="l00131"></a>00131          <span class="stringliteral">&quot;remove them and that transactions will have no payee.&quot;</span> ),
<a name="l00132"></a>00132       gsb_debug_payee_test, gsb_debug_payee_test_fix },
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     { NULL, NULL, NULL, NULL, NULL },
<a name="l00136"></a>00136 };
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00145"></a><a class="code" href="gsb__debug_8h.html#a0f8015596839d99fcbdf93c38bc8cf34">00145</a> gboolean <a class="code" href="gsb__debug_8c.html#a0f8015596839d99fcbdf93c38bc8cf34">gsb_debug</a> ( <span class="keywordtype">void</span> )
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147     GtkWidget * assistant, * text_view;
<a name="l00148"></a>00148     GtkTextBuffer * text_buffer;
<a name="l00149"></a>00149     GtkWidget *scrolled_window;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <a class="code" href="gsb__status_8c.html#a476044d7002fa33e44709e7293974914">gsb_status_message</a> ( _(<span class="stringliteral">&quot;Checking file for possible corruption...&quot;</span>) );
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     assistant = <a class="code" href="gsb__assistant_8c.html#a8502128771d8c3f3e8c83d877e1f20ea">gsb_assistant_new</a> ( _(<span class="stringliteral">&quot;Grisbi accounts debug&quot;</span>),
<a name="l00154"></a>00154                                     _(<span class="stringliteral">&quot;This assistant will help you to search your account &quot;</span>
<a name="l00155"></a>00155                                       <span class="stringliteral">&quot;file for inconsistencies, which can be caused either &quot;</span>
<a name="l00156"></a>00156                                       <span class="stringliteral">&quot;by bugs or by erroneous manipulation.&quot;</span>),
<a name="l00157"></a>00157                                     <span class="stringliteral">&quot;bug.png&quot;</span>,
<a name="l00158"></a>00158                                     NULL );
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     scrolled_window = gtk_scrolled_window_new (FALSE, FALSE);
<a name="l00161"></a>00161     gtk_scrolled_window_set_policy (GTK_SCROLLED_WINDOW (scrolled_window),
<a name="l00162"></a>00162                                     GTK_POLICY_AUTOMATIC,
<a name="l00163"></a>00163                                     GTK_POLICY_AUTOMATIC );
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     text_view = gtk_text_view_new ();
<a name="l00166"></a>00166     gtk_text_view_set_wrap_mode ( GTK_TEXT_VIEW (text_view), GTK_WRAP_WORD );
<a name="l00167"></a>00167     gtk_text_view_set_editable ( GTK_TEXT_VIEW(text_view), FALSE );
<a name="l00168"></a>00168     gtk_text_view_set_cursor_visible ( GTK_TEXT_VIEW(text_view), FALSE );
<a name="l00169"></a>00169     gtk_text_view_set_left_margin ( GTK_TEXT_VIEW(text_view), 12 );
<a name="l00170"></a>00170     gtk_text_view_set_right_margin ( GTK_TEXT_VIEW(text_view), 12 );
<a name="l00171"></a>00171     gtk_container_add ( GTK_CONTAINER (scrolled_window),
<a name="l00172"></a>00172                         text_view );
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     text_buffer = gtk_text_view_get_buffer ( GTK_TEXT_VIEW ( text_view ) );
<a name="l00175"></a>00175     g_object_set_data ( G_OBJECT ( assistant ), <span class="stringliteral">&quot;text-buffer&quot;</span>, text_buffer );
<a name="l00176"></a>00176     gtk_text_buffer_create_tag ( text_buffer, <span class="stringliteral">&quot;bold&quot;</span>, <span class="stringliteral">&quot;weight&quot;</span>, PANGO_WEIGHT_BOLD, NULL);  
<a name="l00177"></a>00177     gtk_text_buffer_create_tag ( text_buffer, <span class="stringliteral">&quot;x-large&quot;</span>, <span class="stringliteral">&quot;scale&quot;</span>, PANGO_SCALE_X_LARGE, NULL);
<a name="l00178"></a>00178     gtk_text_buffer_create_tag ( text_buffer, <span class="stringliteral">&quot;indented&quot;</span>, <span class="stringliteral">&quot;left-margin&quot;</span>, 24, NULL);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <a class="code" href="gsb__assistant_8c.html#a6972bde2415e07b7afb35a062456f129">gsb_assistant_add_page</a> ( assistant, scrolled_window, 1, 0, -1, 
<a name="l00181"></a>00181                              G_CALLBACK ( gsb_debug_enter_test_page ) );
<a name="l00182"></a>00182     
<a name="l00183"></a>00183     <a class="code" href="gsb__assistant_8c.html#a886a6fa8c458d71d7cfae7b54bd3187f">gsb_assistant_run</a> ( assistant );
<a name="l00184"></a>00184     gtk_widget_destroy ( assistant );
<a name="l00185"></a>00185     
<a name="l00186"></a>00186     <span class="keywordflow">return</span> FALSE;
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 
<a name="l00196"></a>00196 gboolean gsb_debug_enter_test_page ( GtkWidget * assistant )
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     GtkTextBuffer * text_buffer = NULL;
<a name="l00199"></a>00199     GtkTextIter text_iter;
<a name="l00200"></a>00200     gboolean inconsistency = FALSE;
<a name="l00201"></a>00201     gint i, page = 2;
<a name="l00202"></a>00202         gchar* tmpstr;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     text_buffer = g_object_get_data ( G_OBJECT(assistant), <span class="stringliteral">&quot;text-buffer&quot;</span> );
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="keywordflow">while</span> ( gtk_notebook_get_n_pages ( g_object_get_data ( G_OBJECT (assistant), 
<a name="l00207"></a>00207                                                            <span class="stringliteral">&quot;notebook&quot;</span> ) ) &gt; 2 )
<a name="l00208"></a>00208     {
<a name="l00209"></a>00209         gtk_notebook_remove_page ( g_object_get_data ( G_OBJECT (assistant), <span class="stringliteral">&quot;notebook&quot;</span> ), 
<a name="l00210"></a>00210                                    -1 );
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     gtk_text_buffer_set_text ( text_buffer, <span class="stringliteral">&quot;\n&quot;</span>, -1);
<a name="l00214"></a>00214     gtk_text_buffer_get_iter_at_offset ( text_buffer, &amp;text_iter, 1 );
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">for</span> ( i = 0 ; debug_tests [i] . <a class="code" href="structgsb__debug__test.html#a18bdf722e904d07735b2bbd18c200001">name</a> != NULL ; i ++ )
<a name="l00217"></a>00217     {
<a name="l00218"></a>00218         gchar * result = debug_tests [ i ] . <a class="code" href="structgsb__debug__test.html#aa7c27394a1df6c65cb51f19e0f1bf15e">test</a> ();
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="keywordflow">if</span> ( result )
<a name="l00221"></a>00221         {
<a name="l00222"></a>00222             <span class="keywordflow">if</span> ( ! inconsistency )
<a name="l00223"></a>00223             {
<a name="l00224"></a>00224                 <span class="comment">/* No inconsistency found yet so put title. */</span>
<a name="l00225"></a>00225                 gtk_text_buffer_insert_with_tags_by_name ( text_buffer, &amp;text_iter,
<a name="l00226"></a>00226                                                            _(<span class="stringliteral">&quot;Inconsistencies found\n\n&quot;</span>), 
<a name="l00227"></a>00227                                                            -1, <span class="stringliteral">&quot;x-large&quot;</span>, NULL );
<a name="l00228"></a>00228                 gtk_text_buffer_insert ( text_buffer, &amp;text_iter,
<a name="l00229"></a>00229                                          _(<span class="stringliteral">&quot;The following debug tests found inconsistencies &quot;</span>
<a name="l00230"></a>00230                                            <span class="stringliteral">&quot;in this accounts file:\n\n&quot;</span>),
<a name="l00231"></a>00231                                          -1 );
<a name="l00232"></a>00232             }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234             tmpstr = g_strconcat ( <span class="stringliteral">&quot;• &quot;</span>, _( debug_tests[i] . <a class="code" href="structgsb__debug__test.html#a18bdf722e904d07735b2bbd18c200001">name</a> ), <span class="stringliteral">&quot;\n&quot;</span>, NULL );
<a name="l00235"></a>00235             gtk_text_buffer_insert_with_tags_by_name ( text_buffer, &amp;text_iter,
<a name="l00236"></a>00236                                                        tmpstr,
<a name="l00237"></a>00237                                                        -1, <span class="stringliteral">&quot;indented&quot;</span>, NULL );
<a name="l00238"></a>00238             g_free ( tmpstr );
<a name="l00239"></a>00239 
<a name="l00240"></a>00240             inconsistency = TRUE;
<a name="l00241"></a>00241             gsb_debug_add_report_page ( assistant, page, &amp;(debug_tests[i]), result );
<a name="l00242"></a>00242             page ++;
<a name="l00243"></a>00243         }
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245     
<a name="l00246"></a>00246     <a class="code" href="gsb__status_8c.html#a476044d7002fa33e44709e7293974914">gsb_status_message</a> ( _(<span class="stringliteral">&quot;Done&quot;</span>) );
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="keywordflow">if</span> ( !inconsistency )
<a name="l00249"></a>00249     {
<a name="l00250"></a>00250         gtk_text_buffer_insert_with_tags_by_name ( text_buffer, &amp;text_iter,
<a name="l00251"></a>00251                                                    _(<span class="stringliteral">&quot;No inconsistency found\n\n&quot;</span>), 
<a name="l00252"></a>00252                                                    -1, <span class="stringliteral">&quot;x-large&quot;</span>, NULL );
<a name="l00253"></a>00253         gtk_text_buffer_insert ( text_buffer, &amp;text_iter,
<a name="l00254"></a>00254                                  _(<span class="stringliteral">&quot;Congratulations, your account file is in good shape!\n&quot;</span>),
<a name="l00255"></a>00255                                  -1 );
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     
<a name="l00258"></a>00258     <span class="keywordflow">return</span> TRUE;
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 
<a name="l00267"></a>00267 <span class="keywordtype">void</span> gsb_debug_add_report_page ( GtkWidget * assistant, gint page, 
<a name="l00268"></a>00268                                  <span class="keyword">struct</span> <a class="code" href="structgsb__debug__test.html">gsb_debug_test</a> * <a class="code" href="structgsb__debug__test.html#aa7c27394a1df6c65cb51f19e0f1bf15e">test</a>, gchar * summary )
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     GtkWidget * vbox, * label, * button;
<a name="l00271"></a>00271     GtkWidget *scrolled_window;
<a name="l00272"></a>00272     gchar *tmp_str;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     scrolled_window = gtk_scrolled_window_new (FALSE, FALSE);
<a name="l00275"></a>00275     gtk_scrolled_window_set_policy (GTK_SCROLLED_WINDOW (scrolled_window),
<a name="l00276"></a>00276                                     GTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC );
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     vbox = gtk_vbox_new ( FALSE, 6 );
<a name="l00279"></a>00279     gtk_scrolled_window_add_with_viewport ( GTK_SCROLLED_WINDOW (scrolled_window),
<a name="l00280"></a>00280                                             vbox );
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     label = gtk_label_new ( NULL );
<a name="l00283"></a>00283     tmp_str = g_strconcat ( <a class="code" href="dialog_8c.html#a936cdb52ba9be8a56212e8a4e5979c3c">make_pango_attribut</a> (
<a name="l00284"></a>00284                         <span class="stringliteral">&quot;size=\&quot;larger\&quot; weight=\&quot;bold\&quot;&quot;</span>,_( test -&gt; <a class="code" href="structgsb__debug__test.html#a18bdf722e904d07735b2bbd18c200001">name</a> ) ),
<a name="l00285"></a>00285                         <span class="stringliteral">&quot;\n\n&quot;</span>, summary, NULL );
<a name="l00286"></a>00286     gtk_label_set_markup ( GTK_LABEL(label), tmp_str );
<a name="l00287"></a>00287     gtk_label_set_line_wrap ( GTK_LABEL(label), TRUE );
<a name="l00288"></a>00288     gtk_label_set_justify ( GTK_LABEL(label), GTK_JUSTIFY_LEFT );
<a name="l00289"></a>00289     gtk_misc_set_alignment (GTK_MISC (label), 0, 1);
<a name="l00290"></a>00290     g_free ( tmp_str );
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     gtk_box_pack_start ( GTK_BOX(vbox), label, FALSE, FALSE, 0 );
<a name="l00293"></a>00293     gtk_container_set_border_width ( GTK_CONTAINER(vbox), 12 );
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     <span class="keywordflow">if</span> ( test -&gt; <a class="code" href="structgsb__debug__test.html#a64cca62deab47075983d30232c5ffd66">instructions</a> )
<a name="l00296"></a>00296     {
<a name="l00297"></a>00297         GtkWidget * expander, * label;
<a name="l00298"></a>00298         gchar* tmpstr = g_strconcat ( <span class="stringliteral">&quot;&lt;b&gt;&quot;</span>,_(<span class="stringliteral">&quot;Details&quot;</span>), <span class="stringliteral">&quot;&lt;/b&gt;&quot;</span>, NULL );
<a name="l00299"></a>00299         expander = gtk_expander_new ( tmpstr );
<a name="l00300"></a>00300         g_free ( tmpstr );
<a name="l00301"></a>00301         gtk_expander_set_use_markup ( GTK_EXPANDER(expander), TRUE );
<a name="l00302"></a>00302         label = gtk_label_new ( NULL );
<a name="l00303"></a>00303         gtk_label_set_line_wrap ( GTK_LABEL(label), TRUE );
<a name="l00304"></a>00304         gtk_label_set_markup ( GTK_LABEL(label), _( test -&gt; <a class="code" href="structgsb__debug__test.html#a64cca62deab47075983d30232c5ffd66">instructions</a> ) );
<a name="l00305"></a>00305         gtk_misc_set_padding ( GTK_MISC(label), 12, 6 );
<a name="l00306"></a>00306         gtk_container_add ( GTK_CONTAINER(expander), label );
<a name="l00307"></a>00307         gtk_box_pack_start ( GTK_BOX(vbox), expander, FALSE, FALSE, 6 );
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="keywordflow">if</span> ( test -&gt; <a class="code" href="structgsb__debug__test.html#ab93d792e9ec4be45e4e01ea0d8f5fa59">fix</a> )
<a name="l00311"></a>00311     {
<a name="l00312"></a>00312         button = gtk_button_new_with_label ( _(<span class="stringliteral">&quot;Try to fix this inconsistency.&quot;</span>) );
<a name="l00313"></a>00313         gtk_box_pack_start ( GTK_BOX(vbox), button, FALSE, FALSE, 0 );
<a name="l00314"></a>00314         g_signal_connect_swapped ( G_OBJECT(button), <span class="stringliteral">&quot;clicked&quot;</span>, 
<a name="l00315"></a>00315                                    G_CALLBACK ( gsb_debug_try_fix ), 
<a name="l00316"></a>00316                                    (gpointer) test -&gt; <a class="code" href="structgsb__debug__test.html#ab93d792e9ec4be45e4e01ea0d8f5fa59">fix</a> );
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     gtk_widget_show_all ( scrolled_window );
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     <a class="code" href="gsb__assistant_8c.html#a6972bde2415e07b7afb35a062456f129">gsb_assistant_add_page</a> ( assistant, scrolled_window, page, page - 1, -1, NULL );
<a name="l00322"></a>00322     <a class="code" href="gsb__assistant_8c.html#a06ff0b5745a3a4bd14ceecbd56cd09c1">gsb_assistant_set_next</a> ( assistant, page - 1, page );
<a name="l00323"></a>00323     <a class="code" href="gsb__assistant_8c.html#af9667499ec49ad50593c8662801d4a9c">gsb_assistant_change_button_next</a> ( assistant, GTK_STOCK_GO_FORWARD, GTK_RESPONSE_YES );
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00333"></a>00333 gboolean gsb_debug_try_fix ( gboolean (* <a class="code" href="structgsb__debug__test.html#ab93d792e9ec4be45e4e01ea0d8f5fa59">fix</a>) () )
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="keywordflow">if</span> ( <a class="code" href="structgsb__debug__test.html#ab93d792e9ec4be45e4e01ea0d8f5fa59">fix</a> () )
<a name="l00337"></a>00337     {
<a name="l00338"></a>00338         <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a9d0fa9057da603e64a601d69d7bf2b51">modification_fichier</a> == 0 )
<a name="l00339"></a>00339         <a class="code" href="traitement__variables_8c.html#aa4084b9e508b1d1fea1d09c6b6208021">modification_fichier</a> ( TRUE );
<a name="l00340"></a>00340         <a class="code" href="dialog_8c.html#a1ae76010f96aab227a640333d3933277">dialogue_hint</a> ( _(<span class="stringliteral">&quot;Grisbi successfully repaired this account file.  &quot;</span>
<a name="l00341"></a>00341                           <span class="stringliteral">&quot;You may now save your modifications.&quot;</span>),
<a name="l00342"></a>00342                         _(<span class="stringliteral">&quot;Fix completed&quot;</span>));
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344     <span class="keywordflow">else</span>
<a name="l00345"></a>00345     {
<a name="l00346"></a>00346         <a class="code" href="dialog_8c.html#a194ffa6e8e89cc8fb7fbfbc41109fe1e">dialogue_error_hint</a> ( _(<span class="stringliteral">&quot;Grisbi was unable to repair this account file.  &quot;</span>
<a name="l00347"></a>00347                                 <span class="stringliteral">&quot;No modification has been done.&quot;</span>),
<a name="l00348"></a>00348                               _(<span class="stringliteral">&quot;Unable to fix account&quot;</span>));
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <span class="keywordflow">return</span> FALSE;
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">/******************************************************************************/</span>
<a name="l00357"></a>00357 <span class="comment">/* reconciliation_check.                                                      */</span>
<a name="l00358"></a>00358 <span class="comment">/* Cette fonction est appelée après la création de toutes les listes.         */</span>
<a name="l00359"></a>00359 <span class="comment">/* Elle permet de vérifier la cohérence des rapprochements suite à la         */</span>
<a name="l00360"></a>00360 <span class="comment">/* découverte des bogues #466 et #488.                                        */</span>
<a name="l00361"></a>00361 <span class="comment">/* return a newly allocated string or NULL.                                   */</span>
<a name="l00362"></a>00362 <span class="comment">/******************************************************************************/</span>
<a name="l00363"></a>00363 gchar * gsb_debug_reconcile_test ( <span class="keywordtype">void</span> )
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365     gint affected_accounts = 0;
<a name="l00366"></a>00366     gint tested_account = 0;
<a name="l00367"></a>00367     GSList *pUserAccountsList = NULL;
<a name="l00368"></a>00368     gchar *pText = g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00369"></a>00369         gchar* tmprealstr1;
<a name="l00370"></a>00370         gchar* tmprealstr2;
<a name="l00371"></a>00371         gchar* tmpstr1;
<a name="l00372"></a>00372         gchar* tmpstr2;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="comment">/* S&#39;il n&#39;y a pas de compte, on quitte */</span>
<a name="l00375"></a>00375     <span class="keywordflow">if</span> ( ! <a class="code" href="gsb__data__account_8c.html#a56c9a589563db8c15800e41378908b27">gsb_data_account_get_accounts_amount</a> ( ) )
<a name="l00376"></a>00376     {
<a name="l00377"></a>00377         g_free ( pText );
<a name="l00378"></a>00378         <span class="keywordflow">return</span> NULL;
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="comment">/* On fera la vérification des comptes dans l&#39;ordre préféré</span>
<a name="l00382"></a>00382 <span class="comment">       de l&#39;utilisateur. On fait une copie de la liste. */</span>
<a name="l00383"></a>00383     pUserAccountsList = g_slist_copy ( <a class="code" href="gsb__data__account_8c.html#aaf4d25733c7ea5a0ca263c0ab79e6212">gsb_data_account_get_list_accounts</a> ( ) );
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="comment">/* Pour chacun des comptes, faire */</span>
<a name="l00386"></a>00386     <span class="keywordflow">do</span>
<a name="l00387"></a>00387     {
<a name="l00388"></a>00388         gpointer p_account = pUserAccountsList -&gt; data;
<a name="l00389"></a>00389         gint account_nb = <a class="code" href="gsb__data__account_8c.html#ad61190b4638c2be7b7ce320470f1cb5a">gsb_data_account_get_no_account</a> ( p_account );
<a name="l00390"></a>00390         gint reconcile_number;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="comment">/* Si le compte a été rapproché au moins une fois.</span>
<a name="l00393"></a>00393 <span class="comment">        * Seule la date permet de l&#39;affirmer. */</span>
<a name="l00394"></a>00394         reconcile_number = <a class="code" href="gsb__data__reconcile_8c.html#a2ab9538da63a10bec22e1efe1cd3f19f">gsb_data_reconcile_get_account_last_number</a> (account_nb);
<a name="l00395"></a>00395         <span class="keywordflow">if</span> (reconcile_number)
<a name="l00396"></a>00396         {
<a name="l00397"></a>00397         GSList *pTransactionList;
<a name="l00398"></a>00398         <a class="code" href="structgsb__real.html">gsb_real</a> reconcilied_amount = null_real;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400         <span class="comment">/* On va recalculer le montant rapproché du compte (c-à-d le solde initial</span>
<a name="l00401"></a>00401 <span class="comment">             * plus le montant des opérations rapprochées) et le comparer à la valeur</span>
<a name="l00402"></a>00402 <span class="comment">             * stockée dans le fichier. Si les valeurs diffèrent, on affiche une boite</span>
<a name="l00403"></a>00403 <span class="comment">             * d&#39;avertissement */</span>
<a name="l00404"></a>00404       
<a name="l00405"></a>00405         reconcilied_amount = <a class="code" href="gsb__data__account_8c.html#aeef4070a2b411519cf998f79106b6c96">gsb_data_account_get_init_balance</a> ( account_nb, -1 );
<a name="l00406"></a>00406 
<a name="l00407"></a>00407         <span class="comment">/* On récupère la liste des opérations */</span>
<a name="l00408"></a>00408         pTransactionList = <a class="code" href="gsb__data__transaction_8c.html#aa54aeb205f29c2272154b2998fea490b">gsb_data_transaction_get_complete_transactions_list</a> ();;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <span class="keywordflow">while</span> ( pTransactionList )
<a name="l00411"></a>00411         {
<a name="l00412"></a>00412             gint transaction = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (
<a name="l00413"></a>00413                         pTransactionList -&gt; data );
<a name="l00414"></a>00414 
<a name="l00415"></a>00415             <span class="comment">/* On ne prend en compte que les opérations rapprochées.</span>
<a name="l00416"></a>00416 <span class="comment">             * On ne prend pas en compte les sous-opérations ventilées. </span>
<a name="l00417"></a>00417 <span class="comment">             * modification aportée pour tenir compte de la transformation ultérieure</span>
<a name="l00418"></a>00418 <span class="comment">             d&#39;une opération simple en opération ventilée et pour avoir une correspondance</span>
<a name="l00419"></a>00419 <span class="comment">             * entre le relevé et l&#39;edition de déboggage */</span>
<a name="l00420"></a>00420             <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (transaction) == account_nb
<a name="l00421"></a>00421             &amp;&amp;
<a name="l00422"></a>00422             (<a class="code" href="gsb__data__transaction_8c.html#a52cf9684818c3930c5c688b54f7cf393">gsb_data_transaction_get_marked_transaction</a> ( transaction ) == <a class="code" href="gsb__data__transaction_8h.html#a82f385a1c75ac98496b5c09a123bf521a41425f55add3a05ffc4c7aa366048fc9">OPERATION_RAPPROCHEE</a> )
<a name="l00423"></a>00423             &amp;&amp;
<a name="l00424"></a>00424             ! <a class="code" href="gsb__data__transaction_8c.html#a6018560ece7ab02e8d46bc9bdaffd607">gsb_data_transaction_get_mother_transaction_number</a> ( transaction ) )
<a name="l00425"></a>00425             {
<a name="l00426"></a>00426             reconcilied_amount = <a class="code" href="gsb__real_8c.html#a5a3e9b2189f43f10c28333b09179e335">gsb_real_add</a> ( reconcilied_amount,
<a name="l00427"></a>00427                                                       <a class="code" href="gsb__data__transaction_8c.html#a8f44da078801e109873c479399b72191">gsb_data_transaction_get_adjusted_amount_for_currency</a> ( transaction, 
<a name="l00428"></a>00428                                                                                                               <a class="code" href="gsb__data__account_8c.html#a9f8d132b988ca73a7061fca955f6bc2c">gsb_data_account_get_currency</a> (account_nb),
<a name="l00429"></a>00429                                                                                                               -1 ));
<a name="l00430"></a>00430             }
<a name="l00431"></a>00431             pTransactionList = pTransactionList -&gt; next;
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <span class="keywordflow">if</span> ( <a class="code" href="gsb__real_8c.html#ae727c3ee72397bb23657fb3571bcf4da">gsb_real_abs</a> ( <a class="code" href="gsb__real_8c.html#aa5a0cf079b0a5a0e47d7eaca164e0f25">gsb_real_sub</a> ( reconcilied_amount,
<a name="l00435"></a>00435                                              <a class="code" href="gsb__data__reconcile_8c.html#a261a4e1eacb9c6517df7daa4afa879bb">gsb_data_reconcile_get_final_balance</a> (reconcile_number))).mantissa &gt; 0 )
<a name="l00436"></a>00436         {
<a name="l00437"></a>00437             affected_accounts ++;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439             tmprealstr1 = <a class="code" href="gsb__real_8c.html#a03f4474a9a4269e384951af9be4acedd">gsb_real_get_string_with_currency</a> (
<a name="l00440"></a>00440                                         <a class="code" href="gsb__data__reconcile_8c.html#a261a4e1eacb9c6517df7daa4afa879bb">gsb_data_reconcile_get_final_balance</a> (reconcile_number),
<a name="l00441"></a>00441                                         <a class="code" href="gsb__data__account_8c.html#a9f8d132b988ca73a7061fca955f6bc2c">gsb_data_account_get_currency</a> ( account_nb ), TRUE  );
<a name="l00442"></a>00442             tmprealstr2 = <a class="code" href="gsb__real_8c.html#a03f4474a9a4269e384951af9be4acedd">gsb_real_get_string_with_currency</a> (reconcilied_amount,
<a name="l00443"></a>00443                                         <a class="code" href="gsb__data__account_8c.html#a9f8d132b988ca73a7061fca955f6bc2c">gsb_data_account_get_currency</a> ( account_nb ), TRUE  );
<a name="l00444"></a>00444             tmpstr1 = g_strdup_printf ( _(<span class="stringliteral">&quot;&lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;\n&quot;</span>
<a name="l00445"></a>00445                                         <span class="stringliteral">&quot;  Last reconciliation amount : %s\n&quot;</span>
<a name="l00446"></a>00446                                         <span class="stringliteral">&quot;  Computed reconciliation amount : %s\n&quot;</span>),
<a name="l00447"></a>00447                                         <a class="code" href="gsb__data__account_8c.html#a6b0df19868e38619bff512f2c18ef51e">gsb_data_account_get_name</a> ( account_nb ), 
<a name="l00448"></a>00448                                         tmprealstr1,
<a name="l00449"></a>00449                                         tmprealstr2 );
<a name="l00450"></a>00450             tmpstr2 = pText;
<a name="l00451"></a>00451             pText = g_strconcat ( tmpstr2, tmpstr1, NULL );
<a name="l00452"></a>00452             g_free ( tmpstr2 );
<a name="l00453"></a>00453             g_free ( tmpstr1 );
<a name="l00454"></a>00454             g_free ( tmprealstr1 );
<a name="l00455"></a>00455             g_free ( tmprealstr2 );
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457         tested_account++;
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459     }
<a name="l00460"></a>00460     <span class="keywordflow">while</span> ( (  pUserAccountsList = pUserAccountsList -&gt; next ) );
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     g_slist_free ( pUserAccountsList );
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <span class="keywordflow">if</span> ( affected_accounts )
<a name="l00465"></a>00465     {
<a name="l00466"></a>00466         pText [ strlen(pText) - 1 ] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00467"></a>00467         <span class="keywordflow">return</span> pText;
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <span class="keywordflow">return</span> NULL;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="comment">/******************************************************************************/</span>
<a name="l00476"></a>00476 <span class="comment">/* contra_transaction_check.                                                  */</span>
<a name="l00477"></a>00477 <span class="comment">/* Cette fonction est appelée après la création de toutes les listes.         */</span>
<a name="l00478"></a>00478 <span class="comment">/* Elle permet de vérifier la cohérence des virements entre comptes           */</span>
<a name="l00479"></a>00479 <span class="comment">/* suite à la découverte du bogue #542                                        */</span>
<a name="l00480"></a>00480 <span class="comment">/* return a newly allocated string or NULL                                    */</span>
<a name="l00481"></a>00481 <span class="comment">/******************************************************************************/</span>
<a name="l00482"></a>00482 gchar * gsb_debug_transfer_test ( <span class="keywordtype">void</span> )
<a name="l00483"></a>00483 {
<a name="l00484"></a>00484     gboolean corrupted_file = FALSE;
<a name="l00485"></a>00485     GSList * pUserAccountsList;
<a name="l00486"></a>00486     gchar * pText = g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00487"></a>00487         gchar* tmpstr;
<a name="l00488"></a>00488         gchar* oldstr;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     pUserAccountsList = <a class="code" href="gsb__data__account_8c.html#aaf4d25733c7ea5a0ca263c0ab79e6212">gsb_data_account_get_list_accounts</a> ();
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="keywordflow">do</span>
<a name="l00493"></a>00493     {
<a name="l00494"></a>00494     gboolean corrupted_account = FALSE;
<a name="l00495"></a>00495     GSList *pTransactionList;
<a name="l00496"></a>00496     gpointer p_account = pUserAccountsList -&gt; data;
<a name="l00497"></a>00497     gint account_nb = <a class="code" href="gsb__data__account_8c.html#ad61190b4638c2be7b7ce320470f1cb5a">gsb_data_account_get_no_account</a> ( p_account );
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     pTransactionList = <a class="code" href="gsb__data__transaction_8c.html#af781a71a62eece020188ef62847f2887">gsb_data_transaction_get_transactions_list</a> ();
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="keywordflow">while</span> ( pTransactionList )
<a name="l00502"></a>00502     {
<a name="l00503"></a>00503         gint transaction, transfer_transaction;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         transaction = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> ( pTransactionList -&gt; data );
<a name="l00506"></a>00506         transfer_transaction = <a class="code" href="gsb__data__transaction_8c.html#a4040925a3db49485b5a2b0a8ea19d2ee">gsb_data_transaction_get_contra_transaction_number</a> ( transaction );
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="comment">/* Si l&#39;opération est un virement vers un compte non supprimé */</span>
<a name="l00509"></a>00509         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> ( transaction ) == account_nb &amp;&amp;
<a name="l00510"></a>00510              transfer_transaction &gt; 0 )
<a name="l00511"></a>00511         {
<a name="l00512"></a>00512             <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> ( transfer_transaction ) !=
<a name="l00513"></a>00513                  <a class="code" href="gsb__data__transaction_8c.html#a655b6ad03fae3a20ff86adffc95a3ab3">gsb_data_transaction_get_contra_transaction_account</a> ( transaction ) )
<a name="l00514"></a>00514             {
<a name="l00515"></a>00515                 <span class="comment">/* S&#39;il n&#39;y avait pas eu encore d&#39;erreur dans ce compte,</span>
<a name="l00516"></a>00516 <span class="comment">                   on affiche son nom */</span>
<a name="l00517"></a>00517                 <span class="keywordflow">if</span> ( !corrupted_account ) {
<a name="l00518"></a>00518                     gchar* tmpstr = g_strdup_printf ( <span class="stringliteral">&quot;\n&lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;\n&quot;</span>,
<a name="l00519"></a>00519                                                             <a class="code" href="gsb__data__account_8c.html#a6b0df19868e38619bff512f2c18ef51e">gsb_data_account_get_name</a> ( account_nb ) );
<a name="l00520"></a>00520                     gchar* oldstr = pText;
<a name="l00521"></a>00521                     pText = g_strconcat ( pText, tmpstr, NULL );
<a name="l00522"></a>00522                     g_free ( oldstr );
<a name="l00523"></a>00523                     g_free ( tmpstr );
<a name="l00524"></a>00524                 }
<a name="l00525"></a>00525                 tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction #%d is linked to non existent transaction #%d.\n&quot;</span>),
<a name="l00526"></a>00526                                                         transaction, transfer_transaction );
<a name="l00527"></a>00527                 oldstr = pText;
<a name="l00528"></a>00528                 pText = g_strconcat ( pText , tmpstr, NULL );
<a name="l00529"></a>00529                 g_free ( oldstr );
<a name="l00530"></a>00530                 g_free ( tmpstr );
<a name="l00531"></a>00531                 corrupted_file = corrupted_account = TRUE;
<a name="l00532"></a>00532             }
<a name="l00533"></a>00533             <span class="keywordflow">else</span>
<a name="l00534"></a>00534             {
<a name="l00535"></a>00535                 <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a4040925a3db49485b5a2b0a8ea19d2ee">gsb_data_transaction_get_contra_transaction_number</a> ( transfer_transaction ) != transaction )
<a name="l00536"></a>00536                 {
<a name="l00537"></a>00537                     <span class="comment">/* S&#39;il n&#39;y avait pas eu encore d&#39;erreur dans ce compte,</span>
<a name="l00538"></a>00538 <span class="comment">                       on affiche son nom */</span>
<a name="l00539"></a>00539                     <span class="keywordflow">if</span> ( !corrupted_account ) {
<a name="l00540"></a>00540                         gchar* oldstr = pText;
<a name="l00541"></a>00541                         gchar* tmpstr = g_strdup_printf ( <span class="stringliteral">&quot;\n&lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;\n&quot;</span>,
<a name="l00542"></a>00542                                                                 <a class="code" href="gsb__data__account_8c.html#a6b0df19868e38619bff512f2c18ef51e">gsb_data_account_get_name</a> ( account_nb ) );
<a name="l00543"></a>00543                         pText = g_strconcat ( pText, tmpstr , NULL );
<a name="l00544"></a>00544                         g_free ( oldstr );
<a name="l00545"></a>00545                         g_free ( tmpstr );
<a name="l00546"></a>00546                     }
<a name="l00547"></a>00547                     oldstr = pText;
<a name="l00548"></a>00548                     tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction #%d is linked to transaction #%d, &quot;</span>
<a name="l00549"></a>00549                                                               <span class="stringliteral">&quot;which is linked to transaction #%d.\n&quot;</span>),
<a name="l00550"></a>00550                                                             transaction,
<a name="l00551"></a>00551                                                             transfer_transaction,
<a name="l00552"></a>00552                                                             <a class="code" href="gsb__data__transaction_8c.html#a4040925a3db49485b5a2b0a8ea19d2ee">gsb_data_transaction_get_contra_transaction_number</a> ( transfer_transaction ) );
<a name="l00553"></a>00553                     pText = g_strconcat ( pText , tmpstr , NULL );
<a name="l00554"></a>00554                     g_free ( oldstr );
<a name="l00555"></a>00555                     g_free ( tmpstr );
<a name="l00556"></a>00556                     corrupted_file = corrupted_account = TRUE;
<a name="l00557"></a>00557                 }
<a name="l00558"></a>00558             }
<a name="l00559"></a>00559         }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561         pTransactionList = pTransactionList -&gt; next;
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564     pUserAccountsList = pUserAccountsList -&gt; next;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567     <span class="keywordflow">while</span> ( pUserAccountsList );
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <span class="keywordflow">if</span> ( corrupted_file )
<a name="l00570"></a>00570     {
<a name="l00571"></a>00571         <span class="comment">/* Skip both last and first carriage return. */</span>
<a name="l00572"></a>00572         pText [ strlen(pText) - 1 ] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00573"></a>00573         printf ( <span class="stringliteral">&quot;%s\n&quot;</span>, pText);
<a name="l00574"></a>00574         <span class="keywordflow">return</span> pText + 1;
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="keywordflow">return</span> NULL;
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 
<a name="l00588"></a>00588 gchar *gsb_debug_category_test  ( <span class="keywordtype">void</span> )
<a name="l00589"></a>00589 {
<a name="l00590"></a>00590     GSList *tmp_list;
<a name="l00591"></a>00591     gchar *returned_text = g_strdup (<span class="stringliteral">&quot;&quot;</span>);       <span class="comment">/* !!! don&#39;t set here my_strdup else returned_text becomes NULL */</span>
<a name="l00592"></a>00592     gchar *tmpstr;
<a name="l00593"></a>00593     gchar *tmpstr1;
<a name="l00594"></a>00594     gboolean invalid = FALSE;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     tmp_list = <a class="code" href="gsb__data__transaction_8c.html#aa54aeb205f29c2272154b2998fea490b">gsb_data_transaction_get_complete_transactions_list</a> ();
<a name="l00597"></a>00597     <span class="keywordflow">while</span> (tmp_list)
<a name="l00598"></a>00598     {
<a name="l00599"></a>00599         gint transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (tmp_list -&gt; data);
<a name="l00600"></a>00600         gint category_number = <a class="code" href="gsb__data__transaction_8c.html#a5cdaf5e8911118bf8d1dbdfc42dc4761">gsb_data_transaction_get_category_number</a> (transaction_number);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__category_8c.html#a1ea1662771313b5e9800d380eed970d2">gsb_data_category_get_structure</a> (category_number))
<a name="l00603"></a>00603         {
<a name="l00604"></a>00604             <span class="comment">/* category found, check sub-category */</span>
<a name="l00605"></a>00605             gint sub_category_number = <a class="code" href="gsb__data__transaction_8c.html#a2e0ed6fbd584d4363d75e4b0155660b7">gsb_data_transaction_get_sub_category_number</a> (transaction_number);
<a name="l00606"></a>00606             <span class="keywordflow">if</span> (sub_category_number &amp;&amp;
<a name="l00607"></a>00607                 !<a class="code" href="gsb__data__category_8c.html#ab36a02b615d8b89789810a7f74f338cd">gsb_data_category_get_sub_category_structure</a> (category_number, sub_category_number))
<a name="l00608"></a>00608             {
<a name="l00609"></a>00609                 <span class="comment">/* sub-category not found */</span>
<a name="l00610"></a>00610                 tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction %d has category %d but invalid sub-category %d.\n&quot;</span>),
<a name="l00611"></a>00611                                            transaction_number, category_number, sub_category_number );
<a name="l00612"></a>00612                 tmpstr1 = g_strconcat ( returned_text,
<a name="l00613"></a>00613                                         tmpstr,
<a name="l00614"></a>00614                                         NULL );
<a name="l00615"></a>00615                 g_free (returned_text);
<a name="l00616"></a>00616                 g_free (tmpstr);
<a name="l00617"></a>00617                 returned_text = tmpstr1;
<a name="l00618"></a>00618                 invalid = TRUE;
<a name="l00619"></a>00619             }
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621         <span class="keywordflow">else</span>
<a name="l00622"></a>00622         {
<a name="l00623"></a>00623             <span class="comment">/* category not found */</span>
<a name="l00624"></a>00624             tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction %d has invalid category %d.\n&quot;</span>),
<a name="l00625"></a>00625                                        transaction_number, category_number );
<a name="l00626"></a>00626             tmpstr1 = g_strconcat ( returned_text,
<a name="l00627"></a>00627                                     tmpstr,
<a name="l00628"></a>00628                                     NULL );
<a name="l00629"></a>00629             g_free (returned_text);
<a name="l00630"></a>00630             g_free (tmpstr);
<a name="l00631"></a>00631             returned_text = tmpstr1;
<a name="l00632"></a>00632             invalid = TRUE;
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634         tmp_list = tmp_list -&gt; next;
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (invalid)
<a name="l00638"></a>00638         <span class="keywordflow">return</span> returned_text;
<a name="l00639"></a>00639     <span class="keywordflow">else</span>
<a name="l00640"></a>00640     {
<a name="l00641"></a>00641         g_free (returned_text);
<a name="l00642"></a>00642         <span class="keywordflow">return</span> NULL;
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00654"></a>00654 gboolean gsb_debug_category_test_fix ()
<a name="l00655"></a>00655 {
<a name="l00656"></a>00656     GSList *tmp_list;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     tmp_list = <a class="code" href="gsb__data__transaction_8c.html#aa54aeb205f29c2272154b2998fea490b">gsb_data_transaction_get_complete_transactions_list</a> ();
<a name="l00659"></a>00659     <span class="keywordflow">while</span> (tmp_list)
<a name="l00660"></a>00660     {
<a name="l00661"></a>00661         gint transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (tmp_list -&gt; data);
<a name="l00662"></a>00662         gint category_number = <a class="code" href="gsb__data__transaction_8c.html#a5cdaf5e8911118bf8d1dbdfc42dc4761">gsb_data_transaction_get_category_number</a> (transaction_number);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__category_8c.html#a1ea1662771313b5e9800d380eed970d2">gsb_data_category_get_structure</a> (category_number))
<a name="l00665"></a>00665         {
<a name="l00666"></a>00666             <span class="comment">/* category found, check sub-category */</span>
<a name="l00667"></a>00667             gint sub_category_number = <a class="code" href="gsb__data__transaction_8c.html#a2e0ed6fbd584d4363d75e4b0155660b7">gsb_data_transaction_get_sub_category_number</a> (transaction_number);
<a name="l00668"></a>00668             <span class="keywordflow">if</span> (sub_category_number &amp;&amp;
<a name="l00669"></a>00669                 !<a class="code" href="gsb__data__category_8c.html#ab36a02b615d8b89789810a7f74f338cd">gsb_data_category_get_sub_category_structure</a> (category_number, sub_category_number))
<a name="l00670"></a>00670                 <span class="comment">/* sub-category not found */</span>
<a name="l00671"></a>00671                 <a class="code" href="gsb__data__transaction_8c.html#a0a63ca7e6d34a226c6f0b8b339fbf518">gsb_data_transaction_set_sub_category_number</a> (transaction_number, 0);
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673         <span class="keywordflow">else</span>
<a name="l00674"></a>00674         {
<a name="l00675"></a>00675             <span class="comment">/* category not found */</span>
<a name="l00676"></a>00676             <a class="code" href="gsb__data__transaction_8c.html#a31f2706a543b988ba279b1cddb40c53e">gsb_data_transaction_set_category_number</a> (transaction_number, 0);
<a name="l00677"></a>00677             <a class="code" href="gsb__data__transaction_8c.html#a0a63ca7e6d34a226c6f0b8b339fbf518">gsb_data_transaction_set_sub_category_number</a> (transaction_number, 0);
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679         tmp_list = tmp_list -&gt; next;
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="keywordflow">return</span> TRUE;
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00692"></a>00692 gchar *gsb_debug_budget_test  ( <span class="keywordtype">void</span> )
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694     GSList *tmp_list;
<a name="l00695"></a>00695     gchar *returned_text = g_strdup (<span class="stringliteral">&quot;&quot;</span>);       <span class="comment">/* !!! don&#39;t set here my_strdup else returned_text becomes NULL */</span>
<a name="l00696"></a>00696     gchar *tmpstr;
<a name="l00697"></a>00697     gchar *tmpstr1;
<a name="l00698"></a>00698     gboolean invalid = FALSE;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     tmp_list = <a class="code" href="gsb__data__transaction_8c.html#aa54aeb205f29c2272154b2998fea490b">gsb_data_transaction_get_complete_transactions_list</a> ();
<a name="l00701"></a>00701     <span class="keywordflow">while</span> (tmp_list)
<a name="l00702"></a>00702     {
<a name="l00703"></a>00703         gint transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (tmp_list -&gt; data);
<a name="l00704"></a>00704         gint budget_number = <a class="code" href="gsb__data__transaction_8c.html#a4d84c55dbdfa032c500f4ade0754501f">gsb_data_transaction_get_budgetary_number</a> (transaction_number);
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__budget_8c.html#ace802eb38829d136f54f4f7b981a29c6">gsb_data_budget_get_structure</a> (budget_number))
<a name="l00707"></a>00707         {
<a name="l00708"></a>00708             <span class="comment">/* budget found, check sub-budget */</span>
<a name="l00709"></a>00709             gint sub_budget_number = <a class="code" href="gsb__data__transaction_8c.html#a44dbcf1f953a233d0038027289aa2372">gsb_data_transaction_get_sub_budgetary_number</a> (transaction_number);
<a name="l00710"></a>00710             <span class="keywordflow">if</span> (sub_budget_number &amp;&amp;
<a name="l00711"></a>00711                 !<a class="code" href="gsb__data__budget_8c.html#a6f2e832890d1351f46fa91d33e4d55d4">gsb_data_budget_get_sub_budget_structure</a> (budget_number, sub_budget_number))
<a name="l00712"></a>00712             {
<a name="l00713"></a>00713                 <span class="comment">/* sub-budget not found */</span>
<a name="l00714"></a>00714                 tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction %d has budget %d but invalid sub-budget %d.\n&quot;</span>),
<a name="l00715"></a>00715                                            transaction_number, budget_number, sub_budget_number );
<a name="l00716"></a>00716                 tmpstr1 = g_strconcat ( returned_text,
<a name="l00717"></a>00717                                         tmpstr,
<a name="l00718"></a>00718                                         NULL );
<a name="l00719"></a>00719                 g_free (returned_text);
<a name="l00720"></a>00720                 g_free (tmpstr);
<a name="l00721"></a>00721                 returned_text = tmpstr1;
<a name="l00722"></a>00722                 invalid = TRUE;
<a name="l00723"></a>00723             }
<a name="l00724"></a>00724         }
<a name="l00725"></a>00725         <span class="keywordflow">else</span>
<a name="l00726"></a>00726         {
<a name="l00727"></a>00727             <span class="comment">/* budget not found */</span>
<a name="l00728"></a>00728             tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction %d has invalid budget %d.\n&quot;</span>),
<a name="l00729"></a>00729                                        transaction_number, budget_number );
<a name="l00730"></a>00730             tmpstr1 = g_strconcat ( returned_text,
<a name="l00731"></a>00731                                     tmpstr,
<a name="l00732"></a>00732                                     NULL );
<a name="l00733"></a>00733             g_free (returned_text);
<a name="l00734"></a>00734             g_free (tmpstr);
<a name="l00735"></a>00735             returned_text = tmpstr1;
<a name="l00736"></a>00736             invalid = TRUE;
<a name="l00737"></a>00737         }
<a name="l00738"></a>00738         tmp_list = tmp_list -&gt; next;
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="keywordflow">if</span> (invalid)
<a name="l00742"></a>00742         <span class="keywordflow">return</span> returned_text;
<a name="l00743"></a>00743     <span class="keywordflow">else</span>
<a name="l00744"></a>00744     {
<a name="l00745"></a>00745         g_free (returned_text);
<a name="l00746"></a>00746         <span class="keywordflow">return</span> NULL;
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748     <span class="keywordflow">return</span> NULL;
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00759"></a>00759 gboolean gsb_debug_budget_test_fix ()
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761     GSList *tmp_list;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     tmp_list = <a class="code" href="gsb__data__transaction_8c.html#aa54aeb205f29c2272154b2998fea490b">gsb_data_transaction_get_complete_transactions_list</a> ();
<a name="l00764"></a>00764     <span class="keywordflow">while</span> (tmp_list)
<a name="l00765"></a>00765     {
<a name="l00766"></a>00766         gint transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (tmp_list -&gt; data);
<a name="l00767"></a>00767         gint budget_number = <a class="code" href="gsb__data__transaction_8c.html#a4d84c55dbdfa032c500f4ade0754501f">gsb_data_transaction_get_budgetary_number</a> (transaction_number);
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__budget_8c.html#ace802eb38829d136f54f4f7b981a29c6">gsb_data_budget_get_structure</a> (budget_number))
<a name="l00770"></a>00770         {
<a name="l00771"></a>00771             <span class="comment">/* budget found, check sub-budget */</span>
<a name="l00772"></a>00772             gint sub_budget_number = <a class="code" href="gsb__data__transaction_8c.html#a44dbcf1f953a233d0038027289aa2372">gsb_data_transaction_get_sub_budgetary_number</a> (transaction_number);
<a name="l00773"></a>00773             <span class="keywordflow">if</span> (sub_budget_number &amp;&amp;
<a name="l00774"></a>00774                 !<a class="code" href="gsb__data__budget_8c.html#a6f2e832890d1351f46fa91d33e4d55d4">gsb_data_budget_get_sub_budget_structure</a> (budget_number, sub_budget_number))
<a name="l00775"></a>00775                 <span class="comment">/* sub-budget not found */</span>
<a name="l00776"></a>00776                 <a class="code" href="gsb__data__transaction_8c.html#a5cdc1a654e5dbb278af9ad23828fe82d">gsb_data_transaction_set_budgetary_number</a> (transaction_number, 0);
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778         <span class="keywordflow">else</span>
<a name="l00779"></a>00779         {
<a name="l00780"></a>00780             <span class="comment">/* budget not found */</span>
<a name="l00781"></a>00781             <a class="code" href="gsb__data__transaction_8c.html#aae141d1ea0866286b7d86231862e2b0a">gsb_data_transaction_set_sub_budgetary_number</a> (transaction_number, 0);
<a name="l00782"></a>00782             <a class="code" href="gsb__data__transaction_8c.html#a5cdc1a654e5dbb278af9ad23828fe82d">gsb_data_transaction_set_budgetary_number</a> (transaction_number, 0);
<a name="l00783"></a>00783         }
<a name="l00784"></a>00784         tmp_list = tmp_list -&gt; next;
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786     <span class="keywordflow">return</span> TRUE;
<a name="l00787"></a>00787 }
<a name="l00788"></a>00788 
<a name="l00796"></a>00796 gchar *gsb_debug_payee_test  ( <span class="keywordtype">void</span> )
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798     GSList *tmp_list;
<a name="l00799"></a>00799     gchar *returned_text = g_strdup (<span class="stringliteral">&quot;&quot;</span>);       <span class="comment">/* !!! don&#39;t set here my_strdup else returned_text becomes NULL */</span>
<a name="l00800"></a>00800     gchar *tmpstr;
<a name="l00801"></a>00801     gchar *tmpstr1;
<a name="l00802"></a>00802     gboolean invalid = FALSE;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     tmp_list = <a class="code" href="gsb__data__transaction_8c.html#aa54aeb205f29c2272154b2998fea490b">gsb_data_transaction_get_complete_transactions_list</a> ();
<a name="l00805"></a>00805     <span class="keywordflow">while</span> (tmp_list)
<a name="l00806"></a>00806     {
<a name="l00807"></a>00807         gint transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (tmp_list -&gt; data);
<a name="l00808"></a>00808         gint payee_number = <a class="code" href="gsb__data__transaction_8c.html#afa032df45afa2ad7a4be48449a7e8d15">gsb_data_transaction_get_party_number</a> (transaction_number);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="keywordflow">if</span> ( !<a class="code" href="gsb__data__payee_8c.html#a6e682c7bfd8d88b7136512fe2679a24b">gsb_data_payee_get_structure</a> (payee_number))
<a name="l00811"></a>00811         {
<a name="l00812"></a>00812             <span class="comment">/* payee not found */</span>
<a name="l00813"></a>00813             tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction %d has invalid payee %d.\n&quot;</span>),
<a name="l00814"></a>00814                                        transaction_number, payee_number );
<a name="l00815"></a>00815             tmpstr1 = g_strconcat ( returned_text,
<a name="l00816"></a>00816                                     tmpstr,
<a name="l00817"></a>00817                                     NULL );
<a name="l00818"></a>00818             g_free (returned_text);
<a name="l00819"></a>00819             g_free (tmpstr);
<a name="l00820"></a>00820             returned_text = tmpstr1;
<a name="l00821"></a>00821             invalid = TRUE;
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823         tmp_list = tmp_list -&gt; next;
<a name="l00824"></a>00824     }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826     <span class="keywordflow">if</span> (invalid)
<a name="l00827"></a>00827         <span class="keywordflow">return</span> returned_text;
<a name="l00828"></a>00828     <span class="keywordflow">else</span>
<a name="l00829"></a>00829     {
<a name="l00830"></a>00830         g_free (returned_text);
<a name="l00831"></a>00831         <span class="keywordflow">return</span> NULL;
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833     <span class="keywordflow">return</span> NULL;
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 
<a name="l00844"></a>00844 gboolean gsb_debug_payee_test_fix ()
<a name="l00845"></a>00845 {
<a name="l00846"></a>00846     GSList *tmp_list;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     tmp_list = <a class="code" href="gsb__data__transaction_8c.html#aa54aeb205f29c2272154b2998fea490b">gsb_data_transaction_get_complete_transactions_list</a> ();
<a name="l00849"></a>00849     <span class="keywordflow">while</span> (tmp_list)
<a name="l00850"></a>00850     {
<a name="l00851"></a>00851         gint transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (tmp_list -&gt; data);
<a name="l00852"></a>00852         gint payee_number = <a class="code" href="gsb__data__transaction_8c.html#afa032df45afa2ad7a4be48449a7e8d15">gsb_data_transaction_get_party_number</a> (transaction_number);
<a name="l00853"></a>00853 
<a name="l00854"></a>00854         <span class="keywordflow">if</span> ( !<a class="code" href="gsb__data__payee_8c.html#a6e682c7bfd8d88b7136512fe2679a24b">gsb_data_payee_get_structure</a> (payee_number))
<a name="l00855"></a>00855             <a class="code" href="gsb__data__transaction_8c.html#ae334be534c1cfcc7dacf260008ee49f2">gsb_data_transaction_set_party_number</a> (transaction_number, 0);
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         tmp_list = tmp_list -&gt; next;
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     <span class="keywordflow">return</span> TRUE;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 <span class="comment">/* /\******************************************************************************\/ */</span>
<a name="l00864"></a>00864 <span class="comment">/* /\* financial_years_check.                                                     *\/ */</span>
<a name="l00865"></a>00865 <span class="comment">/* /\* Cette fonction est appelée après la création de toutes les listes          *\/ */</span>
<a name="l00866"></a>00866 <span class="comment">/* /\* Elle permet de vérifier la cohérence des exercices des opérations          *\/ */</span>
<a name="l00867"></a>00867 <span class="comment">/* /\* de ventilation avec l&#39;opération mère (Bogue #546).                         *\/ */</span>
<a name="l00868"></a>00868 <span class="comment">/* /\******************************************************************************\/ */</span>
<a name="l00869"></a>00869 <span class="comment">/* gboolean financial_years_check ( void ) */</span>
<a name="l00870"></a>00870 <span class="comment">/* { */</span>
<a name="l00871"></a>00871 <span class="comment">/*   gint affected_accounts = 0; */</span>
<a name="l00872"></a>00872 <span class="comment">/*   gboolean corrupted_file = FALSE; */</span>
<a name="l00873"></a>00873 <span class="comment">/*   GSList *pUserAccountsList = NULL; */</span>
<a name="l00874"></a>00874 <span class="comment">/*   gchar *pHint = NULL, *pText = &quot;&quot;; */</span>
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 <span class="comment">/*   /\* S&#39;il n&#39;y a pas de compte, on quitte *\/ */</span>
<a name="l00877"></a>00877 <span class="comment">/*   if ( !nb_comptes ) */</span>
<a name="l00878"></a>00878 <span class="comment">/*     return FALSE; */</span>
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 <span class="comment">/*   /\* Si on n&#39;utilise pas les exercices, on quitte *\/ */</span>
<a name="l00881"></a>00881 <span class="comment">/*   if ( !etat.utilise_exercice ) */</span>
<a name="l00882"></a>00882 <span class="comment">/*     return FALSE; */</span>
<a name="l00883"></a>00883     
<a name="l00884"></a>00884 <span class="comment">/*   /\* On fera la vérification des comptes dans l&#39;ordre préféré */</span>
<a name="l00885"></a>00885 <span class="comment">/*      de l&#39;utilisateur. On fait une copie de la liste. *\/ */</span>
<a name="l00886"></a>00886 <span class="comment">/*   pUserAccountsList = g_slist_copy ( ordre_comptes ); */</span>
<a name="l00887"></a>00887   
<a name="l00888"></a>00888 <span class="comment">/*   /\* Pour chacun des comptes, faire *\/ */</span>
<a name="l00889"></a>00889 <span class="comment">/*   do */</span>
<a name="l00890"></a>00890 <span class="comment">/*   { */</span>
<a name="l00891"></a>00891 <span class="comment">/*     gboolean corrupted_account = FALSE; */</span>
<a name="l00892"></a>00892 <span class="comment">/*     GSList *pTransactionList; */</span>
<a name="l00893"></a>00893 <span class="comment">/*     gchar *account_name = NULL; */</span>
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 <span class="comment">/*     p_tab_nom_de_compte_variable = p_tab_nom_de_compte + GPOINTER_TO_INT ( pUserAccountsList -&gt; data ); */</span>
<a name="l00896"></a>00896       
<a name="l00897"></a>00897 <span class="comment">/*     /\* On affiche le nom du compte testé. Si le compte n&#39;est pas affecté, */</span>
<a name="l00898"></a>00898 <span class="comment">/*        on libèrera la mémoire *\/ */</span>
<a name="l00899"></a>00899 <span class="comment">/*     account_name = g_strdup_printf (&quot;%s&quot;, NOM_DU_COMPTE); */</span>
<a name="l00900"></a>00900 
<a name="l00901"></a>00901 <span class="comment">/*     /\* On récupère la liste des opérations *\/ */</span>
<a name="l00902"></a>00902 <span class="comment">/*     pTransactionList = LISTE_OPERATIONS; */</span>
<a name="l00903"></a>00903 
<a name="l00904"></a>00904 <span class="comment">/*     while ( pTransactionList ) */</span>
<a name="l00905"></a>00905 <span class="comment">/*     { */</span>
<a name="l00906"></a>00906 <span class="comment">/*       struct structure_operation *pSplitTransaction; */</span>
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 <span class="comment">/*       pSplitTransaction = pTransactionList -&gt; data; */</span>
<a name="l00909"></a>00909 
<a name="l00910"></a>00910 <span class="comment">/*       /\* si c&#39;est une ventilation d&#39;opération et que cette ventilation a un exercice, */</span>
<a name="l00911"></a>00911 <span class="comment">/*          on va voir si l&#39;opération mère possède le même exercice *\/ */</span>
<a name="l00912"></a>00912 <span class="comment">/*       if ( pSplitTransaction -&gt; no_operation_ventilee_associee &amp;&amp; */</span>
<a name="l00913"></a>00913 <span class="comment">/*            pSplitTransaction -&gt; no_exercice ) */</span>
<a name="l00914"></a>00914 <span class="comment">/*       { */</span>
<a name="l00915"></a>00915 <span class="comment">/*      struct structure_operation *pTransaction; */</span>
<a name="l00916"></a>00916 
<a name="l00917"></a>00917 <span class="comment">/*      pTransaction = g_slist_find_custom ( LISTE_OPERATIONS, */</span>
<a name="l00918"></a>00918 <span class="comment">/*                                           GINT_TO_POINTER ( pSplitTransaction -&gt; no_operation_ventilee_associee ), */</span>
<a name="l00919"></a>00919 <span class="comment">/*                                           (GCompareFunc) recherche_operation_par_no ) -&gt; data; */</span>
<a name="l00920"></a>00920 <span class="comment">/*      if (!pTransaction) */</span>
<a name="l00921"></a>00921 <span class="comment">/*      { */</span>
<a name="l00922"></a>00922 <span class="comment">/*        /\* S&#39;il n&#39;y avait pas eu encore d&#39;erreur dans ce compte, */</span>
<a name="l00923"></a>00923 <span class="comment">/*           on affiche son nom *\/ */</span>
<a name="l00924"></a>00924 <span class="comment">/*        if ( !corrupted_account ) { */</span>
<a name="l00925"></a>00925 <span class="comment">/*          pText = g_strconcat ( pText, */</span>
<a name="l00926"></a>00926 <span class="comment">/*                                g_strdup_printf ( &quot;\n&lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;\n&quot;, */</span>
<a name="l00927"></a>00927 <span class="comment">/*                                                  account_name),  */</span>
<a name="l00928"></a>00928 <span class="comment">/*                                NULL ); */</span>
<a name="l00929"></a>00929 <span class="comment">/*        } */</span>
<a name="l00930"></a>00930 <span class="comment">/*        pText = g_strconcat ( pText, */</span>
<a name="l00931"></a>00931 <span class="comment">/*                              g_strdup_printf ( _(&quot;Split line #%d is orpheanous.\n&quot;), */</span>
<a name="l00932"></a>00932 <span class="comment">/*                                                pSplitTransaction -&gt; no_operation), */</span>
<a name="l00933"></a>00933 <span class="comment">/*                              NULL ); */</span>
<a name="l00934"></a>00934 <span class="comment">/*        corrupted_account = TRUE; */</span>
<a name="l00935"></a>00935 <span class="comment">/*      } */</span>
<a name="l00936"></a>00936 <span class="comment">/*      else */</span>
<a name="l00937"></a>00937 <span class="comment">/*      { */</span>
<a name="l00938"></a>00938 <span class="comment">/*        if( pTransaction -&gt; no_exercice != pSplitTransaction -&gt; no_exercice ) */</span>
<a name="l00939"></a>00939 <span class="comment">/*        { */</span>
<a name="l00940"></a>00940 <span class="comment">/*          /\* S&#39;il n&#39;y avait pas eu encore d&#39;erreur dans ce compte, */</span>
<a name="l00941"></a>00941 <span class="comment">/*             on affiche son nom *\/ */</span>
<a name="l00942"></a>00942 <span class="comment">/*          if ( !corrupted_account ) { */</span>
<a name="l00943"></a>00943 <span class="comment">/*            pText = g_strconcat ( pText, */</span>
<a name="l00944"></a>00944 <span class="comment">/*                                  g_strdup_printf ( &quot;\n&lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;\n&quot;, */</span>
<a name="l00945"></a>00945 <span class="comment">/*                                                  account_name),  */</span>
<a name="l00946"></a>00946 <span class="comment">/*                                  NULL ); */</span>
<a name="l00947"></a>00947 <span class="comment">/*          } */</span>
<a name="l00948"></a>00948 <span class="comment">/*          pText = g_strconcat ( pText, */</span>
<a name="l00949"></a>00949 <span class="comment">/*                                g_strdup_printf ( _(&quot;Transaction #%d has a financial year named %s and &quot; */</span>
<a name="l00950"></a>00950 <span class="comment">/*                                                    &quot;split line #%d of this transaction has a &quot; */</span>
<a name="l00951"></a>00951 <span class="comment">/*                                                    &quot;financial year named %s\n&quot;), */</span>
<a name="l00952"></a>00952 <span class="comment">/*                                                  pTransaction -&gt; no_operation, */</span>
<a name="l00953"></a>00953 <span class="comment">/*                                                  gsb_data_fyear_get_name ( pTransaction -&gt; no_exercice ), */</span>
<a name="l00954"></a>00954 <span class="comment">/*                                                  pSplitTransaction -&gt; no_operation, */</span>
<a name="l00955"></a>00955 <span class="comment">/*                                                  gsb_data_fyear_get_name ( pSplitTransaction -&gt; no_exercice ) ), */</span>
<a name="l00956"></a>00956 <span class="comment">/*                                NULL ); */</span>
<a name="l00957"></a>00957 <span class="comment">/*          corrupted_account = TRUE; */</span>
<a name="l00958"></a>00958 <span class="comment">/*        } */</span>
<a name="l00959"></a>00959 <span class="comment">/*      } */</span>
<a name="l00960"></a>00960       
<a name="l00961"></a>00961 <span class="comment">/*       } */</span>
<a name="l00962"></a>00962 <span class="comment">/*       pTransactionList = pTransactionList -&gt; next; */</span>
<a name="l00963"></a>00963 <span class="comment">/*     } */</span>
<a name="l00964"></a>00964 <span class="comment">/*     if ( corrupted_account ) { */</span>
<a name="l00965"></a>00965 <span class="comment">/*       corrupted_file = TRUE; */</span>
<a name="l00966"></a>00966 <span class="comment">/*       affected_accounts++; */</span>
<a name="l00967"></a>00967 <span class="comment">/*     } */</span>
<a name="l00968"></a>00968 <span class="comment">/*     g_free ( account_name ); */</span>
<a name="l00969"></a>00969 <span class="comment">/*   } */</span>
<a name="l00970"></a>00970 <span class="comment">/*   while ( ( pUserAccountsList = pUserAccountsList -&gt; next ) ); */</span>
<a name="l00971"></a>00971 
<a name="l00972"></a>00972 <span class="comment">/*   if ( affected_accounts ) */</span>
<a name="l00973"></a>00973 <span class="comment">/*   { */</span>
<a name="l00974"></a>00974 <span class="comment">/*     pText = g_strconcat ( _(&quot;Grisbi found split lines that have financial years different &quot; */</span>
<a name="l00975"></a>00975 <span class="comment">/*                          &quot;from the financial years of the related transaction.  Perhaps it isn&#39;t &quot; */</span>
<a name="l00976"></a>00976 <span class="comment">/*                          &quot;a problem, but perhaps it is.\n&quot; */</span>
<a name="l00977"></a>00977 <span class="comment">/*                          &quot;The following accounts seems inconsistent:\n&quot;),  */</span>
<a name="l00978"></a>00978 <span class="comment">/*                        pText, NULL ); */</span>
<a name="l00979"></a>00979 
<a name="l00980"></a>00980 <span class="comment">/*     if ( affected_accounts &gt; 1 ) */</span>
<a name="l00981"></a>00981 <span class="comment">/*     { */</span>
<a name="l00982"></a>00982 <span class="comment">/*       pHint = g_strdup_printf ( _(&quot;%d accounts have inconsistencies.&quot;),  */</span>
<a name="l00983"></a>00983 <span class="comment">/*                              affected_accounts ); */</span>
<a name="l00984"></a>00984 <span class="comment">/*     } */</span>
<a name="l00985"></a>00985 <span class="comment">/*     else */</span>
<a name="l00986"></a>00986 <span class="comment">/*     { */</span>
<a name="l00987"></a>00987 <span class="comment">/*       pHint = _(&quot;An account has inconsistencies.&quot;); */</span>
<a name="l00988"></a>00988 <span class="comment">/*     } */</span>
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 <span class="comment">/*     dialogue_warning_hint ( pText, pHint ); */</span>
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="comment">/*     g_free ( pText ); */</span>
<a name="l00993"></a>00993 <span class="comment">/*     g_free ( pHint ); */</span>
<a name="l00994"></a>00994 <span class="comment">/*   } */</span>
<a name="l00995"></a>00995 <span class="comment">/*   g_slist_free ( pUserAccountsList ); */</span>
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 <span class="comment">/*   return corrupted_file; */</span>
<a name="l00998"></a>00998 <span class="comment">/* } */</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 
<a name="l01002"></a>01002 <span class="comment">/* Local Variables: */</span>
<a name="l01003"></a>01003 <span class="comment">/* c-basic-offset: 4 */</span>
<a name="l01004"></a>01004 <span class="comment">/* End: */</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Généré le Sat Aug 7 22:12:02 2010 pour Grisbi par&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
