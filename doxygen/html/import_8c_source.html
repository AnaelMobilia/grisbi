<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Grisbi:  Fichier source de import.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Généré par Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Page&nbsp;principale</span></a></li>
      <li><a href="pages.html"><span>Pages&nbsp;associées</span></a></li>
      <li><a href="annotated.html"><span>Structures&nbsp;de&nbsp;données</span></a></li>
      <li class="current"><a href="files.html"><span>Fichiers</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>Liste&nbsp;des&nbsp;fichiers</span></a></li>
      <li><a href="globals.html"><span>Portée&nbsp;globale</span></a></li>
    </ul>
  </div>
<h1>import.c</h1><a href="import_8c.html">Aller à la documentation de ce fichier.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ************************************************************************** */</span>
<a name="l00002"></a>00002 <span class="comment">/*                                                                            */</span>
<a name="l00003"></a>00003 <span class="comment">/*     Copyright (C)    2000-2008 Cédric Auger (cedric@grisbi.org)            */</span>
<a name="l00004"></a>00004 <span class="comment">/*          2004-2008 Benjamin Drieu (bdrieu@april.org)                       */</span>
<a name="l00005"></a>00005 <span class="comment">/*                      2008-2009 Pierre Biava (grisbi@pierre.biava.name)     */</span>
<a name="l00006"></a>00006 <span class="comment">/*          http://www.grisbi.org                                             */</span>
<a name="l00007"></a>00007 <span class="comment">/*                                                                            */</span>
<a name="l00008"></a>00008 <span class="comment">/*  This program is free software; you can redistribute it and/or modify      */</span>
<a name="l00009"></a>00009 <span class="comment">/*  it under the terms of the GNU General Public License as published by      */</span>
<a name="l00010"></a>00010 <span class="comment">/*  the Free Software Foundation; either version 2 of the License, or         */</span>
<a name="l00011"></a>00011 <span class="comment">/*  (at your option) any later version.                                       */</span>
<a name="l00012"></a>00012 <span class="comment">/*                                                                            */</span>
<a name="l00013"></a>00013 <span class="comment">/*  This program is distributed in the hope that it will be useful,           */</span>
<a name="l00014"></a>00014 <span class="comment">/*  but WITHOUT ANY WARRANTY; without even the implied warranty of            */</span>
<a name="l00015"></a>00015 <span class="comment">/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             */</span>
<a name="l00016"></a>00016 <span class="comment">/*  GNU General Public License for more details.                              */</span>
<a name="l00017"></a>00017 <span class="comment">/*                                                                            */</span>
<a name="l00018"></a>00018 <span class="comment">/*  You should have received a copy of the GNU General Public License         */</span>
<a name="l00019"></a>00019 <span class="comment">/*  along with this program; if not, write to the Free Software               */</span>
<a name="l00020"></a>00020 <span class="comment">/*  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA */</span>
<a name="l00021"></a>00021 <span class="comment">/*                                                                            */</span>
<a name="l00022"></a>00022 <span class="comment">/* ************************************************************************** */</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="include_8h.html">include.h</a>&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="comment">/*START_INCLUDE*/</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="import_8h.html">import.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html">utils.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="bet__data_8h.html">bet_data.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="import__csv_8h.html">import_csv.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="dialog_8h.html">dialog.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="utils__file__selection_8h.html">utils_file_selection.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="go-charmap-sel_8h.html">go-charmap-sel.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="gsb__account_8h.html">gsb_account.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="gsb__account__property_8h.html">gsb_account_property.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="gsb__assistant_8h.html">gsb_assistant.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="gsb__assistant__file_8h.html">gsb_assistant_file.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="gsb__automem_8h.html">gsb_automem.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="utils__buttons_8h.html">utils_buttons.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="gsb__combo__box_8h.html">gsb_combo_box.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="gsb__currency__config_8h.html">gsb_currency_config.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="gsb__currency_8h.html">gsb_currency.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__account_8h.html">gsb_data_account.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__budget_8h.html">gsb_data_budget.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__category_8h.html">gsb_data_category.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__currency_8h.html">gsb_data_currency.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__form_8h.html">gsb_data_form.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__fyear_8h.html">gsb_data_fyear.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__import__rule_8h.html">gsb_data_import_rule.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__payee_8h.html">gsb_data_payee.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__payment_8h.html">gsb_data_payment.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__transaction_8h.html">gsb_data_transaction.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="utils__dates_8h.html">utils_dates.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="gsb__file_8h.html">gsb_file.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="gsb__file__util_8h.html">gsb_file_util.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="gsb__form__scheduler_8h.html">gsb_form_scheduler.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="gsb__form__transaction_8h.html">gsb_form_transaction.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="navigation_8h.html">navigation.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="menu_8h.html">menu.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="tiers__onglet_8h.html">tiers_onglet.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="gsb__real_8h.html">gsb_real.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="gsb__status_8h.html">gsb_status.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="utils__str_8h.html">utils_str.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="gsb__transactions__list_8h.html">gsb_transactions_list.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="gtk__combofix_8h.html">gtk_combofix.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="traitement__variables_8h.html">traitement_variables.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="main_8h.html">main.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="accueil_8h.html">accueil.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="parametres_8h.html">parametres.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="qif_8h.html">qif.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="transaction__list_8h.html">transaction_list.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="utils__files_8h.html">utils_files.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="structures_8h.html">structures.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="gsb__transactions__list_8h.html">gsb_transactions_list.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="go-charmap-sel_8h.html">go-charmap-sel.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__payment_8h.html">gsb_data_payment.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__account_8h.html">gsb_data_account.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="gtk__combofix_8h.html">gtk_combofix.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="include_8h.html">include.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="gsb__data__transaction_8h.html">gsb_data_transaction.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="gsb__form__scheduler_8h.html">gsb_form_scheduler.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="erreur_8h.html">erreur.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="comment">/*END_INCLUDE*/</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">/*START_STATIC*/</span>
<a name="l00087"></a>00087 <span class="keyword">static</span> gboolean affichage_recapitulatif_importation ( GtkWidget * assistant );
<a name="l00088"></a>00088 <span class="keyword">static</span> <span class="keyword">const</span> gchar * autodetect_file_type ( gchar * filename,
<a name="l00089"></a>00089                         gchar * pointeur_char );
<a name="l00090"></a>00090 <span class="keyword">static</span> gboolean changement_valeur_echelle_recherche_date_import ( GtkWidget *spin_button );
<a name="l00091"></a>00091 <span class="keyword">static</span> gboolean click_dialog_ope_orphelines ( GtkWidget *dialog,
<a name="l00092"></a>00092                         gint result,
<a name="l00093"></a>00093                         GtkWidget *liste_ope_celibataires );
<a name="l00094"></a>00094 <span class="keyword">static</span> gboolean click_sur_liste_opes_orphelines ( GtkCellRendererToggle *renderer,
<a name="l00095"></a>00095                         gchar *ligne,
<a name="l00096"></a>00096                         GtkTreeModel *store );
<a name="l00097"></a>00097 <span class="keyword">static</span> <span class="keywordtype">void</span> confirmation_enregistrement_ope_import ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account );
<a name="l00098"></a>00098 <span class="keyword">static</span> <span class="keywordtype">void</span> cree_liens_virements_ope_import ( <span class="keywordtype">void</span> );
<a name="l00099"></a>00099 <span class="keyword">static</span> GtkWidget *cree_ligne_recapitulatif ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * compte );
<a name="l00100"></a>00100 <span class="keyword">static</span> gint gsb_import_add_currency ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * compte );
<a name="l00101"></a>00101 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_add_imported_transactions ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account,
<a name="l00102"></a>00102                         gint account_number );
<a name="l00103"></a>00103 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_associations_add_assoc ( GtkWidget *button, GtkWidget *main_widget );
<a name="l00104"></a>00104 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_associations_cell_edited (GtkCellRendererText *cell,
<a name="l00105"></a>00105                         <span class="keyword">const</span> gchar *path_string,
<a name="l00106"></a>00106                         <span class="keyword">const</span> gchar *new_text,
<a name="l00107"></a>00107                         GObject * main_widget );
<a name="l00108"></a>00108 <span class="keyword">static</span> gboolean gsb_import_associations_check_add_button ( GObject * main_widget );
<a name="l00109"></a>00109 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_associations_combo_changed ( GtkEditable *editable,
<a name="l00110"></a>00110                         GObject * main_widget );
<a name="l00111"></a>00111 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_associations_del_assoc ( GtkWidget *button, GtkWidget *main_widget );
<a name="l00112"></a>00112 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_associations_fill_model ( GtkListStore *list_store );
<a name="l00113"></a>00113 <span class="keyword">static</span> gint gsb_import_associations_find_payee ( gchar *imported_tiers);
<a name="l00114"></a>00114 <span class="keyword">static</span> gboolean gsb_import_associations_select_func ( GtkTreeSelection *selection,
<a name="l00115"></a>00115                         GtkTreeModel *model,
<a name="l00116"></a>00116                         GtkTreePath *path,
<a name="l00117"></a>00117                         gboolean path_currently_selected,
<a name="l00118"></a>00118                         GObject *main_widget );
<a name="l00119"></a>00119 <span class="keyword">static</span> gchar **gsb_import_by_rule_ask_filename ( gint rule );
<a name="l00120"></a>00120 <span class="keyword">static</span> gboolean gsb_import_by_rule_get_file ( GtkWidget *button,
<a name="l00121"></a>00121                         GtkWidget *entry );
<a name="l00122"></a>00122 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_check_ope_import ( GtkWidget *widget, gpointer data );
<a name="l00123"></a>00123 <span class="keyword">static</span> gboolean gsb_import_check_transaction_link ( gint transaction_number,
<a name="l00124"></a>00124                         gint tested_transaction );
<a name="l00125"></a>00125 <span class="keyword">static</span> GSList *gsb_import_create_file_chooser ( <span class="keyword">const</span> <span class="keywordtype">char</span> *enc, GtkWidget *parent );
<a name="l00126"></a>00126 <span class="keyword">static</span> gint gsb_import_create_imported_account ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account );
<a name="l00127"></a>00127 <span class="keyword">static</span> gint gsb_import_create_transaction ( <span class="keyword">struct</span> <a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *imported_transaction,
<a name="l00128"></a>00128                         gint account_number, gchar * origine );
<a name="l00129"></a>00129 <span class="keyword">static</span> gboolean gsb_import_define_action ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account,
<a name="l00130"></a>00130                         gint account_number,
<a name="l00131"></a>00131                         GDate *first_date_import );
<a name="l00132"></a>00132 <span class="keyword">static</span> GDate *gsb_import_get_first_date ( GSList *import_list );
<a name="l00133"></a>00133 <span class="keyword">static</span> gboolean gsb_import_gunzip_file ( gchar *filename );
<a name="l00134"></a>00134 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_lookup_budget ( <span class="keyword">struct</span> <a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *imported_transaction,
<a name="l00135"></a>00135                         gint transaction_number);
<a name="l00136"></a>00136 <span class="keyword">static</span> gboolean gsb_import_ope_import_test_toggled ( GtkWidget *vbox , gboolean test );
<a name="l00137"></a>00137 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_ope_import_toggled ( GtkWidget *button, GtkWidget *vbox );
<a name="l00138"></a>00138 <span class="keyword">static</span> gboolean gsb_import_set_id_compte ( gint account_nb, gchar *imported_id );
<a name="l00139"></a>00139 <span class="keyword">static</span> gboolean gsb_import_set_tmp_file ( gchar *filename,
<a name="l00140"></a>00140                         gchar * pointeur_char );
<a name="l00141"></a>00141 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_show_orphan_transactions ( GSList *orphan_list );
<a name="l00142"></a>00142 <span class="keyword">static</span> gboolean import_account_action_activated ( GtkWidget * radio, gint action );
<a name="l00143"></a>00143 <span class="keyword">static</span> gboolean import_active_toggled ( GtkCellRendererToggle * cell, gchar *path_str,
<a name="l00144"></a>00144                         gpointer model );
<a name="l00145"></a>00145 <span class="keyword">static</span> GtkWidget *import_create_file_selection_page ( GtkWidget * assistant );
<a name="l00146"></a>00146 <span class="keyword">static</span> GtkWidget *import_create_final_page ( GtkWidget * assistant );
<a name="l00147"></a>00147 <span class="keyword">static</span> GtkWidget *import_create_resume_page ( GtkWidget * assistant );
<a name="l00148"></a>00148 <span class="keyword">static</span> gboolean import_enter_file_selection_page ( GtkWidget * assistant );
<a name="l00149"></a>00149 <span class="keyword">static</span> gboolean import_enter_resume_page ( GtkWidget * assistant );
<a name="l00150"></a>00150 <span class="keyword">static</span> <span class="keywordtype">void</span> import_preview_maybe_sensitive_next ( GtkWidget * assistant, GtkTreeModel * model );
<a name="l00151"></a>00151 <span class="keyword">static</span> gboolean import_select_file ( GtkWidget * button, GtkWidget * assistant );
<a name="l00152"></a>00152 <span class="keyword">static</span> gboolean import_switch_type ( GtkCellRendererText *cell, <span class="keyword">const</span> gchar *path,
<a name="l00153"></a>00153                         <span class="keyword">const</span> gchar *value, GtkListStore * model );
<a name="l00154"></a>00154 <span class="keyword">static</span> <span class="keywordtype">void</span> pointe_opes_importees ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account,
<a name="l00155"></a>00155                         gint account_number );
<a name="l00156"></a>00156 <span class="keyword">static</span> <span class="keywordtype">void</span> traitement_operations_importees ( <span class="keywordtype">void</span> );
<a name="l00157"></a>00157 <span class="comment">/*END_STATIC*/</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">/*START_EXTERN*/</span>
<a name="l00160"></a>00160 <span class="keyword">extern</span> GtkWidget *<a class="code" href="barre__outils_8c.html#ae624b78f586a9e3f5d60e6f2e2866819">menu_import_rules</a>;
<a name="l00161"></a>00161 <span class="keyword">extern</span> gint <a class="code" href="accueil_8c.html#a018917e8dacfd8fbe4e94d0f99a59c08">mise_a_jour_liste_comptes_accueil</a>;
<a name="l00162"></a>00162 <span class="keyword">extern</span> gint <a class="code" href="accueil_8c.html#afaffaedc4fd0ae8638f7158c6777b35b">mise_a_jour_soldes_minimaux</a>;
<a name="l00163"></a>00163 <span class="keyword">extern</span> gint <a class="code" href="categories__onglet_8c.html#a8f609654dcfbbcaa6791bcee83d6473d">no_devise_totaux_categ</a>;
<a name="l00164"></a>00164 <span class="keyword">extern</span> gint <a class="code" href="gsb__currency__config_8c.html#a2f4b5073521c582e1bc8941533026556">no_devise_totaux_ib</a>;
<a name="l00165"></a>00165 <span class="keyword">extern</span> gint <a class="code" href="gsb__currency__config_8c.html#a3add720d0e0b25caa37589bcfb879c6f">no_devise_totaux_tiers</a>;
<a name="l00166"></a>00166 <span class="keyword">extern</span> GtkWidget *<a class="code" href="accueil_8c.html#a3d346c08cf2d67c388caabffb412b293">window</a>;
<a name="l00167"></a>00167 <span class="comment">/*END_EXTERN*/</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment">/* recopie des types de transaction de la libofx en attendant une version propre */</span>
<a name="l00170"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173">00170</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l00171"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a55a44ce2b4561d75e1387d14bf4346e3">00171</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a55a44ce2b4561d75e1387d14bf4346e3">OFX_CREDIT</a>,     
<a name="l00172"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ab60c4a61836e4c9eddd43df98f58f25a">00172</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ab60c4a61836e4c9eddd43df98f58f25a">OFX_DEBIT</a>,      
<a name="l00173"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a6c561a0df9837463a7badde944a6c6ce">00173</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a6c561a0df9837463a7badde944a6c6ce">OFX_INT</a>,        
<a name="l00174"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173adbf02dcc7c9b4bb5de5e0126127ec482">00174</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173adbf02dcc7c9b4bb5de5e0126127ec482">OFX_DIV</a>,        
<a name="l00175"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ad0b1678dd27d1caa1e0464b471b49d5b">00175</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ad0b1678dd27d1caa1e0464b471b49d5b">OFX_FEE</a>,        
<a name="l00176"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a94c350d04bb151bc7af01285f8564ff2">00176</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a94c350d04bb151bc7af01285f8564ff2">OFX_SRVCHG</a>,     
<a name="l00177"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ad47566169d26dcbd4effe5bee0a5e02d">00177</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ad47566169d26dcbd4effe5bee0a5e02d">OFX_DEP</a>,        
<a name="l00178"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a64b99c67932f371b0793f91786dfcbce">00178</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a64b99c67932f371b0793f91786dfcbce">OFX_ATM</a>,        
<a name="l00179"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a15566db98285da8aa8c4f3b7b9fabc6e">00179</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a15566db98285da8aa8c4f3b7b9fabc6e">OFX_POS</a>,        
<a name="l00180"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a0cacbc14384739342490f0ee8662e4b6">00180</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a0cacbc14384739342490f0ee8662e4b6">OFX_XFER</a>,       
<a name="l00181"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a791ae71426db867d29e0ce41fe8f4d02">00181</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a791ae71426db867d29e0ce41fe8f4d02">OFX_CHECK</a>,      
<a name="l00182"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a44e13043cd858cc10e0d298c21373ce3">00182</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a44e13043cd858cc10e0d298c21373ce3">OFX_PAYMENT</a>,    
<a name="l00183"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a4bef7088f38bcefd900bacc7956f969a">00183</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a4bef7088f38bcefd900bacc7956f969a">OFX_CASH</a>,       
<a name="l00184"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a1eec1a02b6945ca4ab70e79c617b97ed">00184</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a1eec1a02b6945ca4ab70e79c617b97ed">OFX_DIRECTDEP</a>,  
<a name="l00185"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ac66a49bd7d3e0e14a88c2ea30941efef">00185</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ac66a49bd7d3e0e14a88c2ea30941efef">OFX_DIRECTDEBIT</a>,
<a name="l00186"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173af2b3f6d44dd25fd77be05880ec2a4edf">00186</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173af2b3f6d44dd25fd77be05880ec2a4edf">OFX_REPEATPMT</a>,  
<a name="l00187"></a><a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a67e1508a2089ea04720e582036f45101">00187</a>     <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a67e1508a2089ea04720e582036f45101">OFX_OTHER</a>       
<a name="l00188"></a>00188   } <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173">OFXTransactionType</a>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 
<a name="l00192"></a>00192 <span class="keyword">static</span> GSList * import_formats = NULL;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="comment">/* set to TRUE if we import some marked R transactions</span>
<a name="l00195"></a>00195 <span class="comment"> * grisbi cannot associate them to a reconcile number, so if TRUE,</span>
<a name="l00196"></a>00196 <span class="comment"> * grisbi will show a dialog to tell people to manually associate them */</span>
<a name="l00197"></a>00197 <span class="keyword">static</span> gboolean marked_r_transactions_imported;
<a name="l00198"></a>00198 
<a name="l00200"></a><a class="code" href="import_8c.html#ad6a70f4778cc786375179b149bc44b24">00200</a> <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> <a class="code" href="import_8c.html#ad6a70f4778cc786375179b149bc44b24">builtin_formats</a>[] = {
<a name="l00201"></a>00201 { <span class="stringliteral">&quot;CSV&quot;</span>, N_(<span class="stringliteral">&quot;Comma Separated Values&quot;</span>),     <span class="stringliteral">&quot;csv&quot;</span>, (<a class="code" href="import_8h.html#ae5eefe8d2e5aee94dc314801a7faaf15">import_function</a>) <a class="code" href="import__csv_8c.html#ae91b90112538a2ac7605b2843715e3d3">csv_import_csv_account</a> },
<a name="l00202"></a>00202 { <span class="stringliteral">&quot;QIF&quot;</span>, N_(<span class="stringliteral">&quot;Quicken Interchange Format&quot;</span>), <span class="stringliteral">&quot;qif&quot;</span>, (<a class="code" href="import_8h.html#ae5eefe8d2e5aee94dc314801a7faaf15">import_function</a>) <a class="code" href="qif_8c.html#a73e30ab82ed579859c5b35895252f1ff" title="Import QIF data.">recuperation_donnees_qif</a> },
<a name="l00203"></a>00203 { NULL,  NULL,              NULL,       NULL },
<a name="l00204"></a>00204 };
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 
<a name="l00208"></a>00208 <span class="keyword">static</span> gint mother_transaction_number;
<a name="l00209"></a><a class="code" href="traitement__variables_8c.html#abd82865835fd6c5fcfe97283dbfd0648">00209</a> gint <a class="code" href="bet__tab_8c.html#abd82865835fd6c5fcfe97283dbfd0648">valeur_echelle_recherche_date_import</a>;
<a name="l00210"></a><a class="code" href="qif_8c.html#a78273b1077a17a5b03056ffebb17a140">00210</a> GSList *<a class="code" href="import_8c.html#a78273b1077a17a5b03056ffebb17a140">liste_comptes_importes</a>;
<a name="l00211"></a><a class="code" href="qif_8c.html#a6e161f53c7a853cfac180c82953b5111">00211</a> GSList *<a class="code" href="import_8c.html#a6e161f53c7a853cfac180c82953b5111">liste_comptes_importes_error</a>;
<a name="l00212"></a>00212 <span class="keyword">static</span> gint virements_a_chercher;
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="utils__files_8c.html#ab4dbd4be47f9c5648daab02c47ff90e6">00214</a> gchar *<a class="code" href="import_8c.html#ab4dbd4be47f9c5648daab02c47ff90e6">charmap_imported</a>;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="comment">/* gestion des associations entre un tiers et sa chaine de recherche */</span>
<a name="l00217"></a><a class="code" href="tiers__onglet_8c.html#a8521224403aeb524822a05746e899bcf">00217</a> GSList *<a class="code" href="import_8c.html#a8521224403aeb524822a05746e899bcf">liste_associations_tiers</a> = NULL;
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012a">00220</a> <span class="keyword">enum</span> <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012a">import_filesel_columns</a> {
<a name="l00221"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">00221</a>     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">IMPORT_FILESEL_SELECTED</a> = 0,
<a name="l00222"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aae4a6bbea8769df27656c23cce1659f4a">00222</a>     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aae4a6bbea8769df27656c23cce1659f4a">IMPORT_FILESEL_TYPENAME</a>,
<a name="l00223"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaaf0ce41c0b5c0fe4497b35308c90f94">00223</a>     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaaf0ce41c0b5c0fe4497b35308c90f94">IMPORT_FILESEL_FILENAME</a>,
<a name="l00224"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaad6483753cacb80277975fa466178fc">00224</a>     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaad6483753cacb80277975fa466178fc">IMPORT_FILESEL_REALNAME</a>,
<a name="l00225"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa5f35d70ce904f5ab9e49a78479fb779d">00225</a>     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa5f35d70ce904f5ab9e49a78479fb779d">IMPORT_FILESEL_TYPE</a>,
<a name="l00226"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aac4bc8a9798d9e74e696dc9ee632a4305">00226</a>     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aac4bc8a9798d9e74e696dc9ee632a4305">IMPORT_FILESEL_CODING</a>,
<a name="l00227"></a><a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaf470dcc802d3c36b71d8179922f9014c">00227</a>     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaf470dcc802d3c36b71d8179922f9014c">IMPORT_FILESEL_NUM_COLS</a>,
<a name="l00228"></a>00228 };
<a name="l00229"></a>00229 
<a name="l00231"></a><a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1">00231</a> <span class="keyword">enum</span> <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1">import_pages</a> {
<a name="l00232"></a><a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1aebdb3a554248367f00671fc0a0ebeadb">00232</a>     <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1aebdb3a554248367f00671fc0a0ebeadb">IMPORT_STARTUP_PAGE</a>,
<a name="l00233"></a><a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1a79e8d557aae1b5cc0a66044e2e77cabe">00233</a>     <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1a79e8d557aae1b5cc0a66044e2e77cabe">IMPORT_FILESEL_PAGE</a>,
<a name="l00234"></a><a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad9799f3a9f6875fb71a002d741a0cb21">00234</a>     <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad9799f3a9f6875fb71a002d741a0cb21">IMPORT_CSV_PAGE</a>,
<a name="l00235"></a><a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ae3b9800771a2fbffc2d472c7a3095a0f">00235</a>     <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ae3b9800771a2fbffc2d472c7a3095a0f">IMPORT_RESUME_PAGE</a>,
<a name="l00236"></a><a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad7f5183fac1b068b43870a3ba511e2cb">00236</a>     <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad7f5183fac1b068b43870a3ba511e2cb">IMPORT_FIRST_ACCOUNT_PAGE</a>,
<a name="l00237"></a>00237 };
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 
<a name="l00244"></a><a class="code" href="import_8h.html#a24f0a83e63a5c81379d5971d41256324">00244</a> <span class="keywordtype">void</span> <a class="code" href="import_8c.html#a24f0a83e63a5c81379d5971d41256324">register_import_formats</a> ()
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     gint i;
<a name="l00247"></a>00247     <span class="keywordflow">for</span> ( i = 0; builtin_formats [ i ] . <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a> != NULL ; i ++ )
<a name="l00248"></a>00248     {
<a name="l00249"></a>00249     <a class="code" href="import_8c.html#a363697c684d8b70752d14c4a6eef0f73">register_import_format</a> ( &amp;builtin_formats [ i ] );
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 
<a name="l00262"></a><a class="code" href="import_8h.html#a363697c684d8b70752d14c4a6eef0f73">00262</a> G_MODULE_EXPORT <span class="keywordtype">void</span> <a class="code" href="import_8c.html#a363697c684d8b70752d14c4a6eef0f73">register_import_format</a> ( <span class="keyword">struct</span> <a class="code" href="structimport__format.html">import_format</a> * format )
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264     gchar* tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Adding &#39;%s&#39; as an import format&quot;</span>), format -&gt; <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a> );
<a name="l00265"></a>00265     <a class="code" href="erreur_8h.html#a17bfffc4306bc76edd79e060a8947dc4">devel_debug</a> ( tmpstr );
<a name="l00266"></a>00266     g_free ( tmpstr );
<a name="l00267"></a>00267     import_formats = g_slist_append ( import_formats, format );
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 
<a name="l00277"></a><a class="code" href="import_8h.html#a109c976310f1373efb8fdb52b3ee4263">00277</a> <span class="keywordtype">void</span> <a class="code" href="import_8c.html#a109c976310f1373efb8fdb52b3ee4263">importer_fichier</a> ( <span class="keywordtype">void</span> )
<a name="l00278"></a>00278 {
<a name="l00279"></a>00279     GSList * tmp = import_formats;
<a name="l00280"></a>00280     gchar * formats = g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00281"></a>00281     GtkWidget * assistant;
<a name="l00282"></a>00282         gchar* tmpstr;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284     <span class="comment">/* if nothing opened, we need to create a new file to set up all the variables */</span>
<a name="l00285"></a>00285     <span class="keywordflow">if</span> (!<a class="code" href="gsb__data__currency_8c.html#a147d01fc4583c3c4c34189cff9611db1">gsb_data_currency_get_currency_list</a> ())
<a name="l00286"></a>00286     {
<a name="l00287"></a>00287     <a class="code" href="traitement__variables_8c.html#a2977fbd2f72d5a8a5da608f804bd2a6f">init_variables</a> ();
<a name="l00288"></a>00288     <a class="code" href="gsb__assistant__file_8c.html#aae9dc6c606124740c2518604c2b77685">gsb_assistant_file_run</a> (FALSE, TRUE);
<a name="l00289"></a>00289     <span class="keywordflow">return</span>;
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     liste_comptes_importes = NULL;
<a name="l00293"></a>00293     liste_comptes_importes_error = NULL;
<a name="l00294"></a>00294     virements_a_chercher = 0;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="keywordflow">while</span> ( tmp )
<a name="l00297"></a>00297     {
<a name="l00298"></a>00298     <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> * format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l00299"></a>00299     gchar* old_str = formats;
<a name="l00300"></a>00300     formats = g_strconcat ( formats,
<a name="l00301"></a>00301                         <span class="stringliteral">&quot;       • &quot;</span>,
<a name="l00302"></a>00302                         _(format -&gt; <a class="code" href="structimport__format.html#ad56aa46c179fd48f77dfdd535aa2e734">complete_name</a>),
<a name="l00303"></a>00303                         <span class="stringliteral">&quot; (&quot;</span>, format -&gt; <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a>, <span class="stringliteral">&quot;)\n&quot;</span>,
<a name="l00304"></a>00304                         NULL );
<a name="l00305"></a>00305     g_free ( old_str );
<a name="l00306"></a>00306     tmp = tmp -&gt; next;
<a name="l00307"></a>00307     }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     tmpstr = g_strconcat ( _(<span class="stringliteral">&quot;This assistant will help you import one or several &quot;</span>
<a name="l00310"></a>00310                     <span class="stringliteral">&quot;files into Grisbi.&quot;</span>
<a name="l00311"></a>00311                     <span class="stringliteral">&quot;\n\n&quot;</span>
<a name="l00312"></a>00312                     <span class="stringliteral">&quot;Grisbi will try to do its best to guess which format are imported, &quot;</span>
<a name="l00313"></a>00313                     <span class="stringliteral">&quot;but you may have to manually set them in the list of next page.  &quot;</span>
<a name="l00314"></a>00314                     <span class="stringliteral">&quot;So far, the following formats are supported:&quot;</span>
<a name="l00315"></a>00315                     <span class="stringliteral">&quot;\n\n&quot;</span>),
<a name="l00316"></a>00316                     formats, NULL );
<a name="l00317"></a>00317     assistant = <a class="code" href="gsb__assistant_8c.html#a8502128771d8c3f3e8c83d877e1f20ea">gsb_assistant_new</a> ( _(<span class="stringliteral">&quot;Importing transactions into Grisbi&quot;</span>),
<a name="l00318"></a>00318                         tmpstr,
<a name="l00319"></a>00319                         <span class="stringliteral">&quot;impexp.png&quot;</span>,
<a name="l00320"></a>00320                         NULL );
<a name="l00321"></a>00321     g_free (formats);
<a name="l00322"></a>00322     g_free (tmpstr);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <a class="code" href="gsb__assistant_8c.html#a6972bde2415e07b7afb35a062456f129">gsb_assistant_add_page</a> ( assistant,
<a name="l00325"></a>00325                         import_create_file_selection_page ( assistant ),
<a name="l00326"></a>00326                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1a79e8d557aae1b5cc0a66044e2e77cabe">IMPORT_FILESEL_PAGE</a>,
<a name="l00327"></a>00327                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1aebdb3a554248367f00671fc0a0ebeadb">IMPORT_STARTUP_PAGE</a>,
<a name="l00328"></a>00328                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ae3b9800771a2fbffc2d472c7a3095a0f">IMPORT_RESUME_PAGE</a>,
<a name="l00329"></a>00329                         G_CALLBACK ( import_enter_file_selection_page ) );
<a name="l00330"></a>00330     <a class="code" href="gsb__assistant_8c.html#a6972bde2415e07b7afb35a062456f129">gsb_assistant_add_page</a> ( assistant,
<a name="l00331"></a>00331                         <a class="code" href="import__csv_8c.html#a4539af86cc658258c77621c5e2473d29">import_create_csv_preview_page</a> ( assistant ),
<a name="l00332"></a>00332                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad9799f3a9f6875fb71a002d741a0cb21">IMPORT_CSV_PAGE</a>,
<a name="l00333"></a>00333                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1a79e8d557aae1b5cc0a66044e2e77cabe">IMPORT_FILESEL_PAGE</a>,
<a name="l00334"></a>00334                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ae3b9800771a2fbffc2d472c7a3095a0f">IMPORT_RESUME_PAGE</a>,
<a name="l00335"></a>00335                         G_CALLBACK ( <a class="code" href="import__csv_8c.html#afa61668796ba48ba9a3df231034349ca">import_enter_csv_preview_page</a> ) );
<a name="l00336"></a>00336     <a class="code" href="gsb__assistant_8c.html#a6972bde2415e07b7afb35a062456f129">gsb_assistant_add_page</a> ( assistant,
<a name="l00337"></a>00337                         import_create_resume_page ( assistant ),
<a name="l00338"></a>00338                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ae3b9800771a2fbffc2d472c7a3095a0f">IMPORT_RESUME_PAGE</a>,
<a name="l00339"></a>00339                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1a79e8d557aae1b5cc0a66044e2e77cabe">IMPORT_FILESEL_PAGE</a>,
<a name="l00340"></a>00340                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad7f5183fac1b068b43870a3ba511e2cb">IMPORT_FIRST_ACCOUNT_PAGE</a>,
<a name="l00341"></a>00341                         G_CALLBACK ( import_enter_resume_page ) );
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">if</span> ( <a class="code" href="gsb__assistant_8c.html#a886a6fa8c458d71d7cfae7b54bd3187f">gsb_assistant_run</a> ( assistant ) == GTK_RESPONSE_APPLY )
<a name="l00344"></a>00344     {
<a name="l00345"></a>00345     <a class="code" href="gsb__status_8c.html#a16da6eed5923c59ba4584c96af26ff41">gsb_status_wait</a> ( TRUE );
<a name="l00346"></a>00346     traitement_operations_importees ();
<a name="l00347"></a>00347     gtk_widget_destroy ( assistant );
<a name="l00348"></a>00348     <a class="code" href="gsb__status_8c.html#ac4035c7e810531f0bf1264ae3be76c52">gsb_status_stop_wait</a> ( TRUE );
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350     <span class="keywordflow">else</span>
<a name="l00351"></a>00351     {
<a name="l00352"></a>00352     gtk_widget_destroy ( assistant );
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 
<a name="l00357"></a>00357 
<a name="l00363"></a>00363 GtkWidget *import_create_file_selection_page ( GtkWidget * assistant )
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365     GtkWidget * vbox, * paddingbox, * chooser, * tree_view, * sw;
<a name="l00366"></a>00366     GtkTreeViewColumn *column;
<a name="l00367"></a>00367     GtkCellRenderer *renderer;
<a name="l00368"></a>00368     GtkTreeModel * model, * list_acc;
<a name="l00369"></a>00369     GSList * tmp;
<a name="l00370"></a>00370         gchar* tmpstr;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     vbox = gtk_vbox_new ( FALSE, 6 );
<a name="l00373"></a>00373     gtk_container_set_border_width ( GTK_CONTAINER(vbox), 12 );
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     paddingbox = <a class="code" href="utils_8c.html#a22ba81fcf046b5bec6cf6d55d440abc5">new_paddingbox_with_title</a> ( vbox, TRUE, _(<span class="stringliteral">&quot;Choose file to import&quot;</span>));
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     chooser = gtk_button_new_with_label ( _(<span class="stringliteral">&quot;Add file to import...&quot;</span> ));
<a name="l00378"></a>00378     tmpstr = g_build_filename ( PIXMAPS_DIR, <span class="stringliteral">&quot;import.png&quot;</span>, NULL );
<a name="l00379"></a>00379     gtk_button_set_image ( GTK_BUTTON(chooser),
<a name="l00380"></a>00380                         gtk_image_new_from_file ( tmpstr ) );
<a name="l00381"></a>00381     g_free ( tmpstr );
<a name="l00382"></a>00382     gtk_box_pack_start ( GTK_BOX(paddingbox), chooser, FALSE, FALSE, 6 );
<a name="l00383"></a>00383     g_signal_connect ( G_OBJECT ( chooser ), <span class="stringliteral">&quot;clicked&quot;</span>, G_CALLBACK ( import_select_file ),
<a name="l00384"></a>00384                         assistant );
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="comment">/* Scroll for tree view. */</span>
<a name="l00387"></a>00387     sw = gtk_scrolled_window_new (NULL, NULL);
<a name="l00388"></a>00388     gtk_widget_set_size_request ( sw, 480, 120 );
<a name="l00389"></a>00389     gtk_scrolled_window_set_shadow_type (GTK_SCROLLED_WINDOW (sw), GTK_SHADOW_ETCHED_IN);
<a name="l00390"></a>00390     gtk_scrolled_window_set_policy (GTK_SCROLLED_WINDOW (sw), GTK_POLICY_AUTOMATIC,
<a name="l00391"></a>00391                         GTK_POLICY_AUTOMATIC);
<a name="l00392"></a>00392     gtk_box_pack_start ( GTK_BOX(paddingbox), sw, TRUE, TRUE, 6 );
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="comment">/* Tree view and model. */</span>
<a name="l00395"></a>00395     model = GTK_TREE_MODEL ( gtk_tree_store_new ( <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaf470dcc802d3c36b71d8179922f9014c">IMPORT_FILESEL_NUM_COLS</a>, G_TYPE_BOOLEAN,
<a name="l00396"></a>00396                         G_TYPE_STRING, G_TYPE_STRING,
<a name="l00397"></a>00397                         G_TYPE_STRING, G_TYPE_STRING, G_TYPE_STRING));
<a name="l00398"></a>00398     tree_view = gtk_tree_view_new_with_model ( GTK_TREE_MODEL ( model ) );
<a name="l00399"></a>00399     gtk_container_add ( GTK_CONTAINER ( sw ), tree_view );
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">/* Toggle column. */</span>
<a name="l00402"></a>00402     renderer = gtk_cell_renderer_toggle_new ();
<a name="l00403"></a>00403     g_signal_connect ( renderer, <span class="stringliteral">&quot;toggled&quot;</span>, G_CALLBACK (import_active_toggled), model);
<a name="l00404"></a>00404     column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Import&quot;</span>), renderer,
<a name="l00405"></a>00405                         <span class="stringliteral">&quot;active&quot;</span>, <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">IMPORT_FILESEL_SELECTED</a>,
<a name="l00406"></a>00406                         NULL);
<a name="l00407"></a>00407     gtk_tree_view_append_column (GTK_TREE_VIEW ( tree_view ), column );
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="comment">/* Type column. */</span>
<a name="l00410"></a>00410     renderer = gtk_cell_renderer_combo_new ();
<a name="l00411"></a>00411     g_signal_connect ( G_OBJECT (renderer), <span class="stringliteral">&quot;edited&quot;</span>, G_CALLBACK ( import_switch_type),
<a name="l00412"></a>00412                         model );
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     list_acc = GTK_TREE_MODEL (gtk_list_store_new (1, G_TYPE_STRING));
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     tmp = import_formats;
<a name="l00417"></a>00417     <span class="keywordflow">while</span> ( tmp )
<a name="l00418"></a>00418     {
<a name="l00419"></a>00419     GtkTreeIter iter;
<a name="l00420"></a>00420     <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> * format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     gtk_list_store_append (GTK_LIST_STORE (list_acc), &amp;iter);
<a name="l00423"></a>00423     gtk_list_store_set (GTK_LIST_STORE (list_acc), &amp;iter, 0,
<a name="l00424"></a>00424                         format -&gt; <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a>, -1);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     tmp = tmp -&gt; next;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     g_object_set ( renderer,
<a name="l00430"></a>00430                         <span class="stringliteral">&quot;model&quot;</span>, list_acc,
<a name="l00431"></a>00431                         <span class="stringliteral">&quot;text-column&quot;</span>, 0,
<a name="l00432"></a>00432                         <span class="stringliteral">&quot;editable&quot;</span>, TRUE,
<a name="l00433"></a>00433                         <span class="stringliteral">&quot;editable-set&quot;</span>, FALSE,
<a name="l00434"></a>00434                         <span class="stringliteral">&quot;has-entry&quot;</span>, FALSE,
<a name="l00435"></a>00435                         NULL );
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Type&quot;</span>), renderer,
<a name="l00438"></a>00438                         <span class="stringliteral">&quot;text&quot;</span>, <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aae4a6bbea8769df27656c23cce1659f4a">IMPORT_FILESEL_TYPENAME</a>,
<a name="l00439"></a>00439                         NULL);
<a name="l00440"></a>00440     gtk_tree_view_append_column (GTK_TREE_VIEW ( tree_view ), column );
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="comment">/* Name column. */</span>
<a name="l00443"></a>00443     renderer = gtk_cell_renderer_text_new ();
<a name="l00444"></a>00444     column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;File name&quot;</span>), renderer,
<a name="l00445"></a>00445                         <span class="stringliteral">&quot;text&quot;</span>, <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaaf0ce41c0b5c0fe4497b35308c90f94">IMPORT_FILESEL_FILENAME</a>,
<a name="l00446"></a>00446                         NULL);
<a name="l00447"></a>00447     gtk_tree_view_append_column (GTK_TREE_VIEW ( tree_view ), column );
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     g_object_set_data ( G_OBJECT(assistant), <span class="stringliteral">&quot;tree_view&quot;</span>, tree_view );
<a name="l00450"></a>00450     g_object_set_data ( G_OBJECT(assistant), <span class="stringliteral">&quot;model&quot;</span>, model );
<a name="l00451"></a>00451     g_object_set_data ( G_OBJECT(model), <span class="stringliteral">&quot;assistant&quot;</span>, assistant );
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <span class="keywordflow">return</span> vbox;
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 
<a name="l00462"></a>00462 gboolean import_switch_type ( GtkCellRendererText *cell, <span class="keyword">const</span> gchar *path,
<a name="l00463"></a>00463                         <span class="keyword">const</span> gchar *value, GtkListStore * model )
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465     GtkTreeIter iter;
<a name="l00466"></a>00466     GtkWidget * assistant;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     assistant = g_object_get_data ( G_OBJECT (model), <span class="stringliteral">&quot;assistant&quot;</span> );
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <span class="keywordflow">if</span> ( gtk_tree_model_get_iter_from_string ( GTK_TREE_MODEL ( model ), &amp;iter, path ))
<a name="l00471"></a>00471     {
<a name="l00472"></a>00472     GSList * tmp = import_formats;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="keywordflow">while</span> ( tmp )
<a name="l00475"></a>00475     {
<a name="l00476"></a>00476         gchar *contents;
<a name="l00477"></a>00477         gchar *nom_fichier;
<a name="l00478"></a>00478         gchar *tmp_str;
<a name="l00479"></a>00479         GError *error = NULL;
<a name="l00480"></a>00480         <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> * format;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l00483"></a>00483         <span class="keywordflow">if</span> ( ! strcmp ( value, format -&gt; <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a> ) )
<a name="l00484"></a>00484         {
<a name="l00485"></a>00485         gtk_tree_store_set ( GTK_TREE_STORE (model), &amp;iter,
<a name="l00486"></a>00486                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aae4a6bbea8769df27656c23cce1659f4a">IMPORT_FILESEL_TYPENAME</a>, value,
<a name="l00487"></a>00487                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa5f35d70ce904f5ab9e49a78479fb779d">IMPORT_FILESEL_TYPE</a>, format -&gt; <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a>,
<a name="l00488"></a>00488                         -1 );
<a name="l00489"></a>00489 
<a name="l00490"></a>00490         <span class="comment">/* CSV is special because it needs configuration, so</span>
<a name="l00491"></a>00491 <span class="comment">         * we add a conditional jump there. */</span>
<a name="l00492"></a>00492         <span class="keywordflow">if</span> ( ! strcmp ( value, <span class="stringliteral">&quot;CSV&quot;</span> ) )
<a name="l00493"></a>00493         {
<a name="l00494"></a>00494             <a class="code" href="gsb__assistant_8c.html#a06ff0b5745a3a4bd14ceecbd56cd09c1">gsb_assistant_set_next</a> ( assistant, <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1a79e8d557aae1b5cc0a66044e2e77cabe">IMPORT_FILESEL_PAGE</a>,
<a name="l00495"></a>00495                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad9799f3a9f6875fb71a002d741a0cb21">IMPORT_CSV_PAGE</a> );
<a name="l00496"></a>00496             <a class="code" href="gsb__assistant_8c.html#a9c400b973258731e6d4dd4a01a63e1aa">gsb_assistant_set_prev</a> ( assistant, <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ae3b9800771a2fbffc2d472c7a3095a0f">IMPORT_RESUME_PAGE</a>,
<a name="l00497"></a>00497                         <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad9799f3a9f6875fb71a002d741a0cb21">IMPORT_CSV_PAGE</a> );
<a name="l00498"></a>00498         }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500         gtk_tree_model_get ( GTK_TREE_MODEL ( model ), &amp;iter,
<a name="l00501"></a>00501                     <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaad6483753cacb80277975fa466178fc">IMPORT_FILESEL_REALNAME</a>, &amp;nom_fichier,
<a name="l00502"></a>00502                     -1 );
<a name="l00503"></a>00503         <span class="comment">/* get contents of file */</span>
<a name="l00504"></a>00504         <span class="keywordflow">if</span> ( ! g_file_get_contents ( nom_fichier, &amp;tmp_str, NULL, &amp;error ) )
<a name="l00505"></a>00505         {
<a name="l00506"></a>00506             g_print ( _(<span class="stringliteral">&quot;Unable to read file: %s\n&quot;</span>), error -&gt; message);
<a name="l00507"></a>00507             <span class="keywordflow">return</span> FALSE;
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <span class="comment">/* Convert in UTF8 */</span>
<a name="l00511"></a>00511         contents = g_convert ( tmp_str, -1, <span class="stringliteral">&quot;UTF-8&quot;</span>, charmap_imported, NULL, NULL, NULL );
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         <span class="keywordflow">if</span> ( contents == NULL )
<a name="l00514"></a>00514         {
<a name="l00515"></a>00515             charmap_imported = <a class="code" href="utils__files_8c.html#a317adcd21f47902ddbd7b39ea98a8ec6">utils_files_create_sel_charset</a> ( assistant, tmp_str,
<a name="l00516"></a>00516                         charmap_imported,
<a name="l00517"></a>00517                 g_path_get_basename ( nom_fichier ) );
<a name="l00518"></a>00518             gtk_tree_store_set ( GTK_TREE_STORE ( model ), &amp;iter,
<a name="l00519"></a>00519                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aac4bc8a9798d9e74e696dc9ee632a4305">IMPORT_FILESEL_CODING</a>, charmap_imported,
<a name="l00520"></a>00520                         -1 );
<a name="l00521"></a>00521             g_free ( contents );
<a name="l00522"></a>00522         }
<a name="l00523"></a>00523         g_free ( tmp_str );
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         import_preview_maybe_sensitive_next ( assistant, GTK_TREE_MODEL ( model ));
<a name="l00526"></a>00526         }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         tmp = tmp -&gt; next;
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532      <span class="keywordflow">return</span> FALSE;
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 
<a name="l00540"></a>00540 gboolean import_enter_file_selection_page ( GtkWidget * assistant )
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     GtkTreeModel * model;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     model = g_object_get_data ( G_OBJECT ( assistant ), <span class="stringliteral">&quot;model&quot;</span> );
<a name="l00545"></a>00545     import_preview_maybe_sensitive_next ( assistant, model );
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="keywordflow">return</span> FALSE;
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 
<a name="l00557"></a>00557 gboolean import_active_toggled ( GtkCellRendererToggle * cell, gchar *path_str,
<a name="l00558"></a>00558                         gpointer model )
<a name="l00559"></a>00559 {
<a name="l00560"></a>00560     GtkWidget * assistant;
<a name="l00561"></a>00561     GtkTreePath *path = gtk_tree_path_new_from_string (path_str);
<a name="l00562"></a>00562     GtkTreeIter iter;
<a name="l00563"></a>00563     gboolean toggle_item;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     assistant = g_object_get_data ( G_OBJECT ( model ), <span class="stringliteral">&quot;assistant&quot;</span> );
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     gtk_tree_model_get_iter ( GTK_TREE_MODEL ( model ), &amp;iter, path);
<a name="l00568"></a>00568     gtk_tree_model_get ( GTK_TREE_MODEL ( model ), &amp;iter,
<a name="l00569"></a>00569                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">IMPORT_FILESEL_SELECTED</a>, &amp;toggle_item, -1 );
<a name="l00570"></a>00570     gtk_tree_store_set ( GTK_TREE_STORE ( model ), &amp;iter,
<a name="l00571"></a>00571                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">IMPORT_FILESEL_SELECTED</a>, !toggle_item, -1 );
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     import_preview_maybe_sensitive_next ( assistant, model );
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="keywordflow">return</span> FALSE;
<a name="l00576"></a>00576 }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 
<a name="l00585"></a>00585 <span class="keywordtype">void</span> import_preview_maybe_sensitive_next ( GtkWidget * assistant, GtkTreeModel * model )
<a name="l00586"></a>00586 {
<a name="l00587"></a>00587     GtkTreeIter iter;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <span class="comment">/* Don&#39;t allow going to next page if no file is selected yet. */</span>
<a name="l00590"></a>00590     gtk_widget_set_sensitive ( g_object_get_data ( G_OBJECT (assistant), <span class="stringliteral">&quot;button_next&quot;</span> ), FALSE );
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     gtk_tree_model_get_iter_first ( model, &amp;iter );
<a name="l00593"></a>00593     <span class="keywordflow">if</span> ( ! gtk_tree_store_iter_is_valid ( GTK_TREE_STORE (model), &amp;iter ))
<a name="l00594"></a>00594     {
<a name="l00595"></a>00595     <span class="keywordflow">return</span>;
<a name="l00596"></a>00596     }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <span class="comment">/* Iterate over lines so we check if some are checked. */</span>
<a name="l00599"></a>00599     <span class="keywordflow">do</span>
<a name="l00600"></a>00600     {
<a name="l00601"></a>00601     gboolean selected;
<a name="l00602"></a>00602     gchar * type;
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     gtk_tree_model_get ( GTK_TREE_MODEL ( model ), &amp;iter,
<a name="l00605"></a>00605                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">IMPORT_FILESEL_SELECTED</a>, &amp;selected,
<a name="l00606"></a>00606                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa5f35d70ce904f5ab9e49a78479fb779d">IMPORT_FILESEL_TYPE</a>, &amp;type,
<a name="l00607"></a>00607                     -   1 );
<a name="l00608"></a>00608     <span class="keywordflow">if</span> ( selected &amp;&amp; strcmp ( type, _(<span class="stringliteral">&quot;Unknown&quot;</span>) ) )
<a name="l00609"></a>00609     {
<a name="l00610"></a>00610         gtk_widget_set_sensitive ( g_object_get_data ( G_OBJECT (assistant),
<a name="l00611"></a>00611                         <span class="stringliteral">&quot;button_next&quot;</span> ),
<a name="l00612"></a>00612                         TRUE );
<a name="l00613"></a>00613         <span class="keywordflow">return</span>;
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616     <span class="keywordflow">while</span> ( gtk_tree_model_iter_next ( model, &amp;iter ) );
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 
<a name="l00626"></a>00626 gboolean import_select_file ( GtkWidget * button, GtkWidget * assistant )
<a name="l00627"></a>00627 {
<a name="l00628"></a>00628     GSList * filenames, * iterator;
<a name="l00629"></a>00629     GtkTreeModel * model;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     filenames = gsb_import_create_file_chooser ( NULL, assistant );
<a name="l00632"></a>00632     <span class="keywordflow">if</span> (!filenames)
<a name="l00633"></a>00633     <span class="keywordflow">return</span> FALSE;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     iterator = filenames;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     model = g_object_get_data ( G_OBJECT ( assistant ), <span class="stringliteral">&quot;model&quot;</span> );
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <span class="keywordflow">while</span> ( iterator &amp;&amp; model )
<a name="l00640"></a>00640     {
<a name="l00641"></a>00641     GtkTreeIter iter;
<a name="l00642"></a>00642     <span class="keyword">const</span> gchar *type;
<a name="l00643"></a>00643     gchar *nom_fichier;
<a name="l00644"></a>00644     gchar *tmp_str;
<a name="l00645"></a>00645     gchar *contents;
<a name="l00646"></a>00646     gchar *charmap;
<a name="l00647"></a>00647     GError *error = NULL;
<a name="l00648"></a>00648     gchar * <a class="code" href="structimport__format.html#a218d1ed91e7f487691b69458206c1b52">extension</a>;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     <span class="comment">/* Open file */</span>
<a name="l00651"></a>00651     extension = strrchr ( iterator -&gt; data, <span class="charliteral">&#39;.&#39;</span> );
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <span class="comment">/* unzip Gnucash file if necessary */</span>
<a name="l00654"></a>00654     <span class="keywordflow">if</span> ( strcmp ( extension, <span class="stringliteral">&quot;.gnc&quot;</span> ) == 0 )
<a name="l00655"></a>00655         gsb_import_gunzip_file ( iterator -&gt; data );
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     <span class="comment">/* get contents of file */</span>
<a name="l00658"></a>00658     <span class="keywordflow">if</span> ( ! g_file_get_contents ( iterator -&gt; data, &amp;tmp_str, NULL, &amp;error ) )
<a name="l00659"></a>00659     {
<a name="l00660"></a>00660         g_print ( _(<span class="stringliteral">&quot;Unable to read file: %s\n&quot;</span>), error -&gt; message);
<a name="l00661"></a>00661         <span class="keywordflow">return</span> FALSE;
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     type = autodetect_file_type ( iterator -&gt; data, tmp_str );
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="comment">/* passe par un fichier temporaire pour bipasser le bug libofx */</span>
<a name="l00667"></a>00667     <span class="keywordflow">if</span> ( strcmp ( type, <span class="stringliteral">&quot;OFX&quot;</span> ) == 0 )
<a name="l00668"></a>00668     {
<a name="l00669"></a>00669         nom_fichier = g_strconcat (g_get_tmp_dir (),G_DIR_SEPARATOR_S,
<a name="l00670"></a>00670                                    g_path_get_basename ( iterator -&gt; data ), NULL);
<a name="l00671"></a>00671         <span class="keywordflow">if</span> (! gsb_import_set_tmp_file (nom_fichier, tmp_str ) )
<a name="l00672"></a>00672         {
<a name="l00673"></a>00673             g_free ( tmp_str );
<a name="l00674"></a>00674             <span class="keywordflow">return</span> FALSE;
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676         <span class="keywordflow">if</span> ( ( charmap = <a class="code" href="utils__files_8c.html#ac9835d1064eac1edc68310b67ec5c249">utils_files_get_ofx_charset</a> ( tmp_str ) ) != NULL )
<a name="l00677"></a>00677         {
<a name="l00678"></a>00678             <span class="keywordflow">if</span> ( charmap_imported &amp;&amp; strlen ( charmap_imported ) &gt; 0 )
<a name="l00679"></a>00679                 g_free ( charmap_imported );
<a name="l00680"></a>00680             charmap_imported = charmap;
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683     <span class="keywordflow">else</span>
<a name="l00684"></a>00684         nom_fichier = <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> (iterator -&gt; data);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">/* CSV is special because it needs configuration, so we</span>
<a name="l00687"></a>00687 <span class="comment">     * add a conditional jump there. */</span>
<a name="l00688"></a>00688     <span class="keywordflow">if</span> ( ! strcmp ( type, <span class="stringliteral">&quot;CSV&quot;</span> ) )
<a name="l00689"></a>00689     {
<a name="l00690"></a>00690         <a class="code" href="gsb__assistant_8c.html#a06ff0b5745a3a4bd14ceecbd56cd09c1">gsb_assistant_set_next</a> ( assistant, <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1a79e8d557aae1b5cc0a66044e2e77cabe">IMPORT_FILESEL_PAGE</a>, <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad9799f3a9f6875fb71a002d741a0cb21">IMPORT_CSV_PAGE</a> );
<a name="l00691"></a>00691         <a class="code" href="gsb__assistant_8c.html#a9c400b973258731e6d4dd4a01a63e1aa">gsb_assistant_set_prev</a> ( assistant, <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ae3b9800771a2fbffc2d472c7a3095a0f">IMPORT_RESUME_PAGE</a>, <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad9799f3a9f6875fb71a002d741a0cb21">IMPORT_CSV_PAGE</a> );
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="comment">/* Convert to UTF8 */</span>
<a name="l00695"></a>00695     contents = g_convert ( tmp_str, -1, <span class="stringliteral">&quot;UTF-8&quot;</span>, charmap_imported, NULL, NULL, NULL );
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <span class="keywordflow">if</span> ( contents == NULL )
<a name="l00698"></a>00698         charmap_imported = <a class="code" href="utils__files_8c.html#a317adcd21f47902ddbd7b39ea98a8ec6">utils_files_create_sel_charset</a> ( assistant, tmp_str,
<a name="l00699"></a>00699                     charmap_imported,
<a name="l00700"></a>00700                     g_path_get_basename ( iterator -&gt; data ) );
<a name="l00701"></a>00701     <span class="keywordflow">else</span>
<a name="l00702"></a>00702         g_free ( contents );
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     gtk_tree_store_append ( GTK_TREE_STORE ( model ), &amp;iter, NULL );
<a name="l00705"></a>00705     gtk_tree_store_set ( GTK_TREE_STORE ( model ), &amp;iter,
<a name="l00706"></a>00706                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">IMPORT_FILESEL_SELECTED</a>, TRUE,
<a name="l00707"></a>00707                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aae4a6bbea8769df27656c23cce1659f4a">IMPORT_FILESEL_TYPENAME</a>, type,
<a name="l00708"></a>00708                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaaf0ce41c0b5c0fe4497b35308c90f94">IMPORT_FILESEL_FILENAME</a>, g_path_get_basename ( iterator -&gt; data ),
<a name="l00709"></a>00709                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaad6483753cacb80277975fa466178fc">IMPORT_FILESEL_REALNAME</a>, nom_fichier,
<a name="l00710"></a>00710                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa5f35d70ce904f5ab9e49a78479fb779d">IMPORT_FILESEL_TYPE</a>, type,
<a name="l00711"></a>00711                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aac4bc8a9798d9e74e696dc9ee632a4305">IMPORT_FILESEL_CODING</a>, charmap_imported,
<a name="l00712"></a>00712                         -1 );
<a name="l00713"></a>00713     g_free ( nom_fichier );
<a name="l00714"></a>00714     g_free ( tmp_str );
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="keywordflow">if</span> ( strcmp ( type, _(<span class="stringliteral">&quot;Unknown&quot;</span>) ) )
<a name="l00717"></a>00717     {
<a name="l00718"></a>00718         <span class="comment">/* A valid file was selected, so we can now go ahead. */</span>
<a name="l00719"></a>00719         gtk_widget_set_sensitive ( g_object_get_data ( G_OBJECT (assistant), <span class="stringliteral">&quot;button_next&quot;</span> ),
<a name="l00720"></a>00720                         TRUE );
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     iterator = iterator -&gt; next;
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="keywordflow">if</span> ( filenames )
<a name="l00727"></a>00727         g_slist_free ( filenames );
<a name="l00728"></a>00728     <span class="keywordflow">return</span> FALSE;
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731 
<a name="l00740"></a>00740 GSList *gsb_import_create_file_chooser ( <span class="keyword">const</span> <span class="keywordtype">char</span> *enc, GtkWidget *parent )
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742     GtkWidget * dialog, * hbox, * go_charmap_sel;
<a name="l00743"></a>00743     GtkFileFilter * filter, * default_filter;
<a name="l00744"></a>00744     gchar * files;
<a name="l00745"></a>00745     GSList * tmp;
<a name="l00746"></a>00746     <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> * format;
<a name="l00747"></a>00747     GSList *filenames = NULL;
<a name="l00748"></a>00748         gchar* old_str;
<a name="l00749"></a>00749         gchar* tmpstr;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     dialog = gtk_file_chooser_dialog_new ( _(<span class="stringliteral">&quot;Choose files to import.&quot;</span>),
<a name="l00752"></a>00752                         GTK_WINDOW ( parent ),
<a name="l00753"></a>00753                         GTK_FILE_CHOOSER_ACTION_OPEN,
<a name="l00754"></a>00754                         GTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL,
<a name="l00755"></a>00755                         GTK_STOCK_OPEN, GTK_RESPONSE_ACCEPT,
<a name="l00756"></a>00756                         NULL);
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     gtk_file_chooser_set_select_multiple ( GTK_FILE_CHOOSER ( dialog ), TRUE );
<a name="l00759"></a>00759     gtk_file_chooser_set_current_folder ( GTK_FILE_CHOOSER ( dialog ), <a class="code" href="gsb__file_8c.html#a05b2359af2cda48c801099a2d222aa55">gsb_file_get_last_path</a> () );
<a name="l00760"></a>00760 
<a name="l00761"></a>00761     <span class="comment">/* Import filters */</span>
<a name="l00762"></a>00762     tmp = import_formats;
<a name="l00763"></a>00763     format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l00764"></a>00764     files = g_strconcat ( <span class="stringliteral">&quot;*.&quot;</span>, format -&gt; extension, NULL );
<a name="l00765"></a>00765     tmp = tmp -&gt; next;
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     <span class="keywordflow">while</span> ( tmp )
<a name="l00768"></a>00768     {
<a name="l00769"></a>00769     format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l00770"></a>00770     old_str = files;
<a name="l00771"></a>00771     files = g_strconcat ( files, <span class="stringliteral">&quot;, *.&quot;</span>, format -&gt; extension, NULL );
<a name="l00772"></a>00772     g_free ( old_str );
<a name="l00773"></a>00773     tmp = tmp -&gt; next;
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     default_filter = gtk_file_filter_new ();
<a name="l00777"></a>00777     tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Known files (%s)&quot;</span>), files );
<a name="l00778"></a>00778     gtk_file_filter_set_name ( default_filter, tmpstr );
<a name="l00779"></a>00779     g_free ( tmpstr );
<a name="l00780"></a>00780 
<a name="l00781"></a>00781     tmp = import_formats;
<a name="l00782"></a>00782     <span class="keywordflow">while</span> ( tmp )
<a name="l00783"></a>00783     {
<a name="l00784"></a>00784     GtkFileFilter * format_filter;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     format_filter = gtk_file_filter_new ();
<a name="l00789"></a>00789     tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;%s files (*.%s)&quot;</span>),
<a name="l00790"></a>00790                         format -&gt; <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a>,
<a name="l00791"></a>00791                         format -&gt; extension );
<a name="l00792"></a>00792     gtk_file_filter_set_name ( format_filter, tmpstr );
<a name="l00793"></a>00793     g_free ( tmpstr );
<a name="l00794"></a>00794     tmpstr = g_strconcat ( <span class="stringliteral">&quot;*.&quot;</span>, format -&gt; extension, NULL );
<a name="l00795"></a>00795     gtk_file_filter_add_pattern ( format_filter,
<a name="l00796"></a>00796                         tmpstr );
<a name="l00797"></a>00797     g_free ( tmpstr );
<a name="l00798"></a>00798     gtk_file_chooser_add_filter ( GTK_FILE_CHOOSER ( dialog ), format_filter );
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     <span class="comment">/* Global filter */</span>
<a name="l00801"></a>00801     tmpstr = g_strconcat ( <span class="stringliteral">&quot;*.&quot;</span>, format -&gt; extension, NULL );
<a name="l00802"></a>00802     gtk_file_filter_add_pattern ( default_filter, tmpstr );
<a name="l00803"></a>00803     g_free ( tmpstr );
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     tmp = tmp -&gt; next;
<a name="l00806"></a>00806     }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     gtk_file_chooser_add_filter ( GTK_FILE_CHOOSER ( dialog ), default_filter );
<a name="l00809"></a>00809     gtk_file_chooser_set_filter ( GTK_FILE_CHOOSER ( dialog ), default_filter );
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     filter = gtk_file_filter_new ();
<a name="l00812"></a>00812     gtk_file_filter_set_name ( filter, _(<span class="stringliteral">&quot;All files&quot;</span>) );
<a name="l00813"></a>00813     gtk_file_filter_add_pattern ( filter, <span class="stringliteral">&quot;*&quot;</span> );
<a name="l00814"></a>00814     gtk_file_chooser_add_filter ( GTK_FILE_CHOOSER ( dialog ), filter );
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     <span class="comment">/* Add encoding preview */</span>
<a name="l00817"></a>00817     hbox = gtk_hbox_new ( FALSE, 6 );
<a name="l00818"></a>00818     gtk_file_chooser_set_extra_widget ( GTK_FILE_CHOOSER ( dialog ), hbox );
<a name="l00819"></a>00819     gtk_box_pack_start ( GTK_BOX ( hbox ), gtk_label_new ( <a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a>(_(<span class="stringliteral">&quot;Encoding&quot;</span>)) ),
<a name="l00820"></a>00820                         FALSE, FALSE, 0 );
<a name="l00821"></a>00821     go_charmap_sel = <a class="code" href="go-charmap-sel_8c.html#a68d9a2dfcd7e29cf4585e4d830abfba4">go_charmap_sel_new</a> (<a class="code" href="go-charmap-sel_8h.html#a758de5be5c36f44240e2a4fb4fcd7912a8d47de8eb25d43aebcf157ed4ab82418">GO_CHARMAP_SEL_TO_UTF8</a>);
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (enc &amp;&amp; strlen (enc))
<a name="l00823"></a>00823         <a class="code" href="go-charmap-sel_8c.html#afaad94b300355324942ac3632d75377b">go_charmap_sel_set_encoding</a> ((<a class="code" href="struct__GOCharmapSel.html">GOCharmapSel</a> *) go_charmap_sel, enc);
<a name="l00824"></a>00824     gtk_box_pack_start ( GTK_BOX ( hbox ), go_charmap_sel, TRUE, TRUE, 0 );
<a name="l00825"></a>00825     gtk_widget_show_all ( hbox );
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="keywordflow">if</span> ( gtk_dialog_run ( GTK_DIALOG (dialog ) ) == GTK_RESPONSE_ACCEPT )
<a name="l00828"></a>00828     filenames = gtk_file_chooser_get_filenames ( GTK_FILE_CHOOSER (dialog));
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="comment">/* save charmap */</span>
<a name="l00831"></a>00831     charmap_imported = g_strdup (<a class="code" href="go-charmap-sel_8c.html#a17a7ca06cfc5d9a8d0e08f764d50b7f8">go_charmap_sel_get_encoding</a> ( (<a class="code" href="struct__GOCharmapSel.html">GOCharmapSel</a> * )go_charmap_sel ));
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <a class="code" href="gsb__file_8c.html#abea90088f86f05e8386739483e16b380">gsb_file_update_last_path</a> (<a class="code" href="utils__file__selection_8c.html#a7ceee035264e3ea82cd7e5863650a6c3">file_selection_get_last_directory</a> (GTK_FILE_CHOOSER (dialog), TRUE));
<a name="l00834"></a>00834     gtk_widget_destroy (dialog);
<a name="l00835"></a>00835     <span class="keywordflow">return</span> filenames;
<a name="l00836"></a>00836 }
<a name="l00837"></a>00837 
<a name="l00842"></a>00842 GtkWidget *import_create_resume_page ( GtkWidget * assistant )
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844     GtkWidget *sw;
<a name="l00845"></a>00845     GtkWidget *view;
<a name="l00846"></a>00846     GtkTextBuffer *buffer;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     sw = gtk_scrolled_window_new (NULL, NULL);
<a name="l00849"></a>00849     gtk_scrolled_window_set_policy ( GTK_SCROLLED_WINDOW ( sw ),
<a name="l00850"></a>00850                         GTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC );
<a name="l00851"></a>00851     view = gtk_text_view_new ();
<a name="l00852"></a>00852     gtk_container_add (GTK_CONTAINER (sw), view);
<a name="l00853"></a>00853     gtk_text_view_set_wrap_mode (GTK_TEXT_VIEW (view), GTK_WRAP_WORD);
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     gtk_text_view_set_editable ( GTK_TEXT_VIEW (view), FALSE );
<a name="l00856"></a>00856     gtk_text_view_set_cursor_visible ( GTK_TEXT_VIEW (view), FALSE );
<a name="l00857"></a>00857     gtk_text_view_set_left_margin ( GTK_TEXT_VIEW (view), 12 );
<a name="l00858"></a>00858     gtk_text_view_set_right_margin ( GTK_TEXT_VIEW (view), 12 );
<a name="l00859"></a>00859 
<a name="l00860"></a>00860     buffer = gtk_text_view_get_buffer (GTK_TEXT_VIEW (view));
<a name="l00861"></a>00861     gtk_text_buffer_create_tag ( buffer, <span class="stringliteral">&quot;bold&quot;</span>,
<a name="l00862"></a>00862                         <span class="stringliteral">&quot;weight&quot;</span>, PANGO_WEIGHT_BOLD, NULL);
<a name="l00863"></a>00863     gtk_text_buffer_create_tag ( buffer, <span class="stringliteral">&quot;x-large&quot;</span>,
<a name="l00864"></a>00864                         <span class="stringliteral">&quot;scale&quot;</span>, PANGO_SCALE_X_LARGE, NULL);
<a name="l00865"></a>00865     gtk_text_buffer_create_tag (buffer, <span class="stringliteral">&quot;indented&quot;</span>,
<a name="l00866"></a>00866                         <span class="stringliteral">&quot;left-margin&quot;</span>, 24, NULL);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     g_object_set_data ( G_OBJECT ( assistant ), <span class="stringliteral">&quot;text-buffer&quot;</span>, buffer );
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="keywordflow">return</span> sw;
<a name="l00871"></a>00871 }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 
<a name="l00880"></a>00880 gboolean import_enter_resume_page ( GtkWidget * assistant )
<a name="l00881"></a>00881 {
<a name="l00882"></a>00882     GSList * files = <a class="code" href="import_8c.html#af47b0c4c36291dc40375ad1d3b402880">import_selected_files</a> ( assistant ), * list;
<a name="l00883"></a>00883     GtkTextBuffer * buffer;
<a name="l00884"></a>00884     GtkTextIter iter;
<a name="l00885"></a>00885     gchar * error_message = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00886"></a>00886         gchar* tmpstr;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     liste_comptes_importes_error = NULL;
<a name="l00889"></a>00889     liste_comptes_importes = NULL;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891     <span class="keywordflow">while</span> ( files )
<a name="l00892"></a>00892     {
<a name="l00893"></a>00893     <span class="keyword">struct </span><a class="code" href="structimported__file.html">imported_file</a> * imported = files -&gt; data;
<a name="l00894"></a>00894     GSList * tmp = import_formats;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <span class="keywordflow">while</span> ( tmp )
<a name="l00897"></a>00897     {
<a name="l00898"></a>00898         <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> * format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900         <span class="keywordflow">if</span> ( !strcmp ( imported -&gt; type, format -&gt; <a class="code" href="structimport__format.html#af9cf8699252e2fc46a307afd3ed73cd2">name</a> ) )
<a name="l00901"></a>00901         {
<a name="l00902"></a>00902         format -&gt; <span class="keyword">import</span> ( assistant, imported );
<a name="l00903"></a>00903         tmp = tmp -&gt; next;
<a name="l00904"></a>00904         <span class="keywordflow">continue</span>;
<a name="l00905"></a>00905         }
<a name="l00906"></a>00906 
<a name="l00907"></a>00907         tmp = tmp -&gt; next;
<a name="l00908"></a>00908     }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     files = files -&gt; next;
<a name="l00911"></a>00911     }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     buffer = g_object_get_data ( G_OBJECT ( assistant ), <span class="stringliteral">&quot;text-buffer&quot;</span> );
<a name="l00914"></a>00914     gtk_text_buffer_set_text (buffer, <span class="stringliteral">&quot;\n&quot;</span>, -1 );
<a name="l00915"></a>00915     gtk_text_buffer_get_iter_at_offset (buffer, &amp;iter, 1);
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <span class="keywordflow">if</span> ( liste_comptes_importes )
<a name="l00918"></a>00918     {
<a name="l00919"></a>00919     gtk_text_buffer_insert_with_tags_by_name (buffer, &amp;iter,
<a name="l00920"></a>00920                         _(<span class="stringliteral">&quot;Congratulations !&quot;</span>), -1,
<a name="l00921"></a>00921                         <span class="stringliteral">&quot;x-large&quot;</span>, NULL);
<a name="l00922"></a>00922     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     gtk_text_buffer_insert (buffer, &amp;iter,
<a name="l00925"></a>00925                         <a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a> ( _(<span class="stringliteral">&quot;You successfully imported files into Grisbi.  The &quot;</span>
<a name="l00926"></a>00926                                   <span class="stringliteral">&quot;following pages will help you set up imported data for &quot;</span>
<a name="l00927"></a>00927                                   <span class="stringliteral">&quot;the following files&quot;</span>) ),
<a name="l00928"></a>00928                         -1 );
<a name="l00929"></a>00929     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l00930"></a>00930 
<a name="l00931"></a>00931     list = liste_comptes_importes;
<a name="l00932"></a>00932     <span class="keywordflow">while</span> ( list )
<a name="l00933"></a>00933     {
<a name="l00934"></a>00934         <span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * compte;
<a name="l00935"></a>00935         compte = list -&gt; data;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937         <span class="comment">/* Fix account name if needed. */</span>
<a name="l00938"></a>00938         <span class="keywordflow">if</span> ( ! compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a> )
<a name="l00939"></a>00939         {
<a name="l00940"></a>00940         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a> = _(<span class="stringliteral">&quot;Unnamed Imported account&quot;</span>);
<a name="l00941"></a>00941         }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943         tmpstr = g_strconcat ( <span class="stringliteral">&quot;• &quot;</span>, compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a>,
<a name="l00944"></a>00944                         <span class="stringliteral">&quot; (&quot;</span>,
<a name="l00945"></a>00945                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#adac142c3810e741372cf8df90774662c">origine</a>,
<a name="l00946"></a>00946                         <span class="stringliteral">&quot;)\n\n&quot;</span>,
<a name="l00947"></a>00947                         NULL );
<a name="l00948"></a>00948         gtk_text_buffer_insert_with_tags_by_name (buffer, &amp;iter,
<a name="l00949"></a>00949                         tmpstr ,
<a name="l00950"></a>00950                         -1, <span class="stringliteral">&quot;indented&quot;</span>, NULL );
<a name="l00951"></a>00951         g_free ( tmpstr );
<a name="l00952"></a>00952 
<a name="l00953"></a>00953         list = list -&gt; next;
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <span class="keywordflow">while</span> ( gtk_notebook_get_n_pages ( g_object_get_data ( G_OBJECT (assistant), 
<a name="l00957"></a>00957                         <span class="stringliteral">&quot;notebook&quot;</span> ) ) &gt; <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad7f5183fac1b068b43870a3ba511e2cb">IMPORT_FIRST_ACCOUNT_PAGE</a> )
<a name="l00958"></a>00958     {
<a name="l00959"></a>00959         gtk_notebook_remove_page ( g_object_get_data ( G_OBJECT (assistant), <span class="stringliteral">&quot;notebook&quot;</span> ), -1 );
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961     affichage_recapitulatif_importation ( assistant );
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963     <span class="keywordflow">else</span>
<a name="l00964"></a>00964     {
<a name="l00965"></a>00965     gtk_text_buffer_insert_with_tags_by_name (buffer, &amp;iter,
<a name="l00966"></a>00966                         _(<span class="stringliteral">&quot;Error !&quot;</span>), -1,
<a name="l00967"></a>00967                         <span class="stringliteral">&quot;x-large&quot;</span>, NULL);
<a name="l00968"></a>00968     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     gtk_text_buffer_insert (buffer, &amp;iter,
<a name="l00971"></a>00971                         _(<span class="stringliteral">&quot;No file has been imported, please double check that they are &quot;</span>
<a name="l00972"></a>00972                           <span class="stringliteral">&quot;valid files.  Please make sure that they are not compressed and &quot;</span>
<a name="l00973"></a>00973                           <span class="stringliteral">&quot;that their format is valid.&quot;</span>),
<a name="l00974"></a>00974                         -1 );
<a name="l00975"></a>00975     <span class="keywordflow">if</span> ( strlen ( error_message ) )
<a name="l00976"></a>00976     {
<a name="l00977"></a>00977         gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l00978"></a>00978         gtk_text_buffer_insert (buffer, &amp;iter, error_message, -1 );
<a name="l00979"></a>00979     }
<a name="l00980"></a>00980     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="keywordflow">if</span> ( liste_comptes_importes_error )
<a name="l00984"></a>00984     {
<a name="l00985"></a>00985     gtk_text_buffer_insert (buffer, &amp;iter, _(<span class="stringliteral">&quot;The following files are in error:&quot;</span>), -1 );
<a name="l00986"></a>00986     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     list = liste_comptes_importes_error;
<a name="l00989"></a>00989     <span class="keywordflow">while</span> ( list )
<a name="l00990"></a>00990     {
<a name="l00991"></a>00991         <span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * compte;
<a name="l00992"></a>00992         compte = list -&gt; data;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         tmpstr = g_strconcat ( <span class="stringliteral">&quot;• &quot;</span>, compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a>,
<a name="l00995"></a>00995                         <span class="stringliteral">&quot; (&quot;</span>,
<a name="l00996"></a>00996                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#adac142c3810e741372cf8df90774662c">origine</a>,
<a name="l00997"></a>00997                         <span class="stringliteral">&quot;)\n\n&quot;</span>,
<a name="l00998"></a>00998                         NULL );
<a name="l00999"></a>00999         gtk_text_buffer_insert_with_tags_by_name (buffer, &amp;iter,
<a name="l01000"></a>01000                         tmpstr,
<a name="l01001"></a>01001                         -1, <span class="stringliteral">&quot;indented&quot;</span>, NULL );
<a name="l01002"></a>01002         g_free ( tmpstr );
<a name="l01003"></a>01003 
<a name="l01004"></a>01004         list = list -&gt; next;
<a name="l01005"></a>01005     }
<a name="l01006"></a>01006     }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">return</span> FALSE;
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 
<a name="l01016"></a>01016 GtkWidget *import_create_final_page ( GtkWidget * assistant )
<a name="l01017"></a>01017 {
<a name="l01018"></a>01018     GtkWidget * view;
<a name="l01019"></a>01019     GtkTextBuffer * buffer;
<a name="l01020"></a>01020     GtkTextIter iter;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022     view = gtk_text_view_new ();
<a name="l01023"></a>01023     gtk_text_view_set_wrap_mode (GTK_TEXT_VIEW (view), GTK_WRAP_WORD);
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     gtk_text_view_set_editable ( GTK_TEXT_VIEW (view), FALSE );
<a name="l01026"></a>01026     gtk_text_view_set_cursor_visible ( GTK_TEXT_VIEW (view), FALSE );
<a name="l01027"></a>01027     gtk_text_view_set_left_margin ( GTK_TEXT_VIEW (view), 12 );
<a name="l01028"></a>01028     gtk_text_view_set_right_margin ( GTK_TEXT_VIEW (view), 12 );
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     buffer = gtk_text_view_get_buffer (GTK_TEXT_VIEW (view));
<a name="l01031"></a>01031     gtk_text_buffer_create_tag ( buffer, <span class="stringliteral">&quot;x-large&quot;</span>,
<a name="l01032"></a>01032                         <span class="stringliteral">&quot;scale&quot;</span>, PANGO_SCALE_X_LARGE, NULL);
<a name="l01033"></a>01033     gtk_text_buffer_get_iter_at_offset (buffer, &amp;iter, 1);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n&quot;</span>, -1 );
<a name="l01036"></a>01036     gtk_text_buffer_insert_with_tags_by_name (buffer, &amp;iter,
<a name="l01037"></a>01037                         _(<span class="stringliteral">&quot;Import terminated&quot;</span>), -1,
<a name="l01038"></a>01038                         <span class="stringliteral">&quot;x-large&quot;</span>, NULL);
<a name="l01039"></a>01039     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l01040"></a>01040     gtk_text_buffer_insert (buffer, &amp;iter,
<a name="l01041"></a>01041                         _(<span class="stringliteral">&quot;You have successfully set up transactions import into Grisbi. &quot;</span>
<a name="l01042"></a>01042                           <span class="stringliteral">&quot;Press the &#39;Close&#39; button to terminate import.&quot;</span>),
<a name="l01043"></a>01043                         -1 );
<a name="l01044"></a>01044     gtk_text_buffer_insert (buffer, &amp;iter, <span class="stringliteral">&quot;\n\n&quot;</span>, -1 );
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     <span class="keywordflow">return</span> view;
<a name="l01047"></a>01047 }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049 
<a name="l01055"></a><a class="code" href="import_8h.html#af47b0c4c36291dc40375ad1d3b402880">01055</a> GSList *<a class="code" href="import_8c.html#af47b0c4c36291dc40375ad1d3b402880">import_selected_files</a> ( GtkWidget * assistant )
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057     GSList * list = NULL;
<a name="l01058"></a>01058     GtkTreeModel * model;
<a name="l01059"></a>01059     GtkTreeIter iter;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     model = g_object_get_data ( G_OBJECT ( assistant ), <span class="stringliteral">&quot;model&quot;</span> );
<a name="l01062"></a>01062     g_return_val_if_fail ( model, NULL );
<a name="l01063"></a>01063 
<a name="l01064"></a>01064     gtk_tree_model_get_iter_first ( model, &amp;iter );
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="keywordflow">do</span>
<a name="l01067"></a>01067     {
<a name="l01068"></a>01068     <span class="keyword">struct </span><a class="code" href="structimported__file.html">imported_file</a> * imported;
<a name="l01069"></a>01069     gboolean selected;
<a name="l01070"></a>01070 
<a name="l01071"></a>01071     imported = g_malloc0 ( <span class="keyword">sizeof</span> ( <span class="keyword">struct</span> <a class="code" href="structimported__file.html">imported_file</a> ) );
<a name="l01072"></a>01072     gtk_tree_model_get ( GTK_TREE_MODEL ( model ), &amp;iter,
<a name="l01073"></a>01073                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa1198380335058f832ac22d4bcd04c5ca">IMPORT_FILESEL_SELECTED</a>, &amp;selected,
<a name="l01074"></a>01074                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aaaad6483753cacb80277975fa466178fc">IMPORT_FILESEL_REALNAME</a>, &amp;(imported -&gt; <a class="code" href="structimported__file.html#abfd9a9c068751bb65b413afecca70e6f">name</a>),
<a name="l01075"></a>01075                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aa5f35d70ce904f5ab9e49a78479fb779d">IMPORT_FILESEL_TYPE</a>, &amp;(imported -&gt; type),
<a name="l01076"></a>01076                         <a class="code" href="import_8c.html#ac8217d37285ac5d86ee34b65ce6b012aac4bc8a9798d9e74e696dc9ee632a4305">IMPORT_FILESEL_CODING</a>, &amp;(imported -&gt; <a class="code" href="structimported__file.html#af9b8e05e83e1adcd22c504ee990736d3">coding_system</a>),
<a name="l01077"></a>01077                         -1 );
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     <span class="keywordflow">if</span> ( selected )
<a name="l01080"></a>01080     {
<a name="l01081"></a>01081         list = g_slist_append ( list, imported );
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083     }
<a name="l01084"></a>01084     <span class="keywordflow">while</span> ( gtk_tree_model_iter_next ( model, &amp;iter ) );
<a name="l01085"></a>01085 
<a name="l01086"></a>01086     <span class="keywordflow">return</span> list;
<a name="l01087"></a>01087 }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 
<a name="l01099"></a>01099 gboolean affichage_recapitulatif_importation ( GtkWidget * assistant )
<a name="l01100"></a>01100 {
<a name="l01101"></a>01101     gint page;
<a name="l01102"></a>01102     GSList *list_tmp;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104     <span class="keywordflow">if</span> (!assistant)
<a name="l01105"></a>01105     <span class="keywordflow">return</span> FALSE;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107     <span class="comment">/* Initial page is fourth. */</span>
<a name="l01108"></a>01108     page = <a class="code" href="import_8c.html#afc0bab97fcba28239c323fa850dabac1ad7f5183fac1b068b43870a3ba511e2cb">IMPORT_FIRST_ACCOUNT_PAGE</a>;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110     <span class="comment">/* First, iter to see if we need to create currencies */</span>
<a name="l01111"></a>01111     list_tmp = liste_comptes_importes;
<a name="l01112"></a>01112     <span class="keywordflow">while</span> ( list_tmp )
<a name="l01113"></a>01113     {
<a name="l01114"></a>01114     <span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * compte;
<a name="l01115"></a>01115     compte = list_tmp -&gt; data;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117     <span class="comment">/* add one page per account */</span>
<a name="l01118"></a>01118     <a class="code" href="gsb__assistant_8c.html#a6972bde2415e07b7afb35a062456f129">gsb_assistant_add_page</a> ( assistant, cree_ligne_recapitulatif ( list_tmp -&gt; data ),
<a name="l01119"></a>01119                         page, page - 1, page + 1, G_CALLBACK ( NULL ) );
<a name="l01120"></a>01120     page ++;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     list_tmp = list_tmp -&gt; next;
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">/* And final page */</span>
<a name="l01126"></a>01126     <a class="code" href="gsb__assistant_8c.html#a6972bde2415e07b7afb35a062456f129">gsb_assistant_add_page</a> ( assistant, import_create_final_page ( assistant ),
<a name="l01127"></a>01127                         page, page - 1, -1, G_CALLBACK ( NULL ) );
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     <span class="comment">/* Replace button. */</span>
<a name="l01130"></a>01130     <a class="code" href="gsb__assistant_8c.html#af9667499ec49ad50593c8662801d4a9c">gsb_assistant_change_button_next</a> ( assistant, GTK_STOCK_GO_FORWARD, GTK_RESPONSE_YES );
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <span class="keywordflow">return</span> ( FALSE );
<a name="l01133"></a>01133 }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 
<a name="l01141"></a>01141 GtkWidget *cree_ligne_recapitulatif ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * compte )
<a name="l01142"></a>01142 {
<a name="l01143"></a>01143     GtkWidget * vbox, * hbox, * label, * radio, * radio_add_account,* radiogroup;
<a name="l01144"></a>01144     GtkWidget * <a class="code" href="structures_8h.html#a1de17aeac7cb885573d40a996aff3306">alignement</a>;
<a name="l01145"></a>01145     gchar * short_filename;
<a name="l01146"></a>01146     gint size = 0, spacing = 0;
<a name="l01147"></a>01147     gint account_number;
<a name="l01148"></a>01148     GtkWidget *button;
<a name="l01149"></a>01149     gchar* tmpstr;
<a name="l01150"></a>01150 
<a name="l01151"></a>01151     vbox = gtk_vbox_new ( FALSE, 6 );
<a name="l01152"></a>01152     gtk_container_set_border_width ( GTK_CONTAINER(vbox), 12 );
<a name="l01153"></a>01153 
<a name="l01154"></a>01154     <span class="keywordflow">if</span> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a251887d1a77ba7cd4cb99759fc1e9bed">filename</a> )
<a name="l01155"></a>01155     short_filename = g_path_get_basename (compte -&gt; <a class="code" href="structstruct__compte__importation.html#a251887d1a77ba7cd4cb99759fc1e9bed">filename</a>);
<a name="l01156"></a>01156     <span class="keywordflow">else</span>
<a name="l01157"></a>01157     {
<a name="l01158"></a>01158     <span class="keywordflow">if</span> (compte -&gt; <a class="code" href="structstruct__compte__importation.html#ae8d33c742956a6b9b668c6d3f291e4db">real_filename</a>)
<a name="l01159"></a>01159         short_filename = g_path_get_basename (compte -&gt; <a class="code" href="structstruct__compte__importation.html#ae8d33c742956a6b9b668c6d3f291e4db">real_filename</a>);
<a name="l01160"></a>01160     <span class="keywordflow">else</span>
<a name="l01161"></a>01161         short_filename = g_strdup (_(<span class="stringliteral">&quot;file&quot;</span>));
<a name="l01162"></a>01162     }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164     label = gtk_label_new ( NULL );
<a name="l01165"></a>01165     gtk_misc_set_alignment ( GTK_MISC ( label ), 0, 0.5);
<a name="l01166"></a>01166     gtk_label_set_justify ( GTK_LABEL ( label ), GTK_JUSTIFY_LEFT );
<a name="l01167"></a>01167     tmpstr = g_markup_printf_escaped ( _(<span class="stringliteral">&quot;&lt;span size=\&quot;x-large\&quot;&gt;%s&lt;/span&gt;\n\n&quot;</span>
<a name="l01168"></a>01168                         <span class="stringliteral">&quot;What do you want to do with contents from &lt;span &quot;</span>
<a name="l01169"></a>01169                         <span class="stringliteral">&quot;foreground=\&quot;blue\&quot;&gt;%s&lt;/span&gt; ?\n&quot;</span>),
<a name="l01170"></a>01170                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a>, short_filename );
<a name="l01171"></a>01171     gtk_label_set_markup ( GTK_LABEL ( label ), tmpstr );
<a name="l01172"></a>01172     g_free ( tmpstr );
<a name="l01173"></a>01173     g_free (short_filename);
<a name="l01174"></a>01174     gtk_box_pack_start ( GTK_BOX ( vbox ), label, FALSE, FALSE, 0 );
<a name="l01175"></a>01175 
<a name="l01176"></a>01176     <span class="comment">/* New account */</span>
<a name="l01177"></a>01177     radio = gtk_radio_button_new_with_label ( NULL, _(<span class="stringliteral">&quot;Create a new account&quot;</span>) );
<a name="l01178"></a>01178     radiogroup = radio;
<a name="l01179"></a>01179     gtk_box_pack_start ( GTK_BOX ( vbox ), radio, FALSE, FALSE, 0 );
<a name="l01180"></a>01180     gtk_widget_style_get (radio, <span class="stringliteral">&quot;indicator_size&quot;</span>, &amp;size, NULL);
<a name="l01181"></a>01181     gtk_widget_style_get (radio, <span class="stringliteral">&quot;indicator_spacing&quot;</span>, &amp;spacing, NULL);
<a name="l01182"></a>01182 
<a name="l01183"></a>01183     compte -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a> = gtk_hbox_new ( FALSE, 6 );
<a name="l01184"></a>01184     gtk_box_pack_start ( GTK_BOX ( vbox ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a>, FALSE, FALSE, 0 );
<a name="l01185"></a>01185     label = gtk_label_new ( <a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a> ( _(<span class="stringliteral">&quot;Account type&quot;</span>) ) );
<a name="l01186"></a>01186     alignement = gtk_alignment_new ( 0.5, 0.5, 1, 1 );
<a name="l01187"></a>01187     gtk_container_set_border_width ( GTK_CONTAINER ( alignement ), 2 );
<a name="l01188"></a>01188     gtk_alignment_set_padding ( GTK_ALIGNMENT ( alignement ), 0, 0, 2 * spacing + size, 0 );
<a name="l01189"></a>01189     gtk_container_add ( GTK_CONTAINER ( alignement ), label );
<a name="l01190"></a>01190     gtk_box_pack_start ( GTK_BOX ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a> ), alignement, FALSE, FALSE, 0 );
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     compte -&gt; <a class="code" href="structstruct__compte__importation.html#aeb1267b8ebbe8d35b5cdcbe20c754028">bouton_type_compte</a> = <a class="code" href="gsb__combo__box_8c.html#aaa528158307654e8a321fbaaf07cd349">gsb_combo_box_new_with_index_by_list</a> (
<a name="l01193"></a>01193                         <a class="code" href="gsb__account__property_8c.html#ade6600516c1245dbeb1b249db4692a57">gsb_account_property_create_combobox_list</a> (),
<a name="l01194"></a>01194                         NULL, NULL );
<a name="l01195"></a>01195     gtk_box_pack_start ( GTK_BOX ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a> ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#aeb1267b8ebbe8d35b5cdcbe20c754028">bouton_type_compte</a>,
<a name="l01196"></a>01196                         TRUE, TRUE, 0 );
<a name="l01197"></a>01197 
<a name="l01198"></a>01198     <span class="comment">/* at this level imported_account -&gt; type_de_compte was filled while importing transactions,</span>
<a name="l01199"></a>01199 <span class="comment">     * in qif.c or ofx.c ; but we have only 4 kind of account for now, so try to place the combobox correctly</span>
<a name="l01200"></a>01200 <span class="comment">     * and it&#39;s the user who will choose the kind of account */</span>
<a name="l01201"></a>01201     <span class="keywordflow">switch</span> (compte -&gt; <a class="code" href="structstruct__compte__importation.html#a36a0a4246c032137dfe0f526cc98e21a">type_de_compte</a>)
<a name="l01202"></a>01202     {
<a name="l01203"></a>01203     <span class="keywordflow">case</span> 3:
<a name="l01204"></a>01204         <a class="code" href="gsb__combo__box_8c.html#a8d9cde44f97483d1e2ebe3c6c65f5570">gsb_combo_box_set_index</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aeb1267b8ebbe8d35b5cdcbe20c754028">bouton_type_compte</a>,
<a name="l01205"></a>01205                         <a class="code" href="gsb__data__account_8h.html#ab5b2ad5b1ac065827dcf65b09542f53dad80fd01815f2d74aecc46cad959a3da9">GSB_TYPE_LIABILITIES</a> );
<a name="l01206"></a>01206         <span class="keywordflow">break</span>;
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     <span class="keywordflow">case</span> 7:
<a name="l01209"></a>01209         <a class="code" href="gsb__combo__box_8c.html#a8d9cde44f97483d1e2ebe3c6c65f5570">gsb_combo_box_set_index</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aeb1267b8ebbe8d35b5cdcbe20c754028">bouton_type_compte</a>,
<a name="l01210"></a>01210                         <a class="code" href="gsb__data__account_8h.html#ab5b2ad5b1ac065827dcf65b09542f53da1e355ad8c560d892d0b5912be1d875a2">GSB_TYPE_CASH</a> );
<a name="l01211"></a>01211         <span class="keywordflow">break</span>;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="keywordflow">default</span>:
<a name="l01214"></a>01214         <a class="code" href="gsb__combo__box_8c.html#a8d9cde44f97483d1e2ebe3c6c65f5570">gsb_combo_box_set_index</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aeb1267b8ebbe8d35b5cdcbe20c754028">bouton_type_compte</a>,
<a name="l01215"></a>01215                         <a class="code" href="gsb__data__account_8h.html#ab5b2ad5b1ac065827dcf65b09542f53da718d20004be845980da235b81c70f72a">GSB_TYPE_BANK</a> );
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     g_object_set_data ( G_OBJECT ( radio ), <span class="stringliteral">&quot;associated&quot;</span>, compte -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a> );
<a name="l01219"></a>01219     g_object_set_data ( G_OBJECT ( radio ), <span class="stringliteral">&quot;account&quot;</span>, compte );
<a name="l01220"></a>01220     g_signal_connect ( G_OBJECT ( radio ), <span class="stringliteral">&quot;toggled&quot;</span>,
<a name="l01221"></a>01221                         G_CALLBACK ( import_account_action_activated ), <a class="code" href="import_8h.html#ad9e4b45dec9fbedb5154906d8a5cfc47">IMPORT_CREATE_ACCOUNT</a> );
<a name="l01222"></a>01222 
<a name="l01223"></a>01223     <span class="comment">/* Add to account */</span>
<a name="l01224"></a>01224     radio_add_account = gtk_radio_button_new_with_label_from_widget ( GTK_RADIO_BUTTON ( radiogroup ),
<a name="l01225"></a>01225                         _(<span class="stringliteral">&quot;Add transactions to an account&quot;</span>) );
<a name="l01226"></a>01226     gtk_box_pack_start ( GTK_BOX ( vbox ), radio_add_account, FALSE, FALSE, 0 );
<a name="l01227"></a>01227     <span class="keywordflow">if</span> (radio_add_account &amp;&amp; GTK_WIDGET_VISIBLE (radio_add_account))
<a name="l01228"></a>01228         gtk_widget_set_sensitive  ( radio_add_account, <a class="code" href="utils_8c.html#a201366e3a41e970cd3009d8b5d7afdd0">assert_account_loaded</a> ( ) );
<a name="l01229"></a>01229 
<a name="l01230"></a>01230     compte -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a> = gtk_hbox_new ( FALSE, 6 );
<a name="l01231"></a>01231     gtk_box_pack_start ( GTK_BOX ( vbox ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a>, FALSE, FALSE, 0 );
<a name="l01232"></a>01232     label = gtk_label_new ( <a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a> ( _(<span class="stringliteral">&quot;Account name&quot;</span>) ) );
<a name="l01233"></a>01233     alignement = gtk_alignment_new ( 0.5, 0.5, 1, 1 );
<a name="l01234"></a>01234     gtk_container_set_border_width ( GTK_CONTAINER ( alignement ), 2 );
<a name="l01235"></a>01235     gtk_alignment_set_padding ( GTK_ALIGNMENT ( alignement ), 0, 0, 2 * spacing + size, 0 );
<a name="l01236"></a>01236     gtk_container_add ( GTK_CONTAINER ( alignement ), label );
<a name="l01237"></a>01237     gtk_box_pack_start ( GTK_BOX ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a> ), alignement, FALSE, FALSE, 0 );
<a name="l01238"></a>01238 
<a name="l01239"></a>01239     compte -&gt; <a class="code" href="structstruct__compte__importation.html#aae36436487430bfade72e24031f2feb0">bouton_compte_add</a> = <a class="code" href="gsb__account_8c.html#a252b9f3c12c50f00a1d1db3e4321460c">gsb_account_create_combo_list</a> (NULL, NULL, FALSE);
<a name="l01240"></a>01240     gtk_box_pack_start ( GTK_BOX ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a> ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#aae36436487430bfade72e24031f2feb0">bouton_compte_add</a>, TRUE, TRUE, 0 );
<a name="l01241"></a>01241     gtk_widget_set_sensitive ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a>, FALSE );
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     g_object_set_data ( G_OBJECT ( radio_add_account ), <span class="stringliteral">&quot;associated&quot;</span>, compte -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a> );
<a name="l01244"></a>01244     g_object_set_data ( G_OBJECT ( radio_add_account ), <span class="stringliteral">&quot;account&quot;</span>, compte );
<a name="l01245"></a>01245     g_signal_connect ( G_OBJECT ( radio_add_account ), <span class="stringliteral">&quot;toggled&quot;</span>,
<a name="l01246"></a>01246                         G_CALLBACK ( import_account_action_activated ), 
<a name="l01247"></a>01247                         GINT_TO_POINTER (<a class="code" href="import_8h.html#ab305602f6b5404b42e8d2789aaff3885">IMPORT_ADD_TRANSACTIONS</a>));
<a name="l01248"></a>01248 
<a name="l01249"></a>01249     <span class="comment">/* Mark account */</span>
<a name="l01250"></a>01250     radio = gtk_radio_button_new_with_label_from_widget ( GTK_RADIO_BUTTON ( radiogroup ),
<a name="l01251"></a>01251                         _(<span class="stringliteral">&quot;Mark transactions of an account&quot;</span>) );
<a name="l01252"></a>01252     gtk_box_pack_start ( GTK_BOX ( vbox ), radio, FALSE, FALSE, 0 );
<a name="l01253"></a>01253     gtk_widget_set_sensitive  ( radio, <a class="code" href="utils_8c.html#a201366e3a41e970cd3009d8b5d7afdd0">assert_account_loaded</a> ( ) );
<a name="l01254"></a>01254 
<a name="l01255"></a>01255     compte -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a> = gtk_hbox_new ( FALSE, 6 );
<a name="l01256"></a>01256     gtk_box_pack_start ( GTK_BOX ( vbox ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a>, FALSE, FALSE, 0 );
<a name="l01257"></a>01257     label = gtk_label_new ( <a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a> ( _(<span class="stringliteral">&quot;Account name&quot;</span>) ) );
<a name="l01258"></a>01258     alignement = gtk_alignment_new ( 0.5, 0.5, 1, 1 );
<a name="l01259"></a>01259     gtk_container_set_border_width ( GTK_CONTAINER ( alignement ), 2 );
<a name="l01260"></a>01260     gtk_alignment_set_padding ( GTK_ALIGNMENT ( alignement ), 0, 0, 2 * spacing + size, 0 );
<a name="l01261"></a>01261     gtk_container_add ( GTK_CONTAINER ( alignement ), label );
<a name="l01262"></a>01262     gtk_box_pack_start ( GTK_BOX ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a> ), alignement, FALSE, FALSE, 0 );
<a name="l01263"></a>01263 
<a name="l01264"></a>01264     compte -&gt; <a class="code" href="structstruct__compte__importation.html#aa29a9309c5ed724e203778ef76f4d5d5">bouton_compte_mark</a> = <a class="code" href="gsb__account_8c.html#a252b9f3c12c50f00a1d1db3e4321460c">gsb_account_create_combo_list</a> (NULL, NULL, FALSE);
<a name="l01265"></a>01265     gtk_box_pack_start ( GTK_BOX ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a> ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#aa29a9309c5ed724e203778ef76f4d5d5">bouton_compte_mark</a>, TRUE, TRUE, 0 );
<a name="l01266"></a>01266     gtk_widget_set_sensitive ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a>, FALSE );
<a name="l01267"></a>01267 
<a name="l01268"></a>01268     g_object_set_data ( G_OBJECT ( radio ), <span class="stringliteral">&quot;associated&quot;</span>, compte -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a> );
<a name="l01269"></a>01269     g_object_set_data ( G_OBJECT ( radio ), <span class="stringliteral">&quot;account&quot;</span>, compte );
<a name="l01270"></a>01270     g_signal_connect ( G_OBJECT ( radio ), <span class="stringliteral">&quot;toggled&quot;</span>,
<a name="l01271"></a>01271                         G_CALLBACK ( import_account_action_activated ), 
<a name="l01272"></a>01272                         GINT_TO_POINTER (<a class="code" href="import_8h.html#ac9f1610298b18bf7ca81eb1ac4974629">IMPORT_MARK_TRANSACTIONS</a>));
<a name="l01273"></a>01273 
<a name="l01274"></a>01274         <span class="comment">/* set on the right account */</span>
<a name="l01275"></a>01275     account_number = <a class="code" href="gsb__data__account_8c.html#a21d9c5bea7d663331fb47a1852748c5e">gsb_data_account_get_account_by_id</a> ( compte-&gt;<a class="code" href="structstruct__compte__importation.html#a98f4d0a1bbbb5dd69fb25e6a4fdb477b">id_compte</a> );
<a name="l01276"></a>01276     <span class="keywordflow">if</span> ( account_number &gt;= 0 )
<a name="l01277"></a>01277     {
<a name="l01278"></a>01278         import_account_action_activated ( radio_add_account,<a class="code" href="import_8h.html#ab305602f6b5404b42e8d2789aaff3885">IMPORT_ADD_TRANSACTIONS</a> );
<a name="l01279"></a>01279         gtk_toggle_button_set_active ( GTK_TOGGLE_BUTTON ( radio_add_account ), TRUE );
<a name="l01280"></a>01280 
<a name="l01281"></a>01281                 <a class="code" href="gsb__account_8c.html#a7e2153dff1b7f36dd035c01a0e6bf25a">gsb_account_set_combo_account_number</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aae36436487430bfade72e24031f2feb0">bouton_compte_add</a>, account_number );
<a name="l01282"></a>01282         <a class="code" href="gsb__account_8c.html#a7e2153dff1b7f36dd035c01a0e6bf25a">gsb_account_set_combo_account_number</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aa29a9309c5ed724e203778ef76f4d5d5">bouton_compte_mark</a>, account_number );
<a name="l01283"></a>01283     }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285     <span class="comment">/* Currency */</span>
<a name="l01286"></a>01286     hbox = gtk_hbox_new ( FALSE, 6 );
<a name="l01287"></a>01287     label = gtk_label_new ( <a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a> ( _(<span class="stringliteral">&quot;Account currency&quot;</span>) ) );
<a name="l01288"></a>01288     gtk_box_pack_start ( GTK_BOX ( hbox ), label, FALSE, FALSE, 0 );
<a name="l01289"></a>01289     gtk_box_pack_start ( GTK_BOX ( vbox ), hbox, FALSE, FALSE, 0 );
<a name="l01290"></a>01290 
<a name="l01291"></a>01291     compte -&gt; <a class="code" href="structstruct__compte__importation.html#aea1b3ea4a0ba7aa24da4851e96ce1002">bouton_devise</a> = <a class="code" href="gsb__currency_8c.html#ad0c6f15f859f45a94923fa743d81f5b5">gsb_currency_make_combobox</a> ( TRUE );
<a name="l01292"></a>01292 
<a name="l01293"></a>01293     <span class="comment">/* create the currency if doesn&#39;t exist */</span>
<a name="l01294"></a>01294     <span class="keywordflow">if</span> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a1b5632b0fd43c57a888151bbb68de21e">devise</a> )
<a name="l01295"></a>01295     {
<a name="l01296"></a>01296         gint currency_number;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298         <span class="comment">/* First, we search currency from ISO4217 code for existing currencies */</span>
<a name="l01299"></a>01299         currency_number = <a class="code" href="gsb__data__currency_8c.html#ad6f48bd7a2a3533c4be0f5453d2be28b">gsb_data_currency_get_number_by_code_iso4217</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a1b5632b0fd43c57a888151bbb68de21e">devise</a> );
<a name="l01300"></a>01300         <span class="comment">/* Then, by nickname for existing currencies */</span>
<a name="l01301"></a>01301         <span class="keywordflow">if</span> ( !currency_number )
<a name="l01302"></a>01302         {
<a name="l01303"></a>01303             currency_number = gsb_import_add_currency ( compte );
<a name="l01304"></a>01304             <span class="keywordflow">if</span> ( currency_number == 0 )
<a name="l01305"></a>01305                 currency_number = <a class="code" href="gsb__data__currency_8c.html#a07a3bca074a1181fd741e4bb4ef1581b">gsb_data_currency_get_number_by_name</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#a1b5632b0fd43c57a888151bbb68de21e">devise</a> );
<a name="l01306"></a>01306         }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308         <span class="keywordflow">if</span> ( currency_number )
<a name="l01309"></a>01309             <a class="code" href="gsb__currency_8c.html#a8774e282bad3c3101b161fd54bcb660a">gsb_currency_set_combobox_history</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aea1b3ea4a0ba7aa24da4851e96ce1002">bouton_devise</a>,
<a name="l01310"></a>01310                         currency_number );
<a name="l01311"></a>01311         <span class="keywordflow">else</span>
<a name="l01312"></a>01312             currency_number = gsb_import_add_currency ( compte );
<a name="l01313"></a>01313     }
<a name="l01314"></a>01314 
<a name="l01315"></a>01315     gtk_box_pack_start ( GTK_BOX ( hbox ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#aea1b3ea4a0ba7aa24da4851e96ce1002">bouton_devise</a>, FALSE, FALSE, 0 );
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <span class="comment">/* invert amount of transactions */</span>
<a name="l01318"></a>01318     button = <a class="code" href="gsb__automem_8c.html#ad32c3b7a4ae54cbe312fe4e1ee22e10f">gsb_automem_checkbutton_new</a> (_(<span class="stringliteral">&quot;Invert the amount of the imported transactions&quot;</span>),
<a name="l01319"></a>01319                         &amp;compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0f636d05dd8412ef76fe29b93349dcce">invert_transaction_amount</a>, NULL, NULL);
<a name="l01320"></a>01320     gtk_box_pack_start ( GTK_BOX ( vbox ), button, FALSE, FALSE, 0 );
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     <span class="comment">/* propose to create a rule */</span>
<a name="l01323"></a>01323     compte -&gt; <a class="code" href="structstruct__compte__importation.html#abc9c9bafb88d9ad438ec22e9bb90c2b9">hbox_rule</a> = gtk_hbox_new (FALSE, 5);
<a name="l01324"></a>01324     gtk_box_pack_start ( GTK_BOX ( vbox ), compte -&gt; <a class="code" href="structstruct__compte__importation.html#abc9c9bafb88d9ad438ec22e9bb90c2b9">hbox_rule</a>, FALSE, FALSE, 0 );
<a name="l01325"></a>01325     compte -&gt; <a class="code" href="structstruct__compte__importation.html#a58f4a96d0afb16f16f615c729250a94a">entry_name_rule</a> = gtk_entry_new ();
<a name="l01326"></a>01326     button = <a class="code" href="gsb__automem_8c.html#ad32c3b7a4ae54cbe312fe4e1ee22e10f">gsb_automem_checkbutton_new</a> (_(<span class="stringliteral">&quot;Create a rule for this import. Name of the rule : &quot;</span>),
<a name="l01327"></a>01327                         &amp;compte -&gt; <a class="code" href="structstruct__compte__importation.html#a7d24f424b8216b1ecfbbde5af6e42e1d">create_rule</a>, G_CALLBACK (
<a name="l01328"></a>01328                         <a class="code" href="utils__buttons_8c.html#ad3fabcee0e67c73921725cf708b29be1">gsb_button_sensitive_by_checkbutton</a>),
<a name="l01329"></a>01329                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a58f4a96d0afb16f16f615c729250a94a">entry_name_rule</a>);
<a name="l01330"></a>01330     gtk_box_pack_start ( GTK_BOX (compte -&gt; <a class="code" href="structstruct__compte__importation.html#abc9c9bafb88d9ad438ec22e9bb90c2b9">hbox_rule</a>), button, FALSE, FALSE, 0 );
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     <span class="comment">/* we can create a rule only for qif or ofx */</span>
<a name="l01333"></a>01333     <span class="keywordflow">if</span> (strcmp (compte -&gt; <a class="code" href="structstruct__compte__importation.html#adac142c3810e741372cf8df90774662c">origine</a>, <span class="stringliteral">&quot;QIF&quot;</span>) &amp;&amp; strcmp (compte -&gt; <a class="code" href="structstruct__compte__importation.html#adac142c3810e741372cf8df90774662c">origine</a>, <span class="stringliteral">&quot;OFX&quot;</span>))
<a name="l01334"></a>01334     gtk_widget_set_sensitive (button, FALSE);
<a name="l01335"></a>01335 
<a name="l01336"></a>01336     gtk_widget_set_sensitive (compte -&gt; <a class="code" href="structstruct__compte__importation.html#a58f4a96d0afb16f16f615c729250a94a">entry_name_rule</a>, FALSE);
<a name="l01337"></a>01337     gtk_box_pack_start ( GTK_BOX (compte -&gt; <a class="code" href="structstruct__compte__importation.html#abc9c9bafb88d9ad438ec22e9bb90c2b9">hbox_rule</a>), 
<a name="l01338"></a>01338                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a58f4a96d0afb16f16f615c729250a94a">entry_name_rule</a>, FALSE, FALSE, 0 );
<a name="l01339"></a>01339 
<a name="l01340"></a>01340     <span class="keywordflow">return</span> vbox;
<a name="l01341"></a>01341 }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343 
<a name="l01349"></a>01349 gint gsb_import_add_currency ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * compte )
<a name="l01350"></a>01350 {
<a name="l01351"></a>01351     GtkWidget *vbox, *checkbox, *dialog;
<a name="l01352"></a>01352     gint response;
<a name="l01353"></a>01353     gchar *tmpstr;
<a name="l01354"></a>01354     gchar *tmpstr2;
<a name="l01355"></a>01355     gchar *text;
<a name="l01356"></a>01356     gint currency_number = 0;
<a name="l01357"></a>01357 
<a name="l01358"></a>01358     tmpstr = g_strdup_printf ( 
<a name="l01359"></a>01359                         _(<span class="stringliteral">&quot;The account currency imported %s is %s.\nThis currency &quot;</span>
<a name="l01360"></a>01360                         <span class="stringliteral">&quot;doesn&#39;t exist so you have to create it by selecting OK.\n&quot;</span>
<a name="l01361"></a>01361                         <span class="stringliteral">&quot;\n&quot;</span>
<a name="l01362"></a>01362                         <span class="stringliteral">&quot;Do you create it ?&quot;</span>),
<a name="l01363"></a>01363                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a>,
<a name="l01364"></a>01364                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a1b5632b0fd43c57a888151bbb68de21e">devise</a> );
<a name="l01365"></a>01365     tmpstr2 = g_strdup_printf ( 
<a name="l01366"></a>01366                         _(<span class="stringliteral">&quot;Can&#39;t associate ISO 4217 code for currency &#39;%s&#39;.&quot;</span>),
<a name="l01367"></a>01367                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a1b5632b0fd43c57a888151bbb68de21e">devise</a> );
<a name="l01368"></a>01368     text = <a class="code" href="dialog_8c.html#a84758de40aa2807a4e5ebd97ede7df23">make_hint</a> ( tmpstr2, tmpstr );
<a name="l01369"></a>01369     g_free ( tmpstr );
<a name="l01370"></a>01370     g_free ( tmpstr2 );
<a name="l01371"></a>01371 
<a name="l01372"></a>01372     dialog = gtk_message_dialog_new ( GTK_WINDOW ( <a class="code" href="accueil_8c.html#a3d346c08cf2d67c388caabffb412b293">window</a> ),
<a name="l01373"></a>01373                         GTK_DIALOG_DESTROY_WITH_PARENT,
<a name="l01374"></a>01374                         GTK_MESSAGE_QUESTION,
<a name="l01375"></a>01375                         GTK_BUTTONS_YES_NO,
<a name="l01376"></a>01376                         <span class="stringliteral">&quot;%s&quot;</span>, text );
<a name="l01377"></a>01377     gtk_label_set_markup ( GTK_LABEL ( GTK_MESSAGE_DIALOG ( dialog ) -&gt;label ), text );
<a name="l01378"></a>01378 
<a name="l01379"></a>01379     vbox = GTK_DIALOG(dialog) -&gt; vbox;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381     checkbox = gtk_check_button_new_with_label ( 
<a name="l01382"></a>01382                         _(<span class="stringliteral">&quot;Use this currency for totals for the payees categories\n&quot;</span>
<a name="l01383"></a>01383                         <span class="stringliteral">&quot;and budgetary lines&quot;</span>) );
<a name="l01384"></a>01384     gtk_box_pack_start ( GTK_BOX ( vbox ), checkbox, TRUE, TRUE, 6 );
<a name="l01385"></a>01385 
<a name="l01386"></a>01386     gtk_widget_show_all ( checkbox );
<a name="l01387"></a>01387     gtk_window_set_modal ( GTK_WINDOW ( dialog ), TRUE );
<a name="l01388"></a>01388 
<a name="l01389"></a>01389     response = gtk_dialog_run (GTK_DIALOG (dialog));
<a name="l01390"></a>01390 
<a name="l01391"></a>01391     <span class="keywordflow">if</span> ( response == GTK_RESPONSE_YES
<a name="l01392"></a>01392      &amp;&amp;
<a name="l01393"></a>01393      <a class="code" href="gsb__currency__config_8c.html#ad50f95efd36cc02e06d28e54a52f70b9">gsb_currency_config_add_currency</a> ( NULL, NULL ) )
<a name="l01394"></a>01394     {
<a name="l01395"></a>01395         currency_number = <a class="code" href="gsb__data__currency_8c.html#ad6f48bd7a2a3533c4be0f5453d2be28b">gsb_data_currency_get_number_by_code_iso4217</a> (
<a name="l01396"></a>01396                         compte -&gt; <a class="code" href="structstruct__compte__importation.html#a1b5632b0fd43c57a888151bbb68de21e">devise</a> );
<a name="l01397"></a>01397         <span class="keywordflow">if</span> ( gtk_toggle_button_get_active ( GTK_TOGGLE_BUTTON ( checkbox ) ) )
<a name="l01398"></a>01398         {
<a name="l01399"></a>01399             <a class="code" href="gsb__currency__config_8c.html#a3add720d0e0b25caa37589bcfb879c6f">no_devise_totaux_tiers</a> = currency_number;
<a name="l01400"></a>01400             <a class="code" href="categories__onglet_8c.html#a8f609654dcfbbcaa6791bcee83d6473d">no_devise_totaux_categ</a> = currency_number;
<a name="l01401"></a>01401             <a class="code" href="gsb__currency__config_8c.html#a2f4b5073521c582e1bc8941533026556">no_devise_totaux_ib</a> = currency_number;
<a name="l01402"></a>01402         }
<a name="l01403"></a>01403     }
<a name="l01404"></a>01404     gtk_widget_destroy ( dialog );
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     <span class="keywordflow">return</span> currency_number;
<a name="l01407"></a>01407 }
<a name="l01408"></a>01408 
<a name="l01409"></a>01409 
<a name="l01414"></a>01414 gboolean import_account_action_activated ( GtkWidget * radio, gint <a class="code" href="structstruct__compte__importation.html#a0393a47e80bf0f244d22c17c20be31c6">action</a> )
<a name="l01415"></a>01415 {
<a name="l01416"></a>01416     <span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * account;
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     account = g_object_get_data ( G_OBJECT ( radio ), <span class="stringliteral">&quot;account&quot;</span> );
<a name="l01419"></a>01419 
<a name="l01420"></a>01420     <span class="keywordflow">if</span> (account -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a> &amp;&amp; GTK_WIDGET_VISIBLE (account -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a>))
<a name="l01421"></a>01421         gtk_widget_set_sensitive ( account -&gt; <a class="code" href="structstruct__compte__importation.html#a5bf56c845b4b614f2ff708a93725ca28">hbox1</a>, FALSE );
<a name="l01422"></a>01422     <span class="keywordflow">if</span> (account -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a> &amp;&amp; GTK_WIDGET_VISIBLE (account -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a>))
<a name="l01423"></a>01423         gtk_widget_set_sensitive ( account -&gt; <a class="code" href="structstruct__compte__importation.html#a2fcc401a65dab09ef1c70e95a86371a7">hbox2</a>, FALSE );
<a name="l01424"></a>01424     <span class="keywordflow">if</span> (account -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a> &amp;&amp; GTK_WIDGET_VISIBLE (account -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a>))
<a name="l01425"></a>01425         gtk_widget_set_sensitive ( account -&gt; <a class="code" href="structstruct__compte__importation.html#a8262f71d590e76596af72da501edd71f">hbox3</a>, FALSE );
<a name="l01426"></a>01426     gtk_widget_set_sensitive ( g_object_get_data ( G_OBJECT ( radio ), <span class="stringliteral">&quot;associated&quot;</span> ), TRUE );
<a name="l01427"></a>01427 
<a name="l01428"></a>01428     account -&gt; action = action;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430     <span class="keywordflow">if</span> ( account -&gt; <a class="code" href="structstruct__compte__importation.html#abc9c9bafb88d9ad438ec22e9bb90c2b9">hbox_rule</a> &amp;&amp; GTK_WIDGET_VISIBLE (account -&gt; <a class="code" href="structstruct__compte__importation.html#abc9c9bafb88d9ad438ec22e9bb90c2b9">hbox_rule</a>) )
<a name="l01431"></a>01431         gtk_widget_set_sensitive ( account -&gt; <a class="code" href="structstruct__compte__importation.html#abc9c9bafb88d9ad438ec22e9bb90c2b9">hbox_rule</a>, action != <a class="code" href="import_8h.html#ad9e4b45dec9fbedb5154906d8a5cfc47">IMPORT_CREATE_ACCOUNT</a> );
<a name="l01432"></a>01432     <span class="keywordflow">return</span> FALSE;
<a name="l01433"></a>01433 }
<a name="l01434"></a>01434 
<a name="l01435"></a>01435 
<a name="l01445"></a>01445 <span class="keywordtype">void</span> traitement_operations_importees ( <span class="keywordtype">void</span> )
<a name="l01446"></a>01446 {
<a name="l01447"></a>01447     GSList *list_tmp;
<a name="l01448"></a>01448     gint new_file;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     <span class="comment">/* when come here, all the currencies are already created</span>
<a name="l01451"></a>01451 <span class="comment">     * and init_variables is already called</span>
<a name="l01452"></a>01452 <span class="comment">     * ( see affichage_recapitulatif_importation) */</span>
<a name="l01453"></a>01453 
<a name="l01454"></a>01454     <span class="comment">/* if new file, init grisbi */</span>
<a name="l01455"></a>01455     <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__account_8c.html#a56c9a589563db8c15800e41378908b27">gsb_data_account_get_accounts_amount</a> () )
<a name="l01456"></a>01456     new_file = 0;
<a name="l01457"></a>01457     <span class="keywordflow">else</span>
<a name="l01458"></a>01458     {
<a name="l01459"></a>01459     <span class="comment">/* Create initial lists. */</span>
<a name="l01460"></a>01460     new_file = 1;
<a name="l01461"></a>01461     }
<a name="l01462"></a>01462 
<a name="l01463"></a>01463     <span class="comment">/* for now, no marked transactions imported */</span>
<a name="l01464"></a>01464     marked_r_transactions_imported = FALSE;
<a name="l01465"></a>01465 
<a name="l01466"></a>01466     <span class="comment">/* go throw the accounts and do what is asked */</span>
<a name="l01467"></a>01467     list_tmp = liste_comptes_importes;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <span class="keywordflow">while</span> ( list_tmp )
<a name="l01470"></a>01470     {
<a name="l01471"></a>01471     <span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *compte;
<a name="l01472"></a>01472     gint account_number = 0;
<a name="l01473"></a>01473 
<a name="l01474"></a>01474     compte = list_tmp -&gt; data;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476     <span class="keywordflow">switch</span> ( compte -&gt; action )
<a name="l01477"></a>01477     {
<a name="l01478"></a>01478         <span class="keywordflow">case</span> <a class="code" href="import_8h.html#ad9e4b45dec9fbedb5154906d8a5cfc47">IMPORT_CREATE_ACCOUNT</a>:
<a name="l01479"></a>01479         account_number = gsb_import_create_imported_account ( compte );
<a name="l01480"></a>01480 
<a name="l01481"></a>01481         <span class="keywordflow">if</span> ( account_number == -1 )
<a name="l01482"></a>01482         {
<a name="l01483"></a>01483             gchar* tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;An error occured while creating the new &quot;</span>
<a name="l01484"></a>01484                                                 <span class="stringliteral">&quot;account %s,\nWe try to continue to import &quot;</span>
<a name="l01485"></a>01485                                                 <span class="stringliteral">&quot;but bad things can happen...&quot;</span>),
<a name="l01486"></a>01486                                                 compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a>);
<a name="l01487"></a>01487             <a class="code" href="dialog_8c.html#aa88d9d93c78818a177e9a14eff15f360">dialogue_error</a> ( tmpstr);
<a name="l01488"></a>01488             g_free ( tmpstr );
<a name="l01489"></a>01489             <span class="keywordflow">continue</span>;
<a name="l01490"></a>01490         }
<a name="l01491"></a>01491 
<a name="l01492"></a>01492         <span class="comment">/* the next functions will add the transaction to the tree view list</span>
<a name="l01493"></a>01493 <span class="comment">         * so if we create a new file, we need to finish the gui here to append</span>
<a name="l01494"></a>01494 <span class="comment">         * the transactions */</span>
<a name="l01495"></a>01495         <span class="keywordflow">if</span> (new_file)
<a name="l01496"></a>01496         {
<a name="l01497"></a>01497             <span class="comment">/* this should be the same as the end of gsb_file_new */</span>
<a name="l01498"></a>01498             <span class="comment">/* init the gui */</span>
<a name="l01499"></a>01499             <a class="code" href="gsb__file_8c.html#a6905aa328e960638de7ede0c72e89d32">gsb_file_new_gui</a> ();
<a name="l01500"></a>01500 
<a name="l01501"></a>01501             new_file = 0;
<a name="l01502"></a>01502         }
<a name="l01503"></a>01503         <span class="keywordflow">else</span>
<a name="l01504"></a>01504             <a class="code" href="navigation_8c.html#acc4cb91805c595677dcc822498171ece">gsb_gui_navigation_add_account</a> ( account_number, FALSE );
<a name="l01505"></a>01505 
<a name="l01506"></a>01506             gsb_import_add_imported_transactions ( compte, account_number );
<a name="l01507"></a>01507         <span class="keywordflow">break</span>;
<a name="l01508"></a>01508 
<a name="l01509"></a>01509         <span class="keywordflow">case</span> <a class="code" href="import_8h.html#ab305602f6b5404b42e8d2789aaff3885">IMPORT_ADD_TRANSACTIONS</a>:
<a name="l01510"></a>01510         account_number = <a class="code" href="gsb__account_8c.html#a8c27c31186134dfd2a9ee5a1ca0b4d2d">gsb_account_get_combo_account_number</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aae36436487430bfade72e24031f2feb0">bouton_compte_add</a> );
<a name="l01511"></a>01511         gsb_import_add_imported_transactions ( compte,account_number);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513         <span class="keywordflow">break</span>;
<a name="l01514"></a>01514 
<a name="l01515"></a>01515         <span class="keywordflow">case</span> <a class="code" href="import_8h.html#ac9f1610298b18bf7ca81eb1ac4974629">IMPORT_MARK_TRANSACTIONS</a>:
<a name="l01516"></a>01516         account_number = <a class="code" href="gsb__account_8c.html#a8c27c31186134dfd2a9ee5a1ca0b4d2d">gsb_account_get_combo_account_number</a> ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#aa29a9309c5ed724e203778ef76f4d5d5">bouton_compte_mark</a> );
<a name="l01517"></a>01517         pointe_opes_importees ( compte, account_number );
<a name="l01518"></a>01518         <a class="code" href="transaction__list_8c.html#aee9667138888c4cb946225cae2972363">transaction_list_update_element</a> (<a class="code" href="gsb__transactions__list_8h.html#ab04a0655cd1e3bcac5e8f48c18df1a57a1c9bb425c66169e4464498e2d76c6f00">ELEMENT_MARK</a>);
<a name="l01519"></a>01519         <span class="keywordflow">break</span>;
<a name="l01520"></a>01520     }
<a name="l01521"></a>01521 
<a name="l01522"></a>01522         <span class="comment">/* MAJ des données du module bet */</span>
<a name="l01523"></a>01523         <a class="code" href="gsb__data__account_8c.html#aad11cfab16ac44e8de3dd6d792fce4cd">gsb_data_account_set_bet_maj</a> ( account_number, <a class="code" href="structures_8h.html#ab021d1439ce505d767a56f4fc41af400a9d574c71c6a04cadf85be9083be54eed">BET_MAJ_ALL</a> );
<a name="l01524"></a>01524 
<a name="l01525"></a>01525     <span class="comment">/* first, we create the rule if asked */</span>
<a name="l01526"></a>01526     <span class="keywordflow">if</span> (compte -&gt; <a class="code" href="structstruct__compte__importation.html#a7d24f424b8216b1ecfbbde5af6e42e1d">create_rule</a> &amp;&amp; compte -&gt; action != <a class="code" href="import_8h.html#ad9e4b45dec9fbedb5154906d8a5cfc47">IMPORT_CREATE_ACCOUNT</a>)
<a name="l01527"></a>01527     {
<a name="l01528"></a>01528         <span class="comment">/* ok, we create the rule */</span>
<a name="l01529"></a>01529         gint rule;
<a name="l01530"></a>01530         <span class="keyword">const</span> gchar *name;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532         name = gtk_entry_get_text (GTK_ENTRY (compte -&gt; <a class="code" href="structstruct__compte__importation.html#a58f4a96d0afb16f16f615c729250a94a">entry_name_rule</a>));
<a name="l01533"></a>01533         <span class="keywordflow">if</span> (!strlen (name))
<a name="l01534"></a>01534         {
<a name="l01535"></a>01535         <span class="comment">/* the user didn&#39;t enter a name, propose now */</span>
<a name="l01536"></a>01536         gchar *tmpstr;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538         tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;You want to create an import rule for the account %s &quot;</span>
<a name="l01539"></a>01539                                      <span class="stringliteral">&quot;but didn&#39;t give a name to that rule. Please set a &quot;</span>
<a name="l01540"></a>01540                                      <span class="stringliteral">&quot;name or let it empty to cancel the rule creation.&quot;</span>),
<a name="l01541"></a>01541                                     <a class="code" href="gsb__data__account_8c.html#a6b0df19868e38619bff512f2c18ef51e">gsb_data_account_get_name</a> (account_number));
<a name="l01542"></a>01542         name = <a class="code" href="dialog_8c.html#a7c2da4f5ed9a9065df01db0464431913">dialogue_hint_with_entry</a> (tmpstr, _(<span class="stringliteral">&quot;No name for the import rule&quot;</span>),
<a name="l01543"></a>01543                                                  _(<span class="stringliteral">&quot;Name of the rule :&quot;</span>));
<a name="l01544"></a>01544         g_free (tmpstr);
<a name="l01545"></a>01545         }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547         <span class="keywordflow">if</span> (!strlen (name))
<a name="l01548"></a>01548         <span class="keywordflow">break</span>;
<a name="l01549"></a>01549 
<a name="l01550"></a>01550         rule = <a class="code" href="gsb__data__import__rule_8c.html#a8d2561f54770ed44cea5192ecdd3d7f6">gsb_data_import_rule_new</a> (name);
<a name="l01551"></a>01551         <a class="code" href="gsb__data__import__rule_8c.html#a08b2dffce7e174d22d7b3edbf5c535db">gsb_data_import_rule_set_account</a> (rule, account_number);
<a name="l01552"></a>01552         <a class="code" href="gsb__data__import__rule_8c.html#aa3b67e78d2abb73c38d2b9373922cf3c">gsb_data_import_rule_set_currency</a> (rule, <a class="code" href="gsb__currency_8c.html#a3abd39af3aafa4213a8ffbe74d5d6b10">gsb_currency_get_currency_from_combobox</a> (compte -&gt; <a class="code" href="structstruct__compte__importation.html#aea1b3ea4a0ba7aa24da4851e96ce1002">bouton_devise</a>));
<a name="l01553"></a>01553         <a class="code" href="gsb__data__import__rule_8c.html#aad4737db8b0a2921574a22e0fcfb1fb5">gsb_data_import_rule_set_invert</a> (rule, compte -&gt; <a class="code" href="structstruct__compte__importation.html#a0f636d05dd8412ef76fe29b93349dcce">invert_transaction_amount</a>);
<a name="l01554"></a>01554         <a class="code" href="gsb__data__import__rule_8c.html#a23233bd23d863d59ebef9c32b3b4f186">gsb_data_import_rule_set_charmap</a> (rule, charmap_imported);
<a name="l01555"></a>01555         <a class="code" href="gsb__data__import__rule_8c.html#a528a876800185bac62799e142d65613f">gsb_data_import_rule_set_last_file_name</a> (rule, compte -&gt; <a class="code" href="structstruct__compte__importation.html#ae8d33c742956a6b9b668c6d3f291e4db">real_filename</a>);
<a name="l01556"></a>01556         <a class="code" href="gsb__data__import__rule_8c.html#a8ffd44577da9551b3a319838e225556a">gsb_data_import_rule_set_action</a> (rule, compte -&gt; action);
<a name="l01557"></a>01557     }
<a name="l01558"></a>01558     <span class="keywordflow">if</span> ( ! strcmp ( compte -&gt; <a class="code" href="structstruct__compte__importation.html#adac142c3810e741372cf8df90774662c">origine</a>, <span class="stringliteral">&quot;OFX&quot;</span> ) )
<a name="l01559"></a>01559     {
<a name="l01560"></a>01560         g_remove (compte -&gt; <a class="code" href="structstruct__compte__importation.html#ae8d33c742956a6b9b668c6d3f291e4db">real_filename</a>);
<a name="l01561"></a>01561     }
<a name="l01562"></a>01562     list_tmp = list_tmp -&gt; next;
<a name="l01563"></a>01563     }
<a name="l01564"></a>01564 
<a name="l01565"></a>01565     <span class="comment">/* if no account created, there is a problem</span>
<a name="l01566"></a>01566 <span class="comment">     * show an error and go away */</span>
<a name="l01567"></a>01567     <span class="keywordflow">if</span> (!<a class="code" href="gsb__data__account_8c.html#a56c9a589563db8c15800e41378908b27">gsb_data_account_get_accounts_amount</a> ())
<a name="l01568"></a>01568     {
<a name="l01569"></a>01569     <a class="code" href="dialog_8c.html#aa88d9d93c78818a177e9a14eff15f360">dialogue_error</a> (_(<span class="stringliteral">&quot;No account in memory now, this is bad...\nBetter to leave &quot;</span>
<a name="l01570"></a>01570                       <span class="stringliteral">&quot;the import before a crash.\n\nPlease contact the grisbi team &quot;</span>
<a name="l01571"></a>01571                       <span class="stringliteral">&quot;to find the problem.&quot;</span>));
<a name="l01572"></a>01572     <span class="keywordflow">return</span>;
<a name="l01573"></a>01573     }
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     <span class="comment">/* create the links between transactions (transfer) */</span>
<a name="l01576"></a>01576     <span class="keywordflow">if</span> ( virements_a_chercher )
<a name="l01577"></a>01577     cree_liens_virements_ope_import ();
<a name="l01578"></a>01578 
<a name="l01579"></a>01579     <a class="code" href="gsb__status_8c.html#a476044d7002fa33e44709e7293974914">gsb_status_message</a> ( _(<span class="stringliteral">&quot;Please wait&quot;</span>) );
<a name="l01580"></a>01580 
<a name="l01581"></a>01581     <span class="comment">/* update the name of accounts in scheduler form */</span>
<a name="l01582"></a>01582     <a class="code" href="gsb__account_8c.html#a62f0c33eae4fe6957f7668da14e47020">gsb_account_update_combo_list</a> (
<a name="l01583"></a>01583                         <a class="code" href="gsb__form__scheduler_8c.html#a7d99c295efd93b1750ded52204d8ab72">gsb_form_scheduler_get_element_widget</a> ( <a class="code" href="gsb__form__scheduler_8h.html#a93ff9bf3e5edd696882626ba5bd6338aa236226041a9a2521a8dfeb40d6197c8e">SCHEDULED_FORM_ACCOUNT</a> ),
<a name="l01584"></a>01584                         FALSE );
<a name="l01585"></a>01585 
<a name="l01586"></a>01586     <span class="comment">/* set the rule button if necessary */</span>
<a name="l01587"></a>01587     <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__import__rule_8c.html#a1551ae76c7867c88884532cb9da30d82">gsb_data_import_rule_account_has_rule</a> (<a class="code" href="navigation_8c.html#a3b668bf52ce71dcff3ea10c9db7be859">gsb_gui_navigation_get_current_account</a> ()))
<a name="l01588"></a>01588         gtk_widget_show (<a class="code" href="barre__outils_8c.html#ae624b78f586a9e3f5d60e6f2e2866819">menu_import_rules</a>);
<a name="l01589"></a>01589     <span class="keywordflow">else</span>
<a name="l01590"></a>01590         gtk_widget_hide (<a class="code" href="barre__outils_8c.html#ae624b78f586a9e3f5d60e6f2e2866819">menu_import_rules</a>);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <span class="comment">/* show the account list */</span>
<a name="l01593"></a>01593     <a class="code" href="menu_8c.html#a82ddd4b1a12d79cf3c8211128ef52a88">gsb_menu_update_accounts_in_menus</a>();
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     <span class="comment">/* update main page */</span>
<a name="l01596"></a>01596     <a class="code" href="accueil_8c.html#a018917e8dacfd8fbe4e94d0f99a59c08">mise_a_jour_liste_comptes_accueil</a> = 1;
<a name="l01597"></a>01597     <a class="code" href="accueil_8c.html#afaffaedc4fd0ae8638f7158c6777b35b">mise_a_jour_soldes_minimaux</a> = 1;
<a name="l01598"></a>01598     <a class="code" href="accueil_8c.html#a15511226739a34542ef8d7b979aedcf0">mise_a_jour_accueil</a> (FALSE);
<a name="l01599"></a>01599 
<a name="l01600"></a>01600     <a class="code" href="gsb__status_8c.html#ae0a64a6da0c88a30c75e64e06c734aec">gsb_status_clear</a>();
<a name="l01601"></a>01601 
<a name="l01602"></a>01602     <span class="comment">/* if some R marked transactions are imported, show a message */</span>
<a name="l01603"></a>01603     <span class="keywordflow">if</span> (marked_r_transactions_imported)
<a name="l01604"></a>01604     <a class="code" href="dialog_8c.html#ade6e4adf08627021abf579246f58aac1">dialogue</a> ( _(<span class="stringliteral">&quot;You have just imported reconciled transactions but they not associated &quot;</span>
<a name="l01605"></a>01605                  <span class="stringliteral">&quot;with any reconcile number yet.  You may associate them with a reconcilation &quot;</span>
<a name="l01606"></a>01606                  <span class="stringliteral">&quot;later via the preferences windows.&quot;</span>) );
<a name="l01607"></a>01607 
<a name="l01608"></a>01608     <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a9d0fa9057da603e64a601d69d7bf2b51">modification_fichier</a> == 0 )
<a name="l01609"></a>01609         <a class="code" href="traitement__variables_8c.html#aa4084b9e508b1d1fea1d09c6b6208021">modification_fichier</a> ( TRUE );
<a name="l01610"></a>01610 }
<a name="l01611"></a>01611 
<a name="l01612"></a>01612 
<a name="l01622"></a>01622 <span class="keywordtype">void</span> cree_liens_virements_ope_import ( <span class="keywordtype">void</span> )
<a name="l01623"></a>01623 {
<a name="l01624"></a>01624     GSList *list_tmp_transactions;
<a name="l01625"></a>01625     list_tmp_transactions = <a class="code" href="gsb__data__transaction_8c.html#af781a71a62eece020188ef62847f2887">gsb_data_transaction_get_transactions_list</a> ();
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     <span class="keywordflow">while</span> ( list_tmp_transactions )
<a name="l01628"></a>01628     {
<a name="l01629"></a>01629         gint transaction_number_tmp;
<a name="l01630"></a>01630         transaction_number_tmp = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (list_tmp_transactions -&gt; data);
<a name="l01631"></a>01631 
<a name="l01632"></a>01632         <span class="comment">/* if the contra transaction number is -1, it&#39;s a transfer,</span>
<a name="l01633"></a>01633 <span class="comment">         * in that case, the name of the contra account is in the bank_references */</span>
<a name="l01634"></a>01634         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a4040925a3db49485b5a2b0a8ea19d2ee">gsb_data_transaction_get_contra_transaction_number</a> (transaction_number_tmp)== -1
<a name="l01635"></a>01635              &amp;&amp;
<a name="l01636"></a>01636              <a class="code" href="gsb__data__transaction_8c.html#a8ef7712f47278152551c3d9454ecf36a">gsb_data_transaction_get_bank_references</a> (transaction_number_tmp))
<a name="l01637"></a>01637         {
<a name="l01638"></a>01638             <span class="comment">/* the name of the contra account is in the bank references with [ and ] */</span>
<a name="l01639"></a>01639             gchar *contra_account_name;
<a name="l01640"></a>01640             gint contra_account_number;
<a name="l01641"></a>01641 
<a name="l01642"></a>01642             contra_account_name = <a class="code" href="utils__str_8c.html#a132f77383d5b1e3070ef354a1fdd8a10">my_strdelimit</a> (<a class="code" href="gsb__data__transaction_8c.html#a8ef7712f47278152551c3d9454ecf36a">gsb_data_transaction_get_bank_references</a> (transaction_number_tmp),
<a name="l01643"></a>01643                                                  <span class="stringliteral">&quot;[]&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01644"></a>01644             contra_account_number = <a class="code" href="gsb__data__account_8c.html#af305bbd4dfe43c7b47f3aee8975108af">gsb_data_account_get_no_account_by_name</a> ( contra_account_name );
<a name="l01645"></a>01645             g_free (contra_account_name);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647             <span class="comment">/* now we needn&#39;t the bank reference anymore */</span>
<a name="l01648"></a>01648             <a class="code" href="gsb__data__transaction_8c.html#a4e91601dcc725a5ff6a109e4d1dad915">gsb_data_transaction_set_bank_references</a> ( transaction_number_tmp, NULL );
<a name="l01649"></a>01649 
<a name="l01650"></a>01650             <span class="keywordflow">if</span> ( contra_account_number == -1 )
<a name="l01651"></a>01651             {
<a name="l01652"></a>01652                 <span class="comment">/* we have not found the contra-account */</span>
<a name="l01653"></a>01653                 <a class="code" href="gsb__data__transaction_8c.html#a7b333676b59c4dae3c5e56a88b4981e3">gsb_data_transaction_set_contra_transaction_number</a> ( transaction_number_tmp,
<a name="l01654"></a>01654                                                                      0);
<a name="l01655"></a>01655             }
<a name="l01656"></a>01656             <span class="keywordflow">else</span>
<a name="l01657"></a>01657             {
<a name="l01658"></a>01658                 <span class="comment">/* we have found the contra-account, we look for the contra-transaction */</span>
<a name="l01659"></a>01659                 GSList *list_tmp_transactions_2;
<a name="l01660"></a>01660                 gint transaction_account = <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (transaction_number_tmp);
<a name="l01661"></a>01661 
<a name="l01662"></a>01662                 list_tmp_transactions_2 = <a class="code" href="gsb__data__transaction_8c.html#af781a71a62eece020188ef62847f2887">gsb_data_transaction_get_transactions_list</a> ();
<a name="l01663"></a>01663                 <span class="keywordflow">while</span> ( list_tmp_transactions_2 )
<a name="l01664"></a>01664                 {
<a name="l01665"></a>01665                     gint contra_transaction_number_tmp;
<a name="l01666"></a>01666                     gint contra_transaction_account;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668                     contra_transaction_number_tmp = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (list_tmp_transactions_2 -&gt; data);
<a name="l01669"></a>01669                     contra_transaction_account = <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (contra_transaction_number_tmp);
<a name="l01670"></a>01670 
<a name="l01671"></a>01671                     <span class="keywordflow">if</span> (contra_account_number == contra_transaction_account
<a name="l01672"></a>01672                         &amp;&amp;
<a name="l01673"></a>01673                         gsb_import_check_transaction_link (transaction_number_tmp, contra_transaction_number_tmp))
<a name="l01674"></a>01674                     {
<a name="l01675"></a>01675                         <span class="comment">/* we have found the contra transaction, set all the values */</span>
<a name="l01676"></a>01676                         gint payment_number;
<a name="l01677"></a>01677 
<a name="l01678"></a>01678                         <a class="code" href="gsb__data__transaction_8c.html#a7b333676b59c4dae3c5e56a88b4981e3">gsb_data_transaction_set_contra_transaction_number</a> ( transaction_number_tmp,
<a name="l01679"></a>01679                                                                              contra_transaction_number_tmp );
<a name="l01680"></a>01680                         <a class="code" href="gsb__data__transaction_8c.html#a7b333676b59c4dae3c5e56a88b4981e3">gsb_data_transaction_set_contra_transaction_number</a> ( contra_transaction_number_tmp,
<a name="l01681"></a>01681                                                                              transaction_number_tmp);
<a name="l01682"></a>01682 
<a name="l01683"></a>01683                         <span class="comment">/* unset the reference of the contra transaction */</span>
<a name="l01684"></a>01684                         <a class="code" href="gsb__data__transaction_8c.html#a4e91601dcc725a5ff6a109e4d1dad915">gsb_data_transaction_set_bank_references</a> ( contra_transaction_number_tmp,
<a name="l01685"></a>01685                                                                    NULL );
<a name="l01686"></a>01686 
<a name="l01687"></a>01687                         <span class="comment">/* try to set the good method of payment to transfer */</span>
<a name="l01688"></a>01688                         payment_number = <a class="code" href="gsb__data__payment_8c.html#a11b56161aa3440cc9367c89a72c595d5">gsb_data_payment_get_transfer_payment_number</a> (transaction_account);
<a name="l01689"></a>01689                         <span class="keywordflow">if</span> (payment_number)
<a name="l01690"></a>01690                             <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number_tmp, payment_number);
<a name="l01691"></a>01691 
<a name="l01692"></a>01692                         payment_number = <a class="code" href="gsb__data__payment_8c.html#a11b56161aa3440cc9367c89a72c595d5">gsb_data_payment_get_transfer_payment_number</a> (contra_transaction_account);
<a name="l01693"></a>01693                         <span class="keywordflow">if</span> (payment_number)
<a name="l01694"></a>01694                             <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (contra_transaction_number_tmp, payment_number);
<a name="l01695"></a>01695                     }
<a name="l01696"></a>01696                     list_tmp_transactions_2 = list_tmp_transactions_2 -&gt; next;
<a name="l01697"></a>01697                 }
<a name="l01698"></a>01698 
<a name="l01699"></a>01699                 <span class="comment">/* if no contra-transaction, that transaction becomes normal */</span>
<a name="l01700"></a>01700                 <span class="keywordflow">if</span> (<a class="code" href="gsb__data__transaction_8c.html#a4040925a3db49485b5a2b0a8ea19d2ee">gsb_data_transaction_get_contra_transaction_number</a> (transaction_number_tmp) == -1)
<a name="l01701"></a>01701                     <span class="comment">/* the contra transaction is still -1, so no contra transaction found, unset that */</span>
<a name="l01702"></a>01702                     <a class="code" href="gsb__data__transaction_8c.html#a7b333676b59c4dae3c5e56a88b4981e3">gsb_data_transaction_set_contra_transaction_number</a> ( transaction_number_tmp,
<a name="l01703"></a>01703                                                                          0);
<a name="l01704"></a>01704             }
<a name="l01705"></a>01705         }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707         list_tmp_transactions = list_tmp_transactions -&gt; next;
<a name="l01708"></a>01708     }
<a name="l01709"></a>01709     <span class="comment">/* the transactions were already set in the list,</span>
<a name="l01710"></a>01710 <span class="comment">     * and the transfer was not written, we need to update the categories values</span>
<a name="l01711"></a>01711 <span class="comment">     * in the lists */</span>
<a name="l01712"></a>01712     <a class="code" href="transaction__list_8c.html#aee9667138888c4cb946225cae2972363">transaction_list_update_element</a> (<a class="code" href="gsb__transactions__list_8h.html#ab04a0655cd1e3bcac5e8f48c18df1a57a14d07ec8c3f6be2c40010a64205711be">ELEMENT_CATEGORY</a>);
<a name="l01713"></a>01713     <a class="code" href="transaction__list_8c.html#aee9667138888c4cb946225cae2972363">transaction_list_update_element</a> (<a class="code" href="gsb__transactions__list_8h.html#ab04a0655cd1e3bcac5e8f48c18df1a57ab990b13349c34bf1524cab596b6c614b">ELEMENT_PAYMENT_TYPE</a>);
<a name="l01714"></a>01714 }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716 
<a name="l01726"></a>01726 gboolean gsb_import_check_transaction_link ( gint transaction_number,
<a name="l01727"></a>01727                         gint tested_transaction )
<a name="l01728"></a>01728 {
<a name="l01729"></a>01729     gchar *contra_account_name;
<a name="l01730"></a>01730     gint contra_account_number;
<a name="l01731"></a>01731     <a class="code" href="structgsb__real.html">gsb_real</a> amount_1, amount_2;
<a name="l01732"></a>01732 
<a name="l01733"></a>01733     <span class="comment">/* we check first the easy and quick things, and if all ok, comes after the check</span>
<a name="l01734"></a>01734 <span class="comment">     * which need some time */</span>
<a name="l01735"></a>01735 
<a name="l01736"></a>01736     <span class="comment">/* check if the contra transaction number of the tested transaction is -1 (ie imported transfer) */</span>
<a name="l01737"></a>01737     <span class="keywordflow">if</span> (<a class="code" href="gsb__data__transaction_8c.html#a4040925a3db49485b5a2b0a8ea19d2ee">gsb_data_transaction_get_contra_transaction_number</a> (tested_transaction) != -1)
<a name="l01738"></a>01738         <span class="keywordflow">return</span> FALSE;
<a name="l01739"></a>01739 
<a name="l01740"></a>01740     <span class="comment">/* check if there is a contra account name */</span>
<a name="l01741"></a>01741     <span class="keywordflow">if</span> (!<a class="code" href="gsb__data__transaction_8c.html#a8ef7712f47278152551c3d9454ecf36a">gsb_data_transaction_get_bank_references</a> (tested_transaction))
<a name="l01742"></a>01742         <span class="keywordflow">return</span> FALSE;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744     <span class="comment">/* check same payee */</span>
<a name="l01745"></a>01745     <span class="keywordflow">if</span> (<a class="code" href="gsb__data__transaction_8c.html#afa032df45afa2ad7a4be48449a7e8d15">gsb_data_transaction_get_party_number</a> (transaction_number) != <a class="code" href="gsb__data__transaction_8c.html#afa032df45afa2ad7a4be48449a7e8d15">gsb_data_transaction_get_party_number</a> (tested_transaction))
<a name="l01746"></a>01746         <span class="keywordflow">return</span> FALSE;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     <span class="comment">/* check same date */</span>
<a name="l01749"></a>01749     <span class="keywordflow">if</span> (g_date_compare ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (transaction_number),
<a name="l01750"></a>01750                          <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (tested_transaction)))
<a name="l01751"></a>01751         <span class="keywordflow">return</span> FALSE;
<a name="l01752"></a>01752 
<a name="l01753"></a>01753     <span class="comment">/* check if same amount (but opposite) */</span>
<a name="l01754"></a>01754     amount_1 = <a class="code" href="gsb__real_8c.html#ae727c3ee72397bb23657fb3571bcf4da">gsb_real_abs</a> (<a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (transaction_number));
<a name="l01755"></a>01755     amount_2 = <a class="code" href="gsb__real_8c.html#ae727c3ee72397bb23657fb3571bcf4da">gsb_real_abs</a> (<a class="code" href="gsb__data__transaction_8c.html#a8f44da078801e109873c479399b72191">gsb_data_transaction_get_adjusted_amount_for_currency</a> ( tested_transaction,
<a name="l01756"></a>01756                                                                                      <a class="code" href="gsb__data__transaction_8c.html#aa39edcb597bd75a438b00b67cf898e88">gsb_data_transaction_get_currency_number</a> (transaction_number),
<a name="l01757"></a>01757                                                                                      -1));
<a name="l01758"></a>01758     <span class="keywordflow">if</span> (<a class="code" href="gsb__real_8c.html#a9ffa1aad0087896f5a3f1e2320c97db4">gsb_real_cmp</a> (amount_1, amount_2))
<a name="l01759"></a>01759         <span class="keywordflow">return</span> FALSE;
<a name="l01760"></a>01760 
<a name="l01761"></a>01761     <span class="comment">/* check if the contra account name of the tested transaction is the account of the transaction */</span>
<a name="l01762"></a>01762     contra_account_name = <a class="code" href="utils__str_8c.html#a132f77383d5b1e3070ef354a1fdd8a10">my_strdelimit</a> (<a class="code" href="gsb__data__transaction_8c.html#a8ef7712f47278152551c3d9454ecf36a">gsb_data_transaction_get_bank_references</a> (tested_transaction),
<a name="l01763"></a>01763                                          <span class="stringliteral">&quot;[]&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01764"></a>01764     contra_account_number = <a class="code" href="gsb__data__account_8c.html#af305bbd4dfe43c7b47f3aee8975108af">gsb_data_account_get_no_account_by_name</a> ( contra_account_name );
<a name="l01765"></a>01765     g_free (contra_account_name);
<a name="l01766"></a>01766 
<a name="l01767"></a>01767     <span class="keywordflow">if</span> (<a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (transaction_number) != contra_account_number)
<a name="l01768"></a>01768         <span class="keywordflow">return</span> FALSE;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="comment">/* all seems the same, can return TRUE */</span>
<a name="l01771"></a>01771     <span class="keywordflow">return</span> TRUE;
<a name="l01772"></a>01772 }
<a name="l01773"></a>01773 
<a name="l01774"></a>01774 
<a name="l01783"></a>01783 gint gsb_import_create_imported_account ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account )
<a name="l01784"></a>01784 {
<a name="l01785"></a>01785     gint account_number;
<a name="l01786"></a>01786     gint <a class="code" href="gsb__data__account_8h.html#abe336abc6aaa13733b0ea311c9478862">kind_account</a>;
<a name="l01787"></a>01787 
<a name="l01788"></a>01788     <span class="keywordflow">if</span> (!imported_account)
<a name="l01789"></a>01789         <span class="keywordflow">return</span> -1;
<a name="l01790"></a>01790 
<a name="l01791"></a>01791     <span class="comment">/* create the new account,</span>
<a name="l01792"></a>01792 <span class="comment">     * for now 3 kind of account, GSB_TYPE_BANK, GSB_TYPE_LIABILITIES or GSB_TYPE_CASH */</span>
<a name="l01793"></a>01793     <span class="keywordflow">switch</span> (<a class="code" href="gsb__combo__box_8c.html#a12d7d2e0baa0791bf2e5740c43376153">gsb_combo_box_get_index</a> (imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#aeb1267b8ebbe8d35b5cdcbe20c754028">bouton_type_compte</a>))
<a name="l01794"></a>01794     {
<a name="l01795"></a>01795         <span class="keywordflow">case</span> 2:
<a name="l01796"></a>01796             kind_account = <a class="code" href="gsb__data__account_8h.html#ab5b2ad5b1ac065827dcf65b09542f53dad80fd01815f2d74aecc46cad959a3da9">GSB_TYPE_LIABILITIES</a>;
<a name="l01797"></a>01797             <span class="keywordflow">break</span>;
<a name="l01798"></a>01798 
<a name="l01799"></a>01799         <span class="keywordflow">case</span> 1:
<a name="l01800"></a>01800             kind_account = <a class="code" href="gsb__data__account_8h.html#ab5b2ad5b1ac065827dcf65b09542f53da1e355ad8c560d892d0b5912be1d875a2">GSB_TYPE_CASH</a>;
<a name="l01801"></a>01801             <span class="keywordflow">break</span>;
<a name="l01802"></a>01802 
<a name="l01803"></a>01803         <span class="keywordflow">default</span>:
<a name="l01804"></a>01804             kind_account = <a class="code" href="gsb__data__account_8h.html#ab5b2ad5b1ac065827dcf65b09542f53da718d20004be845980da235b81c70f72a">GSB_TYPE_BANK</a>;
<a name="l01805"></a>01805     }
<a name="l01806"></a>01806 
<a name="l01807"></a>01807     account_number = <a class="code" href="gsb__data__account_8c.html#ab7ed7a61d763a2b3a99c66cd24d7668e">gsb_data_account_new</a> (kind_account);
<a name="l01808"></a>01808 
<a name="l01809"></a>01809     <span class="keywordflow">if</span> ( account_number == -1 )
<a name="l01810"></a>01810         <span class="keywordflow">return</span> -1;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812     <span class="comment">/* set the default method of payment */</span>
<a name="l01813"></a>01813     <a class="code" href="gsb__data__payment_8c.html#ac5615b1d09ddb9d46e13d9cf552e1925">gsb_data_payment_create_default</a> (account_number);
<a name="l01814"></a>01814 
<a name="l01815"></a>01815     <span class="comment">/* set the id and try to find the bank */</span>
<a name="l01816"></a>01816     <span class="keywordflow">if</span> ( imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a98f4d0a1bbbb5dd69fb25e6a4fdb477b">id_compte</a> )
<a name="l01817"></a>01817     {
<a name="l01818"></a>01818         gchar **tab_str;
<a name="l01819"></a>01819 
<a name="l01820"></a>01820         <a class="code" href="gsb__data__account_8c.html#a7fb3fd2eb6e83fb23e80ff982755d9b6">gsb_data_account_set_id</a> (account_number,
<a name="l01821"></a>01821                                  imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a98f4d0a1bbbb5dd69fb25e6a4fdb477b">id_compte</a> );
<a name="l01822"></a>01822 
<a name="l01823"></a>01823         <span class="comment">/* usually, the id is &quot;bank_number guichet_number account_number key&quot;</span>
<a name="l01824"></a>01824 <span class="comment">         * try to get the datas */</span>
<a name="l01825"></a>01825 
<a name="l01826"></a>01826         tab_str = g_strsplit ( <a class="code" href="gsb__data__account_8c.html#a8e894871e7b44a38b1a3450eab292fd2">gsb_data_account_get_id</a> (account_number),
<a name="l01827"></a>01827                                <span class="stringliteral">&quot; &quot;</span>,
<a name="l01828"></a>01828                                3 );
<a name="l01829"></a>01829         <span class="keywordflow">if</span> ( tab_str[1] )
<a name="l01830"></a>01830         {
<a name="l01831"></a>01831             <a class="code" href="gsb__data__account_8c.html#ae342f4484c8a654ad07d4fa6d6cc98c3">gsb_data_account_set_bank_branch_code</a> ( account_number,
<a name="l01832"></a>01832                                                     tab_str[1] );
<a name="l01833"></a>01833             <span class="keywordflow">if</span> ( tab_str[2] )
<a name="l01834"></a>01834             {
<a name="l01835"></a>01835                 gchar *temp;
<a name="l01836"></a>01836 
<a name="l01837"></a>01837                 <a class="code" href="gsb__data__account_8c.html#aff4a326b7e9b5cde47a9672947da61b1">gsb_data_account_set_bank_account_key</a> ( account_number,
<a name="l01838"></a>01838                                                         tab_str[2] + strlen ( tab_str[2] ) - 1 );
<a name="l01839"></a>01839 
<a name="l01840"></a>01840                 temp = <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> ( tab_str[2] );
<a name="l01841"></a>01841                 <span class="keywordflow">if</span> ( temp &amp;&amp; strlen(temp) )
<a name="l01842"></a>01842                 {
<a name="l01843"></a>01843                     temp[strlen (temp) - 1 ] = 0;
<a name="l01844"></a>01844                     <a class="code" href="gsb__data__account_8c.html#a751bee9b44956e222ac2808f81e4d02e">gsb_data_account_set_bank_account_number</a> ( account_number, temp );
<a name="l01845"></a>01845                     g_free (temp);
<a name="l01846"></a>01846                 }
<a name="l01847"></a>01847             }
<a name="l01848"></a>01848         }
<a name="l01849"></a>01849         g_strfreev ( tab_str );
<a name="l01850"></a>01850     }
<a name="l01851"></a>01851 
<a name="l01852"></a>01852     <span class="comment">/* set the name (the g_strstrip is VERY important !!!) */</span>
<a name="l01853"></a>01853     <span class="keywordflow">if</span> ( imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a> )
<a name="l01854"></a>01854         <a class="code" href="gsb__data__account_8c.html#ada7df5e9e4e880b68c992c47d210f741">gsb_data_account_set_name</a> ( account_number,
<a name="l01855"></a>01855                                     g_strstrip (imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a>));
<a name="l01856"></a>01856     <span class="keywordflow">else</span>
<a name="l01857"></a>01857         <a class="code" href="gsb__data__account_8c.html#ada7df5e9e4e880b68c992c47d210f741">gsb_data_account_set_name</a> ( account_number,
<a name="l01858"></a>01858                                     _(<span class="stringliteral">&quot;Imported account&quot;</span>));
<a name="l01859"></a>01859 
<a name="l01860"></a>01860     <span class="comment">/* set the currency */</span>
<a name="l01861"></a>01861     <a class="code" href="gsb__data__account_8c.html#a3236265c824125519a80c0b0721d48ab">gsb_data_account_set_currency</a> ( account_number,
<a name="l01862"></a>01862                                     <a class="code" href="gsb__currency_8c.html#a3abd39af3aafa4213a8ffbe74d5d6b10">gsb_currency_get_currency_from_combobox</a> (imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#aea1b3ea4a0ba7aa24da4851e96ce1002">bouton_devise</a>));
<a name="l01863"></a>01863 
<a name="l01864"></a>01864     <span class="comment">/* set the initial balance */</span>
<a name="l01865"></a>01865     <a class="code" href="gsb__data__account_8c.html#a79169a74fd8bce5eb8379bb4bb31342c">gsb_data_account_set_init_balance</a> ( account_number,
<a name="l01866"></a>01866                                         imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a9c9132279c2dac0301bc5061088d3596">solde</a>);
<a name="l01867"></a>01867 
<a name="l01868"></a>01868     <span class="comment">/* Use two lines view by default. */</span>
<a name="l01869"></a>01869     <a class="code" href="gsb__data__account_8c.html#a1b6a86b8cdab56cee9535be87877e0f0">gsb_data_account_set_nb_rows</a> ( account_number, 2 );
<a name="l01870"></a>01870 
<a name="l01871"></a>01871     <span class="comment">/* set the new form organization */</span>
<a name="l01872"></a>01872     <a class="code" href="gsb__data__form_8c.html#a8e695941eaf64be2d15afd287e064523">gsb_data_form_new_organization</a> ( account_number );
<a name="l01873"></a>01873     <a class="code" href="gsb__data__form_8c.html#a4f0c2bea1f39f695cccdee80bb8fe2ee">gsb_data_form_set_default_organization</a> ( account_number );
<a name="l01874"></a>01874 
<a name="l01875"></a>01875     <span class="keywordflow">return</span> account_number;
<a name="l01876"></a>01876 }
<a name="l01877"></a>01877 
<a name="l01878"></a>01878 
<a name="l01889"></a>01889 <span class="keywordtype">void</span> gsb_import_add_imported_transactions ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account,
<a name="l01890"></a>01890                         gint account_number )
<a name="l01891"></a>01891 {
<a name="l01892"></a>01892     GSList *list_tmp;
<a name="l01893"></a>01893     GDate *first_date_import = NULL;
<a name="l01894"></a>01894     gint demande_confirmation;
<a name="l01895"></a>01895 
<a name="l01896"></a>01896     <span class="comment">/* check the imported account id, and set it in the grisbi account if it doesn&#39;t </span>
<a name="l01897"></a>01897 <span class="comment">     * exist or if it&#39;s wrong */</span>
<a name="l01898"></a>01898     <span class="keywordflow">if</span> ( imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a98f4d0a1bbbb5dd69fb25e6a4fdb477b">id_compte</a> )
<a name="l01899"></a>01899     {
<a name="l01900"></a>01900         <span class="keywordflow">if</span> ( ! gsb_import_set_id_compte ( account_number, imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a98f4d0a1bbbb5dd69fb25e6a4fdb477b">id_compte</a> ) )
<a name="l01901"></a>01901             <span class="keywordflow">return</span>;
<a name="l01902"></a>01902     }
<a name="l01903"></a>01903 
<a name="l01904"></a>01904     <span class="comment">/* on fait un premier tour de la liste des opés pour repérer celles qui sont déjà entrées</span>
<a name="l01905"></a>01905 <span class="comment">     * si on n&#39;importe que du ofx, c&#39;est facile, chaque opé est repérée par une id </span>
<a name="l01906"></a>01906 <span class="comment">     * donc si l&#39;opé importée a une id, il suffit de rechercher l&#39;id dans le compte, si elle </span>
<a name="l01907"></a>01907 <span class="comment">     * n&#39;y est pas l&#39;opé est à enregistrer </span>
<a name="l01908"></a>01908 <span class="comment">     * si on importe du qif, il n&#39;y a pas d&#39;id. donc soit on retrouve une opé semblable </span>
<a name="l01909"></a>01909 <span class="comment">     * (cad même montant et même date, on ne fait pas joujou avec le tiers car l&#39;utilisateur  </span>
<a name="l01910"></a>01910 <span class="comment">     * a pu le changer), et on demande à l&#39;utilisateur quoi faire, sinon on enregistre l&#39;opé</span>
<a name="l01911"></a>01911 <span class="comment">     */</span>
<a name="l01912"></a>01912 
<a name="l01913"></a>01913     <span class="comment">/* pour gagner en rapidité, on va récupérer la date de la première</span>
<a name="l01914"></a>01914 <span class="comment">     * opération qui est dans le fichier importé */</span>
<a name="l01915"></a>01915     first_date_import = gsb_import_get_first_date ( imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a5ecc8020d6a8cc2f35c895c074286881">operations_importees</a> );
<a name="l01916"></a>01916 
<a name="l01917"></a>01917     <span class="comment">/* ok, now first_date_import contains the firt transaction date used in that account,</span>
<a name="l01918"></a>01918 <span class="comment">     * can check the imported transactions */</span>
<a name="l01919"></a>01919     demande_confirmation = gsb_import_define_action ( imported_account,
<a name="l01920"></a>01920                         account_number,
<a name="l01921"></a>01921                         first_date_import );
<a name="l01922"></a>01922 
<a name="l01923"></a>01923     <span class="comment">/* if we are not sure about some transactions, ask now */</span>
<a name="l01924"></a>01924     <span class="keywordflow">if</span> ( demande_confirmation )
<a name="l01925"></a>01925         confirmation_enregistrement_ope_import ( imported_account );
<a name="l01926"></a>01926 
<a name="l01927"></a>01927     <span class="comment">/* ok, now we know what to do for each transactions, can import to the account */</span>
<a name="l01928"></a>01928     mother_transaction_number = 0;
<a name="l01929"></a>01929 
<a name="l01930"></a>01930     list_tmp = imported_account -&gt; <a class="code" href="structstruct__compte__importation.html#a5ecc8020d6a8cc2f35c895c074286881">operations_importees</a>;
<a name="l01931"></a>01931 
<a name="l01932"></a>01932     <span class="keywordflow">while</span> ( list_tmp )
<a name="l01933"></a>01933     {
<a name="l01934"></a>01934         <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *imported_transaction;
<a name="l01935"></a>01935 
<a name="l01936"></a>01936         imported_transaction = list_tmp -&gt; data;
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         <span class="keywordflow">if</span> ( imported_transaction -&gt; action == <a class="code" href="import_8h.html#a27cf9d59526d475c8f2cfc3835517226">IMPORT_TRANSACTION_GET_TRANSACTION</a> )
<a name="l01939"></a>01939         {
<a name="l01940"></a>01940             gint transaction_number;
<a name="l01941"></a>01941 
<a name="l01942"></a>01942             <span class="comment">/* set the account currency to the transaction and create the transaction */</span>
<a name="l01943"></a>01943             <span class="keywordflow">if</span> (imported_account -&gt; bouton_devise)
<a name="l01944"></a>01944             imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a> = <a class="code" href="gsb__currency_8c.html#a3abd39af3aafa4213a8ffbe74d5d6b10">gsb_currency_get_currency_from_combobox</a> (
<a name="l01945"></a>01945                         imported_account -&gt; bouton_devise);
<a name="l01946"></a>01946             <span class="keywordflow">else</span>
<a name="l01947"></a>01947             imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a> = <a class="code" href="gsb__data__currency_8c.html#ad6f48bd7a2a3533c4be0f5453d2be28b">gsb_data_currency_get_number_by_code_iso4217</a> (
<a name="l01948"></a>01948                         imported_account -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a>);
<a name="l01949"></a>01949 
<a name="l01950"></a>01950             transaction_number = gsb_import_create_transaction ( imported_transaction,
<a name="l01951"></a>01951                         account_number, imported_account -&gt; origine );
<a name="l01952"></a>01952 
<a name="l01953"></a>01953         <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a> &amp;&amp;
<a name="l01954"></a>01954                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> &gt; 0 )
<a name="l01955"></a>01955         {
<a name="l01956"></a>01956             <a class="code" href="gsb__transactions__list_8c.html#a83f53b0c0b9da33efa7f7691ea939f9e">gsb_transactions_list_update_transaction</a> ( transaction_number );
<a name="l01957"></a>01957             list_tmp = list_tmp -&gt; next;
<a name="l01958"></a>01958             <span class="keywordflow">continue</span>;
<a name="l01959"></a>01959         }
<a name="l01960"></a>01960 
<a name="l01961"></a>01961             <span class="comment">/* invert the amount of the transaction if asked */</span>
<a name="l01962"></a>01962             <span class="keywordflow">if</span> (imported_account -&gt; invert_transaction_amount)
<a name="l01963"></a>01963             <a class="code" href="gsb__data__transaction_8c.html#a76fbbfabc4f16f0f8a51d843785862d7">gsb_data_transaction_set_amount</a> ( transaction_number,
<a name="l01964"></a>01964                         <a class="code" href="gsb__real_8c.html#aee7dfb40ef3a60df7a55c6ccfcc6dfef">gsb_real_opposite</a> (<a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (
<a name="l01965"></a>01965                         transaction_number ) ) );
<a name="l01966"></a>01966 
<a name="l01967"></a>01967             <span class="comment">/* we need to add the transaction now to the tree model here</span>
<a name="l01968"></a>01968 <span class="comment">             * to avoid to write again all the account */</span>
<a name="l01969"></a>01969             <a class="code" href="gsb__transactions__list_8c.html#ab384002f4635a570bc9907b04b3efd24">gsb_transactions_list_append_new_transaction</a> ( transaction_number, FALSE );
<a name="l01970"></a>01970         }
<a name="l01971"></a>01971         list_tmp = list_tmp -&gt; next;
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973 
<a name="l01975"></a>01975     <a class="code" href="tiers__onglet_8c.html#a83502a3974423bccf9982335c494e683">gsb_payee_update_combofix</a> ();
<a name="l01976"></a>01976 
<a name="l01977"></a>01977     <span class="comment">/* if we are on the current account, we need to update the tree_view */</span>
<a name="l01978"></a>01978     <span class="keywordflow">if</span> (<a class="code" href="navigation_8c.html#a3b668bf52ce71dcff3ea10c9db7be859">gsb_gui_navigation_get_current_account</a> () == account_number)
<a name="l01979"></a>01979     {
<a name="l01980"></a>01980         <a class="code" href="gsb__transactions__list_8c.html#ab7d08f59bcf7149edda9db47e67333a4">gsb_transactions_list_update_tree_view</a> (account_number, TRUE);
<a name="l01981"></a>01981         <a class="code" href="gsb__data__account_8c.html#a4607ab78b42360bded7a2203dca78931">gsb_data_account_colorize_current_balance</a> ( account_number );
<a name="l01982"></a>01982     }
<a name="l01983"></a>01983 }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985 
<a name="l01994"></a>01994 gboolean gsb_import_define_action ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account,
<a name="l01995"></a>01995                         gint account_number,
<a name="l01996"></a>01996                         GDate *first_date_import )
<a name="l01997"></a>01997 {
<a name="l01998"></a>01998     GSList *list_tmp;
<a name="l01999"></a>01999     gint demande_confirmation = FALSE;
<a name="l02000"></a>02000     GSList *list_tmp_transactions;
<a name="l02001"></a>02001         gchar* tmpstr;
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     list_tmp = imported_account -&gt; operations_importees;
<a name="l02004"></a>02004 
<a name="l02005"></a>02005     <span class="keywordflow">while</span> ( list_tmp )
<a name="l02006"></a>02006     {
<a name="l02007"></a>02007         <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *imported_transaction;
<a name="l02008"></a>02008         gint transaction_no;
<a name="l02009"></a>02009 
<a name="l02010"></a>02010         imported_transaction = list_tmp -&gt; data;
<a name="l02011"></a>02011 
<a name="l02012"></a>02012         <span class="comment">/* on corrige le bug de la libofx */</span>
<a name="l02013"></a>02013         <span class="keywordflow">if</span> ( imported_account -&gt; origine
<a name="l02014"></a>02014          &amp;&amp; g_ascii_strcasecmp (imported_account -&gt; origine, <span class="stringliteral">&quot;OFX&quot;</span>) == 0 
<a name="l02015"></a>02015          &amp;&amp; imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> )
<a name="l02016"></a>02016             imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a29bbb5cbb09891b7d9b8bcecf635a123">tiers</a> = <a class="code" href="utils__str_8c.html#a132f77383d5b1e3070ef354a1fdd8a10">my_strdelimit</a> (
<a name="l02017"></a>02017                     imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a29bbb5cbb09891b7d9b8bcecf635a123">tiers</a>, <span class="stringliteral">&quot;&amp;&quot;</span>, <span class="stringliteral">&quot;°&quot;</span> );
<a name="l02018"></a>02018 
<a name="l02019"></a>02019         <span class="comment">/* first check the id */</span>
<a name="l02020"></a>02020         <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a>
<a name="l02021"></a>02021          &amp;&amp;
<a name="l02022"></a>02022          ( transaction_no = <a class="code" href="gsb__data__transaction_8c.html#a8904a22be0f714a36c52e4924491e959">gsb_data_transaction_find_by_id</a> (
<a name="l02023"></a>02023                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a>, account_number ) ) )
<a name="l02024"></a>02024         {
<a name="l02025"></a>02025             <span class="comment">/* the id exists with the same account_nb, so the transaction is already</span>
<a name="l02026"></a>02026 <span class="comment">             * in grisbi we will forget that transaction */</span>
<a name="l02027"></a>02027             <span class="keywordflow">if</span> ( g_date_get_year ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ) == g_date_get_year (
<a name="l02028"></a>02028              <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> ( transaction_no ) ) )
<a name="l02029"></a>02029             {
<a name="l02030"></a>02030                 imported_transaction -&gt; action = <a class="code" href="import_8h.html#a835ae119c50247e8cf93d47580689a5a">IMPORT_TRANSACTION_LEAVE_TRANSACTION</a>;
<a name="l02031"></a>02031             }
<a name="l02032"></a>02032         }
<a name="l02033"></a>02033 
<a name="l02034"></a>02034         <span class="comment">/* if no id, check the cheque */</span>
<a name="l02035"></a>02035         <span class="keywordflow">if</span> ( imported_transaction -&gt; action != <a class="code" href="import_8h.html#a835ae119c50247e8cf93d47580689a5a">IMPORT_TRANSACTION_LEAVE_TRANSACTION</a>
<a name="l02036"></a>02036          &amp;&amp;
<a name="l02037"></a>02037          imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a>
<a name="l02038"></a>02038          &amp;&amp;
<a name="l02039"></a>02039          <a class="code" href="gsb__data__transaction_8c.html#aeb3022dd41bfae50a422aeca94d27d2e">gsb_data_transaction_find_by_payment_content</a> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a>,
<a name="l02040"></a>02040                                 account_number ) )
<a name="l02041"></a>02041         {
<a name="l02042"></a>02042             <span class="comment">/* found the cheque, forget that transaction */</span>
<a name="l02043"></a>02043             imported_transaction -&gt; action = <a class="code" href="import_8h.html#a835ae119c50247e8cf93d47580689a5a">IMPORT_TRANSACTION_LEAVE_TRANSACTION</a>;
<a name="l02044"></a>02044         }
<a name="l02045"></a>02045         g_free ( tmpstr );
<a name="l02046"></a>02046 
<a name="l02047"></a>02047         <span class="comment">/* no id, no cheque, try to find the transaction */</span>
<a name="l02048"></a>02048         <span class="keywordflow">if</span> ( imported_transaction -&gt; action != <a class="code" href="import_8h.html#a835ae119c50247e8cf93d47580689a5a">IMPORT_TRANSACTION_LEAVE_TRANSACTION</a> )
<a name="l02049"></a>02049         {
<a name="l02050"></a>02050              list_tmp_transactions = <a class="code" href="gsb__data__transaction_8c.html#af781a71a62eece020188ef62847f2887">gsb_data_transaction_get_transactions_list</a> ();
<a name="l02051"></a>02051 
<a name="l02052"></a>02052             <span class="keywordflow">while</span> ( list_tmp_transactions )
<a name="l02053"></a>02053             {
<a name="l02054"></a>02054                 gint transaction_number;
<a name="l02055"></a>02055 
<a name="l02056"></a>02056                 transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (
<a name="l02057"></a>02057                         list_tmp_transactions -&gt; data);
<a name="l02058"></a>02058                 <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (
<a name="l02059"></a>02059                  transaction_number ) == account_number
<a name="l02060"></a>02060                  &amp;&amp;
<a name="l02061"></a>02061                  g_date_compare ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> ( transaction_number ),
<a name="l02062"></a>02062                         first_date_import ) &gt; 0 )
<a name="l02063"></a>02063                 {
<a name="l02064"></a>02064                     GDate *date_debut_comparaison;
<a name="l02065"></a>02065                             GDate *date_fin_comparaison;
<a name="l02066"></a>02066 
<a name="l02067"></a>02067                     date_debut_comparaison = g_date_new_dmy ( g_date_get_day ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02068"></a>02068                                 g_date_get_month ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02069"></a>02069                                 g_date_get_year ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ));
<a name="l02070"></a>02070                     g_date_subtract_days ( date_debut_comparaison,
<a name="l02071"></a>02071                                 valeur_echelle_recherche_date_import );
<a name="l02072"></a>02072 
<a name="l02073"></a>02073                     date_fin_comparaison = g_date_new_dmy ( g_date_get_day ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02074"></a>02074                                 g_date_get_month ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02075"></a>02075                                 g_date_get_year ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ));
<a name="l02076"></a>02076                     g_date_add_days ( date_fin_comparaison,
<a name="l02077"></a>02077                                                 valeur_echelle_recherche_date_import );
<a name="l02078"></a>02078 
<a name="l02079"></a>02079                     <span class="keywordflow">if</span> ( !<a class="code" href="gsb__real_8c.html#a9ffa1aad0087896f5a3f1e2320c97db4">gsb_real_cmp</a> ( <a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (
<a name="l02080"></a>02080                      transaction_number), imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a> )
<a name="l02081"></a>02081                      &amp;&amp;
<a name="l02082"></a>02082                      ( g_date_compare ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (
<a name="l02083"></a>02083                        transaction_number), date_debut_comparaison ) &gt;= 0 )
<a name="l02084"></a>02084                      &amp;&amp;
<a name="l02085"></a>02085                      ( g_date_compare ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (
<a name="l02086"></a>02086                        transaction_number ), date_fin_comparaison ) &lt;= 0 )
<a name="l02087"></a>02087                      &amp;&amp;
<a name="l02088"></a>02088                      !imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#aa550ffd55aca6827a90343fcc251339f">ope_de_ventilation</a>
<a name="l02089"></a>02089                      &amp;&amp;
<a name="l02090"></a>02090                      ( !<a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a>
<a name="l02091"></a>02091                      ||
<a name="l02092"></a>02092                      !<a class="code" href="gsb__data__transaction_8c.html#a14a1730f01690f24ee0b884cb9654e72">gsb_data_transaction_get_id</a> ( transaction_number ) ) )
<a name="l02093"></a>02093                     {
<a name="l02094"></a>02094                     <span class="comment">/* the imported transaction has the same date and same amount,</span>
<a name="l02095"></a>02095 <span class="comment">                     * will ask the user */</span>
<a name="l02096"></a>02096                     imported_transaction -&gt; action = <a class="code" href="import_8h.html#a1d50fba49a2567252133addea50b83bc">IMPORT_TRANSACTION_ASK_FOR_TRANSACTION</a>;
<a name="l02097"></a>02097                     imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> = transaction_number;
<a name="l02098"></a>02098                     demande_confirmation = TRUE;
<a name="l02099"></a>02099                     }
<a name="l02100"></a>02100                     g_date_free ( date_debut_comparaison );
<a name="l02101"></a>02101                     g_date_free ( date_fin_comparaison );
<a name="l02102"></a>02102                 }
<a name="l02103"></a>02103                 list_tmp_transactions = list_tmp_transactions -&gt; next;
<a name="l02104"></a>02104             }
<a name="l02105"></a>02105         }
<a name="l02106"></a>02106         list_tmp = list_tmp -&gt; next;
<a name="l02107"></a>02107     }
<a name="l02108"></a>02108 
<a name="l02109"></a>02109     <span class="keywordflow">return</span> demande_confirmation;
<a name="l02110"></a>02110 }
<a name="l02119"></a>02119 <span class="keywordtype">void</span> confirmation_enregistrement_ope_import ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account )
<a name="l02120"></a>02120 {
<a name="l02121"></a>02121     GSList *list_tmp;
<a name="l02122"></a>02122     GtkWidget *dialog;
<a name="l02123"></a>02123     GtkWidget *vbox;
<a name="l02124"></a>02124     GtkWidget *hbox;
<a name="l02125"></a>02125     GtkWidget *scrolled_window;
<a name="l02126"></a>02126     GtkWidget *label;
<a name="l02127"></a>02127     GtkWidget *frame;
<a name="l02128"></a>02128     gchar* tmpstr;
<a name="l02129"></a>02129     gchar* tmpstr2;
<a name="l02130"></a>02130     gint action_derniere_ventilation;
<a name="l02131"></a>02131     gint result;
<a name="l02132"></a>02132 
<a name="l02133"></a>02133     <span class="comment">/* pbiava the 03/17/2009 modifications pour la fusion des opérations */</span>
<a name="l02134"></a>02134     <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a> )
<a name="l02135"></a>02135         tmpstr = g_strdup (
<a name="l02136"></a>02136                         _(<span class="stringliteral">&quot;Confirmation of transactions to be merged&quot;</span>) );
<a name="l02137"></a>02137     <span class="keywordflow">else</span>
<a name="l02138"></a>02138         tmpstr = g_strdup (
<a name="l02139"></a>02139                         _(<span class="stringliteral">&quot;Confirmation of importation of transactions&quot;</span>) );
<a name="l02140"></a>02140     dialog = gtk_dialog_new_with_buttons ( tmpstr,
<a name="l02141"></a>02141                         GTK_WINDOW ( <a class="code" href="accueil_8c.html#a3d346c08cf2d67c388caabffb412b293">window</a> ),
<a name="l02142"></a>02142                         GTK_DIALOG_MODAL,
<a name="l02143"></a>02143                         GTK_STOCK_SELECT_ALL, -12,
<a name="l02144"></a>02144                         _(<span class="stringliteral">&quot;Unselect all&quot;</span>), -13,
<a name="l02145"></a>02145                         GTK_STOCK_OK,
<a name="l02146"></a>02146                         GTK_RESPONSE_OK,
<a name="l02147"></a>02147                         NULL );
<a name="l02148"></a>02148     g_free ( tmpstr );
<a name="l02149"></a>02149     gtk_window_set_default_size ( GTK_WINDOW ( dialog ), 770, 412 );
<a name="l02150"></a>02150     gtk_window_set_position ( GTK_WINDOW ( dialog ), GTK_WIN_POS_CENTER_ON_PARENT );
<a name="l02151"></a>02151     gtk_window_set_resizable ( GTK_WINDOW ( dialog ), TRUE );
<a name="l02152"></a>02152     gtk_container_set_border_width ( GTK_CONTAINER(dialog), 12 );
<a name="l02153"></a>02153 
<a name="l02154"></a>02154     <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a> )
<a name="l02155"></a>02155     {
<a name="l02156"></a>02156         gtk_dialog_set_response_sensitive   ( GTK_DIALOG ( dialog ), -12, FALSE );
<a name="l02157"></a>02157         tmpstr = g_strdup (
<a name="l02158"></a>02158                         _(<span class="stringliteral">&quot;Please select the transactions to be merged&quot;</span>) );
<a name="l02159"></a>02159     }
<a name="l02160"></a>02160     <span class="keywordflow">else</span>
<a name="l02161"></a>02161     {
<a name="l02162"></a>02162         gtk_dialog_set_response_sensitive   ( GTK_DIALOG ( dialog ), -13, FALSE );
<a name="l02163"></a>02163         tmpstr = g_strdup (
<a name="l02164"></a>02164                         _(<span class="stringliteral">&quot;Some imported transactions seem to be already saved.&quot;</span>
<a name="l02165"></a>02165                         <span class="stringliteral">&quot;Please select the transactions to import.&quot;</span>) );
<a name="l02166"></a>02166     }
<a name="l02167"></a>02167     label = gtk_label_new ( tmpstr );
<a name="l02168"></a>02168     gtk_misc_set_alignment ( GTK_MISC ( label ), 0.0, 0.0 );
<a name="l02169"></a>02169     gtk_box_pack_start ( GTK_BOX ( GTK_DIALOG ( dialog )-&gt; vbox ),
<a name="l02170"></a>02170                          label,
<a name="l02171"></a>02171                          FALSE,
<a name="l02172"></a>02172                          FALSE,
<a name="l02173"></a>02173                          10 );
<a name="l02174"></a>02174     gtk_widget_show ( label );
<a name="l02175"></a>02175     g_free ( tmpstr );
<a name="l02176"></a>02176 
<a name="l02177"></a>02177     <span class="comment">/* set the decoration */</span>
<a name="l02178"></a>02178     frame = gtk_frame_new (NULL);
<a name="l02179"></a>02179     gtk_box_pack_start ( GTK_BOX ( GTK_DIALOG ( dialog )-&gt; vbox ), frame, TRUE, TRUE, 0 );
<a name="l02180"></a>02180     gtk_widget_show ( frame );
<a name="l02181"></a>02181 
<a name="l02182"></a>02182     vbox = gtk_vbox_new ( FALSE, 0 );
<a name="l02183"></a>02183     gtk_container_add ( GTK_CONTAINER ( frame ), vbox);
<a name="l02184"></a>02184     gtk_widget_show ( vbox );
<a name="l02185"></a>02185 
<a name="l02186"></a>02186     scrolled_window = gtk_scrolled_window_new ( FALSE, FALSE );
<a name="l02187"></a>02187     gtk_scrolled_window_set_policy ( GTK_SCROLLED_WINDOW ( scrolled_window ),
<a name="l02188"></a>02188                         GTK_POLICY_AUTOMATIC,
<a name="l02189"></a>02189                         GTK_POLICY_AUTOMATIC );
<a name="l02190"></a>02190     gtk_box_pack_start ( GTK_BOX ( vbox), scrolled_window, TRUE, TRUE, 0 );
<a name="l02191"></a>02191     gtk_widget_show ( scrolled_window );
<a name="l02192"></a>02192 
<a name="l02193"></a>02193     vbox = gtk_vbox_new ( FALSE, 5 );
<a name="l02194"></a>02194     gtk_scrolled_window_add_with_viewport ( GTK_SCROLLED_WINDOW ( scrolled_window ), vbox );
<a name="l02195"></a>02195     gtk_container_set_border_width ( GTK_CONTAINER ( vbox ), 10 );
<a name="l02196"></a>02196     gtk_widget_show ( vbox );
<a name="l02197"></a>02197 
<a name="l02198"></a>02198     <span class="comment">/*   on fait maintenant le tour des opés importées et affichent celles à problème */</span>
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     list_tmp = imported_account -&gt; operations_importees;
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     <span class="keywordflow">while</span> ( list_tmp )
<a name="l02203"></a>02203     {
<a name="l02204"></a>02204         <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *ope_import;
<a name="l02205"></a>02205 
<a name="l02206"></a>02206         ope_import = list_tmp -&gt; data;
<a name="l02207"></a>02207 
<a name="l02208"></a>02208         <span class="comment">/* on n&#39;affiche pas si c&#39;est des opés de ventil, si la mère est cochée, les filles </span>
<a name="l02209"></a>02209 <span class="comment">     * seront alors cochées on ne teste pas ici car ça a été testé avant */</span>
<a name="l02210"></a>02210         <span class="keywordflow">if</span> ( ope_import -&gt; action == <a class="code" href="import_8h.html#a1d50fba49a2567252133addea50b83bc">IMPORT_TRANSACTION_ASK_FOR_TRANSACTION</a>
<a name="l02211"></a>02211              &amp;&amp;
<a name="l02212"></a>02212              !ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aa550ffd55aca6827a90343fcc251339f">ope_de_ventilation</a> )
<a name="l02213"></a>02213         {
<a name="l02214"></a>02214             <span class="keyword">const</span> gchar *<a class="code" href="structstruct__ope__importation.html#a29bbb5cbb09891b7d9b8bcecf635a123">tiers</a>;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216             hbox = gtk_hbox_new ( FALSE, 5 );
<a name="l02217"></a>02217             gtk_box_pack_start ( GTK_BOX ( vbox ), hbox, FALSE, FALSE, 0 );
<a name="l02218"></a>02218             gtk_widget_show ( hbox );
<a name="l02219"></a>02219 
<a name="l02220"></a>02220             ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a> = gtk_check_button_new ();
<a name="l02221"></a>02221         <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a> )
<a name="l02222"></a>02222             gtk_toggle_button_set_active ( GTK_TOGGLE_BUTTON ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a> ), TRUE );
<a name="l02223"></a>02223         g_object_set_data ( G_OBJECT ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a> ), <span class="stringliteral">&quot;dialog&quot;</span>, dialog );
<a name="l02224"></a>02224         g_signal_connect ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a>,
<a name="l02225"></a>02225                         <span class="stringliteral">&quot;toggled&quot;</span>,
<a name="l02226"></a>02226                         G_CALLBACK (gsb_import_ope_import_toggled),
<a name="l02227"></a>02227                         vbox );
<a name="l02228"></a>02228             gtk_box_pack_start ( GTK_BOX ( hbox ), ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a>, FALSE, FALSE, 0 );
<a name="l02229"></a>02229             gtk_widget_show ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a> );
<a name="l02230"></a>02230 
<a name="l02231"></a>02231             tmpstr2 = <a class="code" href="gsb__real_8c.html#a9207a2084e51e49584c038b6c8ae4433">gsb_real_get_string</a> (ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a>);
<a name="l02232"></a>02232         <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a> )
<a name="l02233"></a>02233             tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transactions to be merged : %s ; %s ; %s&quot;</span>),
<a name="l02234"></a>02234                         <a class="code" href="utils__dates_8c.html#a6e7537390d7569da5efc74f96ea57da7">gsb_format_gdate</a> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02235"></a>02235                         ope_import -&gt; tiers,
<a name="l02236"></a>02236                         tmpstr2);
<a name="l02237"></a>02237         <span class="keywordflow">else</span>
<a name="l02238"></a>02238             tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transactions to import : %s ; %s ; %s&quot;</span>),
<a name="l02239"></a>02239                         <a class="code" href="utils__dates_8c.html#a6e7537390d7569da5efc74f96ea57da7">gsb_format_gdate</a> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02240"></a>02240                         ope_import -&gt; tiers,
<a name="l02241"></a>02241                         tmpstr2);
<a name="l02242"></a>02242             g_free ( tmpstr2 );
<a name="l02243"></a>02243             label = gtk_label_new ( tmpstr );
<a name="l02244"></a>02244             g_free ( tmpstr );
<a name="l02245"></a>02245             gtk_box_pack_start ( GTK_BOX ( hbox ), label, FALSE, FALSE, 0 );
<a name="l02246"></a>02246             gtk_widget_show ( label );
<a name="l02247"></a>02247 
<a name="l02248"></a>02248 
<a name="l02249"></a>02249             hbox = gtk_hbox_new ( FALSE, 5 );
<a name="l02250"></a>02250             gtk_box_pack_start ( GTK_BOX ( vbox ), hbox, FALSE, FALSE, 0 );
<a name="l02251"></a>02251             gtk_widget_show ( hbox );
<a name="l02252"></a>02252 
<a name="l02253"></a>02253             label = gtk_label_new ( <span class="stringliteral">&quot;       &quot;</span> );
<a name="l02254"></a>02254             gtk_box_pack_start ( GTK_BOX ( hbox ), label, FALSE, FALSE, 0 );
<a name="l02255"></a>02255             gtk_widget_show ( label );
<a name="l02256"></a>02256 
<a name="l02257"></a>02257             tiers = <a class="code" href="gsb__data__payee_8c.html#adc6080b7376628d3902f5fd861deb45a">gsb_data_payee_get_name</a> ( <a class="code" href="gsb__data__transaction_8c.html#afa032df45afa2ad7a4be48449a7e8d15">gsb_data_transaction_get_party_number</a> (
<a name="l02258"></a>02258                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a>), FALSE );
<a name="l02259"></a>02259 
<a name="l02260"></a>02260             <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#ad73b393673217f5b9cc295c74e030550">gsb_data_transaction_get_notes</a> (ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a>))
<a name="l02261"></a>02261             {
<a name="l02262"></a>02262             tmpstr2 = <a class="code" href="gsb__real_8c.html#a9207a2084e51e49584c038b6c8ae4433">gsb_real_get_string</a> (<a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (
<a name="l02263"></a>02263                                 ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a>));
<a name="l02264"></a>02264             tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction found : %s ; %s ; %s ; %s&quot;</span>),
<a name="l02265"></a>02265                         <a class="code" href="utils__dates_8c.html#a6e7537390d7569da5efc74f96ea57da7">gsb_format_gdate</a> ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (
<a name="l02266"></a>02266                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> ) ),
<a name="l02267"></a>02267                         tiers,
<a name="l02268"></a>02268                         tmpstr2,
<a name="l02269"></a>02269                         <a class="code" href="gsb__data__transaction_8c.html#ad73b393673217f5b9cc295c74e030550">gsb_data_transaction_get_notes</a> (ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a>));
<a name="l02270"></a>02270             g_free ( tmpstr2 );
<a name="l02271"></a>02271             label = gtk_label_new ( tmpstr);
<a name="l02272"></a>02272             g_free ( tmpstr );
<a name="l02273"></a>02273             }
<a name="l02274"></a>02274             <span class="keywordflow">else</span>
<a name="l02275"></a>02275             {
<a name="l02276"></a>02276             tmpstr2 = <a class="code" href="gsb__real_8c.html#a9207a2084e51e49584c038b6c8ae4433">gsb_real_get_string</a> (<a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (
<a name="l02277"></a>02277                                 ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a>));
<a name="l02278"></a>02278             tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Transaction found : %s ; %s ; %s&quot;</span>),
<a name="l02279"></a>02279                         <a class="code" href="utils__dates_8c.html#a6e7537390d7569da5efc74f96ea57da7">gsb_format_gdate</a> ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (
<a name="l02280"></a>02280                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> ) ),
<a name="l02281"></a>02281                         tiers,
<a name="l02282"></a>02282                         tmpstr2);
<a name="l02283"></a>02283             g_free ( tmpstr2 );
<a name="l02284"></a>02284             label = gtk_label_new ( tmpstr );
<a name="l02285"></a>02285             g_free ( tmpstr );
<a name="l02286"></a>02286             }
<a name="l02287"></a>02287 
<a name="l02288"></a>02288             gtk_box_pack_start ( GTK_BOX ( hbox ), label, FALSE, FALSE, 0 );
<a name="l02289"></a>02289             gtk_widget_show ( label );
<a name="l02290"></a>02290         }
<a name="l02291"></a>02291         list_tmp = list_tmp -&gt; next;
<a name="l02292"></a>02292     }
<a name="l02293"></a>02293 
<a name="l02294"></a>02294 dialog_return:
<a name="l02295"></a>02295     result = gtk_dialog_run ( GTK_DIALOG ( dialog ));
<a name="l02296"></a>02296 
<a name="l02297"></a>02297     <span class="keywordflow">if</span> ( result &lt;= -12 )
<a name="l02298"></a>02298     {
<a name="l02299"></a>02299         gtk_container_foreach ( GTK_CONTAINER ( vbox ),
<a name="l02300"></a>02300                         (GtkCallback) gsb_import_check_ope_import,
<a name="l02301"></a>02301                         GINT_TO_POINTER ( result ) );
<a name="l02302"></a>02302         <span class="keywordflow">goto</span> dialog_return;
<a name="l02303"></a>02303     }
<a name="l02304"></a>02304     
<a name="l02305"></a>02305     <span class="comment">/* on fait maintenant le tour des check buttons pour voir ce qu&#39;on importe */</span>
<a name="l02306"></a>02306     list_tmp = imported_account -&gt; operations_importees;
<a name="l02307"></a>02307     action_derniere_ventilation = 1;
<a name="l02308"></a>02308 
<a name="l02309"></a>02309     <span class="keywordflow">while</span> ( list_tmp )
<a name="l02310"></a>02310     {
<a name="l02311"></a>02311         <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *ope_import;
<a name="l02312"></a>02312 
<a name="l02313"></a>02313         ope_import = list_tmp -&gt; data;
<a name="l02314"></a>02314 
<a name="l02315"></a>02315         <span class="comment">/* si c&#39;est une opé de ventil, elle n&#39;était pas affichée, dans ce cas si l&#39;action de la</span>
<a name="l02316"></a>02316 <span class="comment">           dernière ventil était 0, on fait de même pour les filles */</span>
<a name="l02317"></a>02317 
<a name="l02318"></a>02318         <span class="keywordflow">if</span> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aa550ffd55aca6827a90343fcc251339f">ope_de_ventilation</a> )
<a name="l02319"></a>02319         {
<a name="l02320"></a>02320             <span class="keywordflow">if</span> ( ope_import -&gt; action )
<a name="l02321"></a>02321             ope_import -&gt; action = action_derniere_ventilation;
<a name="l02322"></a>02322         }
<a name="l02323"></a>02323         <span class="keywordflow">else</span>
<a name="l02324"></a>02324             action_derniere_ventilation = 1;
<a name="l02325"></a>02325 
<a name="l02326"></a>02326         <span class="keywordflow">if</span> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a>
<a name="l02327"></a>02327              &amp;&amp;
<a name="l02328"></a>02328              gtk_toggle_button_get_active ( GTK_TOGGLE_BUTTON ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a971aa1abd415f4c6a78c2e991bbd6978">bouton</a> )))
<a name="l02329"></a>02329         {
<a name="l02330"></a>02330             ope_import -&gt; action = 0;
<a name="l02331"></a>02331 
<a name="l02332"></a>02332             <span class="comment">/* si c&#39;était une ventil on met l&#39;action de la dernière ventil à 0 */</span>
<a name="l02333"></a>02333 
<a name="l02334"></a>02334             <span class="keywordflow">if</span> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#ad0311d9f5d7bf9c8837d31614a176742">operation_ventilee</a> )
<a name="l02335"></a>02335                 action_derniere_ventilation = 0;
<a name="l02336"></a>02336         }
<a name="l02337"></a>02337         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a> &amp;&amp;
<a name="l02338"></a>02338                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> &gt; 0 )
<a name="l02339"></a>02339         {
<a name="l02340"></a>02340             ope_import -&gt; action = 0;
<a name="l02341"></a>02341             <span class="keywordflow">if</span> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#ad0311d9f5d7bf9c8837d31614a176742">operation_ventilee</a> )
<a name="l02342"></a>02342                 action_derniere_ventilation = 0;
<a name="l02343"></a>02343             ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> = 0;
<a name="l02344"></a>02344         }
<a name="l02345"></a>02345         list_tmp = list_tmp -&gt; next;
<a name="l02346"></a>02346     }
<a name="l02347"></a>02347 
<a name="l02348"></a>02348     gtk_widget_destroy ( dialog );
<a name="l02349"></a>02349 }
<a name="l02350"></a>02350 
<a name="l02351"></a>02351 
<a name="l02360"></a>02360 gint gsb_import_create_transaction ( <span class="keyword">struct</span> <a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *imported_transaction,
<a name="l02361"></a>02361                         gint account_number, gchar * origine )
<a name="l02362"></a>02362 {
<a name="l02363"></a>02363     gchar **tab_str;
<a name="l02364"></a>02364     gint transaction_number;
<a name="l02365"></a>02365     gint payee_number = 0;
<a name="l02366"></a>02366     gint fyear = 0;
<a name="l02367"></a>02367     gint last_transaction_number;
<a name="l02368"></a>02368     gint div_number;
<a name="l02369"></a>02369     gint payment_number = 0;
<a name="l02370"></a>02370     gchar* tmpstr = NULL;
<a name="l02371"></a>02371 
<a name="l02372"></a>02372     <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a>
<a name="l02373"></a>02373      &amp;&amp;
<a name="l02374"></a>02374      imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> &gt; 0 )
<a name="l02375"></a>02375         transaction_number = imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a>;
<a name="l02376"></a>02376     <span class="keywordflow">else</span>
<a name="l02377"></a>02377         <span class="comment">/* we create the new transaction */</span>
<a name="l02378"></a>02378         transaction_number = <a class="code" href="gsb__data__transaction_8c.html#af65a20fc0270cbfbc5d69f5d55da8112">gsb_data_transaction_new_transaction</a> ( account_number );
<a name="l02379"></a>02379 
<a name="l02380"></a>02380     <span class="comment">/* get the id if exists */</span>
<a name="l02381"></a>02381     <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a> )
<a name="l02382"></a>02382         <a class="code" href="gsb__data__transaction_8c.html#aaafdf25dfa0a28d07716500082f6c35c">gsb_data_transaction_set_transaction_id</a> ( transaction_number,
<a name="l02383"></a>02383                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a> );
<a name="l02384"></a>02384 
<a name="l02385"></a>02385     <span class="comment">/* get the date */</span>
<a name="l02386"></a>02386     <a class="code" href="gsb__data__transaction_8c.html#a1e1d28bf9c59c6e0f24eaaa68769d302">gsb_data_transaction_set_date</a> ( transaction_number,
<a name="l02387"></a>02387                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> );
<a name="l02388"></a>02388 
<a name="l02389"></a>02389     <span class="comment">/* récupération de la date de valeur */</span>    
<a name="l02390"></a>02390     <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a87810cbd10a0ce882486b602d9de8f36">date_de_valeur</a> )
<a name="l02391"></a>02391     {
<a name="l02392"></a>02392         <a class="code" href="gsb__data__transaction_8c.html#a4c7ae911e47c4968dea14e48bafa34ff">gsb_data_transaction_set_value_date</a> ( transaction_number,
<a name="l02393"></a>02393                             imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a87810cbd10a0ce882486b602d9de8f36">date_de_valeur</a> );
<a name="l02394"></a>02394 
<a name="l02395"></a>02395         <span class="comment">/* set the financial year according to the date or value date */</span>
<a name="l02396"></a>02396         <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#af20e6f2e4e19db775dbd86405e877f09">get_fyear_by_value_date</a> )
<a name="l02397"></a>02397             fyear = <a class="code" href="gsb__data__fyear_8c.html#ae8c0a9df7ec7f52e06c494d38f6de3f7">gsb_data_fyear_get_from_date</a> (
<a name="l02398"></a>02398                     imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a87810cbd10a0ce882486b602d9de8f36">date_de_valeur</a> );
<a name="l02399"></a>02399     }
<a name="l02400"></a>02400 
<a name="l02401"></a>02401     <span class="comment">/* if no fyear found, get from the date */</span>
<a name="l02402"></a>02402     <span class="keywordflow">if</span> (fyear &lt;= 0)
<a name="l02403"></a>02403         fyear = <a class="code" href="gsb__data__fyear_8c.html#ae8c0a9df7ec7f52e06c494d38f6de3f7">gsb_data_fyear_get_from_date</a> (imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> );
<a name="l02404"></a>02404     <span class="keywordflow">if</span> (fyear &gt; 0)
<a name="l02405"></a>02405         <a class="code" href="gsb__data__transaction_8c.html#a305e4bd347a0b42e2a5379b4c109d5b2">gsb_data_transaction_set_financial_year_number</a> ( transaction_number, fyear );
<a name="l02406"></a>02406 
<a name="l02407"></a>02407     <span class="comment">/* on sort de la fonction si on a fusionné des opérations */</span>
<a name="l02408"></a>02408     <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a>
<a name="l02409"></a>02409      &amp;&amp;
<a name="l02410"></a>02410      imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#aab3dedcb8364500b7df11ba68d12541c">ope_correspondante</a> &gt; 0 )
<a name="l02411"></a>02411     {
<a name="l02412"></a>02412         <span class="keywordflow">if</span> ( imported_transaction -&gt; tiers
<a name="l02413"></a>02413          &amp;&amp;
<a name="l02414"></a>02414          strlen (imported_transaction -&gt; tiers) )
<a name="l02415"></a>02415         {
<a name="l02416"></a>02416             <span class="comment">/* Before leaving, we retrieve the data from payee */</span>
<a name="l02417"></a>02417             <a class="code" href="gsb__data__transaction_8c.html#ab503c0949e0aff8438156f760e20f85e">gsb_data_transaction_set_notes</a> ( transaction_number,
<a name="l02418"></a>02418                         imported_transaction -&gt; tiers );
<a name="l02419"></a>02419             <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a628fdfc85cd4c1b52ca5f29b7cb7cd06">get_extract_number_for_check</a> )
<a name="l02420"></a>02420             {
<a name="l02421"></a>02421                 tmpstr = <a class="code" href="utils__str_8c.html#a573a6cddf4b47bcd3a0790575304e4a8">gsb_string_extract_int</a> ( imported_transaction -&gt; tiers );
<a name="l02422"></a>02422                 <span class="keywordflow">if</span> ( tmpstr &amp;&amp; strlen ( tmpstr ) &gt; 0 )
<a name="l02423"></a>02423                 {
<a name="l02424"></a>02424                     payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Check&quot;</span>),
<a name="l02425"></a>02425                             account_number );
<a name="l02426"></a>02426                     <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, 
<a name="l02427"></a>02427                             payment_number);
<a name="l02428"></a>02428                     <a class="code" href="gsb__data__transaction_8c.html#ac4d8a66d20d37abac0fd3af84460921c">gsb_data_transaction_set_method_of_payment_content</a> (
<a name="l02429"></a>02429                             transaction_number, tmpstr );
<a name="l02430"></a>02430                     g_free ( tmpstr );
<a name="l02431"></a>02431                 }
<a name="l02432"></a>02432             }
<a name="l02433"></a>02433         }
<a name="l02434"></a>02434 
<a name="l02435"></a>02435         <span class="keywordflow">return</span> transaction_number;
<a name="l02436"></a>02436     }
<a name="l02437"></a>02437 
<a name="l02438"></a>02438     <span class="comment">/* récupération du montant */</span>
<a name="l02439"></a>02439     <a class="code" href="gsb__data__transaction_8c.html#a76fbbfabc4f16f0f8a51d843785862d7">gsb_data_transaction_set_amount</a> ( transaction_number,
<a name="l02440"></a>02440                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a> );
<a name="l02441"></a>02441 
<a name="l02442"></a>02442     <span class="comment">/* récupération de la devise */</span>
<a name="l02443"></a>02443     <a class="code" href="gsb__data__transaction_8c.html#ad36cc91a9e388b0d249e8d65c17debc0">gsb_data_transaction_set_currency_number</a> ( transaction_number,
<a name="l02444"></a>02444                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a> );
<a name="l02445"></a>02445 
<a name="l02446"></a>02446     <span class="comment">/* Recovery of payee.</span>
<a name="l02447"></a>02447 <span class="comment">     * we routinely backup imported payee. May be replaced later if </span>
<a name="l02448"></a>02448 <span class="comment">     * notes exist to transactions imported */</span>
<a name="l02449"></a>02449     <span class="keywordflow">if</span> ( imported_transaction -&gt; tiers
<a name="l02450"></a>02450      &amp;&amp;
<a name="l02451"></a>02451      strlen (imported_transaction -&gt; tiers))
<a name="l02452"></a>02452     {
<a name="l02453"></a>02453         payee_number = gsb_import_associations_find_payee (
<a name="l02454"></a>02454                         imported_transaction -&gt; tiers );
<a name="l02455"></a>02455         <span class="keywordflow">if</span> ( payee_number == 0 )
<a name="l02456"></a>02456             payee_number = <a class="code" href="gsb__data__payee_8c.html#a0841102ff1dc4d499187b11a187fe92d">gsb_data_payee_get_number_by_name</a> (
<a name="l02457"></a>02457                         imported_transaction -&gt; tiers, TRUE );
<a name="l02458"></a>02458         <span class="keywordflow">else</span>
<a name="l02459"></a>02459         {
<a name="l02460"></a>02460             <span class="keywordflow">if</span> ( g_utf8_collate ( (gchar *) <a class="code" href="gsb__data__payee_8c.html#adc6080b7376628d3902f5fd861deb45a">gsb_data_payee_get_name</a> (
<a name="l02461"></a>02461                         payee_number, FALSE ),
<a name="l02462"></a>02462                         imported_transaction -&gt; tiers ) != 0 )
<a name="l02463"></a>02463                 <a class="code" href="gsb__data__transaction_8c.html#ab503c0949e0aff8438156f760e20f85e">gsb_data_transaction_set_notes</a> ( transaction_number,
<a name="l02464"></a>02464                         imported_transaction -&gt; tiers );
<a name="l02465"></a>02465         }
<a name="l02466"></a>02466         <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a628fdfc85cd4c1b52ca5f29b7cb7cd06">get_extract_number_for_check</a> )
<a name="l02467"></a>02467         {
<a name="l02468"></a>02468             tmpstr = <a class="code" href="utils__str_8c.html#a573a6cddf4b47bcd3a0790575304e4a8">gsb_string_extract_int</a> ( imported_transaction -&gt; tiers );
<a name="l02469"></a>02469             <span class="keywordflow">if</span> ( tmpstr &amp;&amp; strlen ( tmpstr ) &gt; 0 )
<a name="l02470"></a>02470             {
<a name="l02471"></a>02471                 payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Check&quot;</span>),
<a name="l02472"></a>02472                         account_number );
<a name="l02473"></a>02473                 <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, 
<a name="l02474"></a>02474                         payment_number);
<a name="l02475"></a>02475                 <a class="code" href="gsb__data__transaction_8c.html#ac4d8a66d20d37abac0fd3af84460921c">gsb_data_transaction_set_method_of_payment_content</a> (
<a name="l02476"></a>02476                         transaction_number, tmpstr );
<a name="l02477"></a>02477                 g_free ( tmpstr );
<a name="l02478"></a>02478             }
<a name="l02479"></a>02479         }
<a name="l02480"></a>02480         <a class="code" href="gsb__data__transaction_8c.html#ae334be534c1cfcc7dacf260008ee49f2">gsb_data_transaction_set_party_number</a> ( transaction_number, payee_number );
<a name="l02481"></a>02481     }
<a name="l02482"></a>02482 
<a name="l02483"></a>02483     <span class="comment">/* checking if split, otherwise recovery categories */</span>
<a name="l02484"></a>02484     <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#ad0311d9f5d7bf9c8837d31614a176742">operation_ventilee</a> )
<a name="l02485"></a>02485     {
<a name="l02486"></a>02486         <span class="comment">/* transaction is splitted */</span>
<a name="l02487"></a>02487         <a class="code" href="gsb__data__transaction_8c.html#a6296340e0b31e2f5433b37924b86b3e6">gsb_data_transaction_set_split_of_transaction</a> ( transaction_number, 1 );
<a name="l02488"></a>02488     }
<a name="l02489"></a>02489     <span class="keywordflow">else</span>
<a name="l02490"></a>02490     {
<a name="l02491"></a>02491         <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#afa6a9d44530054f14c841f799dc0b723">categ</a>
<a name="l02492"></a>02492             &amp;&amp;
<a name="l02493"></a>02493             strlen (imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#afa6a9d44530054f14c841f799dc0b723">categ</a>))
<a name="l02494"></a>02494         {
<a name="l02495"></a>02495             <span class="comment">/* Fill budget if existing */</span>
<a name="l02496"></a>02496             <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a6f43995ba43d76590e8c3324db78f150">budget</a>
<a name="l02497"></a>02497                 &amp;&amp;
<a name="l02498"></a>02498                 strlen (imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a6f43995ba43d76590e8c3324db78f150">budget</a>))
<a name="l02499"></a>02499             {
<a name="l02500"></a>02500                 gsb_import_lookup_budget(imported_transaction, transaction_number);
<a name="l02501"></a>02501             }
<a name="l02502"></a>02502 
<a name="l02503"></a>02503             <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#afa6a9d44530054f14c841f799dc0b723">categ</a>[0] == <span class="charliteral">&#39;[&#39;</span> )
<a name="l02504"></a>02504             {
<a name="l02505"></a>02505             <span class="comment">/* it&#39;s a transfer,</span>
<a name="l02506"></a>02506 <span class="comment">             * we will try to make the link later, for now, we keep the name of the contra account into</span>
<a name="l02507"></a>02507 <span class="comment">             * the bank references (never used for import)</span>
<a name="l02508"></a>02508 <span class="comment">             * and set contra_transaction_number to -1 to search the link later */</span>
<a name="l02509"></a>02509 
<a name="l02510"></a>02510             <a class="code" href="gsb__data__transaction_8c.html#a4e91601dcc725a5ff6a109e4d1dad915">gsb_data_transaction_set_bank_references</a> ( transaction_number,
<a name="l02511"></a>02511                             imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#afa6a9d44530054f14c841f799dc0b723">categ</a>);
<a name="l02512"></a>02512             <a class="code" href="gsb__data__transaction_8c.html#a7b333676b59c4dae3c5e56a88b4981e3">gsb_data_transaction_set_contra_transaction_number</a> ( transaction_number, -1);
<a name="l02513"></a>02513             virements_a_chercher = 1;
<a name="l02514"></a>02514             }
<a name="l02515"></a>02515             <span class="keywordflow">else</span>
<a name="l02516"></a>02516             {
<a name="l02517"></a>02517             <span class="comment">/* it&#39;s a normal category */</span>
<a name="l02518"></a>02518 
<a name="l02519"></a>02519             gint category_number;
<a name="l02520"></a>02520 
<a name="l02521"></a>02521             tab_str = g_strsplit ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#afa6a9d44530054f14c841f799dc0b723">categ</a>,
<a name="l02522"></a>02522                             <span class="stringliteral">&quot;:&quot;</span>,
<a name="l02523"></a>02523                             2 );
<a name="l02524"></a>02524 
<a name="l02525"></a>02525             <span class="comment">/* get the category and create it if doesn&#39;t exist */</span>
<a name="l02526"></a>02526             <span class="keywordflow">if</span> (tab_str[0])
<a name="l02527"></a>02527                 tab_str[0] = g_strstrip (tab_str[0]);
<a name="l02528"></a>02528             category_number = <a class="code" href="gsb__data__category_8c.html#a0829907fff4f8dda3487debb5f2cc43f">gsb_data_category_get_number_by_name</a> ( tab_str[0],
<a name="l02529"></a>02529                             TRUE,
<a name="l02530"></a>02530                             imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a>.<a class="code" href="structgsb__real.html#a00c99ad79aa77fb0af5b5e08f140b3ae">mantissa</a> &lt; 0 );
<a name="l02531"></a>02531             <a class="code" href="gsb__data__transaction_8c.html#a31f2706a543b988ba279b1cddb40c53e">gsb_data_transaction_set_category_number</a> ( transaction_number,
<a name="l02532"></a>02532                             category_number );
<a name="l02533"></a>02533             <span class="keywordflow">if</span> (tab_str[1])
<a name="l02534"></a>02534                 tab_str[1] = g_strstrip (tab_str[1]);
<a name="l02535"></a>02535             <a class="code" href="gsb__data__transaction_8c.html#a0a63ca7e6d34a226c6f0b8b339fbf518">gsb_data_transaction_set_sub_category_number</a> ( transaction_number,
<a name="l02536"></a>02536                             <a class="code" href="gsb__data__category_8c.html#ae7a9bf73192580090b2d710ec5a1c0f9">gsb_data_category_get_sub_category_number_by_name</a> ( category_number,
<a name="l02537"></a>02537                             tab_str[1],
<a name="l02538"></a>02538                             TRUE ));
<a name="l02539"></a>02539             g_strfreev(tab_str);
<a name="l02540"></a>02540             }
<a name="l02541"></a>02541         }
<a name="l02542"></a>02542         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a3fa0078d2f9783e00e473ee5a127f1f6">get_categorie_for_payee</a> &amp;&amp;  !imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> )
<a name="l02543"></a>02543         {
<a name="l02544"></a>02544             <span class="comment">/* associate the class and the budgetary line to the payee except checks */</span>
<a name="l02545"></a>02545             last_transaction_number = <a class="code" href="gsb__form__transaction_8c.html#a94d3117aba63e480771a5f124c4dc459">gsb_form_transactions_look_for_last_party</a> (
<a name="l02546"></a>02546                                         payee_number, transaction_number,
<a name="l02547"></a>02547                                         account_number );
<a name="l02548"></a>02548             div_number = <a class="code" href="gsb__data__transaction_8c.html#a5cdaf5e8911118bf8d1dbdfc42dc4761">gsb_data_transaction_get_category_number</a> (
<a name="l02549"></a>02549                                         last_transaction_number );
<a name="l02550"></a>02550             <span class="keywordflow">if</span> ( div_number != -1 )
<a name="l02551"></a>02551                 <a class="code" href="gsb__data__transaction_8c.html#a31f2706a543b988ba279b1cddb40c53e">gsb_data_transaction_set_category_number</a> ( transaction_number, div_number );
<a name="l02552"></a>02552 
<a name="l02553"></a>02553             div_number = <a class="code" href="gsb__data__transaction_8c.html#a2e0ed6fbd584d4363d75e4b0155660b7">gsb_data_transaction_get_sub_category_number</a> (
<a name="l02554"></a>02554                                     last_transaction_number );
<a name="l02555"></a>02555             <span class="keywordflow">if</span> ( div_number != -1 )
<a name="l02556"></a>02556                 <a class="code" href="gsb__data__transaction_8c.html#a0a63ca7e6d34a226c6f0b8b339fbf518">gsb_data_transaction_set_sub_category_number</a> ( transaction_number, div_number );
<a name="l02557"></a>02557 
<a name="l02558"></a>02558             div_number = <a class="code" href="gsb__data__transaction_8c.html#a4d84c55dbdfa032c500f4ade0754501f">gsb_data_transaction_get_budgetary_number</a> ( last_transaction_number );
<a name="l02559"></a>02559             <span class="keywordflow">if</span> ( div_number != -1 )
<a name="l02560"></a>02560                 <a class="code" href="gsb__data__transaction_8c.html#a5cdc1a654e5dbb278af9ad23828fe82d">gsb_data_transaction_set_budgetary_number</a> ( transaction_number, div_number );
<a name="l02561"></a>02561 
<a name="l02562"></a>02562             div_number = <a class="code" href="gsb__data__transaction_8c.html#a44dbcf1f953a233d0038027289aa2372">gsb_data_transaction_get_sub_budgetary_number</a> (
<a name="l02563"></a>02563                                     last_transaction_number );
<a name="l02564"></a>02564             <span class="keywordflow">if</span> ( div_number != -1 )
<a name="l02565"></a>02565                 <a class="code" href="gsb__data__transaction_8c.html#aae141d1ea0866286b7d86231862e2b0a">gsb_data_transaction_set_sub_budgetary_number</a> ( transaction_number, div_number );
<a name="l02566"></a>02566         }
<a name="l02567"></a>02567         <span class="keywordflow">else</span>
<a name="l02568"></a>02568         {
<a name="l02569"></a>02569             <a class="code" href="gsb__data__transaction_8c.html#a31f2706a543b988ba279b1cddb40c53e">gsb_data_transaction_set_category_number</a> ( transaction_number, 0 );
<a name="l02570"></a>02570             <a class="code" href="gsb__data__transaction_8c.html#a0a63ca7e6d34a226c6f0b8b339fbf518">gsb_data_transaction_set_sub_category_number</a> ( transaction_number, 0 );
<a name="l02571"></a>02571 
<a name="l02572"></a>02572             <span class="comment">/* Fill budget if existing */</span>
<a name="l02573"></a>02573             <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a6f43995ba43d76590e8c3324db78f150">budget</a>
<a name="l02574"></a>02574                 &amp;&amp;
<a name="l02575"></a>02575                 strlen (imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a6f43995ba43d76590e8c3324db78f150">budget</a>))
<a name="l02576"></a>02576             {
<a name="l02577"></a>02577                 gsb_import_lookup_budget(imported_transaction, transaction_number);
<a name="l02578"></a>02578             }
<a name="l02579"></a>02579         }
<a name="l02580"></a>02580     }
<a name="l02581"></a>02581 
<a name="l02582"></a>02582     <span class="comment">/* récupération des notes */</span>
<a name="l02583"></a>02583     <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9e55cfbe35026b7cabdd2d93e6e6dc3a">notes</a> &amp;&amp;
<a name="l02584"></a>02584                         strlen (imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9e55cfbe35026b7cabdd2d93e6e6dc3a">notes</a>) )
<a name="l02585"></a>02585         <a class="code" href="gsb__data__transaction_8c.html#ab503c0949e0aff8438156f760e20f85e">gsb_data_transaction_set_notes</a> ( transaction_number,
<a name="l02586"></a>02586                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9e55cfbe35026b7cabdd2d93e6e6dc3a">notes</a> );
<a name="l02587"></a>02587 
<a name="l02588"></a>02588     <span class="keywordflow">if</span> (origine &amp;&amp; g_ascii_strcasecmp (origine, <span class="stringliteral">&quot;OFX&quot;</span>) == 0 )
<a name="l02589"></a>02589     {
<a name="l02590"></a>02590     <span class="keywordflow">switch</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a8eafdd598a1677000d009a7da16b81e6">type_de_transaction</a> )
<a name="l02591"></a>02591     {
<a name="l02592"></a>02592         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a791ae71426db867d29e0ce41fe8f4d02">OFX_CHECK</a>:
<a name="l02593"></a>02593         <span class="comment">/* Check = Chèque */</span>
<a name="l02594"></a>02594         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Check&quot;</span>),
<a name="l02595"></a>02595                         account_number );
<a name="l02596"></a>02596         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, 
<a name="l02597"></a>02597                         payment_number);
<a name="l02598"></a>02598         <span class="comment">/* we get the check number */</span>
<a name="l02599"></a>02599         <a class="code" href="gsb__data__transaction_8c.html#ac4d8a66d20d37abac0fd3af84460921c">gsb_data_transaction_set_method_of_payment_content</a> (
<a name="l02600"></a>02600                 transaction_number, imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> );
<a name="l02601"></a>02601 
<a name="l02602"></a>02602         <span class="keywordflow">break</span>;
<a name="l02603"></a>02603         <span class="comment">/* case OFX_INT:</span>
<a name="l02604"></a>02604 <span class="comment">        break;</span>
<a name="l02605"></a>02605 <span class="comment">        case OFX_DIV:</span>
<a name="l02606"></a>02606 <span class="comment">        break;</span>
<a name="l02607"></a>02607 <span class="comment">        case OFX_SRVCHG:</span>
<a name="l02608"></a>02608 <span class="comment">        break;</span>
<a name="l02609"></a>02609 <span class="comment">        case OFX_FEE:</span>
<a name="l02610"></a>02610 <span class="comment">        break; */</span>
<a name="l02611"></a>02611         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ad47566169d26dcbd4effe5bee0a5e02d">OFX_DEP</a>:
<a name="l02612"></a>02612         <span class="comment">/* Deposit = Dépôt */</span>
<a name="l02613"></a>02613         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Deposit&quot;</span>),
<a name="l02614"></a>02614                         account_number );
<a name="l02615"></a>02615         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02616"></a>02616         <span class="keywordflow">break</span>;
<a name="l02617"></a>02617         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a64b99c67932f371b0793f91786dfcbce">OFX_ATM</a>:
<a name="l02618"></a>02618         <span class="comment">/* pas trouvé de définition remplacé par carte de crédit */</span>
<a name="l02619"></a>02619         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Credit card&quot;</span>),
<a name="l02620"></a>02620                         account_number );
<a name="l02621"></a>02621         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02622"></a>02622         <span class="keywordflow">break</span>;
<a name="l02623"></a>02623         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a15566db98285da8aa8c4f3b7b9fabc6e">OFX_POS</a>:
<a name="l02624"></a>02624         <span class="comment">/* Point of sale = Point de vente remplacé par carte de crédit */</span>
<a name="l02625"></a>02625         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Credit card&quot;</span>),
<a name="l02626"></a>02626                         account_number );
<a name="l02627"></a>02627         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02628"></a>02628         <span class="keywordflow">break</span>;
<a name="l02629"></a>02629         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a0cacbc14384739342490f0ee8662e4b6">OFX_XFER</a>:
<a name="l02630"></a>02630         <span class="comment">/* Transfer = Virement */</span>
<a name="l02631"></a>02631         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Transfer&quot;</span>),
<a name="l02632"></a>02632                         account_number );
<a name="l02633"></a>02633         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02634"></a>02634         <span class="keywordflow">break</span>;
<a name="l02635"></a>02635         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a44e13043cd858cc10e0d298c21373ce3">OFX_PAYMENT</a>:
<a name="l02636"></a>02636         <span class="comment">/* Electronic payment remplacé par Direct debit = Prélèvement */</span>
<a name="l02637"></a>02637         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Direct debit&quot;</span>),
<a name="l02638"></a>02638                         account_number );
<a name="l02639"></a>02639         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02640"></a>02640         <span class="keywordflow">break</span>;
<a name="l02641"></a>02641         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a4bef7088f38bcefd900bacc7956f969a">OFX_CASH</a>:
<a name="l02642"></a>02642         <span class="comment">/* Cash withdrawal = retrait en liquide */</span>
<a name="l02643"></a>02643         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Cash withdrawal&quot;</span>),
<a name="l02644"></a>02644                         account_number );
<a name="l02645"></a>02645         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02646"></a>02646         <span class="keywordflow">break</span>;
<a name="l02647"></a>02647         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a1eec1a02b6945ca4ab70e79c617b97ed">OFX_DIRECTDEP</a>:
<a name="l02648"></a>02648         <span class="comment">/* Direct deposit remplacé par Transfert = Virement */</span>
<a name="l02649"></a>02649         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Transfer&quot;</span>),
<a name="l02650"></a>02650                         account_number );
<a name="l02651"></a>02651         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02652"></a>02652         <span class="keywordflow">break</span>;
<a name="l02653"></a>02653         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ac66a49bd7d3e0e14a88c2ea30941efef">OFX_DIRECTDEBIT</a>:
<a name="l02654"></a>02654         <span class="comment">/* Merchant initiated debit remplacé par Direct debit = Prélèvement */</span>
<a name="l02655"></a>02655         payment_number = <a class="code" href="gsb__data__payment_8c.html#a84385c444819731fbdddb56c553ed2e0">gsb_data_payment_get_number_by_name</a> ( _(<span class="stringliteral">&quot;Direct debit&quot;</span>),
<a name="l02656"></a>02656                         account_number );
<a name="l02657"></a>02657         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> (transaction_number, payment_number);
<a name="l02658"></a>02658 
<a name="l02659"></a>02659         <span class="keywordflow">break</span>;
<a name="l02660"></a>02660         <span class="comment">/* case OFX_REPEATPMT:</span>
<a name="l02661"></a>02661 <span class="comment">        break; */</span>
<a name="l02662"></a>02662 
<a name="l02663"></a>02663         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173ab60c4a61836e4c9eddd43df98f58f25a">OFX_DEBIT</a>:
<a name="l02664"></a>02664         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a55a44ce2b4561d75e1387d14bf4346e3">OFX_CREDIT</a>:
<a name="l02665"></a>02665         <span class="keywordflow">case</span> <a class="code" href="import_8c.html#a735cf9b89f806f2be4c52117c5057173a67e1508a2089ea04720e582036f45101">OFX_OTHER</a>:
<a name="l02666"></a>02666         <span class="keywordflow">break</span>;
<a name="l02667"></a>02667     }
<a name="l02668"></a>02668     }
<a name="l02669"></a>02669     <span class="keywordflow">else</span>
<a name="l02670"></a>02670     {
<a name="l02671"></a>02671     <span class="comment">/* récupération du chèque et mise en forme du type d&#39;opération */</span>
<a name="l02672"></a>02672     <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> )
<a name="l02673"></a>02673     {
<a name="l02674"></a>02674     <span class="comment">/* it&#39;s a cheque, try to find a method of payment with automatic increment, if don&#39;t find</span>
<a name="l02675"></a>02675 <span class="comment">     * set in default method of payment */</span>
<a name="l02676"></a>02676     gint payment_number;
<a name="l02677"></a>02677     gint sign;
<a name="l02678"></a>02678 
<a name="l02679"></a>02679     <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (transaction_number).mantissa &lt; 0 )
<a name="l02680"></a>02680     {
<a name="l02681"></a>02681         sign = <a class="code" href="gsb__data__payment_8h.html#a75b824ed98739971febf033ea0293012">GSB_PAYMENT_DEBIT</a>;
<a name="l02682"></a>02682         payment_number = <a class="code" href="gsb__data__account_8c.html#a1b6e5d807cf10ac2685ff23c1da6b131">gsb_data_account_get_default_debit</a> (account_number);
<a name="l02683"></a>02683     }
<a name="l02684"></a>02684     <span class="keywordflow">else</span>
<a name="l02685"></a>02685     {
<a name="l02686"></a>02686         sign = <a class="code" href="gsb__data__payment_8h.html#aeb7171fc651a06537ca3296b3d38680b">GSB_PAYMENT_CREDIT</a>;
<a name="l02687"></a>02687         payment_number = <a class="code" href="gsb__data__account_8c.html#a2a8e260371d44603314ef6058958d025">gsb_data_account_get_default_credit</a> (account_number);
<a name="l02688"></a>02688     }
<a name="l02689"></a>02689 
<a name="l02690"></a>02690     <span class="keywordflow">if</span> ( !<a class="code" href="gsb__data__payment_8c.html#adcfc32426d570e071cb397b7a20e5988">gsb_data_payment_get_automatic_numbering</a> (payment_number))
<a name="l02691"></a>02691     {
<a name="l02692"></a>02692         <span class="comment">/* the default method is not an automatic numbering, try to find one in the method of payment of this account */</span>
<a name="l02693"></a>02693         GSList *list_tmp;
<a name="l02694"></a>02694 
<a name="l02695"></a>02695         list_tmp = <a class="code" href="gsb__data__payment_8c.html#acec454aa5a57af2dd716d6b38e97baec">gsb_data_payment_get_payments_list</a> ();
<a name="l02696"></a>02696         <span class="keywordflow">while</span> (list_tmp)
<a name="l02697"></a>02697         {
<a name="l02698"></a>02698         gint payment_number_tmp;
<a name="l02699"></a>02699 
<a name="l02700"></a>02700         payment_number_tmp = <a class="code" href="gsb__data__payment_8c.html#ad8738991cf8066d32f2a9a76f465f941">gsb_data_payment_get_number</a> (list_tmp -&gt; data);
<a name="l02701"></a>02701 
<a name="l02702"></a>02702         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__payment_8c.html#a02601e83e3a7796d9fc863077dd91627">gsb_data_payment_get_account_number</a> (payment_number_tmp) == account_number
<a name="l02703"></a>02703              &amp;&amp;
<a name="l02704"></a>02704              <a class="code" href="gsb__data__payment_8c.html#adcfc32426d570e071cb397b7a20e5988">gsb_data_payment_get_automatic_numbering</a> (payment_number_tmp)
<a name="l02705"></a>02705              &amp;&amp;
<a name="l02706"></a>02706              ( <a class="code" href="gsb__data__payment_8c.html#a18c88a62c285b34be984f88c03dc2e70">gsb_data_payment_get_sign</a> (payment_number_tmp) == sign
<a name="l02707"></a>02707                ||
<a name="l02708"></a>02708                <a class="code" href="gsb__data__payment_8c.html#a18c88a62c285b34be984f88c03dc2e70">gsb_data_payment_get_sign</a> (payment_number_tmp) == <a class="code" href="gsb__data__payment_8h.html#a4cc6ee85419c370a33a7f4522cb96b31">GSB_PAYMENT_NEUTRAL</a> ))
<a name="l02709"></a>02709         {
<a name="l02710"></a>02710             payment_number = payment_number_tmp;
<a name="l02711"></a>02711             <span class="keywordflow">break</span>;
<a name="l02712"></a>02712         }
<a name="l02713"></a>02713         list_tmp = list_tmp -&gt; next;
<a name="l02714"></a>02714         }
<a name="l02715"></a>02715     }
<a name="l02716"></a>02716     <span class="comment">/* now, either payment_number is an automatic numbering method of payment,</span>
<a name="l02717"></a>02717 <span class="comment">     * either it&#39;s the default method of payment,</span>
<a name="l02718"></a>02718 <span class="comment">     * first save it */</span>
<a name="l02719"></a>02719     <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> ( transaction_number,
<a name="l02720"></a>02720                         payment_number );
<a name="l02721"></a>02721 
<a name="l02722"></a>02722     <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__payment_8c.html#adcfc32426d570e071cb397b7a20e5988">gsb_data_payment_get_automatic_numbering</a> (payment_number))
<a name="l02723"></a>02723         <span class="comment">/* we are on the default payment_number, save just the cheque number */</span>
<a name="l02724"></a>02724         <a class="code" href="gsb__data__transaction_8c.html#ac4d8a66d20d37abac0fd3af84460921c">gsb_data_transaction_set_method_of_payment_content</a> ( transaction_number,
<a name="l02725"></a>02725                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> );
<a name="l02726"></a>02726     <span class="keywordflow">else</span>
<a name="l02727"></a>02727     {
<a name="l02728"></a>02728         <span class="comment">/* we are on a automatic numbering payment, we will save the cheque only</span>
<a name="l02729"></a>02729 <span class="comment">         * if it&#39;s not used before, else we show an warning message */</span>
<a name="l02730"></a>02730         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a40575cdeac27ba06abb312fabd076564">gsb_data_transaction_check_content_payment</a> ( payment_number, imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> ) )
<a name="l02731"></a>02731         {
<a name="l02732"></a>02732         gchar* tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;Warning : the cheque number %s is already used.\nWe skip it&quot;</span>),
<a name="l02733"></a>02733                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> );
<a name="l02734"></a>02734         <a class="code" href="dialog_8c.html#a198880c6e09a934c62fd541c9cb302f9">dialogue_warning</a> ( tmpstr );
<a name="l02735"></a>02735         g_free ( tmpstr );
<a name="l02736"></a>02736         }
<a name="l02737"></a>02737         <span class="keywordflow">else</span>
<a name="l02738"></a>02738         <a class="code" href="gsb__data__transaction_8c.html#ac4d8a66d20d37abac0fd3af84460921c">gsb_data_transaction_set_method_of_payment_content</a> ( transaction_number,
<a name="l02739"></a>02739                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9bf5717da655fe4e25e8c4006584d5de">cheque</a> );
<a name="l02740"></a>02740     }
<a name="l02741"></a>02741     g_free ( tmpstr );
<a name="l02742"></a>02742     }
<a name="l02743"></a>02743     <span class="keywordflow">else</span>
<a name="l02744"></a>02744     {
<a name="l02745"></a>02745     <span class="comment">/* comme ce n&#39;est pas un chèque, on met sur le type par défaut */</span>
<a name="l02746"></a>02746     <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (transaction_number).mantissa &lt; 0 )
<a name="l02747"></a>02747         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> ( transaction_number,
<a name="l02748"></a>02748                         <a class="code" href="gsb__data__account_8c.html#a1b6e5d807cf10ac2685ff23c1da6b131">gsb_data_account_get_default_debit</a> (account_number));
<a name="l02749"></a>02749     <span class="keywordflow">else</span>
<a name="l02750"></a>02750         <a class="code" href="gsb__data__transaction_8c.html#a2ec47094f3a4b930dc6057f574af8019">gsb_data_transaction_set_method_of_payment_number</a> ( transaction_number,
<a name="l02751"></a>02751                         <a class="code" href="gsb__data__account_8c.html#a2a8e260371d44603314ef6058958d025">gsb_data_account_get_default_credit</a> (account_number));
<a name="l02752"></a>02752     }
<a name="l02753"></a>02753     }
<a name="l02754"></a>02754     <span class="comment">/* récupération du pointé */</span>
<a name="l02755"></a>02755     <a class="code" href="gsb__data__transaction_8c.html#ad6f2f1403737959c3aee7059b7115399">gsb_data_transaction_set_marked_transaction</a> ( transaction_number,
<a name="l02756"></a>02756                         imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9b894c7f538103950a23655ff003b5f1">p_r</a> );
<a name="l02757"></a>02757     <span class="keywordflow">if</span> (imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a9b894c7f538103950a23655ff003b5f1">p_r</a> == <a class="code" href="gsb__data__transaction_8h.html#a82f385a1c75ac98496b5c09a123bf521a41425f55add3a05ffc4c7aa366048fc9">OPERATION_RAPPROCHEE</a>)
<a name="l02758"></a>02758     marked_r_transactions_imported = TRUE;
<a name="l02759"></a>02759 
<a name="l02760"></a>02760 
<a name="l02761"></a>02761     <span class="comment">/* si c&#39;est une ope de ventilation, lui ajoute le no de l&#39;opération précédente */</span>
<a name="l02762"></a>02762     <span class="keywordflow">if</span> ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#aa550ffd55aca6827a90343fcc251339f">ope_de_ventilation</a> )
<a name="l02763"></a>02763     <a class="code" href="gsb__data__transaction_8c.html#abfffebad5a6949bd032c09311e3f995e">gsb_data_transaction_set_mother_transaction_number</a> ( transaction_number,
<a name="l02764"></a>02764                         mother_transaction_number );
<a name="l02765"></a>02765     <span class="keywordflow">else</span>
<a name="l02766"></a>02766     mother_transaction_number  = transaction_number;
<a name="l02767"></a>02767 
<a name="l02768"></a>02768     <span class="keywordflow">return</span> (transaction_number);
<a name="l02769"></a>02769 }
<a name="l02770"></a>02770 
<a name="l02771"></a>02771 
<a name="l02772"></a>02772 
<a name="l02777"></a>02777 <span class="keywordtype">void</span> pointe_opes_importees ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *imported_account,
<a name="l02778"></a>02778                         gint account_number )
<a name="l02779"></a>02779 {
<a name="l02780"></a>02780     GSList *list_tmp;
<a name="l02781"></a>02781     GSList *liste_opes_import_celibataires;
<a name="l02782"></a>02782 
<a name="l02783"></a>02783     <span class="comment">/* si le compte importé a une id, on la vérifie ici */</span>
<a name="l02784"></a>02784     <span class="comment">/*     si elle est absente, on met celle importée */</span>
<a name="l02785"></a>02785     <span class="comment">/*     si elle est différente, on demande si on la remplace */</span>
<a name="l02786"></a>02786     <span class="keywordflow">if</span> ( imported_account -&gt; id_compte )
<a name="l02787"></a>02787     {
<a name="l02788"></a>02788         <span class="keywordflow">if</span> ( ! gsb_import_set_id_compte ( account_number, imported_account -&gt; id_compte ) )
<a name="l02789"></a>02789             <span class="keywordflow">return</span>;
<a name="l02790"></a>02790     }
<a name="l02791"></a>02791 
<a name="l02792"></a>02792     <span class="comment">/* on fait le tour des opés importées et recherche dans la liste d&#39;opé s&#39;il y a la </span>
<a name="l02793"></a>02793 <span class="comment">     * correspondance */</span>
<a name="l02794"></a>02794     list_tmp = imported_account -&gt; operations_importees;
<a name="l02795"></a>02795     liste_opes_import_celibataires = NULL;
<a name="l02796"></a>02796 
<a name="l02797"></a>02797     <span class="keywordflow">while</span> ( list_tmp )
<a name="l02798"></a>02798     {
<a name="l02799"></a>02799         GSList *liste_ope_importees_tmp;
<a name="l02800"></a>02800         GSList *ope_trouvees;
<a name="l02801"></a>02801         <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *ope_import;
<a name="l02802"></a>02802         gint transaction_number;
<a name="l02803"></a>02803         gint i;
<a name="l02804"></a>02804 
<a name="l02805"></a>02805         ope_import = list_tmp -&gt; data;
<a name="l02806"></a>02806         ope_trouvees = NULL;
<a name="l02807"></a>02807 
<a name="l02808"></a>02808         <span class="comment">/* set now the account number of the transaction */</span>
<a name="l02809"></a>02809         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a8f9a20942dd3d0811670c24f9daa1a62">no_compte</a> = account_number;
<a name="l02810"></a>02810 
<a name="l02811"></a>02811         <span class="comment">/* si l&#39;opé d&#39;import a une id, on recherche dans la liste d&#39;opé pour trouver</span>
<a name="l02812"></a>02812 <span class="comment">           une id comparable */</span>
<a name="l02813"></a>02813         <span class="keywordflow">if</span> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a>
<a name="l02814"></a>02814              &amp;&amp;
<a name="l02815"></a>02815              (transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a8904a22be0f714a36c52e4924491e959">gsb_data_transaction_find_by_id</a> (
<a name="l02816"></a>02816                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a>, account_number ) ) )
<a name="l02817"></a>02817             ope_trouvees = g_slist_append ( ope_trouvees,
<a name="l02818"></a>02818                                             GINT_TO_POINTER (transaction_number));
<a name="l02819"></a>02819 
<a name="l02820"></a>02820         <span class="comment">/* si on n&#39;a rien trouvé par id, */</span>
<a name="l02821"></a>02821         <span class="comment">/* on fait le tour de la liste d&#39;opés pour trouver des opés comparable */</span>
<a name="l02822"></a>02822         <span class="comment">/* cad même date avec + ou - une échelle et même montant et pas une opé de ventil */</span>
<a name="l02823"></a>02823         <span class="keywordflow">if</span> ( !ope_trouvees )
<a name="l02824"></a>02824         {
<a name="l02825"></a>02825             GDate *date_debut_comparaison;
<a name="l02826"></a>02826             GDate *date_fin_comparaison;
<a name="l02827"></a>02827             GSList *list_tmp_transactions;
<a name="l02828"></a>02828 
<a name="l02829"></a>02829             date_debut_comparaison = g_date_new_dmy ( g_date_get_day ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02830"></a>02830                                                       g_date_get_month ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02831"></a>02831                                                       g_date_get_year ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ));
<a name="l02832"></a>02832             g_date_subtract_days ( date_debut_comparaison,
<a name="l02833"></a>02833                                    valeur_echelle_recherche_date_import );
<a name="l02834"></a>02834 
<a name="l02835"></a>02835             date_fin_comparaison = g_date_new_dmy ( g_date_get_day ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02836"></a>02836                                                     g_date_get_month ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02837"></a>02837                                                     g_date_get_year ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ));
<a name="l02838"></a>02838             g_date_add_days ( date_fin_comparaison,
<a name="l02839"></a>02839                               valeur_echelle_recherche_date_import );
<a name="l02840"></a>02840 
<a name="l02841"></a>02841         <span class="keywordflow">if</span> ( imported_account -&gt; invert_transaction_amount )
<a name="l02842"></a>02842             ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a> =  <a class="code" href="gsb__real_8c.html#aee7dfb40ef3a60df7a55c6ccfcc6dfef">gsb_real_opposite</a> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a> );
<a name="l02843"></a>02843  
<a name="l02844"></a>02844             list_tmp_transactions = <a class="code" href="gsb__data__transaction_8c.html#af781a71a62eece020188ef62847f2887">gsb_data_transaction_get_transactions_list</a> ();
<a name="l02845"></a>02845 
<a name="l02846"></a>02846             <span class="keywordflow">while</span> ( list_tmp_transactions )
<a name="l02847"></a>02847             {
<a name="l02848"></a>02848                 transaction_number = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (
<a name="l02849"></a>02849                         list_tmp_transactions -&gt; data);
<a name="l02850"></a>02850                 <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (transaction_number) == account_number )
<a name="l02851"></a>02851                 {
<a name="l02852"></a>02852                     <span class="keywordflow">if</span> ( !<a class="code" href="gsb__real_8c.html#a9ffa1aad0087896f5a3f1e2320c97db4">gsb_real_cmp</a> ( <a class="code" href="gsb__data__transaction_8c.html#a632c5ba71e742b3ac063b4b3207cf032">gsb_data_transaction_get_amount</a> (transaction_number),
<a name="l02853"></a>02853                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a> )
<a name="l02854"></a>02854                          &amp;&amp;
<a name="l02855"></a>02855                          ( g_date_compare ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (transaction_number),
<a name="l02856"></a>02856                                             date_debut_comparaison ) &gt;= 0 )
<a name="l02857"></a>02857                          &amp;&amp;
<a name="l02858"></a>02858                          ( g_date_compare ( <a class="code" href="gsb__data__transaction_8c.html#ab0b62014885bcf3e2fbfff1ae9b32080">gsb_data_transaction_get_date</a> (transaction_number),
<a name="l02859"></a>02859                                             date_fin_comparaison ) &lt;= 0 )
<a name="l02860"></a>02860 
<a name="l02861"></a>02861                          &amp;&amp;
<a name="l02862"></a>02862                          !<a class="code" href="gsb__data__transaction_8c.html#a6018560ece7ab02e8d46bc9bdaffd607">gsb_data_transaction_get_mother_transaction_number</a> (transaction_number))
<a name="l02863"></a>02863                         <span class="comment">/* on a retouvé une opé de même date et même montant, on l&#39;ajoute à la liste </span>
<a name="l02864"></a>02864 <span class="comment">             * des opés trouvées */</span>
<a name="l02865"></a>02865                         ope_trouvees = g_slist_append ( ope_trouvees,
<a name="l02866"></a>02866                                                         GINT_TO_POINTER (transaction_number));
<a name="l02867"></a>02867                 }
<a name="l02868"></a>02868                 list_tmp_transactions = list_tmp_transactions -&gt; next;
<a name="l02869"></a>02869             }
<a name="l02870"></a>02870         }
<a name="l02871"></a>02871         <span class="comment">/* à ce stade, ope_trouvees contient la ou les opés qui sont comparables à l&#39;opé importée */</span>
<a name="l02872"></a>02872         <span class="comment">/* soit il n&#39;y en n&#39;a qu&#39;une, et on la pointe, soit il y en a plusieurs, et on recherche */</span>
<a name="l02873"></a>02873         <span class="comment">/* les opés importées s&#39;il y en a d&#39;autre comparables, et on pointe les opés en fonction */</span>
<a name="l02874"></a>02874         <span class="comment">/* du nb de celles importées */</span>
<a name="l02875"></a>02875         <span class="keywordflow">switch</span> ( g_slist_length ( ope_trouvees ))
<a name="l02876"></a>02876         {
<a name="l02877"></a>02877             <span class="keywordflow">case</span> 0:
<a name="l02878"></a>02878                 <span class="comment">/* aucune opé comparable n&#39;a été retrouvée */</span>
<a name="l02879"></a>02879                 <span class="comment">/* on marque donc cette opé comme seule */</span>
<a name="l02880"></a>02880                 <span class="comment">/* sauf si c&#39;est une opé de ventil  */</span>
<a name="l02881"></a>02881 
<a name="l02882"></a>02882                 <span class="keywordflow">if</span> ( !ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#aa550ffd55aca6827a90343fcc251339f">ope_de_ventilation</a> )
<a name="l02883"></a>02883                 {
<a name="l02884"></a>02884                     <span class="comment">/* on met le no de compte et la devise de l&#39;opération si plus tard on l&#39;enregistre */</span>
<a name="l02885"></a>02885 
<a name="l02886"></a>02886             <span class="keywordflow">if</span> (imported_account -&gt; bouton_devise)
<a name="l02887"></a>02887                 ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a> = <a class="code" href="gsb__currency_8c.html#a3abd39af3aafa4213a8ffbe74d5d6b10">gsb_currency_get_currency_from_combobox</a> (
<a name="l02888"></a>02888                             imported_account -&gt; bouton_devise);
<a name="l02889"></a>02889             <span class="keywordflow">else</span>
<a name="l02890"></a>02890                 ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a> = <a class="code" href="gsb__data__currency_8c.html#ad6f48bd7a2a3533c4be0f5453d2be28b">gsb_data_currency_get_number_by_code_iso4217</a> (
<a name="l02891"></a>02891                             imported_account -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a>);
<a name="l02892"></a>02892 
<a name="l02893"></a>02893                     liste_opes_import_celibataires = g_slist_append ( liste_opes_import_celibataires,
<a name="l02894"></a>02894                                     ope_import );
<a name="l02895"></a>02895                 }
<a name="l02896"></a>02896 
<a name="l02897"></a>02897                 <span class="keywordflow">break</span>;
<a name="l02898"></a>02898 
<a name="l02899"></a>02899             <span class="keywordflow">case</span> 1:
<a name="l02900"></a>02900                 <span class="comment">/*  il n&#39;y a qu&#39;une opé retrouvée, on la pointe */</span>
<a name="l02901"></a>02901                 <span class="comment">/* si elle est déjà pointée ou relevée, on ne fait rien */</span>
<a name="l02902"></a>02902                 <span class="comment">/* si l&#39;opé d&#39;import a une id et pas l&#39;opé, on marque l&#39;id dans l&#39;opé */</span>
<a name="l02903"></a>02903 
<a name="l02904"></a>02904         transaction_number = GPOINTER_TO_INT ( ope_trouvees -&gt; data );
<a name="l02905"></a>02905 
<a name="l02906"></a>02906                 <span class="keywordflow">if</span> ( strlen ( <a class="code" href="gsb__data__transaction_8c.html#ad171eaf081403c90154beddf8521983f">gsb_data_transaction_get_transaction_id</a> ( transaction_number ) ) == 0
<a name="l02907"></a>02907                      &amp;&amp;
<a name="l02908"></a>02908                      ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a> )
<a name="l02909"></a>02909                     <a class="code" href="gsb__data__transaction_8c.html#aaafdf25dfa0a28d07716500082f6c35c">gsb_data_transaction_set_transaction_id</a> ( transaction_number,
<a name="l02910"></a>02910                                     ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a> );
<a name="l02911"></a>02911 
<a name="l02912"></a>02912                 <span class="keywordflow">if</span> ( !<a class="code" href="gsb__data__transaction_8c.html#a52cf9684818c3930c5c688b54f7cf393">gsb_data_transaction_get_marked_transaction</a> (transaction_number))
<a name="l02913"></a>02913                 {
<a name="l02914"></a>02914                     <a class="code" href="gsb__data__transaction_8c.html#ad6f2f1403737959c3aee7059b7115399">gsb_data_transaction_set_marked_transaction</a> ( transaction_number,
<a name="l02915"></a>02915                                     2 );
<a name="l02916"></a>02916                     <span class="comment">/* si c&#39;est une opé ventilée, on recherche les opé filles pour leur mettre </span>
<a name="l02917"></a>02917 <span class="comment">             * le même pointage que la mère */</span>
<a name="l02918"></a>02918                     <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a2de1ba38ee196b44e3c00c10e1d645cc">gsb_data_transaction_get_split_of_transaction</a> (transaction_number))
<a name="l02919"></a>02919                     {
<a name="l02920"></a>02920                         GSList *list_tmp_transactions;
<a name="l02921"></a>02921 
<a name="l02922"></a>02922                         list_tmp_transactions = <a class="code" href="gsb__data__transaction_8c.html#af781a71a62eece020188ef62847f2887">gsb_data_transaction_get_transactions_list</a> ();
<a name="l02923"></a>02923 
<a name="l02924"></a>02924                         <span class="keywordflow">while</span> ( list_tmp_transactions )
<a name="l02925"></a>02925                         {
<a name="l02926"></a>02926                             gint transaction_number_tmp;
<a name="l02927"></a>02927                             transaction_number_tmp = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (
<a name="l02928"></a>02928                                             list_tmp_transactions -&gt; data);
<a name="l02929"></a>02929 
<a name="l02930"></a>02930                             <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (transaction_number_tmp) == account_number
<a name="l02931"></a>02931                                  &amp;&amp;
<a name="l02932"></a>02932                                  <a class="code" href="gsb__data__transaction_8c.html#a6018560ece7ab02e8d46bc9bdaffd607">gsb_data_transaction_get_mother_transaction_number</a> (transaction_number_tmp) == transaction_number)
<a name="l02933"></a>02933                                 <a class="code" href="gsb__data__transaction_8c.html#ad6f2f1403737959c3aee7059b7115399">gsb_data_transaction_set_marked_transaction</a> ( transaction_number_tmp, 2 );
<a name="l02934"></a>02934                             list_tmp_transactions = list_tmp_transactions -&gt; next;
<a name="l02935"></a>02935                         }
<a name="l02936"></a>02936                     }
<a name="l02937"></a>02937                 }
<a name="l02938"></a>02938 
<a name="l02939"></a>02939         <span class="comment">/* récupération de la date de valeur */</span>    
<a name="l02940"></a>02940         <span class="keywordflow">if</span> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a87810cbd10a0ce882486b602d9de8f36">date_de_valeur</a> )
<a name="l02941"></a>02941         {
<a name="l02942"></a>02942             gint fyear = 0;
<a name="l02943"></a>02943 
<a name="l02944"></a>02944             <a class="code" href="gsb__data__transaction_8c.html#a4c7ae911e47c4968dea14e48bafa34ff">gsb_data_transaction_set_value_date</a> ( transaction_number,
<a name="l02945"></a>02945                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a87810cbd10a0ce882486b602d9de8f36">date_de_valeur</a> );
<a name="l02946"></a>02946         <span class="comment">/* set the financial year according to the date or value date */</span>
<a name="l02947"></a>02947             <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#af20e6f2e4e19db775dbd86405e877f09">get_fyear_by_value_date</a> )
<a name="l02948"></a>02948                 fyear = <a class="code" href="gsb__data__fyear_8c.html#ae8c0a9df7ec7f52e06c494d38f6de3f7">gsb_data_fyear_get_from_date</a> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a87810cbd10a0ce882486b602d9de8f36">date_de_valeur</a> );
<a name="l02949"></a>02949             <span class="keywordflow">if</span> (fyear &gt; 0)
<a name="l02950"></a>02950                 <a class="code" href="gsb__data__transaction_8c.html#a305e4bd347a0b42e2a5379b4c109d5b2">gsb_data_transaction_set_financial_year_number</a> ( transaction_number, fyear );
<a name="l02951"></a>02951 
<a name="l02952"></a>02952         }
<a name="l02953"></a>02953 
<a name="l02954"></a>02954                 <span class="keywordflow">break</span>;
<a name="l02955"></a>02955 
<a name="l02956"></a>02956             <span class="keywordflow">default</span>:
<a name="l02957"></a>02957                 <span class="comment">/* il y a plusieurs opé trouvées correspondant à l&#39;opé importée */</span>
<a name="l02958"></a>02958 
<a name="l02959"></a>02959                 <span class="comment">/* on va voir s&#39;il y a d&#39;autres opées importées ayant la même date et le même montant</span>
<a name="l02960"></a>02960 <span class="comment">                   si on retrouve autant d&#39;opé importées que d&#39;opé trouvées, on peut marquer cette</span>
<a name="l02961"></a>02961 <span class="comment">                   opé sans s&#39;en préoccuper */</span>
<a name="l02962"></a>02962                 i=0;
<a name="l02963"></a>02963                 liste_ope_importees_tmp = imported_account -&gt; operations_importees;
<a name="l02964"></a>02964 
<a name="l02965"></a>02965                 <span class="keywordflow">while</span> ( liste_ope_importees_tmp )
<a name="l02966"></a>02966                 {
<a name="l02967"></a>02967                     <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *ope_import_tmp;
<a name="l02968"></a>02968                     GDate *date_debut_comparaison;
<a name="l02969"></a>02969                     GDate *date_fin_comparaison;
<a name="l02970"></a>02970 
<a name="l02971"></a>02971                     ope_import_tmp = liste_ope_importees_tmp -&gt; data;
<a name="l02972"></a>02972 
<a name="l02973"></a>02973                     <span class="comment">/* we look for a date around ope_import_tmp with +- valeur_echelle_recherche_date_import */</span>
<a name="l02974"></a>02974                     date_debut_comparaison = g_date_new_dmy ( g_date_get_day ( ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02975"></a>02975                                     g_date_get_month ( ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02976"></a>02976                                     g_date_get_year ( ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ));
<a name="l02977"></a>02977                     g_date_subtract_days ( date_debut_comparaison,
<a name="l02978"></a>02978                                     valeur_echelle_recherche_date_import );
<a name="l02979"></a>02979 
<a name="l02980"></a>02980                     date_fin_comparaison = g_date_new_dmy ( g_date_get_day ( ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02981"></a>02981                                     g_date_get_month ( ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l02982"></a>02982                                     g_date_get_year ( ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ));
<a name="l02983"></a>02983                     g_date_add_days ( date_fin_comparaison,
<a name="l02984"></a>02984                                     valeur_echelle_recherche_date_import );
<a name="l02985"></a>02985 
<a name="l02986"></a>02986                     <span class="keywordflow">if</span> ( !<a class="code" href="gsb__real_8c.html#a9ffa1aad0087896f5a3f1e2320c97db4">gsb_real_cmp</a> ( ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a>,
<a name="l02987"></a>02987                                          ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a>  )
<a name="l02988"></a>02988                          &amp;&amp;
<a name="l02989"></a>02989                          ( g_date_compare ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a>,
<a name="l02990"></a>02990                                             date_debut_comparaison ) &gt;= 0 )
<a name="l02991"></a>02991                          &amp;&amp;
<a name="l02992"></a>02992                          ( g_date_compare ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a>,
<a name="l02993"></a>02993                                             date_fin_comparaison ) &lt;= 0 )
<a name="l02994"></a>02994 
<a name="l02995"></a>02995                          &amp;&amp;
<a name="l02996"></a>02996                          !ope_import_tmp -&gt; <a class="code" href="structstruct__ope__importation.html#aa550ffd55aca6827a90343fcc251339f">ope_de_ventilation</a> )
<a name="l02997"></a>02997                         <span class="comment">/* on a retouvé une opé d&#39;import de même date et même montant, on incrémente </span>
<a name="l02998"></a>02998 <span class="comment">             * le nb d&#39;opé d&#39;import semblables trouvees */</span>
<a name="l02999"></a>02999                         i++;
<a name="l03000"></a>03000 
<a name="l03001"></a>03001                     liste_ope_importees_tmp = liste_ope_importees_tmp -&gt; next;
<a name="l03002"></a>03002                 }
<a name="l03003"></a>03003 
<a name="l03004"></a>03004                 <span class="keywordflow">if</span> ( i ==  g_slist_length ( ope_trouvees ))
<a name="l03005"></a>03005                 {
<a name="l03006"></a>03006                     <span class="comment">/* on a trouvé autant d&#39;opé d&#39;import semblables que d&#39;opés semblables dans la </span>
<a name="l03007"></a>03007 <span class="comment">             * liste d&#39;opé donc on peut marquer les opés trouvées */</span>
<a name="l03008"></a>03008                     <span class="comment">/* pour celles qui sont déjà pointées, on ne fait rien */</span>
<a name="l03009"></a>03009                     <span class="comment">/* si l&#39;opé importée à une id, on met cette id dans l&#39;opération si elle n&#39;en a pas */</span>
<a name="l03010"></a>03010 
<a name="l03011"></a>03011                     GSList *list_tmp_2;
<a name="l03012"></a>03012 
<a name="l03013"></a>03013                     list_tmp_2 = ope_trouvees;
<a name="l03014"></a>03014 
<a name="l03015"></a>03015                     <span class="keywordflow">while</span> ( list_tmp_2 )
<a name="l03016"></a>03016                     {
<a name="l03017"></a>03017                         gint transaction_number;
<a name="l03018"></a>03018 
<a name="l03019"></a>03019                         transaction_number = GPOINTER_TO_INT (list_tmp_2 -&gt; data);
<a name="l03020"></a>03020 
<a name="l03021"></a>03021                         <span class="keywordflow">if</span> ( strlen ( <a class="code" href="gsb__data__transaction_8c.html#ad171eaf081403c90154beddf8521983f">gsb_data_transaction_get_transaction_id</a> ( transaction_number ) ) == 0
<a name="l03022"></a>03022                              &amp;&amp;
<a name="l03023"></a>03023                              ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a> )
<a name="l03024"></a>03024                             <a class="code" href="gsb__data__transaction_8c.html#aaafdf25dfa0a28d07716500082f6c35c">gsb_data_transaction_set_transaction_id</a> ( transaction_number,
<a name="l03025"></a>03025                                     ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a9117942cf1ba68459e85803c55420dd0">id_operation</a> );
<a name="l03026"></a>03026 
<a name="l03027"></a>03027                         <span class="keywordflow">if</span> ( !<a class="code" href="gsb__data__transaction_8c.html#a52cf9684818c3930c5c688b54f7cf393">gsb_data_transaction_get_marked_transaction</a> (transaction_number))
<a name="l03028"></a>03028                         {
<a name="l03029"></a>03029                             <a class="code" href="gsb__data__transaction_8c.html#ad6f2f1403737959c3aee7059b7115399">gsb_data_transaction_set_marked_transaction</a> ( transaction_number, 2 );
<a name="l03030"></a>03030 
<a name="l03031"></a>03031                             <span class="comment">/* si c&#39;est une opé ventilée, on recherche les opé filles pour leur mettre </span>
<a name="l03032"></a>03032 <span class="comment">                 * le même pointage que la mère */</span>
<a name="l03033"></a>03033                             <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a2de1ba38ee196b44e3c00c10e1d645cc">gsb_data_transaction_get_split_of_transaction</a> (transaction_number))
<a name="l03034"></a>03034                             {
<a name="l03035"></a>03035                                 GSList *list_tmp_transactions;
<a name="l03036"></a>03036 
<a name="l03037"></a>03037                                 list_tmp_transactions = <a class="code" href="gsb__data__transaction_8c.html#af781a71a62eece020188ef62847f2887">gsb_data_transaction_get_transactions_list</a> ();
<a name="l03038"></a>03038 
<a name="l03039"></a>03039                                 <span class="keywordflow">while</span> ( list_tmp_transactions )
<a name="l03040"></a>03040                                 {
<a name="l03041"></a>03041                                     gint transaction_number_tmp;
<a name="l03042"></a>03042                                     transaction_number_tmp = <a class="code" href="gsb__data__transaction_8c.html#a99bf548513083f4a71fe019faeccbe0a">gsb_data_transaction_get_transaction_number</a> (list_tmp_transactions -&gt; data);
<a name="l03043"></a>03043 
<a name="l03044"></a>03044                                     <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a5b486efbc486f946e9c998a114054bce">gsb_data_transaction_get_account_number</a> (transaction_number_tmp) == account_number )
<a name="l03045"></a>03045                                     {
<a name="l03046"></a>03046                                         <span class="keywordflow">if</span> ( <a class="code" href="gsb__data__transaction_8c.html#a6018560ece7ab02e8d46bc9bdaffd607">gsb_data_transaction_get_mother_transaction_number</a> (transaction_number_tmp) == transaction_number)
<a name="l03047"></a>03047                                             <a class="code" href="gsb__data__transaction_8c.html#ad6f2f1403737959c3aee7059b7115399">gsb_data_transaction_set_marked_transaction</a> ( transaction_number_tmp,
<a name="l03048"></a>03048                                                                                           2 );
<a name="l03049"></a>03049                                     }
<a name="l03050"></a>03050                                     list_tmp_transactions = list_tmp_transactions -&gt; next;
<a name="l03051"></a>03051                                 }
<a name="l03052"></a>03052                             }
<a name="l03053"></a>03053                         }
<a name="l03054"></a>03054                         list_tmp_2 = list_tmp_2 -&gt; next;
<a name="l03055"></a>03055                     }
<a name="l03056"></a>03056                 }
<a name="l03057"></a>03057                 <span class="keywordflow">else</span>
<a name="l03058"></a>03058                 {
<a name="l03059"></a>03059                     <span class="comment">/* on a trouvé un nombre différent d&#39;opés d&#39;import et d&#39;opés semblables dans </span>
<a name="l03060"></a>03060 <span class="comment">             * la liste d&#39;opés on marque donc cette opé d&#39;import comme seule */</span>
<a name="l03061"></a>03061 
<a name="l03062"></a>03062                     ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a> = <a class="code" href="gsb__currency_8c.html#a3abd39af3aafa4213a8ffbe74d5d6b10">gsb_currency_get_currency_from_combobox</a> (
<a name="l03063"></a>03063                         imported_account -&gt; bouton_devise);
<a name="l03064"></a>03064                     liste_opes_import_celibataires = g_slist_append (
<a name="l03065"></a>03065                         liste_opes_import_celibataires, ope_import );
<a name="l03066"></a>03066 
<a name="l03067"></a>03067                 }
<a name="l03068"></a>03068         }
<a name="l03069"></a>03069         list_tmp = list_tmp -&gt; next;
<a name="l03070"></a>03070     }
<a name="l03071"></a>03071 
<a name="l03072"></a>03072     <span class="comment">/* a ce niveau, liste_opes_import_celibataires contient les opés d&#39;import dont on</span>
<a name="l03073"></a>03073 <span class="comment">     * n&#39;a pas retrouvé l&#39;opé correspondante</span>
<a name="l03074"></a>03074 <span class="comment">     * on les affiche dans une liste en proposant de les ajouter à la liste */</span>
<a name="l03075"></a>03075 
<a name="l03076"></a>03076     <span class="keywordflow">if</span> ( liste_opes_import_celibataires )
<a name="l03077"></a>03077         gsb_import_show_orphan_transactions ( liste_opes_import_celibataires );
<a name="l03078"></a>03078 }
<a name="l03079"></a>03079 
<a name="l03080"></a>03080 
<a name="l03089"></a>03089 <span class="keywordtype">void</span> gsb_import_show_orphan_transactions ( GSList *orphan_list )
<a name="l03090"></a>03090 {
<a name="l03091"></a>03091         GtkWidget *liste_ope_celibataires, *dialog, *label, *scrolled_window;
<a name="l03092"></a>03092         GtkListStore *store;
<a name="l03093"></a>03093         GtkCellRenderer *renderer;
<a name="l03094"></a>03094         GtkTreeViewColumn *column;
<a name="l03095"></a>03095     GSList *list_tmp;
<a name="l03096"></a>03096 
<a name="l03097"></a>03097     dialog = gtk_dialog_new_with_buttons ( _(<span class="stringliteral">&quot;Orphaned transactions&quot;</span>),
<a name="l03098"></a>03098                         GTK_WINDOW ( <a class="code" href="accueil_8c.html#a3d346c08cf2d67c388caabffb412b293">window</a> ),
<a name="l03099"></a>03099                         GTK_DIALOG_MODAL | GTK_DIALOG_DESTROY_WITH_PARENT,
<a name="l03100"></a>03100                         GTK_STOCK_SELECT_ALL, GTK_RESPONSE_ACCEPT,
<a name="l03101"></a>03101                         GTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL,
<a name="l03102"></a>03102                         GTK_STOCK_OK, GTK_RESPONSE_OK,
<a name="l03103"></a>03103                         NULL );
<a name="l03104"></a>03104 
<a name="l03105"></a>03105     gtk_window_set_default_size ( GTK_WINDOW ( dialog ), 770, 412 );
<a name="l03106"></a>03106     gtk_window_set_position ( GTK_WINDOW ( dialog ), GTK_WIN_POS_CENTER_ON_PARENT );
<a name="l03107"></a>03107     gtk_window_set_resizable ( GTK_WINDOW ( dialog ), TRUE );
<a name="l03108"></a>03108     gtk_container_set_border_width ( GTK_CONTAINER(dialog), 12 );
<a name="l03109"></a>03109 
<a name="l03110"></a>03110         label = gtk_label_new ( _(<span class="stringliteral">&quot;Mark transactions you want to add to the list and click the &quot;</span>
<a name="l03111"></a>03111                               <span class="stringliteral">&quot;OK button&quot;</span>));
<a name="l03112"></a>03112     gtk_misc_set_alignment ( GTK_MISC ( label ), 0.0, 0.0 );
<a name="l03113"></a>03113         gtk_box_pack_start ( GTK_BOX ( GTK_DIALOG ( dialog ) -&gt; vbox ),
<a name="l03114"></a>03114                         label,
<a name="l03115"></a>03115                         FALSE,
<a name="l03116"></a>03116                         FALSE,
<a name="l03117"></a>03117                         10 );
<a name="l03118"></a>03118         gtk_widget_show ( label );
<a name="l03119"></a>03119 
<a name="l03120"></a>03120     <span class="comment">/* on crée le model et on y associe le dialogue */</span>
<a name="l03121"></a>03121         store = gtk_list_store_new ( 4,
<a name="l03122"></a>03122                         G_TYPE_BOOLEAN,
<a name="l03123"></a>03123                         G_TYPE_STRING,
<a name="l03124"></a>03124                         G_TYPE_STRING,
<a name="l03125"></a>03125                         G_TYPE_STRING );
<a name="l03126"></a>03126     g_object_set_data ( G_OBJECT ( store ), <span class="stringliteral">&quot;dialog&quot;</span>, dialog );
<a name="l03127"></a>03127 
<a name="l03128"></a>03128         <span class="comment">/* on remplit la liste */</span>
<a name="l03129"></a>03129         list_tmp = orphan_list;
<a name="l03130"></a>03130 
<a name="l03131"></a>03131         <span class="keywordflow">while</span> ( list_tmp )
<a name="l03132"></a>03132         {
<a name="l03133"></a>03133             <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *ope_import;
<a name="l03134"></a>03134             GtkTreeIter iter;
<a name="l03135"></a>03135 
<a name="l03136"></a>03136             ope_import = list_tmp -&gt; data;
<a name="l03137"></a>03137 
<a name="l03138"></a>03138             gtk_list_store_append ( store, &amp;iter );
<a name="l03139"></a>03139             gtk_list_store_set ( store,
<a name="l03140"></a>03140                         &amp;iter,
<a name="l03141"></a>03141                         0, FALSE,
<a name="l03142"></a>03142                         1, <a class="code" href="utils__dates_8c.html#a6e7537390d7569da5efc74f96ea57da7">gsb_format_gdate</a> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a> ),
<a name="l03143"></a>03143                         2, ope_import -&gt; tiers,
<a name="l03144"></a>03144                         3, <a class="code" href="gsb__real_8c.html#a03f4474a9a4269e384951af9be4acedd">gsb_real_get_string_with_currency</a> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a6eb3906974bf127228cb61ca9ea1389f">montant</a>,
<a name="l03145"></a>03145                         ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#ac3ee087af86e925117eaa97d036e626a">devise</a>, TRUE ),
<a name="l03146"></a>03146                         -1 );
<a name="l03147"></a>03147 
<a name="l03148"></a>03148             list_tmp = list_tmp -&gt; next;
<a name="l03149"></a>03149         }
<a name="l03150"></a>03150 
<a name="l03151"></a>03151         <span class="comment">/* on crée la liste des opés célibataires et on y associe la gslist */</span>
<a name="l03152"></a>03152         liste_ope_celibataires = gtk_tree_view_new_with_model ( GTK_TREE_MODEL (store));
<a name="l03153"></a>03153         g_object_set_data ( G_OBJECT ( liste_ope_celibataires ), <span class="stringliteral">&quot;liste_ope&quot;</span>, orphan_list );
<a name="l03154"></a>03154 
<a name="l03155"></a>03155         scrolled_window = gtk_scrolled_window_new ( FALSE, FALSE );
<a name="l03156"></a>03156         gtk_widget_set_size_request ( scrolled_window, -1, 300 );
<a name="l03157"></a>03157         gtk_box_pack_start ( GTK_BOX ( GTK_DIALOG ( dialog ) -&gt; vbox ),
<a name="l03158"></a>03158                         scrolled_window,
<a name="l03159"></a>03159                         TRUE,
<a name="l03160"></a>03160                         TRUE,
<a name="l03161"></a>03161                         0 );
<a name="l03162"></a>03162         gtk_scrolled_window_set_policy ( GTK_SCROLLED_WINDOW ( scrolled_window ),
<a name="l03163"></a>03163                         GTK_POLICY_AUTOMATIC,
<a name="l03164"></a>03164                         GTK_POLICY_AUTOMATIC );
<a name="l03165"></a>03165         gtk_scrolled_window_add_with_viewport ( GTK_SCROLLED_WINDOW ( scrolled_window ),
<a name="l03166"></a>03166                                                 liste_ope_celibataires );
<a name="l03167"></a>03167     gtk_tree_view_set_rules_hint (GTK_TREE_VIEW (liste_ope_celibataires), TRUE);
<a name="l03168"></a>03168         gtk_widget_show_all ( scrolled_window );
<a name="l03169"></a>03169 
<a name="l03170"></a>03170         <span class="comment">/* on affiche les colonnes */</span>
<a name="l03171"></a>03171         renderer = gtk_cell_renderer_toggle_new ();
<a name="l03172"></a>03172         g_signal_connect ( renderer,
<a name="l03173"></a>03173                         <span class="stringliteral">&quot;toggled&quot;</span>,
<a name="l03174"></a>03174                         G_CALLBACK (click_sur_liste_opes_orphelines ),
<a name="l03175"></a>03175                         store );
<a name="l03176"></a>03176         column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Mark&quot;</span>),
<a name="l03177"></a>03177                         renderer,
<a name="l03178"></a>03178                         <span class="stringliteral">&quot;active&quot;</span>, 0,
<a name="l03179"></a>03179                         NULL);
<a name="l03180"></a>03180         gtk_tree_view_append_column (GTK_TREE_VIEW (liste_ope_celibataires), column);
<a name="l03181"></a>03181 
<a name="l03182"></a>03182         renderer = gtk_cell_renderer_text_new ();
<a name="l03183"></a>03183         column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Date&quot;</span>),
<a name="l03184"></a>03184                         renderer,
<a name="l03185"></a>03185                         <span class="stringliteral">&quot;text&quot;</span>, 1,
<a name="l03186"></a>03186                         NULL);
<a name="l03187"></a>03187         gtk_tree_view_append_column (GTK_TREE_VIEW (liste_ope_celibataires), column);
<a name="l03188"></a>03188 
<a name="l03189"></a>03189         renderer = gtk_cell_renderer_text_new ();
<a name="l03190"></a>03190         column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Payee&quot;</span>),
<a name="l03191"></a>03191                         renderer,
<a name="l03192"></a>03192                         <span class="stringliteral">&quot;text&quot;</span>, 2,
<a name="l03193"></a>03193                         NULL);
<a name="l03194"></a>03194         gtk_tree_view_append_column (GTK_TREE_VIEW (liste_ope_celibataires), column);
<a name="l03195"></a>03195 
<a name="l03196"></a>03196         renderer = gtk_cell_renderer_text_new ();
<a name="l03197"></a>03197         column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Amount&quot;</span>),
<a name="l03198"></a>03198                         renderer,
<a name="l03199"></a>03199                         <span class="stringliteral">&quot;text&quot;</span>, 3,
<a name="l03200"></a>03200                         NULL);
<a name="l03201"></a>03201         gtk_tree_view_append_column (GTK_TREE_VIEW (liste_ope_celibataires), column);
<a name="l03202"></a>03202 
<a name="l03203"></a>03203         g_signal_connect ( G_OBJECT ( dialog ),
<a name="l03204"></a>03204                         <span class="stringliteral">&quot;response&quot;</span>,
<a name="l03205"></a>03205                         G_CALLBACK ( click_dialog_ope_orphelines ),
<a name="l03206"></a>03206                         liste_ope_celibataires );
<a name="l03207"></a>03207 
<a name="l03208"></a>03208         gtk_widget_show ( dialog );
<a name="l03209"></a>03209 }
<a name="l03218"></a>03218 gboolean gsb_import_set_id_compte ( gint account_nb, gchar *imported_id )
<a name="l03219"></a>03219 {
<a name="l03220"></a>03220     gchar *account_id;
<a name="l03221"></a>03221 
<a name="l03222"></a>03222     account_id = <a class="code" href="gsb__data__account_8c.html#a8e894871e7b44a38b1a3450eab292fd2">gsb_data_account_get_id</a> ( account_nb );
<a name="l03223"></a>03223     <span class="keywordflow">if</span> ( account_id )
<a name="l03224"></a>03224         {
<a name="l03225"></a>03225             <span class="keywordflow">if</span> ( g_ascii_strcasecmp ( account_id, imported_id ) )
<a name="l03226"></a>03226             {
<a name="l03227"></a>03227                 <span class="comment">/*              l&#39;id du compte choisi et l&#39;id du compte importé sont différents */</span>
<a name="l03228"></a>03228                 <span class="comment">/*                  on propose encore d&#39;arrêter... */</span>
<a name="l03229"></a>03229             <span class="keywordflow">if</span> ( <a class="code" href="dialog_8c.html#a9947d688fe96a482d5444e62108a4ed4">question_yes_no_hint</a> (
<a name="l03230"></a>03230                         _(<span class="stringliteral">&quot;The id of the imported and chosen accounts are different&quot;</span>),
<a name="l03231"></a>03231                                             _(<span class="stringliteral">&quot;Perhaps you choose a wrong account ?  If you choose to continue, &quot;</span>
<a name="l03232"></a>03232                         <span class="stringliteral">&quot;the id of the account will be changed.  Do you want to continue ?&quot;</span>),
<a name="l03233"></a>03233                                             GTK_RESPONSE_NO ) )
<a name="l03234"></a>03234                 <a class="code" href="gsb__data__account_8c.html#a7fb3fd2eb6e83fb23e80ff982755d9b6">gsb_data_account_set_id</a> ( account_nb, <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> ( imported_id ) );
<a name="l03235"></a>03235             <span class="keywordflow">else</span>
<a name="l03236"></a>03236                 <span class="keywordflow">return</span> FALSE;
<a name="l03237"></a>03237             }
<a name="l03238"></a>03238         }
<a name="l03239"></a>03239         <span class="keywordflow">else</span>
<a name="l03240"></a>03240             <a class="code" href="gsb__data__account_8c.html#a7fb3fd2eb6e83fb23e80ff982755d9b6">gsb_data_account_set_id</a> ( account_nb, <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> ( imported_id ) );
<a name="l03241"></a>03241 
<a name="l03242"></a>03242     <span class="keywordflow">return</span> TRUE;
<a name="l03243"></a>03243 }
<a name="l03244"></a>03244 
<a name="l03245"></a>03245 
<a name="l03254"></a>03254 GDate *gsb_import_get_first_date ( GSList *import_list )
<a name="l03255"></a>03255 {
<a name="l03256"></a>03256     GSList *list_tmp;
<a name="l03257"></a>03257     GDate *first_date = NULL;
<a name="l03258"></a>03258 
<a name="l03259"></a>03259     list_tmp = import_list;
<a name="l03260"></a>03260 
<a name="l03261"></a>03261     <span class="keywordflow">while</span> ( list_tmp )
<a name="l03262"></a>03262     {
<a name="l03263"></a>03263         <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *imported_transaction;
<a name="l03264"></a>03264 
<a name="l03265"></a>03265         imported_transaction = list_tmp -&gt; data;
<a name="l03266"></a>03266 
<a name="l03267"></a>03267         <span class="keywordflow">if</span> ( !first_date
<a name="l03268"></a>03268          ||
<a name="l03269"></a>03269          g_date_compare ( imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a>, first_date ) &lt; 0 )
<a name="l03270"></a>03270             first_date = imported_transaction -&gt; <a class="code" href="structstruct__ope__importation.html#a98d11b6875040c7783b12abdedc6f5a0">date</a>;
<a name="l03271"></a>03271 
<a name="l03272"></a>03272         list_tmp = list_tmp -&gt; next;
<a name="l03273"></a>03273     }
<a name="l03274"></a>03274 
<a name="l03275"></a>03275     first_date = <a class="code" href="utils__dates_8c.html#ad688d2e013a4c82fa7e1cb47f64054d4">gsb_date_copy</a> ( first_date );
<a name="l03276"></a>03276     g_date_subtract_days ( first_date, valeur_echelle_recherche_date_import );
<a name="l03277"></a>03277 
<a name="l03278"></a>03278     <span class="keywordflow">return</span> first_date;
<a name="l03279"></a>03279 }
<a name="l03280"></a>03280 
<a name="l03281"></a>03281 
<a name="l03282"></a>03282 <span class="comment">/* *******************************************************************************/</span>
<a name="l03283"></a>03283 
<a name="l03284"></a>03284 
<a name="l03285"></a>03285 <span class="comment">/* *******************************************************************************/</span>
<a name="l03286"></a>03286 gboolean click_dialog_ope_orphelines ( GtkWidget *dialog,
<a name="l03287"></a>03287                         gint result,
<a name="l03288"></a>03288                         GtkWidget *liste_ope_celibataires )
<a name="l03289"></a>03289 {
<a name="l03290"></a>03290     GSList *liste_opes_import_celibataires;
<a name="l03291"></a>03291     GSList *list_tmp;
<a name="l03292"></a>03292     GtkTreeIter iter;
<a name="l03293"></a>03293     GtkTreeModel *model;
<a name="l03294"></a>03294 
<a name="l03295"></a>03295     <span class="keywordflow">switch</span> ( result )
<a name="l03296"></a>03296     {
<a name="l03297"></a>03297         <span class="keywordflow">case</span> GTK_RESPONSE_ACCEPT:
<a name="l03298"></a>03298         <span class="comment">/* on coche toutes les cases des opérations */</span>
<a name="l03299"></a>03299         liste_opes_import_celibataires = g_object_get_data (
<a name="l03300"></a>03300                         G_OBJECT ( liste_ope_celibataires ),
<a name="l03301"></a>03301                         <span class="stringliteral">&quot;liste_ope&quot;</span> );
<a name="l03302"></a>03302             model = gtk_tree_view_get_model ( GTK_TREE_VIEW ( liste_ope_celibataires ));
<a name="l03303"></a>03303             <span class="keywordflow">if</span> ( gtk_tree_model_get_iter_first ( GTK_TREE_MODEL ( model ), &amp;iter ) )
<a name="l03304"></a>03304         {
<a name="l03305"></a>03305             <span class="keywordflow">do</span>
<a name="l03306"></a>03306             {
<a name="l03307"></a>03307                 gtk_list_store_set ( GTK_LIST_STORE ( model ), &amp;iter, 0, TRUE, -1 );
<a name="l03308"></a>03308             }
<a name="l03309"></a>03309             <span class="keywordflow">while</span> ( gtk_tree_model_iter_next ( GTK_TREE_MODEL ( model ), &amp;iter ) );
<a name="l03310"></a>03310         }
<a name="l03311"></a>03311         gtk_dialog_set_response_sensitive ( GTK_DIALOG ( dialog ),GTK_RESPONSE_ACCEPT, FALSE );
<a name="l03312"></a>03312         <span class="keywordflow">break</span>;
<a name="l03313"></a>03313         <span class="keywordflow">case</span> GTK_RESPONSE_OK:
<a name="l03314"></a>03314             <span class="comment">/* on ajoute la ou les opés marquées à la liste d&#39;opés en les pointant d&#39;un T</span>
<a name="l03315"></a>03315 <span class="comment">               puis on les retire de la liste des orphelines</span>
<a name="l03316"></a>03316 <span class="comment">               s&#39;il ne reste plus d&#39;opés orphelines, on ferme la boite de dialogue */</span>
<a name="l03317"></a>03317 
<a name="l03318"></a>03318             liste_opes_import_celibataires = g_object_get_data ( G_OBJECT ( liste_ope_celibataires ),
<a name="l03319"></a>03319                                                                  <span class="stringliteral">&quot;liste_ope&quot;</span> );
<a name="l03320"></a>03320             model = gtk_tree_view_get_model ( GTK_TREE_VIEW ( liste_ope_celibataires ));
<a name="l03321"></a>03321             gtk_tree_model_get_iter_first ( GTK_TREE_MODEL ( model ),
<a name="l03322"></a>03322                                             &amp;iter );
<a name="l03323"></a>03323 
<a name="l03324"></a>03324             list_tmp = liste_opes_import_celibataires;
<a name="l03325"></a>03325 
<a name="l03326"></a>03326             <span class="comment">/* normalement, pas besoin de mettre ça à 0 car normalement pas de ventilations à ce stade... */</span>
<a name="l03327"></a>03327 
<a name="l03328"></a>03328             mother_transaction_number = 0;
<a name="l03329"></a>03329 
<a name="l03330"></a>03330             <span class="keywordflow">while</span> ( list_tmp )
<a name="l03331"></a>03331             {
<a name="l03332"></a>03332                 gboolean enregistre;
<a name="l03333"></a>03333                 GSList *last_item;
<a name="l03334"></a>03334 
<a name="l03335"></a>03335                 gtk_tree_model_get ( GTK_TREE_MODEL ( model ),
<a name="l03336"></a>03336                                      &amp;iter,
<a name="l03337"></a>03337                                      0, &amp;enregistre,
<a name="l03338"></a>03338                                      -1 );
<a name="l03339"></a>03339 
<a name="l03340"></a>03340                 <span class="keywordflow">if</span> ( enregistre )
<a name="l03341"></a>03341                 {
<a name="l03342"></a>03342                     <span class="comment">/* à ce niveau, l&#39;opé a été cochée donc on l&#39;enregistre en la marquant T        */</span>
<a name="l03343"></a>03343 
<a name="l03344"></a>03344                     <span class="keyword">struct </span><a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *ope_import;
<a name="l03345"></a>03345                     gint transaction_number;
<a name="l03346"></a>03346 
<a name="l03347"></a>03347                     ope_import = list_tmp -&gt; data;
<a name="l03348"></a>03348 
<a name="l03349"></a>03349                     transaction_number = gsb_import_create_transaction ( ope_import,
<a name="l03350"></a>03350                                                                          ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a8f9a20942dd3d0811670c24f9daa1a62">no_compte</a> , NULL);
<a name="l03351"></a>03351                     <a class="code" href="gsb__data__transaction_8c.html#ad6f2f1403737959c3aee7059b7115399">gsb_data_transaction_set_marked_transaction</a> ( transaction_number, 2 );
<a name="l03352"></a>03352 
<a name="l03353"></a>03353             <span class="comment">/* we need to add the transaction now to the tree model and update the tree_view */</span>
<a name="l03354"></a>03354             <a class="code" href="gsb__transactions__list_8c.html#ab384002f4635a570bc9907b04b3efd24">gsb_transactions_list_append_new_transaction</a> (transaction_number, FALSE);
<a name="l03355"></a>03355             <a class="code" href="gsb__transactions__list_8c.html#ab7d08f59bcf7149edda9db47e67333a4">gsb_transactions_list_update_tree_view</a> (ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a8f9a20942dd3d0811670c24f9daa1a62">no_compte</a>, FALSE);
<a name="l03356"></a>03356             <a class="code" href="gsb__data__account_8c.html#a4607ab78b42360bded7a2203dca78931">gsb_data_account_colorize_current_balance</a> ( ope_import -&gt; <a class="code" href="structstruct__ope__importation.html#a8f9a20942dd3d0811670c24f9daa1a62">no_compte</a> );
<a name="l03357"></a>03357 
<a name="l03358"></a>03358                     <span class="comment">/* on a enregistré l&#39;opé, on la retire maintenant de la liste et de la sliste */</span>
<a name="l03359"></a>03359                     last_item = list_tmp;
<a name="l03360"></a>03360                     list_tmp = list_tmp -&gt; next;
<a name="l03361"></a>03361                     liste_opes_import_celibataires = g_slist_remove_link ( liste_opes_import_celibataires,
<a name="l03362"></a>03362                                                                            last_item );
<a name="l03363"></a>03363 
<a name="l03364"></a>03364                     <span class="comment">/* on retire la ligne qu&#39;on vient d&#39;enregistrer, celà met l&#39;iter directement sur </span>
<a name="l03365"></a>03365 <span class="comment">             * la suite */</span>
<a name="l03366"></a>03366                     gtk_list_store_remove ( GTK_LIST_STORE ( model),
<a name="l03367"></a>03367                                             &amp;iter );
<a name="l03368"></a>03368                 }
<a name="l03369"></a>03369                 <span class="keywordflow">else</span>
<a name="l03370"></a>03370                 {
<a name="l03371"></a>03371                     gtk_tree_model_iter_next ( GTK_TREE_MODEL ( model ),
<a name="l03372"></a>03372                                                &amp;iter );
<a name="l03373"></a>03373                     list_tmp = list_tmp -&gt; next;
<a name="l03374"></a>03374                 }
<a name="l03375"></a>03375             }
<a name="l03376"></a>03376 
<a name="l03377"></a>03377             <span class="comment">/* on enregistre la nouvelle liste d&#39;opé pour la retrouver plus tard */</span>
<a name="l03378"></a>03378 
<a name="l03379"></a>03379             g_object_set_data ( G_OBJECT ( liste_ope_celibataires ),
<a name="l03380"></a>03380                                 <span class="stringliteral">&quot;liste_ope&quot;</span>,
<a name="l03381"></a>03381                                 liste_opes_import_celibataires );
<a name="l03382"></a>03382 
<a name="l03383"></a>03383             <span class="comment">/* il est possible que les opés importées soient des virements, il faut faire les</span>
<a name="l03384"></a>03384 <span class="comment">               relations ici */</span>
<a name="l03385"></a>03385             <span class="keywordflow">if</span> ( virements_a_chercher )
<a name="l03386"></a>03386                 cree_liens_virements_ope_import ();
<a name="l03387"></a>03387 
<a name="l03388"></a>03388             <span class="comment">/* mise à jour de l&#39;accueil */</span>
<a name="l03389"></a>03389 
<a name="l03390"></a>03390             <a class="code" href="accueil_8c.html#a018917e8dacfd8fbe4e94d0f99a59c08">mise_a_jour_liste_comptes_accueil</a> = 1;
<a name="l03391"></a>03391             <a class="code" href="accueil_8c.html#afaffaedc4fd0ae8638f7158c6777b35b">mise_a_jour_soldes_minimaux</a> = 1;
<a name="l03392"></a>03392 
<a name="l03393"></a>03393             <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a9d0fa9057da603e64a601d69d7bf2b51">modification_fichier</a> == 0 )
<a name="l03394"></a>03394             <a class="code" href="traitement__variables_8c.html#aa4084b9e508b1d1fea1d09c6b6208021">modification_fichier</a> ( TRUE );
<a name="l03395"></a>03395 
<a name="l03396"></a>03396             <span class="keywordflow">if</span> ( result != GTK_RESPONSE_OK
<a name="l03397"></a>03397                  &amp;&amp;
<a name="l03398"></a>03398                  g_slist_length ( liste_opes_import_celibataires ))
<a name="l03399"></a>03399                 <span class="keywordflow">break</span>;
<a name="l03400"></a>03400         <span class="keywordflow">default</span>:
<a name="l03401"></a>03401             gtk_widget_destroy ( dialog );
<a name="l03402"></a>03402             <span class="keywordflow">break</span>;
<a name="l03403"></a>03403     }
<a name="l03404"></a>03404 
<a name="l03405"></a>03405     <span class="keywordflow">return</span> ( FALSE );
<a name="l03406"></a>03406 }
<a name="l03407"></a>03407 <span class="comment">/* *******************************************************************************/</span>
<a name="l03408"></a>03408 
<a name="l03409"></a>03409 
<a name="l03410"></a>03410 <span class="comment">/* *******************************************************************************/</span>
<a name="l03411"></a>03411 gboolean click_sur_liste_opes_orphelines ( GtkCellRendererToggle *renderer,
<a name="l03412"></a>03412                         gchar *ligne,
<a name="l03413"></a>03413                         GtkTreeModel *store )
<a name="l03414"></a>03414 {
<a name="l03415"></a>03415     GtkTreeIter iter;
<a name="l03416"></a>03416     gboolean valeur;
<a name="l03417"></a>03417 
<a name="l03418"></a>03418     <span class="keywordflow">if</span> ( gtk_tree_model_get_iter_from_string ( GTK_TREE_MODEL ( store ), &amp;iter, ligne ) )
<a name="l03419"></a>03419     {
<a name="l03420"></a>03420         gtk_tree_model_get ( GTK_TREE_MODEL ( store ), &amp;iter, 0, &amp;valeur, -1 );
<a name="l03421"></a>03421         gtk_list_store_set ( GTK_LIST_STORE ( store ), &amp;iter, 0, 1 - valeur, -1 );
<a name="l03422"></a>03422     }
<a name="l03423"></a>03423     <span class="keywordflow">if</span> ( gtk_tree_model_get_iter_first ( GTK_TREE_MODEL ( store ), &amp;iter ) )
<a name="l03424"></a>03424     {
<a name="l03425"></a>03425         gboolean all_true = TRUE;
<a name="l03426"></a>03426         GtkDialog *dialog;
<a name="l03427"></a>03427 
<a name="l03428"></a>03428         dialog = g_object_get_data ( G_OBJECT ( store ), <span class="stringliteral">&quot;dialog&quot;</span> );
<a name="l03429"></a>03429         <span class="keywordflow">do</span>
<a name="l03430"></a>03430         {
<a name="l03431"></a>03431             gtk_tree_model_get ( GTK_TREE_MODEL ( store ), &amp;iter, 0, &amp;valeur, -1 );
<a name="l03432"></a>03432             <span class="keywordflow">if</span> ( valeur == FALSE )
<a name="l03433"></a>03433                 all_true = FALSE;
<a name="l03434"></a>03434         }
<a name="l03435"></a>03435         <span class="keywordflow">while</span> ( gtk_tree_model_iter_next ( GTK_TREE_MODEL ( store ), &amp;iter ) );
<a name="l03436"></a>03436 
<a name="l03437"></a>03437         <span class="keywordflow">if</span> ( all_true == TRUE )
<a name="l03438"></a>03438             gtk_dialog_set_response_sensitive ( dialog,GTK_RESPONSE_ACCEPT, FALSE );
<a name="l03439"></a>03439         <span class="keywordflow">else</span>
<a name="l03440"></a>03440             gtk_dialog_set_response_sensitive ( dialog,GTK_RESPONSE_ACCEPT, TRUE );
<a name="l03441"></a>03441     }
<a name="l03442"></a>03442     <span class="keywordflow">return</span> ( FALSE );
<a name="l03443"></a>03443 }
<a name="l03444"></a>03444 
<a name="l03445"></a>03445 
<a name="l03446"></a>03446 
<a name="l03455"></a><a class="code" href="import_8h.html#a749d3f56e4864750955ed170111dca08">03455</a> G_MODULE_EXPORT gchar * <a class="code" href="import_8c.html#a749d3f56e4864750955ed170111dca08">unique_imported_name</a> ( gchar * account_name )
<a name="l03456"></a>03456 {
<a name="l03457"></a>03457     GSList * tmp_list = liste_comptes_importes;
<a name="l03458"></a>03458     gchar * basename = <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> (account_name);
<a name="l03459"></a>03459     gint iter = 1;
<a name="l03460"></a>03460 
<a name="l03461"></a>03461     <span class="keywordflow">if</span> ( !liste_comptes_importes )
<a name="l03462"></a>03462     <span class="keywordflow">return</span> basename;
<a name="l03463"></a>03463 
<a name="l03464"></a>03464     <span class="keywordflow">do</span>
<a name="l03465"></a>03465     {
<a name="l03466"></a>03466     <span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * tmp_account;
<a name="l03467"></a>03467 
<a name="l03468"></a>03468     tmp_account = (<span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *) tmp_list -&gt; data;
<a name="l03469"></a>03469 
<a name="l03470"></a>03470     <span class="keywordflow">if</span> ( !strcmp ( basename, tmp_account -&gt; <a class="code" href="structstruct__compte__importation.html#a0313677b85878147bb5e5776425f7413">nom_de_compte</a> ) )
<a name="l03471"></a>03471     {
<a name="l03472"></a>03472         tmp_list = liste_comptes_importes;
<a name="l03473"></a>03473         g_free (basename);
<a name="l03474"></a>03474         basename = g_strdup_printf ( _(<span class="stringliteral">&quot;%s #%d&quot;</span>), account_name, ++iter );
<a name="l03475"></a>03475     }
<a name="l03476"></a>03476     <span class="keywordflow">else</span>
<a name="l03477"></a>03477     {
<a name="l03478"></a>03478         tmp_list = tmp_list -&gt; next;
<a name="l03479"></a>03479     }
<a name="l03480"></a>03480     }
<a name="l03481"></a>03481     <span class="keywordflow">while</span> ( tmp_list );
<a name="l03482"></a>03482 
<a name="l03483"></a>03483     <span class="keywordflow">return</span> basename;
<a name="l03484"></a>03484 }
<a name="l03485"></a>03485 
<a name="l03486"></a>03486 
<a name="l03487"></a>03487 
<a name="l03488"></a>03488 <span class="comment">/* *******************************************************************************/</span>
<a name="l03489"></a>03489 <span class="comment">/* page de configuration pour l&#39;importation */</span>
<a name="l03490"></a>03490 <span class="comment">/* *******************************************************************************/</span>
<a name="l03491"></a><a class="code" href="import_8h.html#a248bf76497a7936687f79e28da9ff0e8">03491</a> GtkWidget *<a class="code" href="import_8c.html#a248bf76497a7936687f79e28da9ff0e8">onglet_importation</a> (<span class="keywordtype">void</span>)
<a name="l03492"></a>03492 {
<a name="l03493"></a>03493     GtkWidget *vbox_pref, *paddingbox;
<a name="l03494"></a>03494     GtkWidget *hbox;
<a name="l03495"></a>03495     GtkWidget *label;
<a name="l03496"></a>03496     GtkWidget *button;
<a name="l03497"></a>03497 
<a name="l03498"></a>03498     vbox_pref = <a class="code" href="utils_8c.html#a3baab3fba6974f2ebf35757198ac8911">new_vbox_with_title_and_icon</a> ( _(<span class="stringliteral">&quot;Import&quot;</span>),
<a name="l03499"></a>03499                         <span class="stringliteral">&quot;importlg.png&quot;</span> );
<a name="l03500"></a>03500 
<a name="l03501"></a>03501     <span class="comment">/* Data import settings */</span>
<a name="l03502"></a>03502     paddingbox = <a class="code" href="utils_8c.html#a22ba81fcf046b5bec6cf6d55d440abc5">new_paddingbox_with_title</a> (vbox_pref, FALSE,
<a name="l03503"></a>03503                         _(<span class="stringliteral">&quot;Import settings&quot;</span>));
<a name="l03504"></a>03504 
<a name="l03505"></a>03505     <span class="comment">/* hbox for label and range-selection */</span>
<a name="l03506"></a>03506     hbox = gtk_hbox_new ( FALSE, 0 );
<a name="l03507"></a>03507     gtk_box_pack_start ( GTK_BOX ( paddingbox ), hbox, FALSE, FALSE, 0 );
<a name="l03508"></a>03508 
<a name="l03509"></a>03509     label = gtk_label_new ( 
<a name="l03510"></a>03510                         _(<span class="stringliteral">&quot;Threshold while matching transaction date during import (in days)&quot;</span>));
<a name="l03511"></a>03511     gtk_box_pack_start ( GTK_BOX ( hbox ), label, FALSE, FALSE, 0 );
<a name="l03512"></a>03512 
<a name="l03513"></a>03513     button = gtk_spin_button_new_with_range ( 0.0,
<a name="l03514"></a>03514                         100.0,
<a name="l03515"></a>03515                         1.0);
<a name="l03516"></a>03516     gtk_spin_button_set_value ( GTK_SPIN_BUTTON ( button ),
<a name="l03517"></a>03517                         (gdouble) valeur_echelle_recherche_date_import );
<a name="l03518"></a>03518     g_signal_connect ( G_OBJECT ( button ),
<a name="l03519"></a>03519                         <span class="stringliteral">&quot;value-changed&quot;</span>,
<a name="l03520"></a>03520                         G_CALLBACK ( changement_valeur_echelle_recherche_date_import ),
<a name="l03521"></a>03521                         NULL );
<a name="l03522"></a>03522     gtk_box_pack_start ( GTK_BOX ( hbox ), button, FALSE, FALSE, 0 );
<a name="l03523"></a>03523 
<a name="l03524"></a>03524     <span class="comment">/* merge transactions imported with planned transactions */</span>
<a name="l03525"></a>03525     hbox = gtk_hbox_new ( FALSE, 0 );
<a name="l03526"></a>03526     gtk_box_pack_start ( GTK_BOX ( paddingbox ), hbox, FALSE, FALSE, 0 );
<a name="l03527"></a>03527 
<a name="l03528"></a>03528     button = <a class="code" href="gsb__automem_8c.html#ad32c3b7a4ae54cbe312fe4e1ee22e10f">gsb_automem_checkbutton_new</a> (
<a name="l03529"></a>03529                         _(<span class="stringliteral">&quot;Merge the imported transactions with the transactions found&quot;</span>),
<a name="l03530"></a>03530                         &amp;<a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a57578c75cdb213a3320a587861a713ad">get_fusion_import_transactions</a>, NULL, NULL );
<a name="l03531"></a>03531 
<a name="l03532"></a>03532     gtk_box_pack_start ( GTK_BOX ( hbox ), button, FALSE, FALSE, 0 );
<a name="l03533"></a>03533 
<a name="l03534"></a>03534     <span class="comment">/* automatically associate the category of the payee if it is possible */</span>
<a name="l03535"></a>03535     hbox = gtk_hbox_new ( FALSE, 0 );
<a name="l03536"></a>03536     gtk_box_pack_start ( GTK_BOX ( paddingbox ), hbox, FALSE, FALSE, 0 );
<a name="l03537"></a>03537 
<a name="l03538"></a>03538     button = <a class="code" href="gsb__automem_8c.html#ad32c3b7a4ae54cbe312fe4e1ee22e10f">gsb_automem_checkbutton_new</a> (
<a name="l03539"></a>03539                         _(<span class="stringliteral">&quot;Automatically associate the category of the payee if it is possible&quot;</span>),
<a name="l03540"></a>03540                         &amp;<a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a3fa0078d2f9783e00e473ee5a127f1f6">get_categorie_for_payee</a>,
<a name="l03541"></a>03541                         NULL, NULL );
<a name="l03542"></a>03542 
<a name="l03543"></a>03543     gtk_box_pack_start ( GTK_BOX ( hbox ), button, FALSE, FALSE, 0 );
<a name="l03544"></a>03544 
<a name="l03545"></a>03545     <span class="comment">/* extraire le numéro de chèque du tiers pour le mettre dans No Cheque/Virement */</span>
<a name="l03546"></a>03546     hbox = gtk_hbox_new ( FALSE, 0 );
<a name="l03547"></a>03547     gtk_box_pack_start ( GTK_BOX ( paddingbox ), hbox, FALSE, FALSE, 0 );
<a name="l03548"></a>03548 
<a name="l03549"></a>03549     button = <a class="code" href="gsb__automem_8c.html#ad32c3b7a4ae54cbe312fe4e1ee22e10f">gsb_automem_checkbutton_new</a> (
<a name="l03550"></a>03550                         _(<span class="stringliteral">&quot;Extracting a number and save it in the field No Cheque/Virement&quot;</span>),
<a name="l03551"></a>03551                         &amp;<a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a628fdfc85cd4c1b52ca5f29b7cb7cd06">get_extract_number_for_check</a>,
<a name="l03552"></a>03552                         NULL, NULL );
<a name="l03553"></a>03553 
<a name="l03554"></a>03554     gtk_box_pack_start ( GTK_BOX ( hbox ), button, FALSE, FALSE, 0 );
<a name="l03555"></a>03555 
<a name="l03556"></a>03556     <span class="comment">/* propose to choose between getting the fyear by value date or by date */</span>
<a name="l03557"></a>03557     <a class="code" href="gsb__automem_8c.html#ade82b8b0e27c163fd3276dacfa6cf9fb">gsb_automem_radiobutton_new_with_title</a> ( vbox_pref,
<a name="l03558"></a>03558                         _(<span class="stringliteral">&quot;Set the financial year&quot;</span>),
<a name="l03559"></a>03559                         _(<span class="stringliteral">&quot;According to the date&quot;</span>),
<a name="l03560"></a>03560                         _(<span class="stringliteral">&quot;According to the value date (if fail, try with the date)&quot;</span>),
<a name="l03561"></a>03561                         &amp;<a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#af20e6f2e4e19db775dbd86405e877f09">get_fyear_by_value_date</a>,
<a name="l03562"></a>03562                         NULL, NULL );
<a name="l03563"></a>03563 
<a name="l03564"></a>03564     gtk_widget_show_all ( vbox_pref );
<a name="l03565"></a>03565 
<a name="l03566"></a>03566     <span class="keywordflow">return</span> ( vbox_pref );
<a name="l03567"></a>03567 }
<a name="l03568"></a>03568 
<a name="l03569"></a>03569 
<a name="l03570"></a>03570 <span class="comment">/* *******************************************************************************/</span>
<a name="l03571"></a>03571 <span class="comment">/* page de configuration pour la gestion des associations des tiers              */</span>
<a name="l03572"></a>03572 <span class="comment">/* *******************************************************************************/</span>
<a name="l03573"></a><a class="code" href="import_8h.html#aeedd1884f94db09625397f7714850f82">03573</a> GtkWidget * <a class="code" href="import_8c.html#aeedd1884f94db09625397f7714850f82">gsb_import_associations_gere_tiers</a> ( <span class="keywordtype">void</span> )
<a name="l03574"></a>03574 {
<a name="l03575"></a>03575     GtkWidget *vbox_main, *vbox, *paddingbox, *button;
<a name="l03576"></a>03576     GtkWidget *hbox, *vbox2, *sw, *treeview ;
<a name="l03577"></a>03577     GtkWidget *table, *label, *entry;
<a name="l03578"></a>03578     GtkListStore *list_store;
<a name="l03579"></a>03579     GtkTreeViewColumn *column;
<a name="l03580"></a>03580     GtkCellRenderer *cell;
<a name="l03581"></a>03581     GtkTreeSelection *selection;
<a name="l03582"></a>03582     gchar *texte;
<a name="l03583"></a>03583 
<a name="l03584"></a>03584     vbox_main = <a class="code" href="utils_8c.html#a3baab3fba6974f2ebf35757198ac8911">new_vbox_with_title_and_icon</a> (
<a name="l03585"></a>03585                         _(<span class="stringliteral">&quot;Manage import associations&quot;</span>),
<a name="l03586"></a>03586                         <span class="stringliteral">&quot;payees.png&quot;</span> );
<a name="l03587"></a>03587 
<a name="l03588"></a>03588     vbox = gtk_vbox_new ( FALSE, 12 );
<a name="l03589"></a>03589     gtk_box_pack_start ( GTK_BOX ( vbox_main ), vbox, TRUE, TRUE, 0 );
<a name="l03590"></a>03590     gtk_container_set_border_width ( GTK_CONTAINER ( vbox ), 12 );
<a name="l03591"></a>03591 
<a name="l03592"></a>03592     paddingbox = <a class="code" href="utils_8c.html#a22ba81fcf046b5bec6cf6d55d440abc5">new_paddingbox_with_title</a> ( vbox, FALSE, _(<span class="stringliteral">&quot;Import associations&quot;</span>) );
<a name="l03593"></a>03593 
<a name="l03594"></a>03594     texte = g_strdup ( _(<span class="stringliteral">&quot;This will associate a search string to a payee every time you &quot;</span>
<a name="l03595"></a>03595                          <span class="stringliteral">&quot;import a file. For instance, all QIF labels containing &#39;Rent&#39; &quot;</span>
<a name="l03596"></a>03596                          <span class="stringliteral">&quot;could be associated with  a specific payee representing your &quot;</span>
<a name="l03597"></a>03597                          <span class="stringliteral">&quot;landlord.&quot;</span>) );
<a name="l03598"></a>03598     label = gtk_label_new ( texte );
<a name="l03599"></a>03599     gtk_label_set_line_wrap ( GTK_LABEL ( label ), TRUE );
<a name="l03600"></a>03600     gtk_misc_set_alignment ( GTK_MISC ( label ), 0, 0);
<a name="l03601"></a>03601     gtk_label_set_justify ( GTK_LABEL ( label ), GTK_JUSTIFY_LEFT );
<a name="l03602"></a>03602     g_free ( texte );
<a name="l03603"></a>03603     gtk_box_pack_start ( GTK_BOX(paddingbox), label, FALSE, FALSE, 6 );
<a name="l03604"></a>03604 
<a name="l03605"></a>03605     hbox = gtk_hbox_new ( FALSE, 5 );
<a name="l03606"></a>03606     gtk_box_pack_start ( GTK_BOX ( paddingbox ), hbox, TRUE, TRUE, 0);
<a name="l03607"></a>03607 
<a name="l03608"></a>03608     sw = gtk_scrolled_window_new (NULL, NULL);
<a name="l03609"></a>03609     gtk_scrolled_window_set_shadow_type (GTK_SCROLLED_WINDOW (sw),
<a name="l03610"></a>03610                         GTK_SHADOW_ETCHED_IN);
<a name="l03611"></a>03611     gtk_scrolled_window_set_policy (GTK_SCROLLED_WINDOW (sw),
<a name="l03612"></a>03612                         GTK_POLICY_AUTOMATIC,
<a name="l03613"></a>03613                         GTK_POLICY_ALWAYS);
<a name="l03614"></a>03614     gtk_box_pack_start ( GTK_BOX (hbox), sw, TRUE,TRUE, 0 );
<a name="l03615"></a>03615 
<a name="l03616"></a>03616     <span class="comment">/* Create Add/Remove buttons */</span>
<a name="l03617"></a>03617     vbox2 = gtk_vbox_new ( FALSE, 5 );
<a name="l03618"></a>03618     gtk_box_pack_start ( GTK_BOX ( hbox ), vbox2, FALSE, FALSE, 0 );
<a name="l03619"></a>03619 
<a name="l03620"></a>03620     <span class="comment">/* Button &quot;Add&quot; */</span>
<a name="l03621"></a>03621     button = gtk_button_new_from_stock (GTK_STOCK_ADD);
<a name="l03622"></a>03622     g_signal_connect ( G_OBJECT ( button ),
<a name="l03623"></a>03623                         <span class="stringliteral">&quot;clicked&quot;</span>,
<a name="l03624"></a>03624                         G_CALLBACK  ( gsb_import_associations_add_assoc ),
<a name="l03625"></a>03625                         vbox_main );
<a name="l03626"></a>03626     gtk_box_pack_start ( GTK_BOX ( vbox2 ), button, FALSE, FALSE, 5 );
<a name="l03627"></a>03627     g_object_set_data ( G_OBJECT (vbox_main), <span class="stringliteral">&quot;add_button&quot;</span>, button );
<a name="l03628"></a>03628 
<a name="l03629"></a>03629     <span class="comment">/* Button &quot;Remove&quot; */</span>
<a name="l03630"></a>03630     button = gtk_button_new_from_stock (GTK_STOCK_REMOVE);
<a name="l03631"></a>03631     g_signal_connect ( G_OBJECT ( button ),
<a name="l03632"></a>03632                         <span class="stringliteral">&quot;clicked&quot;</span>,
<a name="l03633"></a>03633                         G_CALLBACK ( gsb_import_associations_del_assoc ),
<a name="l03634"></a>03634                         vbox_main );
<a name="l03635"></a>03635     gtk_box_pack_start ( GTK_BOX ( vbox2 ), button, FALSE, FALSE, 5 );
<a name="l03636"></a>03636     gtk_widget_set_sensitive ( button, FALSE );
<a name="l03637"></a>03637     g_object_set_data ( G_OBJECT (vbox_main), <span class="stringliteral">&quot;remove_button&quot;</span>, button );
<a name="l03638"></a>03638 
<a name="l03639"></a>03639     <span class="comment">/* create the model */</span>
<a name="l03640"></a>03640     list_store = gtk_list_store_new (
<a name="l03641"></a>03641                         3, G_TYPE_STRING, G_TYPE_STRING, G_TYPE_INT );
<a name="l03642"></a>03642 
<a name="l03643"></a>03643     <span class="comment">/* remplit le modèle si nécessaire */</span>
<a name="l03644"></a>03644     gsb_import_associations_fill_model ( list_store );
<a name="l03645"></a>03645 
<a name="l03646"></a>03646     <span class="comment">/* create the treeview */</span>
<a name="l03647"></a>03647     treeview = gtk_tree_view_new_with_model (
<a name="l03648"></a>03648                         GTK_TREE_MODEL (list_store) );
<a name="l03649"></a>03649     g_object_unref (list_store);
<a name="l03650"></a>03650 
<a name="l03651"></a>03651     gtk_tree_view_set_rules_hint (GTK_TREE_VIEW (treeview), TRUE);
<a name="l03652"></a>03652     gtk_widget_set_size_request ( treeview, -1, 230 );
<a name="l03653"></a>03653     selection = gtk_tree_view_get_selection ( GTK_TREE_VIEW (treeview) );
<a name="l03654"></a>03654     gtk_tree_selection_set_select_function ( selection,
<a name="l03655"></a>03655                         (GtkTreeSelectionFunc) gsb_import_associations_select_func,
<a name="l03656"></a>03656                         vbox_main, NULL );
<a name="l03657"></a>03657     gtk_container_add (GTK_CONTAINER (sw), treeview);
<a name="l03658"></a>03658     gtk_container_set_resize_mode (GTK_CONTAINER (sw), GTK_RESIZE_PARENT);
<a name="l03659"></a>03659     g_object_set_data ( G_OBJECT (vbox_main), <span class="stringliteral">&quot;treeview&quot;</span>, treeview );
<a name="l03660"></a>03660 
<a name="l03661"></a>03661     <span class="comment">/* payee name */</span>
<a name="l03662"></a>03662     cell = gtk_cell_renderer_text_new ( );
<a name="l03663"></a>03663     column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Payee name&quot;</span>),
<a name="l03664"></a>03664                         cell, <span class="stringliteral">&quot;text&quot;</span>, 0, NULL);
<a name="l03665"></a>03665     gtk_tree_view_column_set_expand ( column, TRUE );
<a name="l03666"></a>03666     gtk_tree_view_column_set_alignment ( column, 0.5 );
<a name="l03667"></a>03667     gtk_tree_view_column_set_sort_column_id (column, 0);
<a name="l03668"></a>03668     gtk_tree_view_append_column ( GTK_TREE_VIEW (treeview), column);
<a name="l03669"></a>03669 
<a name="l03670"></a>03670     <span class="comment">/* Search string */</span>
<a name="l03671"></a>03671     cell = gtk_cell_renderer_text_new ( );
<a name="l03672"></a>03672     g_object_set (cell, <span class="stringliteral">&quot;editable&quot;</span>, TRUE, NULL);
<a name="l03673"></a>03673     g_signal_connect ( cell,
<a name="l03674"></a>03674                         <span class="stringliteral">&quot;edited&quot;</span>,
<a name="l03675"></a>03675                         G_CALLBACK (gsb_import_associations_cell_edited),
<a name="l03676"></a>03676                         vbox_main );
<a name="l03677"></a>03677     column = gtk_tree_view_column_new_with_attributes ( _(<span class="stringliteral">&quot;Search string&quot;</span>),
<a name="l03678"></a>03678                         cell, <span class="stringliteral">&quot;text&quot;</span>, 1, NULL);
<a name="l03679"></a>03679     gtk_tree_view_column_set_expand ( column, TRUE );
<a name="l03680"></a>03680     gtk_tree_view_column_set_alignment ( column, 0.5 );
<a name="l03681"></a>03681     gtk_tree_view_column_set_sort_column_id (column, 1);
<a name="l03682"></a>03682     gtk_tree_view_append_column ( GTK_TREE_VIEW (treeview), column);
<a name="l03683"></a>03683 
<a name="l03684"></a>03684 
<a name="l03685"></a>03685     paddingbox = <a class="code" href="utils_8c.html#a22ba81fcf046b5bec6cf6d55d440abc5">new_paddingbox_with_title</a> ( vbox,
<a name="l03686"></a>03686                         FALSE, _(<span class="stringliteral">&quot;Details of associations&quot;</span>));
<a name="l03687"></a>03687 
<a name="l03688"></a>03688     <span class="comment">/* Create table */</span>
<a name="l03689"></a>03689     table = gtk_table_new ( 2, 2, FALSE );
<a name="l03690"></a>03690     gtk_table_set_col_spacings ( GTK_TABLE ( table ), 5 );
<a name="l03691"></a>03691     gtk_table_set_row_spacings ( GTK_TABLE ( table ), 5 );
<a name="l03692"></a>03692     gtk_box_pack_start ( GTK_BOX ( paddingbox ), table, TRUE, TRUE, 0 );
<a name="l03693"></a>03693 
<a name="l03694"></a>03694     <span class="comment">/* Create entry liste des tiers */</span>
<a name="l03695"></a>03695     label = gtk_label_new (<a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a>(_(<span class="stringliteral">&quot;Payee name&quot;</span>)));
<a name="l03696"></a>03696     gtk_misc_set_alignment (GTK_MISC (label), 0, 1);
<a name="l03697"></a>03697     gtk_label_set_justify ( GTK_LABEL(label), GTK_JUSTIFY_RIGHT );
<a name="l03698"></a>03698     gtk_table_attach ( GTK_TABLE ( table ), label, 0, 1, 0, 1,
<a name="l03699"></a>03699                         GTK_SHRINK | GTK_FILL, 0, 0, 0 );
<a name="l03700"></a>03700 
<a name="l03701"></a>03701     entry = <a class="code" href="gtk__combofix_8c.html#a7642341a194730bea49a96c515349870">gtk_combofix_new</a> (
<a name="l03702"></a>03702                         <a class="code" href="gsb__data__payee_8c.html#a04e398908c76c8314a9dcf22dcadaf49">gsb_data_payee_get_name_and_report_list</a>());
<a name="l03703"></a>03703     <a class="code" href="gtk__combofix_8c.html#ac041b5bd83117286152eb388569f137d">gtk_combofix_set_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (entry), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03704"></a>03704     <a class="code" href="gtk__combofix_8c.html#af698335af63e4952d8c35d912732b4e4">gtk_combofix_set_force_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (entry),FALSE );
<a name="l03705"></a>03705     <a class="code" href="gtk__combofix_8c.html#a5f12519f66c3da8248e512bf6b584d29">gtk_combofix_set_max_items</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (entry),
<a name="l03706"></a>03706                         <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a6a71e36dd4154a8a28ec1c61815e48cf">combofix_max_item</a> );
<a name="l03707"></a>03707     <a class="code" href="gtk__combofix_8c.html#ac7743a3ebf76e8dc9203d696dbc02cae">gtk_combofix_set_case_sensitive</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (entry),
<a name="l03708"></a>03708                         <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a125b6acef0ed7c3675d331ebb36ee373">combofix_case_sensitive</a> );
<a name="l03709"></a>03709     gtk_table_attach ( GTK_TABLE ( table ), entry, 1, 2, 0, 1,
<a name="l03710"></a>03710                         GTK_EXPAND|GTK_FILL, 0, 0, 0 );
<a name="l03711"></a>03711     g_object_set_data ( G_OBJECT (vbox_main), <span class="stringliteral">&quot;payee&quot;</span>, entry );
<a name="l03712"></a>03712     g_signal_connect ( G_OBJECT (<a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (entry) -&gt; entry),
<a name="l03713"></a>03713                         <span class="stringliteral">&quot;changed&quot;</span>,
<a name="l03714"></a>03714                         G_CALLBACK (gsb_import_associations_combo_changed),
<a name="l03715"></a>03715                         vbox_main );
<a name="l03716"></a>03716 
<a name="l03717"></a>03717     <span class="comment">/* Create entry search string */</span>
<a name="l03718"></a>03718     label = gtk_label_new (<a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a>(_(<span class="stringliteral">&quot;Search string&quot;</span>)));
<a name="l03719"></a>03719     gtk_misc_set_alignment (GTK_MISC (label), 0, 1);
<a name="l03720"></a>03720     gtk_label_set_justify ( GTK_LABEL(label), GTK_JUSTIFY_RIGHT );
<a name="l03721"></a>03721     gtk_table_attach ( GTK_TABLE ( table ), label, 0, 1, 1, 2,
<a name="l03722"></a>03722                         GTK_SHRINK | GTK_FILL, 0, 0, 0 );
<a name="l03723"></a>03723 
<a name="l03724"></a>03724     entry = gtk_entry_new ();
<a name="l03725"></a>03725     gtk_entry_set_text ( GTK_ENTRY (entry), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03726"></a>03726     gtk_table_attach ( GTK_TABLE ( table ), entry, 1, 2, 1, 2,
<a name="l03727"></a>03727                         GTK_EXPAND|GTK_FILL, 0, 0, 0 );
<a name="l03728"></a>03728     g_signal_connect_swapped ( entry, 
<a name="l03729"></a>03729                         <span class="stringliteral">&quot;changed&quot;</span>, 
<a name="l03730"></a>03730                         G_CALLBACK (gsb_import_associations_check_add_button),
<a name="l03731"></a>03731                         vbox_main );
<a name="l03732"></a>03732     g_object_set_data ( G_OBJECT (vbox_main), <span class="stringliteral">&quot;Search_string&quot;</span>, entry );
<a name="l03733"></a>03733 
<a name="l03734"></a>03734     gsb_import_associations_check_add_button ( G_OBJECT (vbox_main) );
<a name="l03735"></a>03735 
<a name="l03736"></a>03736     <span class="keywordflow">return</span> vbox_main;
<a name="l03737"></a>03737 }
<a name="l03738"></a>03738 
<a name="l03739"></a>03739 
<a name="l03744"></a><a class="code" href="import_8h.html#af8486d8bf4c57369bd528eb5c4474cb5">03744</a> <span class="keywordtype">void</span> <a class="code" href="import_8c.html#af8486d8bf4c57369bd528eb5c4474cb5">gsb_import_associations_init_variables</a> ( <span class="keywordtype">void</span> )
<a name="l03745"></a>03745 {
<a name="l03746"></a>03746     <span class="keywordflow">if</span> ( liste_associations_tiers )
<a name="l03747"></a>03747     {
<a name="l03748"></a>03748         g_slist_free ( liste_associations_tiers );
<a name="l03749"></a>03749         liste_associations_tiers = NULL;
<a name="l03750"></a>03750     }
<a name="l03751"></a>03751 
<a name="l03752"></a>03752 }
<a name="l03753"></a>03753 
<a name="l03754"></a>03754 
<a name="l03755"></a>03755 <span class="keywordtype">void</span> gsb_import_associations_add_assoc ( GtkWidget *button, GtkWidget *main_widget )
<a name="l03756"></a>03756 {
<a name="l03757"></a>03757     GtkWidget *combo, *entry;
<a name="l03758"></a>03758     GtkTreeView *treeview;
<a name="l03759"></a>03759     GtkTreeModel *list_store;
<a name="l03760"></a>03760     gchar *payee, *search_str;
<a name="l03761"></a>03761     gint payee_number;
<a name="l03762"></a>03762 
<a name="l03763"></a>03763     combo = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;payee&quot;</span> );
<a name="l03764"></a>03764     payee = g_strstrip ( g_strdup ( <a class="code" href="gtk__combofix_8c.html#a957ebcb179fe43537f34c0e4134dc182">gtk_combofix_get_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (combo) ) ) );
<a name="l03765"></a>03765     <span class="keywordflow">if</span> ( strlen ( payee ) == 0 )
<a name="l03766"></a>03766         <span class="keywordflow">return</span>;
<a name="l03767"></a>03767 
<a name="l03768"></a>03768     entry = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;Search_string&quot;</span> );
<a name="l03769"></a>03769     search_str = g_strstrip ( g_strdup ( gtk_entry_get_text ( GTK_ENTRY (entry) ) ) );
<a name="l03770"></a>03770     <span class="keywordflow">if</span> ( strlen ( search_str ) == 0 )
<a name="l03771"></a>03771         <span class="keywordflow">return</span>;
<a name="l03772"></a>03772     <a class="code" href="erreur_8h.html#a17bfffc4306bc76edd79e060a8947dc4">devel_debug</a> (payee);
<a name="l03773"></a>03773     <a class="code" href="erreur_8h.html#a17bfffc4306bc76edd79e060a8947dc4">devel_debug</a> (search_str);
<a name="l03774"></a>03774 
<a name="l03775"></a>03775     payee_number = <a class="code" href="gsb__data__payee_8c.html#a0841102ff1dc4d499187b11a187fe92d">gsb_data_payee_get_number_by_name</a>  ( payee, TRUE );
<a name="l03776"></a>03776         g_free(payee);
<a name="l03777"></a>03777     treeview = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;treeview&quot;</span> );
<a name="l03778"></a>03778     list_store = gtk_tree_view_get_model ( GTK_TREE_VIEW (treeview) );
<a name="l03779"></a>03779 
<a name="l03780"></a>03780     <span class="comment">/* add association in liste_associations_tiers */</span>
<a name="l03781"></a>03781     <span class="keywordflow">if</span> (g_slist_length ( liste_associations_tiers ) == 0 )
<a name="l03782"></a>03782     {
<a name="l03783"></a>03783         <span class="keyword">struct </span><a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc;
<a name="l03784"></a>03784 
<a name="l03785"></a>03785         assoc = g_malloc ( <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a>) );
<a name="l03786"></a>03786         assoc -&gt; payee_number = payee_number;
<a name="l03787"></a>03787         assoc -&gt; search_str = search_str;
<a name="l03788"></a>03788         liste_associations_tiers = g_slist_append ( liste_associations_tiers,
<a name="l03789"></a>03789                         assoc );
<a name="l03790"></a>03790         <a class="code" href="gsb__data__payee_8c.html#a8347c14ccb3747b1b38bb6a9ef05719f">gsb_data_payee_set_search_string</a> ( payee_number, search_str );
<a name="l03791"></a>03791     }
<a name="l03792"></a>03792     <span class="keywordflow">else</span>
<a name="l03793"></a>03793     {
<a name="l03794"></a>03794         <span class="keyword">struct </span><a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc;
<a name="l03795"></a>03795 
<a name="l03796"></a>03796         assoc = g_malloc ( <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a>) );
<a name="l03797"></a>03797         assoc -&gt; payee_number = payee_number;
<a name="l03798"></a>03798         assoc -&gt; search_str = search_str;
<a name="l03799"></a>03799         <span class="keywordflow">if</span> ( g_slist_find_custom (liste_associations_tiers,
<a name="l03800"></a>03800                         assoc,
<a name="l03801"></a>03801                         (GCompareFunc) <a class="code" href="import_8c.html#a973a66dc9a88ed606bd0936f32919a4f">gsb_import_associations_cmp_assoc</a>) )
<a name="l03802"></a>03802         {
<a name="l03803"></a>03803             <span class="comment">/* clear the entry */</span>
<a name="l03804"></a>03804             <a class="code" href="gtk__combofix_8c.html#ac041b5bd83117286152eb388569f137d">gtk_combofix_set_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (combo), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03805"></a>03805             gtk_entry_set_text ( GTK_ENTRY (entry), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03806"></a>03806         }
<a name="l03807"></a>03807         <span class="keywordflow">else</span>
<a name="l03808"></a>03808         {
<a name="l03809"></a>03809             liste_associations_tiers = g_slist_insert_sorted (
<a name="l03810"></a>03810                         liste_associations_tiers,
<a name="l03811"></a>03811                         assoc,
<a name="l03812"></a>03812                         (GCompareFunc) gsb_import_associations_cmp_assoc);
<a name="l03813"></a>03813             <a class="code" href="gsb__data__payee_8c.html#a8347c14ccb3747b1b38bb6a9ef05719f">gsb_data_payee_set_search_string</a> ( payee_number, search_str );
<a name="l03814"></a>03814         }
<a name="l03815"></a>03815     }
<a name="l03816"></a>03816     <span class="keywordflow">if</span> (g_slist_length ( liste_associations_tiers ) &gt; 0 )
<a name="l03817"></a>03817         gsb_import_associations_fill_model ( GTK_LIST_STORE (list_store) );
<a name="l03818"></a>03818 
<a name="l03819"></a>03819     <span class="comment">/* clear the entry */</span>
<a name="l03820"></a>03820     <a class="code" href="gtk__combofix_8c.html#ac041b5bd83117286152eb388569f137d">gtk_combofix_set_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (combo), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03821"></a>03821     gtk_entry_set_text ( GTK_ENTRY (entry), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03822"></a>03822 
<a name="l03823"></a>03823 }
<a name="l03824"></a>03824 
<a name="l03825"></a>03825 
<a name="l03826"></a><a class="code" href="import_8h.html#a973a66dc9a88ed606bd0936f32919a4f">03826</a> gint <a class="code" href="import_8c.html#a973a66dc9a88ed606bd0936f32919a4f">gsb_import_associations_cmp_assoc</a> (<span class="keyword">struct</span> <a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc_1,
<a name="l03827"></a>03827                                         <span class="keyword">struct</span> <a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc_2)
<a name="l03828"></a>03828 {
<a name="l03829"></a>03829     gint num_1, num_2;
<a name="l03830"></a>03830 
<a name="l03831"></a>03831     num_1 = assoc_1 -&gt; payee_number;
<a name="l03832"></a>03832     num_2 = assoc_2 -&gt; payee_number;
<a name="l03833"></a>03833 
<a name="l03834"></a>03834     <span class="keywordflow">if</span> ( num_1 == num_2 )
<a name="l03835"></a>03835         <span class="keywordflow">return</span> 0;
<a name="l03836"></a>03836     <span class="keywordflow">else</span>
<a name="l03837"></a>03837         <span class="keywordflow">return</span> g_utf8_collate ( <a class="code" href="gsb__data__payee_8c.html#adc6080b7376628d3902f5fd861deb45a">gsb_data_payee_get_name</a> (num_1, FALSE),
<a name="l03838"></a>03838                         <a class="code" href="gsb__data__payee_8c.html#adc6080b7376628d3902f5fd861deb45a">gsb_data_payee_get_name</a> (num_2, FALSE) );
<a name="l03839"></a>03839 }
<a name="l03840"></a>03840 
<a name="l03841"></a>03841 
<a name="l03842"></a>03842 <span class="keywordtype">void</span> gsb_import_associations_del_assoc ( GtkWidget *button, GtkWidget *main_widget )
<a name="l03843"></a>03843 {
<a name="l03844"></a>03844     GtkWidget *combo, *entry;
<a name="l03845"></a>03845     GtkTreeView *treeview;
<a name="l03846"></a>03846     GtkTreeModel *model;
<a name="l03847"></a>03847     GtkTreeIter iter;
<a name="l03848"></a>03848     GSList *list_tmp;
<a name="l03849"></a>03849     gint payee_number;
<a name="l03850"></a>03850 
<a name="l03851"></a>03851     treeview = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;treeview&quot;</span> );
<a name="l03852"></a>03852     <span class="keywordflow">if</span> ( !gtk_tree_selection_get_selected (
<a name="l03853"></a>03853                         gtk_tree_view_get_selection (treeview),
<a name="l03854"></a>03854                         &amp;model,
<a name="l03855"></a>03855                         &amp;iter ))
<a name="l03856"></a>03856     <span class="keywordflow">return</span>;
<a name="l03857"></a>03857 
<a name="l03858"></a>03858     gtk_tree_model_get ( model, &amp;iter, 2, &amp;payee_number, -1 );
<a name="l03859"></a>03859     <span class="keywordflow">if</span> ( payee_number &gt; 0 )
<a name="l03860"></a>03860     {
<a name="l03861"></a>03861         <a class="code" href="gsb__data__payee_8c.html#a8347c14ccb3747b1b38bb6a9ef05719f">gsb_data_payee_set_search_string</a> ( payee_number, <span class="stringliteral">&quot;&quot;</span> );
<a name="l03862"></a>03862         list_tmp = liste_associations_tiers;
<a name="l03863"></a>03863         <span class="keywordflow">while</span> ( list_tmp )
<a name="l03864"></a>03864         {
<a name="l03865"></a>03865             <span class="keyword">struct </span><a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc;
<a name="l03866"></a>03866 
<a name="l03867"></a>03867             assoc = list_tmp -&gt; data;
<a name="l03868"></a>03868             <span class="keywordflow">if</span> ( assoc -&gt; payee_number == payee_number )
<a name="l03869"></a>03869             {
<a name="l03870"></a>03870                 liste_associations_tiers = g_slist_remove (
<a name="l03871"></a>03871                         liste_associations_tiers, assoc );
<a name="l03872"></a>03872                 gsb_import_associations_fill_model (
<a name="l03873"></a>03873                         GTK_LIST_STORE (model) );
<a name="l03874"></a>03874                 <span class="keywordflow">break</span>;
<a name="l03875"></a>03875             }
<a name="l03876"></a>03876             list_tmp = list_tmp -&gt; next;
<a name="l03877"></a>03877         }
<a name="l03878"></a>03878         combo = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;payee&quot;</span> );
<a name="l03879"></a>03879         <a class="code" href="gtk__combofix_8c.html#ac041b5bd83117286152eb388569f137d">gtk_combofix_set_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (combo), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03880"></a>03880         entry = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;Search_string&quot;</span> );
<a name="l03881"></a>03881         gtk_entry_set_text ( GTK_ENTRY (entry), <span class="stringliteral">&quot;&quot;</span> );
<a name="l03882"></a>03882     }
<a name="l03883"></a>03883 }
<a name="l03884"></a>03884 
<a name="l03885"></a>03885 
<a name="l03886"></a>03886 <span class="keywordtype">void</span> gsb_import_associations_fill_model ( GtkListStore *list_store )
<a name="l03887"></a>03887 {
<a name="l03888"></a>03888     GSList *list_tmp;
<a name="l03889"></a>03889     GtkTreeIter iter;
<a name="l03890"></a>03890 
<a name="l03891"></a>03891     list_tmp = liste_associations_tiers;
<a name="l03892"></a>03892     gtk_list_store_clear ( GTK_LIST_STORE (list_store) );
<a name="l03893"></a>03893     <span class="keywordflow">while</span> ( list_tmp )
<a name="l03894"></a>03894     {
<a name="l03895"></a>03895         gchar *tmpstr;
<a name="l03896"></a>03896         <span class="keyword">struct </span><a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc;
<a name="l03897"></a>03897 
<a name="l03898"></a>03898         assoc = list_tmp -&gt; data;
<a name="l03899"></a>03899         tmpstr = g_strdup ( <a class="code" href="gsb__data__payee_8c.html#adc6080b7376628d3902f5fd861deb45a">gsb_data_payee_get_name</a> (
<a name="l03900"></a>03900                     assoc -&gt; payee_number, TRUE) );
<a name="l03901"></a>03901         gtk_list_store_append (GTK_LIST_STORE (list_store), &amp;iter);
<a name="l03902"></a>03902         gtk_list_store_set (GTK_LIST_STORE (list_store), &amp;iter,
<a name="l03903"></a>03903                     0, tmpstr,
<a name="l03904"></a>03904                     1, assoc -&gt; search_str,
<a name="l03905"></a>03905                     2, assoc -&gt; payee_number,
<a name="l03906"></a>03906                     -1);
<a name="l03907"></a>03907         g_free (tmpstr);
<a name="l03908"></a>03908         list_tmp = list_tmp -&gt; next;
<a name="l03909"></a>03909     }
<a name="l03910"></a>03910 }
<a name="l03911"></a>03911 
<a name="l03912"></a>03912 gboolean gsb_import_associations_select_func ( GtkTreeSelection *selection,
<a name="l03913"></a>03913                         GtkTreeModel *model,
<a name="l03914"></a>03914                         GtkTreePath *path,
<a name="l03915"></a>03915                         gboolean path_currently_selected,
<a name="l03916"></a>03916                         GObject *main_widget )
<a name="l03917"></a>03917 {
<a name="l03918"></a>03918     GtkWidget *combo, *entry, *button;
<a name="l03919"></a>03919     GtkTreeIter iter;
<a name="l03920"></a>03920     gchar *payee_str;
<a name="l03921"></a>03921     gchar *search_str;
<a name="l03922"></a>03922 
<a name="l03923"></a>03923     combo = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;payee&quot;</span> );
<a name="l03924"></a>03924     entry = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;Search_string&quot;</span> );
<a name="l03925"></a>03925     button = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;remove_button&quot;</span> );
<a name="l03926"></a>03926 
<a name="l03927"></a>03927     gtk_tree_model_get_iter ( model, &amp;iter, path );
<a name="l03928"></a>03928     gtk_tree_model_get ( model, &amp;iter, 0, &amp;payee_str, 1, &amp;search_str, -1 );
<a name="l03929"></a>03929 
<a name="l03930"></a>03930     g_signal_handlers_block_by_func ( G_OBJECT (<a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (combo) -&gt; entry),
<a name="l03931"></a>03931                         G_CALLBACK (gsb_import_associations_combo_changed),
<a name="l03932"></a>03932                         main_widget );
<a name="l03933"></a>03933     <a class="code" href="gtk__combofix_8c.html#ac041b5bd83117286152eb388569f137d">gtk_combofix_set_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (combo), payee_str );
<a name="l03934"></a>03934     g_signal_handlers_unblock_by_func ( G_OBJECT (<a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> (combo) -&gt; entry),
<a name="l03935"></a>03935                         G_CALLBACK (gsb_import_associations_combo_changed),
<a name="l03936"></a>03936                         main_widget );
<a name="l03937"></a>03937     gtk_entry_set_text ( GTK_ENTRY (entry), search_str );
<a name="l03938"></a>03938     gtk_widget_set_sensitive ( entry, FALSE );
<a name="l03939"></a>03939     gtk_widget_set_sensitive ( button, TRUE );
<a name="l03940"></a>03940 
<a name="l03941"></a>03941     <span class="keywordflow">return</span> TRUE;
<a name="l03942"></a>03942 }
<a name="l03943"></a>03943 
<a name="l03944"></a>03944 
<a name="l03945"></a>03945 <span class="keyword">static</span> <span class="keywordtype">void</span> gsb_import_associations_cell_edited (GtkCellRendererText *cell,
<a name="l03946"></a>03946                         <span class="keyword">const</span> gchar *path_string,
<a name="l03947"></a>03947                         <span class="keyword">const</span> gchar *new_text,
<a name="l03948"></a>03948                         GObject * main_widget )
<a name="l03949"></a>03949 {
<a name="l03950"></a>03950     GtkWidget *entry;
<a name="l03951"></a>03951     GtkTreeView *treeview;
<a name="l03952"></a>03952     GtkTreeModel *model;
<a name="l03953"></a>03953     GtkTreePath *path = gtk_tree_path_new_from_string (path_string);
<a name="l03954"></a>03954     GtkTreeIter iter;
<a name="l03955"></a>03955     GSList *list_tmp;
<a name="l03956"></a>03956     gchar *search_str;
<a name="l03957"></a>03957     gint payee_number;
<a name="l03958"></a>03958 
<a name="l03959"></a>03959     treeview = g_object_get_data ( G_OBJECT (main_widget), <span class="stringliteral">&quot;treeview&quot;</span> );
<a name="l03960"></a>03960     model = gtk_tree_view_get_model ( treeview );
<a name="l03961"></a>03961     gtk_tree_model_get_iter (model, &amp;iter, path);
<a name="l03962"></a>03962     gtk_tree_model_get ( model, &amp;iter, 1, &amp;search_str, 2, &amp;payee_number, -1 );
<a name="l03963"></a>03963     <span class="keywordflow">if</span> ( g_utf8_collate ( search_str, new_text ) != 0 )
<a name="l03964"></a>03964     {
<a name="l03965"></a>03965         <a class="code" href="erreur_8h.html#a17bfffc4306bc76edd79e060a8947dc4">devel_debug</a> (new_text);
<a name="l03966"></a>03966         gtk_list_store_set (GTK_LIST_STORE (model), &amp;iter, 1, new_text, -1);
<a name="l03967"></a>03967 
<a name="l03968"></a>03968         list_tmp = liste_associations_tiers;
<a name="l03969"></a>03969         <span class="keywordflow">while</span> ( list_tmp )
<a name="l03970"></a>03970         {
<a name="l03971"></a>03971             <span class="keyword">struct </span><a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc;
<a name="l03972"></a>03972 
<a name="l03973"></a>03973             assoc = list_tmp -&gt; data;
<a name="l03974"></a>03974             <span class="keywordflow">if</span> ( assoc -&gt; payee_number == payee_number )
<a name="l03975"></a>03975             {
<a name="l03976"></a>03976                 <span class="keywordflow">if</span> ( assoc -&gt; search_str &amp;&amp; strlen (assoc -&gt; search_str) )
<a name="l03977"></a>03977                     g_free ( assoc -&gt; search_str );
<a name="l03978"></a>03978                 assoc -&gt; search_str = g_strdup ( new_text );
<a name="l03979"></a>03979                 entry = g_object_get_data ( main_widget, <span class="stringliteral">&quot;Search_string&quot;</span> );
<a name="l03980"></a>03980                 gtk_entry_set_text ( GTK_ENTRY (entry), new_text );
<a name="l03981"></a>03981                 <span class="keywordflow">break</span>;
<a name="l03982"></a>03982             }
<a name="l03983"></a>03983             list_tmp = list_tmp -&gt; next;
<a name="l03984"></a>03984         }
<a name="l03985"></a>03985         <a class="code" href="gsb__data__payee_8c.html#a8347c14ccb3747b1b38bb6a9ef05719f">gsb_data_payee_set_search_string</a> ( payee_number, new_text );
<a name="l03986"></a>03986     }
<a name="l03987"></a>03987 }
<a name="l03988"></a>03988 
<a name="l03989"></a>03989 
<a name="l03990"></a>03990 <span class="keywordtype">void</span> gsb_import_associations_combo_changed ( GtkEditable *editable,
<a name="l03991"></a>03991                         GObject * main_widget )
<a name="l03992"></a>03992 {
<a name="l03993"></a>03993     GtkWidget *button, *entry;
<a name="l03994"></a>03994     <span class="keyword">const</span> gchar *tmpstr;
<a name="l03995"></a>03995     gint payee_number;
<a name="l03996"></a>03996 
<a name="l03997"></a>03997     payee_number = <a class="code" href="gsb__data__payee_8c.html#a0841102ff1dc4d499187b11a187fe92d">gsb_data_payee_get_number_by_name</a> (
<a name="l03998"></a>03998                         gtk_editable_get_chars (editable, 0, -1), FALSE );
<a name="l03999"></a>03999     tmpstr = <a class="code" href="gsb__data__payee_8c.html#a8162f3417a19a1fff59c24b47c28e891">gsb_data_payee_get_search_string</a> ( payee_number );
<a name="l04000"></a>04000 
<a name="l04001"></a>04001     entry = g_object_get_data ( main_widget, <span class="stringliteral">&quot;Search_string&quot;</span> );
<a name="l04002"></a>04002 
<a name="l04003"></a>04003     <span class="keywordflow">if</span> ( strlen ( tmpstr) == 0 )
<a name="l04004"></a>04004     {
<a name="l04005"></a>04005         gtk_entry_set_text ( GTK_ENTRY (entry), tmpstr );
<a name="l04006"></a>04006         gtk_widget_set_sensitive ( entry, TRUE );
<a name="l04007"></a>04007     }
<a name="l04008"></a>04008     <span class="keywordflow">else</span>
<a name="l04009"></a>04009     {
<a name="l04010"></a>04010         gchar * str;
<a name="l04011"></a>04011 
<a name="l04012"></a>04012         str = g_strdup_printf ( _(<span class="stringliteral">&quot;You cannot choose this payee because it &quot;</span>
<a name="l04013"></a>04013                         <span class="stringliteral">&quot;already has an association&quot;</span>) );
<a name="l04014"></a>04014         <a class="code" href="dialog_8c.html#a198880c6e09a934c62fd541c9cb302f9">dialogue_warning</a> ( str );
<a name="l04015"></a>04015         gtk_editable_delete_text ( editable, 0, -1 );
<a name="l04016"></a>04016         <span class="keywordflow">if</span> ( strlen (gtk_entry_get_text (GTK_ENTRY (entry))) )
<a name="l04017"></a>04017         {
<a name="l04018"></a>04018             gtk_entry_set_text ( GTK_ENTRY (entry), <span class="stringliteral">&quot;&quot;</span> );
<a name="l04019"></a>04019             
<a name="l04020"></a>04020         }
<a name="l04021"></a>04021         g_free ( str );
<a name="l04022"></a>04022     }
<a name="l04023"></a>04023 
<a name="l04024"></a>04024     <span class="comment">/* on empeche la suppression par inadvertance d&#39;une association */</span>
<a name="l04025"></a>04025     button = g_object_get_data ( main_widget, <span class="stringliteral">&quot;remove_button&quot;</span> );
<a name="l04026"></a>04026     gtk_widget_set_sensitive ( button, FALSE );
<a name="l04027"></a>04027 
<a name="l04028"></a>04028     gsb_import_associations_check_add_button ( main_widget );
<a name="l04029"></a>04029 }
<a name="l04030"></a>04030 
<a name="l04031"></a>04031 
<a name="l04032"></a>04032 gint gsb_import_associations_find_payee ( gchar *imported_tiers)
<a name="l04033"></a>04033 {
<a name="l04034"></a>04034     GSList *list_tmp;
<a name="l04035"></a>04035 
<a name="l04036"></a>04036     list_tmp = liste_associations_tiers;
<a name="l04037"></a>04037     <span class="keywordflow">while</span> ( list_tmp )
<a name="l04038"></a>04038     {
<a name="l04039"></a>04039         <span class="keyword">struct </span><a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc;
<a name="l04040"></a>04040 
<a name="l04041"></a>04041         assoc = list_tmp -&gt; data;
<a name="l04042"></a>04042         <span class="keywordflow">if</span> ( <a class="code" href="utils__str_8c.html#a4f7c837f05cb6ab362e401409acc461b">gsb_string_is_trouve</a> ( imported_tiers, assoc -&gt; search_str ) )
<a name="l04043"></a>04043         {
<a name="l04044"></a>04044            <span class="keywordflow">return</span> assoc -&gt; payee_number;
<a name="l04045"></a>04045         }
<a name="l04046"></a>04046         list_tmp = list_tmp -&gt; next;
<a name="l04047"></a>04047     }
<a name="l04048"></a>04048 
<a name="l04049"></a>04049     <span class="keywordflow">return</span> 0;
<a name="l04050"></a>04050 }
<a name="l04051"></a>04051 
<a name="l04052"></a>04052 
<a name="l04053"></a><a class="code" href="import_8h.html#ac714bc1d2307956bd5172caaa39c1c21">04053</a> gint <a class="code" href="import_8c.html#ac714bc1d2307956bd5172caaa39c1c21">gsb_import_associations_list_append_assoc</a> ( gint payee_number,
<a name="l04054"></a>04054                         <span class="keyword">const</span> gchar *search_str )
<a name="l04055"></a>04055 {
<a name="l04056"></a>04056     <span class="keyword">struct </span><a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a> *assoc;
<a name="l04057"></a>04057 
<a name="l04058"></a>04058     assoc = g_malloc ( <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structstruct__payee__asso.html">struct_payee_asso</a>) );
<a name="l04059"></a>04059     assoc -&gt; payee_number = payee_number;
<a name="l04060"></a>04060     assoc -&gt; search_str = g_strdup ( search_str );
<a name="l04061"></a>04061 
<a name="l04062"></a>04062      <span class="keywordflow">if</span> ( ! g_slist_find_custom (liste_associations_tiers,
<a name="l04063"></a>04063                         assoc,
<a name="l04064"></a>04064                         (GCompareFunc) gsb_import_associations_cmp_assoc) )
<a name="l04065"></a>04065         liste_associations_tiers = g_slist_insert_sorted (
<a name="l04066"></a>04066                         liste_associations_tiers,
<a name="l04067"></a>04067                         assoc,
<a name="l04068"></a>04068                         (GCompareFunc) gsb_import_associations_cmp_assoc);
<a name="l04069"></a>04069 
<a name="l04070"></a>04070     <span class="keywordflow">return</span> g_slist_length ( liste_associations_tiers );
<a name="l04071"></a>04071 }
<a name="l04072"></a>04072 
<a name="l04073"></a>04073 
<a name="l04074"></a>04074 
<a name="l04079"></a>04079 gboolean gsb_import_associations_check_add_button ( GObject * main_widget )
<a name="l04080"></a>04080 {
<a name="l04081"></a>04081     GtkWidget * payee_widget, * search_string_widget;
<a name="l04082"></a>04082 
<a name="l04083"></a>04083     gboolean sensitive = TRUE;
<a name="l04084"></a>04084 
<a name="l04085"></a>04085     payee_widget = g_object_get_data ( main_widget, <span class="stringliteral">&quot;payee&quot;</span> );
<a name="l04086"></a>04086     <span class="keywordflow">if</span> ( payee_widget )
<a name="l04087"></a>04087     {
<a name="l04088"></a>04088         <span class="keyword">const</span> gchar *content;
<a name="l04089"></a>04089 
<a name="l04090"></a>04090         content = <a class="code" href="gtk__combofix_8c.html#a957ebcb179fe43537f34c0e4134dc182">gtk_combofix_get_text</a> ( <a class="code" href="gtk__combofix_8h.html#a6c0219bc33d6d41e2e6ddf984572c041">GTK_COMBOFIX</a> ( payee_widget ) );
<a name="l04091"></a>04091         <span class="keywordflow">if</span> ( !content || ! strlen ( content ) )
<a name="l04092"></a>04092             sensitive = FALSE;
<a name="l04093"></a>04093     }
<a name="l04094"></a>04094 
<a name="l04095"></a>04095     search_string_widget = g_object_get_data ( main_widget, <span class="stringliteral">&quot;Search_string&quot;</span> );
<a name="l04096"></a>04096     <span class="keywordflow">if</span> ( search_string_widget )
<a name="l04097"></a>04097     {
<a name="l04098"></a>04098     <span class="keyword">const</span> gchar * content = gtk_entry_get_text ( GTK_ENTRY ( search_string_widget ) );
<a name="l04099"></a>04099     <span class="keywordflow">if</span> ( ! content || ! strlen(content) )
<a name="l04100"></a>04100         sensitive = FALSE;
<a name="l04101"></a>04101     }
<a name="l04102"></a>04102 
<a name="l04103"></a>04103     gtk_widget_set_sensitive ( GTK_WIDGET ( g_object_get_data ( main_widget, <span class="stringliteral">&quot;add_button&quot;</span> ) ),
<a name="l04104"></a>04104                         sensitive );
<a name="l04105"></a>04105 
<a name="l04106"></a>04106     <span class="keywordflow">return</span> FALSE;
<a name="l04107"></a>04107 }
<a name="l04108"></a>04108 
<a name="l04109"></a>04109 
<a name="l04110"></a>04110 <span class="comment">/* *******************************************************************************/</span>
<a name="l04111"></a>04111 
<a name="l04112"></a>04112 
<a name="l04113"></a>04113 <span class="comment">/* *******************************************************************************/</span>
<a name="l04114"></a>04114 gboolean changement_valeur_echelle_recherche_date_import ( GtkWidget *spin_button )
<a name="l04115"></a>04115 {
<a name="l04116"></a>04116     valeur_echelle_recherche_date_import = gtk_spin_button_get_value_as_int ( GTK_SPIN_BUTTON ( spin_button ));
<a name="l04117"></a>04117     <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a9d0fa9057da603e64a601d69d7bf2b51">modification_fichier</a> == 0 )
<a name="l04118"></a>04118         <a class="code" href="traitement__variables_8c.html#aa4084b9e508b1d1fea1d09c6b6208021">modification_fichier</a> ( TRUE );
<a name="l04119"></a>04119     <span class="keywordflow">return</span> ( FALSE );
<a name="l04120"></a>04120 }
<a name="l04121"></a>04121 
<a name="l04122"></a>04122 
<a name="l04123"></a>04123 
<a name="l04135"></a>04135 <span class="keyword">const</span> gchar * autodetect_file_type ( gchar * filename,
<a name="l04136"></a>04136                         gchar * pointeur_char )
<a name="l04137"></a>04137 {
<a name="l04138"></a>04138     gchar * extension;
<a name="l04139"></a>04139     gchar * type;
<a name="l04140"></a>04140 
<a name="l04141"></a>04141     extension = strrchr ( filename, <span class="charliteral">&#39;.&#39;</span> );
<a name="l04142"></a>04142     <span class="keywordflow">if</span> ( extension )
<a name="l04143"></a>04143     {
<a name="l04144"></a>04144     GSList * tmp = import_formats;
<a name="l04145"></a>04145 
<a name="l04146"></a>04146     <span class="keywordflow">while</span> ( tmp )
<a name="l04147"></a>04147     {
<a name="l04148"></a>04148         <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> * format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l04149"></a>04149 
<a name="l04150"></a>04150         <span class="keywordflow">if</span> ( !g_ascii_strcasecmp ( extension + 1, format -&gt; extension ) )
<a name="l04151"></a>04151         {
<a name="l04152"></a>04152         <span class="keywordflow">return</span> format -&gt; name;
<a name="l04153"></a>04153         }
<a name="l04154"></a>04154 
<a name="l04155"></a>04155         tmp = tmp -&gt; next;
<a name="l04156"></a>04156     }
<a name="l04157"></a>04157     }
<a name="l04158"></a>04158 
<a name="l04159"></a>04159     <span class="keywordflow">if</span> ( ! pointeur_char )
<a name="l04160"></a>04160     {
<a name="l04161"></a>04161     <span class="keywordflow">return</span> _(<span class="stringliteral">&quot;Unknown&quot;</span>);
<a name="l04162"></a>04162     }
<a name="l04163"></a>04163 
<a name="l04166"></a>04166     <span class="keywordflow">if</span> ( g_strrstr ( pointeur_char, <span class="stringliteral">&quot;ofx&quot;</span> ) || g_strrstr ( pointeur_char, <span class="stringliteral">&quot;OFX&quot;</span> ))
<a name="l04167"></a>04167     {
<a name="l04168"></a>04168     type = <span class="stringliteral">&quot;OFX&quot;</span>;
<a name="l04169"></a>04169     }
<a name="l04170"></a>04170     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !<a class="code" href="utils__str_8c.html#abf977b0f883489b8d4c6508f9aac3921">my_strncasecmp</a> ( pointeur_char, <span class="stringliteral">&quot;!Type&quot;</span>, 5 ) ||
<a name="l04171"></a>04171         !<a class="code" href="utils__str_8c.html#abf977b0f883489b8d4c6508f9aac3921">my_strncasecmp</a> ( pointeur_char, <span class="stringliteral">&quot;!Account&quot;</span>, 8 ) ||
<a name="l04172"></a>04172         !<a class="code" href="utils__str_8c.html#abf977b0f883489b8d4c6508f9aac3921">my_strncasecmp</a> ( pointeur_char, <span class="stringliteral">&quot;!Option&quot;</span>, 7 ))
<a name="l04173"></a>04173     {
<a name="l04174"></a>04174     type = <span class="stringliteral">&quot;QIF&quot;</span>;
<a name="l04175"></a>04175     }
<a name="l04176"></a>04176     <span class="keywordflow">else</span>
<a name="l04177"></a>04177     {
<a name="l04178"></a>04178     <span class="keywordflow">if</span> ( strstr ( pointeur_char, <span class="stringliteral">&quot;&lt;gnc-v2&quot;</span> ) )
<a name="l04179"></a>04179     {
<a name="l04180"></a>04180         type = <span class="stringliteral">&quot;Gnucash&quot;</span>;
<a name="l04181"></a>04181     }
<a name="l04182"></a>04182     <span class="keywordflow">else</span>
<a name="l04183"></a>04183     {
<a name="l04184"></a>04184         type = _(<span class="stringliteral">&quot;Unknown&quot;</span>);
<a name="l04185"></a>04185     }
<a name="l04186"></a>04186     }
<a name="l04187"></a>04187 
<a name="l04188"></a>04188     <span class="keywordflow">return</span> type;
<a name="l04189"></a>04189 }
<a name="l04190"></a>04190 
<a name="l04191"></a>04191 
<a name="l04192"></a>04192 
<a name="l04198"></a><a class="code" href="import_8h.html#a20d9d366175a0b8a38fb710d74df63b4">04198</a> G_MODULE_EXPORT <span class="keywordtype">void</span> <a class="code" href="import_8c.html#a20d9d366175a0b8a38fb710d74df63b4">gsb_import_register_account</a> ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * account )
<a name="l04199"></a>04199 {
<a name="l04200"></a>04200     liste_comptes_importes = g_slist_append ( liste_comptes_importes, account );
<a name="l04201"></a>04201 }
<a name="l04202"></a>04202 
<a name="l04203"></a>04203 
<a name="l04204"></a>04204 
<a name="l04210"></a><a class="code" href="import_8h.html#a4bfa72d8a4cd4f0cb17bcce05e286607">04210</a> G_MODULE_EXPORT <span class="keywordtype">void</span> <a class="code" href="import_8c.html#a4bfa72d8a4cd4f0cb17bcce05e286607">gsb_import_register_account_error</a> ( <span class="keyword">struct</span> <a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> * account )
<a name="l04211"></a>04211 {
<a name="l04212"></a>04212     liste_comptes_importes_error = g_slist_append ( liste_comptes_importes, account );
<a name="l04213"></a>04213 }
<a name="l04214"></a>04214 
<a name="l04215"></a>04215 
<a name="l04223"></a><a class="code" href="import_8h.html#a83937dc8d19317b124055841c3fd61a6">04223</a> gboolean <a class="code" href="import_8c.html#a83937dc8d19317b124055841c3fd61a6">gsb_import_by_rule</a> ( gint rule )
<a name="l04224"></a>04224 {
<a name="l04225"></a>04225     gint account_number;
<a name="l04226"></a>04226     gchar **array;
<a name="l04227"></a>04227     gint i=0;
<a name="l04228"></a>04228 
<a name="l04229"></a>04229     charmap_imported = <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> ( <a class="code" href="gsb__data__import__rule_8c.html#ad911feed98610882fa5070032aec5521">gsb_data_import_rule_get_charmap</a> ( rule ));
<a name="l04230"></a>04230     array = gsb_import_by_rule_ask_filename (rule);
<a name="l04231"></a>04231     <span class="keywordflow">if</span> (!array)
<a name="l04232"></a>04232     <span class="keywordflow">return</span> FALSE;
<a name="l04233"></a>04233 
<a name="l04234"></a>04234     account_number = <a class="code" href="gsb__data__import__rule_8c.html#a760102a31b3b6486a76d7cc8b46857cc">gsb_data_import_rule_get_account</a> (rule);
<a name="l04235"></a>04235 
<a name="l04236"></a>04236     <span class="keywordflow">while</span> (array[i])
<a name="l04237"></a>04237     {
<a name="l04238"></a>04238         gchar *filename = array[i];
<a name="l04239"></a>04239         <span class="keyword">const</span> gchar *type;
<a name="l04240"></a>04240         gchar * nom_fichier;
<a name="l04241"></a>04241         <span class="keyword">struct </span><a class="code" href="structimported__file.html">imported_file</a> imported;
<a name="l04242"></a>04242         GSList *tmp = import_formats;
<a name="l04243"></a>04243 
<a name="l04244"></a>04244         <span class="comment">/* check if we are on ofx or qif file */</span>
<a name="l04245"></a>04245         type = autodetect_file_type (filename, NULL);
<a name="l04246"></a>04246         <span class="keywordflow">if</span> (strcmp (type, <span class="stringliteral">&quot;OFX&quot;</span>) &amp;&amp; strcmp (type, <span class="stringliteral">&quot;QIF&quot;</span>))
<a name="l04247"></a>04247         {
<a name="l04248"></a>04248             gchar *tmpstr = g_path_get_basename (filename);
<a name="l04249"></a>04249             gchar *tmpstr2 = g_strdup_printf (_(<span class="stringliteral">&quot;%s is neither an OFX file, neither a QIF file. &quot;</span>
<a name="l04250"></a>04250                             <span class="stringliteral">&quot;Nothing will be done for that file.&quot;</span>),
<a name="l04251"></a>04251                             tmpstr );
<a name="l04252"></a>04252             <a class="code" href="dialog_8c.html#aa88d9d93c78818a177e9a14eff15f360">dialogue_error</a> (tmpstr2);
<a name="l04253"></a>04253             g_free (tmpstr);
<a name="l04254"></a>04254             g_free (tmpstr2);
<a name="l04255"></a>04255             i++;
<a name="l04256"></a>04256             <span class="keywordflow">continue</span>;
<a name="l04257"></a>04257         }
<a name="l04258"></a>04258         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ! strcmp ( type, <span class="stringliteral">&quot;OFX&quot;</span> ) )
<a name="l04259"></a>04259         {
<a name="l04260"></a>04260             gchar * pointeur_char;
<a name="l04261"></a>04261             GError * error = NULL;
<a name="l04262"></a>04262 
<a name="l04263"></a>04263             <span class="keywordflow">if</span> ( ! g_file_get_contents ( filename, &amp;pointeur_char, NULL, &amp;error ) )
<a name="l04264"></a>04264             {
<a name="l04265"></a>04265                 g_print ( _(<span class="stringliteral">&quot;Unable to read file: %s\n&quot;</span>), error -&gt; message);
<a name="l04266"></a>04266                 i++;
<a name="l04267"></a>04267                 <span class="keywordflow">continue</span>;
<a name="l04268"></a>04268             }
<a name="l04269"></a>04269             nom_fichier = g_strconcat (g_get_tmp_dir (),G_DIR_SEPARATOR_S,
<a name="l04270"></a>04270                                        g_path_get_basename ( filename ), NULL);
<a name="l04271"></a>04271             <span class="keywordflow">if</span> (! gsb_import_set_tmp_file (nom_fichier, pointeur_char ) )
<a name="l04272"></a>04272             {
<a name="l04273"></a>04273                 g_free (pointeur_char);
<a name="l04274"></a>04274                 g_free (nom_fichier);
<a name="l04275"></a>04275                 i++;
<a name="l04276"></a>04276                 <span class="keywordflow">continue</span>;
<a name="l04277"></a>04277             }
<a name="l04278"></a>04278             g_free (pointeur_char);
<a name="l04279"></a>04279         }
<a name="l04280"></a>04280         <span class="keywordflow">else</span>
<a name="l04281"></a>04281             nom_fichier = <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> (filename);
<a name="l04282"></a>04282 
<a name="l04283"></a>04283         <span class="comment">/* get the transactions */</span>
<a name="l04284"></a>04284         imported.<a class="code" href="structimported__file.html#abfd9a9c068751bb65b413afecca70e6f">name</a> = nom_fichier;
<a name="l04285"></a>04285         imported.<a class="code" href="structimported__file.html#af9b8e05e83e1adcd22c504ee990736d3">coding_system</a> =  charmap_imported;
<a name="l04286"></a>04286         imported.<a class="code" href="structimported__file.html#a69a7b09e52de8d330bae9a1e9f1391a5">type</a> = type;
<a name="l04287"></a>04287 
<a name="l04288"></a>04288         liste_comptes_importes_error = NULL;
<a name="l04289"></a>04289         liste_comptes_importes = NULL;
<a name="l04290"></a>04290 
<a name="l04291"></a>04291         <span class="keywordflow">while</span> ( tmp )
<a name="l04292"></a>04292         {
<a name="l04293"></a>04293             <span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> * format = (<span class="keyword">struct </span><a class="code" href="structimport__format.html">import_format</a> *) tmp -&gt; data;
<a name="l04294"></a>04294 
<a name="l04295"></a>04295             <span class="keywordflow">if</span> ( !strcmp ( imported.<a class="code" href="structimported__file.html#a69a7b09e52de8d330bae9a1e9f1391a5">type</a>, format -&gt; name ) )
<a name="l04296"></a>04296             {
<a name="l04297"></a>04297             format -&gt; <span class="keyword">import</span> ( NULL, &amp;imported );
<a name="l04298"></a>04298             tmp = tmp -&gt; next;
<a name="l04299"></a>04299                 <span class="keywordflow">continue</span>;
<a name="l04300"></a>04300             }
<a name="l04301"></a>04301             tmp = tmp -&gt; next;
<a name="l04302"></a>04302         }
<a name="l04303"></a>04303 
<a name="l04304"></a>04304         <span class="comment">/* now liste_comptes_importes contains the account structure of imported transactions */</span>
<a name="l04305"></a>04305         <span class="keywordflow">if</span> (liste_comptes_importes_error)
<a name="l04306"></a>04306         {
<a name="l04307"></a>04307             gchar *tmpstr = g_path_get_basename (filename);
<a name="l04308"></a>04308             gchar *tmpstr2 = g_strdup_printf (_(<span class="stringliteral">&quot;%s was not imported successfully. An error occured while getting the transactions.&quot;</span>),
<a name="l04309"></a>04309                             tmpstr );
<a name="l04310"></a>04310             <a class="code" href="dialog_8c.html#aa88d9d93c78818a177e9a14eff15f360">dialogue_error</a> (tmpstr2);
<a name="l04311"></a>04311             g_free (tmpstr);
<a name="l04312"></a>04312             g_free (tmpstr2);
<a name="l04313"></a>04313             i++;
<a name="l04314"></a>04314             <span class="keywordflow">continue</span>;
<a name="l04315"></a>04315         }
<a name="l04316"></a>04316         
<a name="l04317"></a>04317         <span class="keywordflow">while</span> ( liste_comptes_importes )
<a name="l04318"></a>04318         {
<a name="l04319"></a>04319             <span class="keyword">struct </span><a class="code" href="structstruct__compte__importation.html">struct_compte_importation</a> *account;
<a name="l04320"></a>04320 
<a name="l04321"></a>04321             account = liste_comptes_importes -&gt; data;
<a name="l04322"></a>04322             account -&gt; <a class="code" href="structstruct__compte__importation.html#a0f636d05dd8412ef76fe29b93349dcce">invert_transaction_amount</a> = <a class="code" href="gsb__data__import__rule_8c.html#a5334888f570e3c3cfb844dd8731c9453">gsb_data_import_rule_get_invert</a> ( rule );
<a name="l04323"></a>04323 
<a name="l04324"></a>04324             <span class="keywordflow">switch</span> (<a class="code" href="gsb__data__import__rule_8c.html#a099a82ae0d2fd6e50b4f2c8fa96631fb">gsb_data_import_rule_get_action</a> (rule))
<a name="l04325"></a>04325             {
<a name="l04326"></a>04326                 <span class="keywordflow">case</span> <a class="code" href="import_8h.html#ab305602f6b5404b42e8d2789aaff3885">IMPORT_ADD_TRANSACTIONS</a>:
<a name="l04327"></a>04327                 gsb_import_add_imported_transactions ( account, account_number);
<a name="l04328"></a>04328 
<a name="l04329"></a>04329                 <span class="keywordflow">break</span>;
<a name="l04330"></a>04330 
<a name="l04331"></a>04331                 <span class="keywordflow">case</span> <a class="code" href="import_8h.html#ac9f1610298b18bf7ca81eb1ac4974629">IMPORT_MARK_TRANSACTIONS</a>:
<a name="l04332"></a>04332                 pointe_opes_importees ( account, account_number );
<a name="l04333"></a>04333                 <a class="code" href="transaction__list_8c.html#aee9667138888c4cb946225cae2972363">transaction_list_update_element</a> (<a class="code" href="gsb__transactions__list_8h.html#ab04a0655cd1e3bcac5e8f48c18df1a57a1c9bb425c66169e4464498e2d76c6f00">ELEMENT_MARK</a>);
<a name="l04334"></a>04334                 <span class="keywordflow">break</span>;
<a name="l04335"></a>04335             }
<a name="l04336"></a>04336             g_slist_free (account -&gt; <a class="code" href="structstruct__compte__importation.html#a5ecc8020d6a8cc2f35c895c074286881">operations_importees</a>);
<a name="l04337"></a>04337             g_free (account);
<a name="l04338"></a>04338 
<a name="l04339"></a>04339             liste_comptes_importes = liste_comptes_importes -&gt; next;
<a name="l04340"></a>04340         }
<a name="l04341"></a>04341 
<a name="l04342"></a>04342         <span class="comment">/* save the charmap for the last file used */</span>
<a name="l04343"></a>04343         <a class="code" href="gsb__data__import__rule_8c.html#a23233bd23d863d59ebef9c32b3b4f186">gsb_data_import_rule_set_charmap</a> (rule, charmap_imported);
<a name="l04344"></a>04344 
<a name="l04345"></a>04345         <span class="comment">/* save the last file used */</span>
<a name="l04346"></a>04346         <a class="code" href="gsb__data__import__rule_8c.html#a528a876800185bac62799e142d65613f">gsb_data_import_rule_set_last_file_name</a> (rule, filename);
<a name="l04347"></a>04347 
<a name="l04348"></a>04348         <span class="keywordflow">if</span> ( ! strcmp ( type, <span class="stringliteral">&quot;OFX&quot;</span> ) )
<a name="l04349"></a>04349         {
<a name="l04350"></a>04350             g_remove ( nom_fichier );
<a name="l04351"></a>04351         }
<a name="l04352"></a>04352 
<a name="l04353"></a>04353         g_slist_free (liste_comptes_importes);
<a name="l04354"></a>04354         g_free (nom_fichier);
<a name="l04355"></a>04355         i++;
<a name="l04356"></a>04356     }
<a name="l04357"></a>04357     g_strfreev (array);
<a name="l04358"></a>04358 
<a name="l04359"></a>04359     <span class="comment">/* update main page */</span>
<a name="l04360"></a>04360     <a class="code" href="accueil_8c.html#a018917e8dacfd8fbe4e94d0f99a59c08">mise_a_jour_liste_comptes_accueil</a> = 1;
<a name="l04361"></a>04361     <a class="code" href="accueil_8c.html#afaffaedc4fd0ae8638f7158c6777b35b">mise_a_jour_soldes_minimaux</a> = 1;
<a name="l04362"></a>04362     <a class="code" href="accueil_8c.html#a15511226739a34542ef8d7b979aedcf0">mise_a_jour_accueil</a> (FALSE);
<a name="l04363"></a>04363 
<a name="l04364"></a>04364     <span class="comment">/* force the update module budget */</span>
<a name="l04365"></a>04365     <a class="code" href="gsb__data__account_8c.html#aad11cfab16ac44e8de3dd6d792fce4cd">gsb_data_account_set_bet_maj</a> ( account_number, <a class="code" href="structures_8h.html#ab021d1439ce505d767a56f4fc41af400a9d574c71c6a04cadf85be9083be54eed">BET_MAJ_ALL</a> );
<a name="l04366"></a>04366 
<a name="l04367"></a>04367     <span class="keywordflow">if</span> ( <a class="code" href="parametres_8c.html#ab2a744f5d2124688473d13979420e911">etat</a>.<a class="code" href="structgsb__etat__t.html#a9d0fa9057da603e64a601d69d7bf2b51">modification_fichier</a> == 0 )
<a name="l04368"></a>04368         <a class="code" href="traitement__variables_8c.html#aa4084b9e508b1d1fea1d09c6b6208021">modification_fichier</a> ( TRUE );
<a name="l04369"></a>04369 
<a name="l04370"></a>04370     <span class="keywordflow">return</span> FALSE;
<a name="l04371"></a>04371 }
<a name="l04372"></a>04372 
<a name="l04373"></a>04373 
<a name="l04382"></a>04382 gchar **gsb_import_by_rule_ask_filename ( gint rule )
<a name="l04383"></a>04383 {
<a name="l04384"></a>04384     gchar *tmpstr;
<a name="l04385"></a>04385     GtkWidget *dialog, *paddingbox, *table;
<a name="l04386"></a>04386     GtkWidget *label;
<a name="l04387"></a>04387     GtkWidget *button;
<a name="l04388"></a>04388     GtkWidget *entry;
<a name="l04389"></a>04389     GtkWidget *hbox;
<a name="l04390"></a>04390     gchar **array = NULL;
<a name="l04391"></a>04391 
<a name="l04392"></a>04392     <span class="keywordflow">if</span> (!rule)
<a name="l04393"></a>04393     <span class="keywordflow">return</span> NULL;
<a name="l04394"></a>04394 
<a name="l04395"></a>04395     dialog = gtk_dialog_new_with_buttons (_(<span class="stringliteral">&quot;Import a file with a rule&quot;</span>),
<a name="l04396"></a>04396                         GTK_WINDOW ( <a class="code" href="accueil_8c.html#a3d346c08cf2d67c388caabffb412b293">window</a> ),
<a name="l04397"></a>04397                         GTK_DIALOG_MODAL | GTK_DIALOG_DESTROY_WITH_PARENT,
<a name="l04398"></a>04398                         GTK_STOCK_CANCEL, GTK_RESPONSE_REJECT,
<a name="l04399"></a>04399                         GTK_STOCK_OK, GTK_RESPONSE_ACCEPT,
<a name="l04400"></a>04400                         NULL );
<a name="l04401"></a>04401 
<a name="l04402"></a>04402     gtk_window_set_position ( GTK_WINDOW ( dialog ), GTK_WIN_POS_CENTER_ON_PARENT );
<a name="l04403"></a>04403     gtk_window_set_resizable ( GTK_WINDOW ( dialog ), FALSE );
<a name="l04404"></a>04404 
<a name="l04405"></a>04405     <span class="comment">/* text for paddingbox */</span>
<a name="l04406"></a>04406     tmpstr = g_strdup_printf (_(<span class="stringliteral">&quot;Properties of the rule : %s\n&quot;</span>),
<a name="l04407"></a>04407                   <a class="code" href="gsb__data__import__rule_8c.html#a8dded18b2026b5d7a92a93cfb9c799a0">gsb_data_import_rule_get_name</a> (rule));
<a name="l04408"></a>04408 
<a name="l04409"></a>04409     <span class="comment">/* Ugly dance to avoid side effects on dialog&#39;s vbox. */</span>
<a name="l04410"></a>04410     hbox = gtk_hbox_new ( FALSE, 0 );
<a name="l04411"></a>04411     gtk_box_pack_start ( GTK_BOX(GTK_DIALOG(dialog)-&gt;vbox), hbox, FALSE, FALSE, 0 );
<a name="l04412"></a>04412     paddingbox = <a class="code" href="utils_8c.html#a22ba81fcf046b5bec6cf6d55d440abc5">new_paddingbox_with_title</a> ( hbox, TRUE, tmpstr );
<a name="l04413"></a>04413     gtk_container_set_border_width ( GTK_CONTAINER(hbox), 6 );
<a name="l04414"></a>04414     gtk_container_set_border_width ( GTK_CONTAINER(paddingbox), 6 );
<a name="l04415"></a>04415     g_free ( tmpstr );
<a name="l04416"></a>04416 
<a name="l04417"></a>04417     <span class="comment">/* table for layout */</span>
<a name="l04418"></a>04418     table = gtk_table_new ( 2, 3, FALSE );
<a name="l04419"></a>04419     gtk_box_pack_start ( GTK_BOX ( paddingbox ), table, FALSE, FALSE, 6 );
<a name="l04420"></a>04420     gtk_table_set_col_spacings ( GTK_TABLE(table), 6 );
<a name="l04421"></a>04421     gtk_table_set_row_spacings ( GTK_TABLE(table), 6 );
<a name="l04422"></a>04422 
<a name="l04423"></a>04423     <span class="comment">/* textstring 1 */</span>
<a name="l04424"></a>04424     <span class="keywordflow">if</span> (<a class="code" href="gsb__data__import__rule_8c.html#a099a82ae0d2fd6e50b4f2c8fa96631fb">gsb_data_import_rule_get_action</a> (rule) == <a class="code" href="import_8h.html#ab305602f6b5404b42e8d2789aaff3885">IMPORT_ADD_TRANSACTIONS</a>)
<a name="l04425"></a>04425     tmpstr = g_strdup_printf (_(<span class="stringliteral">&quot;Imported transactions will be added to the account %s.\n&quot;</span>),
<a name="l04426"></a>04426                         <a class="code" href="gsb__data__account_8c.html#a6b0df19868e38619bff512f2c18ef51e">gsb_data_account_get_name</a> (<a class="code" href="gsb__data__import__rule_8c.html#a760102a31b3b6486a76d7cc8b46857cc">gsb_data_import_rule_get_account</a> (rule)));
<a name="l04427"></a>04427     <span class="keywordflow">else</span>
<a name="l04428"></a>04428     tmpstr = g_strdup_printf (_(<span class="stringliteral">&quot;Imported transactions will mark transactions in the account &quot;</span>
<a name="l04429"></a>04429                                 <span class="stringliteral">&quot;%s.\n&quot;</span>),
<a name="l04430"></a>04430                         <a class="code" href="gsb__data__account_8c.html#a6b0df19868e38619bff512f2c18ef51e">gsb_data_account_get_name</a> (<a class="code" href="gsb__data__import__rule_8c.html#a760102a31b3b6486a76d7cc8b46857cc">gsb_data_import_rule_get_account</a> (rule)));
<a name="l04431"></a>04431 
<a name="l04432"></a>04432     <span class="comment">/* textstring 2 */</span>
<a name="l04433"></a>04433     tmpstr = g_strconcat(tmpstr, g_strdup_printf (_(<span class="stringliteral">&quot;Currency to import is %s.\n&quot;</span>),
<a name="l04434"></a>04434                         <a class="code" href="gsb__data__currency_8c.html#a0120c1acd462d7ad69ae349d74b23a34">gsb_data_currency_get_name</a> (
<a name="l04435"></a>04435                         <a class="code" href="gsb__data__import__rule_8c.html#a3e559b5525d971d76c625cd52ad1c37e">gsb_data_import_rule_get_currency</a> (rule))), NULL);
<a name="l04436"></a>04436 
<a name="l04437"></a>04437     <span class="comment">/* textstring 3 */</span>
<a name="l04438"></a>04438     <span class="keywordflow">if</span> (<a class="code" href="gsb__data__import__rule_8c.html#a5334888f570e3c3cfb844dd8731c9453">gsb_data_import_rule_get_invert</a> (rule))
<a name="l04439"></a>04439     {
<a name="l04440"></a>04440     tmpstr = g_strconcat(tmpstr, g_strdup_printf (_(<span class="stringliteral">&quot;Amounts of the transactions will be &quot;</span>
<a name="l04441"></a>04441                                                     <span class="stringliteral">&quot;inverted.\n&quot;</span>)), NULL);
<a name="l04442"></a>04442     }
<a name="l04443"></a>04443 
<a name="l04444"></a>04444     label = gtk_label_new ( tmpstr );
<a name="l04445"></a>04445     gtk_misc_set_alignment ( GTK_MISC ( label ), 0.0, 0.0 );
<a name="l04446"></a>04446     gtk_table_attach ( GTK_TABLE(table), label, 0, 3, 0, 1,
<a name="l04447"></a>04447                GTK_SHRINK | GTK_FILL, 0, 0, 0 );
<a name="l04448"></a>04448     g_free ( tmpstr );
<a name="l04449"></a>04449 
<a name="l04450"></a>04450     <span class="comment">/* label filename */</span>
<a name="l04451"></a>04451     label = gtk_label_new (<a class="code" href="structures_8h.html#aaad3270d56994a956f6956f142c1c103">COLON</a>(_(<span class="stringliteral">&quot;Name of the file to import &quot;</span>)));
<a name="l04452"></a>04452     gtk_misc_set_alignment ( GTK_MISC ( label ), 0.0, 0.0 );
<a name="l04453"></a>04453     gtk_table_attach ( GTK_TABLE(table), label, 0, 1, 1, 2,
<a name="l04454"></a>04454                GTK_SHRINK | GTK_FILL, 0, 0, 0 );
<a name="l04455"></a>04455 
<a name="l04456"></a>04456     <span class="comment">/* i tried to use gtk_file_chooser_button, but the name of the file is showed only sometimes</span>
<a name="l04457"></a>04457 <span class="comment">     * so go back to the old method with a gtkentry */</span>
<a name="l04458"></a>04458     entry = gtk_entry_new ();
<a name="l04459"></a>04459     gtk_widget_set_size_request ( entry, 200, -1 );
<a name="l04460"></a>04460     gtk_table_attach ( GTK_TABLE(table), entry, 1, 2, 1, 2,
<a name="l04461"></a>04461                GTK_SHRINK | GTK_FILL, 0, 0, 0 );
<a name="l04462"></a>04462 
<a name="l04463"></a>04463     <span class="keywordflow">if</span> (<a class="code" href="gsb__data__import__rule_8c.html#a55651878d4aeee5a08a2071c6e518b84">gsb_data_import_rule_get_last_file_name</a> (rule))
<a name="l04464"></a>04464     {
<a name="l04465"></a>04465     gtk_entry_set_text ( GTK_ENTRY (entry),
<a name="l04466"></a>04466                <a class="code" href="gsb__data__import__rule_8c.html#a55651878d4aeee5a08a2071c6e518b84">gsb_data_import_rule_get_last_file_name</a> (rule));
<a name="l04467"></a>04467     }
<a name="l04468"></a>04468 
<a name="l04469"></a>04469     button = gtk_button_new_with_label (<span class="stringliteral">&quot;...&quot;</span>);
<a name="l04470"></a>04470     g_signal_connect (G_OBJECT (button), <span class="stringliteral">&quot;clicked&quot;</span>,
<a name="l04471"></a>04471                         G_CALLBACK (gsb_import_by_rule_get_file), entry );
<a name="l04472"></a>04472     gtk_table_attach ( GTK_TABLE(table), button, 2, 3, 1, 2,
<a name="l04473"></a>04473                         GTK_SHRINK | GTK_FILL, 0, 0, 0 );
<a name="l04474"></a>04474 
<a name="l04475"></a>04475     g_object_set_data ( G_OBJECT(entry), <span class="stringliteral">&quot;rule&quot;</span>, GINT_TO_POINTER ( rule ) );
<a name="l04476"></a>04476 
<a name="l04477"></a>04477     gtk_widget_show_all (dialog);
<a name="l04478"></a>04478     <span class="keywordflow">if</span> ( gtk_dialog_run (GTK_DIALOG (dialog)) == GTK_RESPONSE_ACCEPT)
<a name="l04479"></a>04479     array = g_strsplit ( gtk_entry_get_text (GTK_ENTRY (entry)), <span class="stringliteral">&quot;;&quot;</span>, 0);
<a name="l04480"></a>04480 
<a name="l04481"></a>04481     gtk_widget_destroy (dialog);
<a name="l04482"></a>04482     <span class="keywordflow">return</span> array;
<a name="l04483"></a>04483 }
<a name="l04484"></a>04484 
<a name="l04485"></a>04485 
<a name="l04486"></a>04486 
<a name="l04495"></a>04495 gboolean gsb_import_by_rule_get_file ( GtkWidget *button,
<a name="l04496"></a>04496                         GtkWidget *entry )
<a name="l04497"></a>04497 {
<a name="l04498"></a>04498     GSList *filenames;
<a name="l04499"></a>04499     GSList *tmp_list;
<a name="l04500"></a>04500     gchar *<span class="keywordtype">string</span> = NULL;
<a name="l04501"></a>04501     <span class="keyword">const</span> gchar *enc;
<a name="l04502"></a>04502     gint rule;
<a name="l04503"></a>04503 
<a name="l04504"></a>04504     rule = GPOINTER_TO_INT ( g_object_get_data (G_OBJECT (entry), <span class="stringliteral">&quot;rule&quot;</span>));
<a name="l04505"></a>04505     enc = <a class="code" href="gsb__data__import__rule_8c.html#ad911feed98610882fa5070032aec5521">gsb_data_import_rule_get_charmap</a> ( rule );
<a name="l04506"></a>04506     filenames = gsb_import_create_file_chooser ( enc, <a class="code" href="accueil_8c.html#a3d346c08cf2d67c388caabffb412b293">window</a> );
<a name="l04507"></a>04507     <span class="keywordflow">if</span> (!filenames)
<a name="l04508"></a>04508     <span class="keywordflow">return</span> FALSE;
<a name="l04509"></a>04509 
<a name="l04510"></a>04510     <span class="comment">/* separate all the files by ; */</span>
<a name="l04511"></a>04511     tmp_list = filenames;
<a name="l04512"></a>04512     <span class="keywordflow">while</span> (tmp_list)
<a name="l04513"></a>04513     {
<a name="l04514"></a>04514     <span class="keywordflow">if</span> (<span class="keywordtype">string</span>)
<a name="l04515"></a>04515     {
<a name="l04516"></a>04516         gchar *last_string = string;
<a name="l04517"></a>04517 
<a name="l04518"></a>04518         <span class="keywordtype">string</span> = g_strconcat (<span class="keywordtype">string</span>, <span class="stringliteral">&quot;;&quot;</span>, tmp_list -&gt; data, NULL);
<a name="l04519"></a>04519         g_free (last_string);
<a name="l04520"></a>04520     }
<a name="l04521"></a>04521     <span class="keywordflow">else</span>
<a name="l04522"></a>04522         <span class="keywordtype">string</span> = <a class="code" href="utils__str_8c.html#ad9a37361694eeaa2847b0fe11389824d">my_strdup</a> (tmp_list -&gt; data);
<a name="l04523"></a>04523     tmp_list = tmp_list -&gt; next;
<a name="l04524"></a>04524     }
<a name="l04525"></a>04525     g_slist_free (filenames);
<a name="l04526"></a>04526     gtk_entry_set_text (GTK_ENTRY (entry), <span class="keywordtype">string</span>);
<a name="l04527"></a>04527     gtk_editable_select_region ( GTK_EDITABLE (entry), 0, -1);
<a name="l04528"></a>04528     g_free (<span class="keywordtype">string</span>);
<a name="l04529"></a>04529     <span class="keywordflow">return</span> FALSE;
<a name="l04530"></a>04530 }
<a name="l04531"></a>04531 
<a name="l04540"></a>04540 gboolean gsb_import_set_tmp_file ( gchar *filename,
<a name="l04541"></a>04541                         gchar * pointeur_char )
<a name="l04542"></a>04542 {
<a name="l04543"></a>04543     gchar * contenu_fichier;
<a name="l04544"></a>04544     GError * error = NULL;
<a name="l04545"></a>04545 
<a name="l04546"></a>04546     contenu_fichier = <a class="code" href="utils__str_8c.html#a132f77383d5b1e3070ef354a1fdd8a10">my_strdelimit</a> (pointeur_char, <span class="stringliteral">&quot;°&quot;</span>, <span class="stringliteral">&quot;&amp;&quot;</span>);
<a name="l04547"></a>04547 
<a name="l04548"></a>04548     <span class="comment">/* create tmp file */</span>
<a name="l04549"></a>04549     <span class="keywordflow">if</span> ( ! g_file_set_contents ( filename, contenu_fichier, -1, &amp;error ) )
<a name="l04550"></a>04550     {
<a name="l04551"></a>04551         g_free (contenu_fichier);
<a name="l04552"></a>04552         g_print ( _(<span class="stringliteral">&quot;Unable to create tmp file: %s\n&quot;</span>), error -&gt; message);
<a name="l04553"></a>04553         <span class="keywordflow">return</span> FALSE;
<a name="l04554"></a>04554     }
<a name="l04555"></a>04555 
<a name="l04556"></a>04556     g_free (contenu_fichier);
<a name="l04557"></a>04557     <span class="keywordflow">return</span> TRUE;
<a name="l04558"></a>04558 }
<a name="l04559"></a>04559 
<a name="l04560"></a>04560 
<a name="l04568"></a>04568 gboolean gsb_import_gunzip_file ( gchar *filename )
<a name="l04569"></a>04569 {
<a name="l04570"></a>04570     gchar *file_content;
<a name="l04571"></a>04571     gulong length;
<a name="l04572"></a>04572 
<a name="l04573"></a>04573     <span class="keywordflow">if</span> ( <a class="code" href="gsb__file__util_8c.html#aa976d6f0795a4f897ac1092f95ca247c">gsb_file_util_get_contents</a> ( filename, &amp;file_content, &amp;length ) )
<a name="l04574"></a>04574     {
<a name="l04575"></a>04575         GError *error = NULL;
<a name="l04576"></a>04576 
<a name="l04577"></a>04577         g_unlink ( filename );
<a name="l04578"></a>04578         <span class="keywordflow">if</span> ( !g_file_set_contents ( filename, file_content, length, &amp;error ) )
<a name="l04579"></a>04579         {
<a name="l04580"></a>04580             gchar* tmpstr = g_strdup_printf ( _(<span class="stringliteral">&quot;cannot unzip file &#39;%s&#39;: %s&quot;</span>),
<a name="l04581"></a>04581                               filename,
<a name="l04582"></a>04582                               error -&gt; message);
<a name="l04583"></a>04583             <a class="code" href="dialog_8c.html#aa88d9d93c78818a177e9a14eff15f360">dialogue_error</a> ( tmpstr );
<a name="l04584"></a>04584             g_free ( file_content);
<a name="l04585"></a>04585             g_error_free (error);
<a name="l04586"></a>04586 
<a name="l04587"></a>04587             <span class="keywordflow">return</span> FALSE;
<a name="l04588"></a>04588         }
<a name="l04589"></a>04589         <span class="keywordflow">else</span>
<a name="l04590"></a>04590             <span class="keywordflow">return</span> TRUE;
<a name="l04591"></a>04591     }
<a name="l04592"></a>04592     <span class="keywordflow">return</span> FALSE;
<a name="l04593"></a>04593 }
<a name="l04594"></a>04594 
<a name="l04595"></a>04595 
<a name="l04603"></a>04603 <span class="keywordtype">void</span> gsb_import_lookup_budget ( <span class="keyword">struct</span> <a class="code" href="structstruct__ope__importation.html">struct_ope_importation</a> *imported_transaction,
<a name="l04604"></a>04604                         gint transaction_number)
<a name="l04605"></a>04605 {
<a name="l04606"></a>04606         gint budget_number;
<a name="l04607"></a>04607         gchar ** tab_str;
<a name="l04608"></a>04608 
<a name="l04609"></a>04609         tab_str = g_strsplit ( imported_transaction -&gt; budget,
<a name="l04610"></a>04610                                         <span class="stringliteral">&quot;:&quot;</span>,
<a name="l04611"></a>04611                                         2 );
<a name="l04612"></a>04612 
<a name="l04613"></a>04613         <span class="comment">/* get the budget and create it if doesn&#39;t exist */</span>
<a name="l04614"></a>04614         <span class="keywordflow">if</span> (tab_str[0])
<a name="l04615"></a>04615                 tab_str[0] = g_strstrip (tab_str[0]);
<a name="l04616"></a>04616         budget_number = <a class="code" href="gsb__data__budget_8c.html#a1c78de4fbfc0360b85bd503eafe28c96">gsb_data_budget_get_number_by_name</a> ( tab_str[0],
<a name="l04617"></a>04617                                         TRUE,
<a name="l04618"></a>04618                                         imported_transaction -&gt; montant.mantissa &lt; 0 );
<a name="l04619"></a>04619         <a class="code" href="gsb__data__transaction_8c.html#a5cdc1a654e5dbb278af9ad23828fe82d">gsb_data_transaction_set_budgetary_number</a> ( transaction_number,
<a name="l04620"></a>04620                                         budget_number );
<a name="l04621"></a>04621         <span class="keywordflow">if</span> (tab_str[1])
<a name="l04622"></a>04622                 tab_str[1] = g_strstrip (tab_str[1]);
<a name="l04623"></a>04623         <a class="code" href="gsb__data__transaction_8c.html#aae141d1ea0866286b7d86231862e2b0a">gsb_data_transaction_set_sub_budgetary_number</a> ( transaction_number,
<a name="l04624"></a>04624                                         <a class="code" href="gsb__data__budget_8c.html#a6d7e61d14b086448e7176f7681ce6087">gsb_data_budget_get_sub_budget_number_by_name</a> ( budget_number,
<a name="l04625"></a>04625                                         tab_str[1],
<a name="l04626"></a>04626                                         TRUE ));
<a name="l04627"></a>04627         g_strfreev(tab_str);
<a name="l04628"></a>04628 }
<a name="l04629"></a>04629 
<a name="l04630"></a>04630 
<a name="l04639"></a>04639 <span class="keywordtype">void</span> gsb_import_check_ope_import ( GtkWidget *widget, gpointer data )
<a name="l04640"></a>04640 {
<a name="l04641"></a>04641     gint result = GPOINTER_TO_INT ( data );
<a name="l04642"></a>04642     
<a name="l04643"></a>04643     <span class="keywordflow">if</span> ( GTK_IS_HBOX ( widget ) )
<a name="l04644"></a>04644     {
<a name="l04645"></a>04645         gtk_container_foreach ( GTK_CONTAINER (widget ),
<a name="l04646"></a>04646                         (GtkCallback) gsb_import_check_ope_import,
<a name="l04647"></a>04647                         data );
<a name="l04648"></a>04648     }
<a name="l04649"></a>04649     
<a name="l04650"></a>04650     <span class="keywordflow">if</span> ( GTK_IS_TOGGLE_BUTTON ( widget ) )
<a name="l04651"></a>04651     {
<a name="l04652"></a>04652         GtkDialog *dialog;
<a name="l04653"></a>04653 
<a name="l04654"></a>04654         dialog = g_object_get_data ( G_OBJECT ( widget ), <span class="stringliteral">&quot;dialog&quot;</span> );
<a name="l04655"></a>04655         <span class="keywordflow">if</span> ( result == -12 )
<a name="l04656"></a>04656         {
<a name="l04657"></a>04657             gtk_toggle_button_set_active ( GTK_TOGGLE_BUTTON ( widget ), TRUE );
<a name="l04658"></a>04658             gtk_dialog_set_response_sensitive   (dialog, -12, FALSE );
<a name="l04659"></a>04659             gtk_dialog_set_response_sensitive   (dialog, -13, TRUE );
<a name="l04660"></a>04660         }
<a name="l04661"></a>04661         <span class="keywordflow">else</span>
<a name="l04662"></a>04662         {
<a name="l04663"></a>04663             gtk_toggle_button_set_active ( GTK_TOGGLE_BUTTON ( widget ), FALSE );
<a name="l04664"></a>04664             gtk_dialog_set_response_sensitive   (dialog, -12, TRUE );
<a name="l04665"></a>04665             gtk_dialog_set_response_sensitive   (dialog, -13, FALSE );
<a name="l04666"></a>04666         }
<a name="l04667"></a>04667     }
<a name="l04668"></a>04668 }
<a name="l04669"></a>04669 
<a name="l04670"></a>04670 
<a name="l04679"></a>04679 <span class="keywordtype">void</span> gsb_import_ope_import_toggled ( GtkWidget *button, GtkWidget *vbox )
<a name="l04680"></a>04680 {
<a name="l04681"></a>04681     gboolean toggle;
<a name="l04682"></a>04682 
<a name="l04683"></a>04683     toggle = gtk_toggle_button_get_active ( GTK_TOGGLE_BUTTON ( button ) );
<a name="l04684"></a>04684 
<a name="l04685"></a>04685     <span class="keywordflow">if</span> ( gsb_import_ope_import_test_toggled ( vbox, toggle ) )
<a name="l04686"></a>04686     {
<a name="l04687"></a>04687         GtkDialog *dialog;
<a name="l04688"></a>04688 
<a name="l04689"></a>04689         dialog = g_object_get_data ( G_OBJECT ( button ), <span class="stringliteral">&quot;dialog&quot;</span> );
<a name="l04690"></a>04690         <span class="keywordflow">if</span> ( toggle == 1 )
<a name="l04691"></a>04691         {
<a name="l04692"></a>04692             gtk_dialog_set_response_sensitive   (dialog, -12, FALSE );
<a name="l04693"></a>04693             gtk_dialog_set_response_sensitive   (dialog, -13, TRUE );
<a name="l04694"></a>04694         }
<a name="l04695"></a>04695         <span class="keywordflow">else</span>
<a name="l04696"></a>04696         {
<a name="l04697"></a>04697             gtk_dialog_set_response_sensitive   (dialog, -12, TRUE );
<a name="l04698"></a>04698             gtk_dialog_set_response_sensitive   (dialog, -13, FALSE );
<a name="l04699"></a>04699         }
<a name="l04700"></a>04700     }
<a name="l04701"></a>04701 }
<a name="l04702"></a>04702 
<a name="l04703"></a>04703 
<a name="l04712"></a>04712 gboolean gsb_import_ope_import_test_toggled ( GtkWidget *vbox , gboolean test )
<a name="l04713"></a>04713 {
<a name="l04714"></a>04714     GList *children;
<a name="l04715"></a>04715 
<a name="l04716"></a>04716     children = gtk_container_get_children ( GTK_CONTAINER ( vbox ) );
<a name="l04717"></a>04717 
<a name="l04718"></a>04718     <span class="keywordflow">while</span> ( children )
<a name="l04719"></a>04719     {
<a name="l04720"></a>04720         GtkWidget *widget;
<a name="l04721"></a>04721 
<a name="l04722"></a>04722         widget = children -&gt; data;
<a name="l04723"></a>04723         <span class="keywordflow">if</span> ( GTK_IS_HBOX ( widget ) )
<a name="l04724"></a>04724         {
<a name="l04725"></a>04725             GList *list;
<a name="l04726"></a>04726             
<a name="l04727"></a>04727             list = gtk_container_get_children ( GTK_CONTAINER ( widget ) );
<a name="l04728"></a>04728             <span class="keywordflow">while</span> ( list )
<a name="l04729"></a>04729             {
<a name="l04730"></a>04730                 widget = list -&gt; data;
<a name="l04731"></a>04731                 <span class="keywordflow">if</span> ( GTK_IS_TOGGLE_BUTTON ( widget ) )
<a name="l04732"></a>04732                 {
<a name="l04733"></a>04733                     g_list_free ( list );
<a name="l04734"></a>04734                     <span class="keywordflow">break</span>;
<a name="l04735"></a>04735                 }
<a name="l04736"></a>04736                 list = list -&gt; next;
<a name="l04737"></a>04737             }
<a name="l04738"></a>04738         }
<a name="l04739"></a>04739         <span class="keywordflow">if</span> ( GTK_IS_TOGGLE_BUTTON ( widget ) )
<a name="l04740"></a>04740         {
<a name="l04741"></a>04741             <span class="keywordflow">if</span> ( test != gtk_toggle_button_get_active ( GTK_TOGGLE_BUTTON ( widget ) ) )
<a name="l04742"></a>04742                 <span class="keywordflow">return</span> FALSE;
<a name="l04743"></a>04743         }
<a name="l04744"></a>04744         children = children -&gt; next;
<a name="l04745"></a>04745     }
<a name="l04746"></a>04746     g_list_free ( children );
<a name="l04747"></a>04747 
<a name="l04748"></a>04748     <span class="keywordflow">return</span> TRUE;
<a name="l04749"></a>04749 }
<a name="l04750"></a>04750 <span class="comment">/* Local Variables: */</span>
<a name="l04751"></a>04751 <span class="comment">/* c-basic-offset: 4 */</span>
<a name="l04752"></a>04752 <span class="comment">/* End: */</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Généré le Sat Aug 7 22:12:03 2010 pour Grisbi par&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
